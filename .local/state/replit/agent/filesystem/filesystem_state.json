{"file_contents":{"server/src/models/Referral.ts":{"content":"// MONGO BACKUP: import { Schema, model } from 'mongoose';\n// MONGO BACKUP: import { getMaxReferralId } from '../helpers';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IReferral {\n// MONGO BACKUP:   _id?: number;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   referId: number;\n// MONGO BACKUP:   createdAt?: Date;\n// MONGO BACKUP:   updatedAt?: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const ReferralSchema = new Schema<IReferral>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     userId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true\n// MONGO BACKUP:     },\n// MONGO BACKUP:     referId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true\n// MONGO BACKUP:     }\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true,\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: ReferralSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxReferralId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export default model<IReferral>('Referral', ReferralSchema); \n","size_bytes":1410},"server/src/models/Chat.ts":{"content":"// MONGO BACKUP: import { Schema, model, Document } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IMessage {\n// MONGO BACKUP:   sender: number;\n// MONGO BACKUP:   content: string;\n// MONGO BACKUP:   timestamp: Date;\n// MONGO BACKUP:   isSystemMessage?: boolean;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: interface IChat extends Document {\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   messages: IMessage[];\n// MONGO BACKUP:   lastReadByUser?: Date;\n// MONGO BACKUP:   lastReadByAdmin?: Date;\n// MONGO BACKUP:   unreadAdminCount: number;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const messageSchema = new Schema<IMessage>({\n// MONGO BACKUP:   sender: Number,\n// MONGO BACKUP:   content: String,\n// MONGO BACKUP:   timestamp: { type: Date, default: Date.now },\n// MONGO BACKUP:   isSystemMessage: Boolean,\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: const chatSchema = new Schema<IChat>({\n// MONGO BACKUP:   userId: { type: Number, required: true, unique: true },\n// MONGO BACKUP:   messages: [messageSchema],\n// MONGO BACKUP:   lastReadByUser: Date,\n// MONGO BACKUP:   lastReadByAdmin: Date,\n// MONGO BACKUP:   unreadAdminCount: { type: Number, default: 0 },\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export const Chat = model<IChat>('Chat', chatSchema);\n","size_bytes":1336},"admin/src/components/NewGameForm.tsx":{"content":"import React, { useState } from 'react';\nimport {useDispatch} from \"react-redux\";\nimport type {AppDispatch} from \"../store/store.ts\";\nimport {addGame} from \"../store/features/gamesSlice.ts\";\n\nconst NewGameForm: React.FC = () => {\n    const [title, setTitle] = useState('');\n    const [imageUrl, setImageUrl] = useState('');\n    const [gifUrl, setGifUrl] = useState('');\n    const [hasDiscount, setHasDiscount] = useState(false);\n    const [isActual, setIsActual] = useState(true);\n    const [isEnabled, setIsEnabled] = useState(true);\n    const [appleStoreUrl, setAppleStoreUrl] = useState('');\n    const [googlePlayUrl, setGooglePlayUrl] = useState('');\n    const [trailerUrl, setTrailerUrl] = useState('');\n\n    const dispatch = useDispatch<AppDispatch>();\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n\n        const game = {\n            title,\n            imageUrl,\n            gifUrl,\n            hasDiscount,\n            isActual,\n            isEnabled,\n            appleStoreUrl,\n            googlePlayUrl,\n            trailerUrl,\n        }\n\n        await dispatch(addGame(game));\n\n        // reset form\n        setTitle('');\n        setImageUrl('');\n        setGifUrl('');\n        setHasDiscount(false);\n        setIsActual(true);\n        setIsEnabled(true);\n        setAppleStoreUrl('');\n        setGooglePlayUrl('');\n        setTrailerUrl('');\n    };\n\n    return (\n        <form onSubmit={handleSubmit} className=\"space-y-2 max-w-md p-4 rounded\">\n            <input\n                type=\"text\"\n                placeholder=\"Title\"\n                value={title}\n                required\n                onChange={(e) => setTitle(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"url\"\n                placeholder=\"Image URL\"\n                value={imageUrl}\n                required\n                onChange={(e) => setImageUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"url\"\n                placeholder=\"GIF URL\"\n                value={gifUrl}\n                required\n                onChange={(e) => setGifUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <label>\n                <input\n                    type=\"checkbox\"\n                    checked={hasDiscount}\n                    onChange={() => setHasDiscount(!hasDiscount)}\n                /> Has Discount\n                <br/>\n            </label>\n            <label>\n                <input\n                    type=\"checkbox\"\n                    checked={isActual}\n                    onChange={() => setIsActual(!isActual)}\n                /> Is Actual\n                <br/>\n            </label>\n            <label>\n                <input\n                    type=\"checkbox\"\n                    checked={isEnabled}\n                    onChange={() => setIsEnabled(!isEnabled)}\n                /> Is Enabled\n                <br/>\n            </label>\n            <input\n                type=\"url\"\n                placeholder=\"Apple Store URL\"\n                value={appleStoreUrl}\n                required\n                onChange={(e) => setAppleStoreUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"url\"\n                placeholder=\"Google Play URL\"\n                value={googlePlayUrl}\n                required\n                onChange={(e) => setGooglePlayUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"url\"\n                placeholder=\"Trailer URL\"\n                value={trailerUrl}\n                required\n                onChange={(e) => setTrailerUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <button type=\"submit\" className=\"bg-blue-600 text-white px-4 py-2 rounded\">\n                Add Game\n            </button>\n        </form>\n    );\n};\n\nexport default NewGameForm;\n","size_bytes":4078},"client/src/pages/Chat.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport io, { Socket } from 'socket.io-client';\nimport { useSelector } from \"react-redux\";\nimport type { RootState } from \"../store/store.ts\";\nimport type { DefaultEventsMap } from \"socket.io\";\nimport { useNavigate } from \"react-router-dom\";\nimport { useTranslation } from \"react-i18next\";\nimport EmojiPicker, { Theme } from \"emoji-picker-react\";\nimport {SendIcon} from \"lucide-react\";\n\nexport default function Chat() {\n    const [messages, setMessages] = useState([{ sender: -1, content: \"Hello, how can I help you?\" }]);\n    const [input, setInput] = useState(\"\");\n    const [showEmojiPicker, setShowEmojiPicker] = useState(false); // ‚úÖ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n\n    const userId = useSelector((state: RootState) => state.user.user?._id);\n    const { t } = useTranslation();\n    const navigate = useNavigate();\n    const socketRef = useRef<Socket<DefaultEventsMap, DefaultEventsMap> | null>(null);\n    const messagesEndRef = useRef<HTMLDivElement | null>(null);\n\n    useEffect(() => {\n        if (!socketRef.current) {\n            socketRef.current = io(import.meta.env.VITE_API_URL);\n        }\n\n        const socket = socketRef.current;\n        if (!userId) return;\n\n        socket.emit('register_client', userId);\n        const handleHistory = (msgs: any[]) => setMessages(msgs);\n        const handleNewMessage = (msg: any) => setMessages(prev => [...prev, msg]);\n\n        socket.on('chat_history', handleHistory);\n        socket.on('new_message', handleNewMessage);\n\n        return () => {\n            socket.off('chat_history', handleHistory);\n            socket.off('new_message', handleNewMessage);\n        };\n    }, [userId]);\n\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }, [messages]);\n\n    const sendMessage = () => {\n        if (!input.trim() || !socketRef.current) return;\n\n        socketRef.current.emit('send_message', { sender: 1, userId, content: input });\n        setMessages(prev => [...prev, { sender: 1, content: input }]);\n        setInput('');\n    };\n\n    const onEmojiClick = (emojiData: any) => {\n        setInput(prev => prev + emojiData.emoji);\n    };\n\n    return (\n        <div className='flex max-w-[28rem] w-full gap-[8px] flex-wrap content-start justify-start'>\n            <div className=\"w-full h-full border border-[#27282C] rounded-lg flex flex-col\">\n                <div className=\"flex-1 p-2 overflow-y-auto rounded-lg space-y-2 whitespace-pre-wrap\">\n                    {messages.map((msg, idx) => (\n                        <div\n                            key={idx}\n                            className={`p-2 rounded-lg border border-[#27282C] max-w-xs ${\n                                msg.sender === 1 ? \"ml-auto bg-[#1A1B1E] text-white\" : \"mr-auto bg-gray-200 text-black\"\n                            }`}\n                        >\n                            {msg.content}\n                            {msg.sender === -1 && msg.content.includes('üìå Status: PENDING') &&\n                                <button onClick={() => navigate(`/purchase-form/${msg.content.match(/Order ID:\\s*(\\d+)/)?.[1]}`)} className=\"w-full h-[40px] text-sm cursor-pointer mt-2 bg-[#1A1B1E] rounded-lg text-white\">Enter order details</button>\n                            }\n                            {msg.sender === -1 && msg.content.includes('üìå Status: INVALID') &&\n                                <button onClick={() => navigate(`/purchase-form/${msg.content.match(/Order ID:\\s*(\\d+)/)?.[1]}`)} className=\"w-full h-[40px] text-sm cursor-pointer mt-2 bg-[#1A1B1E] rounded-lg text-white\">Edit order details</button>\n                            }\n                            {msg.sender === -1 && msg.content.includes(\"leave a review\") && msg.content.match(/‚Ññ(\\d+)/)?.[1] &&\n                                <button onClick={() => navigate(`/review/${msg.content.match(/‚Ññ(\\d+)/)![1]}`)} className=\"w-full h-[40px] text-sm mt-2 bg-[#1A1B1E] cursor-pointer rounded-lg text-white\">Leave a review</button>\n                            }\n                        </div>\n                    ))}\n                    <div ref={messagesEndRef} />\n                </div>\n\n                <div className=\"p-3 max-[350px]:p-2 rounded-b-lg flex flex-col border-t border-[#27282C]\">\n                    <div className=\"p-2.5 max-[350px]:p-1 rounded-lg flex flex-col bg-[#1a1b1e]\">\n                        {showEmojiPicker && (\n                            <div className=\"w-full mb-2 flex justify-start\">\n                                <div className=\"max-w-[250px] w-full rounded-xl shadow-lg border border-[#27282C] bg-[#1A1B1E] overflow-hidden\">\n                                    <EmojiPicker\n                                        theme={Theme.DARK}\n                                        onEmojiClick={onEmojiClick}\n                                        width=\"100%\"\n                                        height={window.innerWidth < 350 ? 200 : 250}\n                                        searchDisabled={true}\n                                        previewConfig={{ showPreview: false }}\n                                    />\n                                </div>\n                            </div>\n                        )}\n                        <div className=\"flex items-center\">\n                            <input\n                                type=\"text\"\n                                className=\"flex-1 text-white max-[350px]:text-sm outline-none rounded-lg px-3 max-[350px]:px-1.5 py-2 mr-2 focus:outline-none\"\n                                value={input}\n                                onChange={(e) => setInput(e.target.value)}\n                                onKeyDown={(e) => e.key === \"Enter\" && sendMessage()}\n                                placeholder={t('chat.enter')}\n                            />\n                            <button\n                                onClick={() => setShowEmojiPicker(prev => !prev)}\n                                className=\"text-white text-xl mr-2\"\n                            >\n                                üòä\n                            </button>\n                            <button\n                                onClick={sendMessage}\n                                className=\"h-full px-4 max-[350px]:px-3 py-2 rounded-lg border border-[#27282C] cursor-pointer\"\n                            >\n                                <SendIcon className=\"w-5 h-5 max-[350px]:h-4 max-[350px]:w-4 text-[#8F96A3]\" />\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}","size_bytes":6668},"client/src/pages/ReviewForm.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { useParams } from \"react-router-dom\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport { createReview, fetchReviews } from \"../store/features/reviewsSlice\";\nimport { fetchOrder } from \"../store/features/ordersSlice\";\nimport {useTranslation} from \"react-i18next\";\n\nconst ReviewForm: React.FC = () => {\n    const { orderId } = useParams<{ orderId: string }>();\n    const dispatch = useDispatch<AppDispatch>();\n\n    const {t} = useTranslation();\n\n    const [rating, setRating] = useState<number>(5);\n    const [comment, setComment] = useState<string>(\"\");\n    const [error, setError] = useState<string | null>(null);\n    const [success, setSuccess] = useState<boolean>(false);\n\n    const { orderForm, loading: orderLoading, error: orderError } = useSelector((state: RootState) => state.orders);\n    const { reviews, loading: reviewsLoading, error: reviewsError } = useSelector((state: RootState) => state.reviews);\n\n    useEffect(() => {\n        if (orderId) {\n            dispatch(fetchOrder(orderId));\n            dispatch(fetchReviews());\n        }\n    }, [dispatch, orderId]);\n\n    if (!orderId) return <div className=\"p-4 text-red-500 font-bold\">Order ID not found</div>;\n\n    if (orderLoading || reviewsLoading) return <div className=\"p-4 text-white\">Loading...</div>;\n\n    if (!orderForm) return <div className=\"p-4 text-red-500 font-bold\">Order not found</div>;\n\n    if (orderError) return <div className=\"p-4 text-red-500 font-bold\">Order not found</div>;\n\n    if (reviewsError) return <div className=\"p-4 text-red-500 font-bold\">Reviews not found</div>;\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑\n    const alreadyReviewed = reviews.some((review) => review.orderId.toString() === orderId);\n\n    if (alreadyReviewed) {\n        return <div className=\"p-4 text-yellow-400 font-bold\">You have already reviewed this order.</div>;\n    }\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        setError(null);\n\n        if (!rating || !comment.trim()) {\n            setError(\"Rating and comment are required.\");\n            return;\n        }\n\n        try {\n            await dispatch(\n                createReview({\n                    orderId,\n                    rating,\n                    comment,\n                })\n            ).unwrap();\n            setSuccess(true);\n            setComment(\"\");\n        } catch (err: any) {\n            setError(err.message || \"Failed to submit review.\");\n        }\n    };\n\n    const inputClass =\n        \"w-full p-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500 text-gray-200 border-gray-400 bg-[#1A1B1E]\";\n\n    return (\n        <form\n            onSubmit={handleSubmit}\n            className=\"max-w-[28rem] w-full mx-2 my-3 p-4 space-y-4 bg-[#1A1B1E] rounded-xl shadow-md\"\n        >\n            <div>\n                <label className=\"text-white\">{t('reviewForm.rating')} (1-5):</label>\n                <input\n                    type=\"number\"\n                    min=\"1\"\n                    max=\"5\"\n                    value={rating}\n                    onChange={(e) => setRating(Number(e.target.value))}\n                    className={inputClass}\n                />\n            </div>\n            <div>\n                <label className=\"text-white\">{t('reviewForm.comment')}:</label>\n                <textarea\n                    value={comment}\n                    onChange={(e) => setComment(e.target.value)}\n                    className={inputClass + \" min-h-[100px]\"}\n                    placeholder={t('reviewForm.placeholder')}\n                />\n            </div>\n            {error && <div className=\"text-red-500\">{error}</div>}\n            {success && <div className=\"text-green-500\">{t('reviewForm.success')}</div>}\n            <button\n                type=\"submit\"\n                className=\"w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition cursor-pointer\"\n            >\n                {t('reviewForm.btn')}\n            </button>\n        </form>\n    );\n};\n\nexport default ReviewForm;\n","size_bytes":4208},"server/src/helpers/index.ts":{"content":"import Payment from '../models/Payment';\nimport { logger } from '../config/logger';\nimport Order from '../models/Order';\nimport Offer from '../models/Offer';\nimport Game from '../models/Game';\nimport OrderDetails from '../models/OrderDetails';\nimport Withdrawal from '../models/Withdrawal';\nimport Transaction from '../models/Transaction';\nimport Referral from '../models/Referral';\nimport crypto from 'crypto';\nimport Review from \"../models/Review\";\n\nexport const getMaxPaymentId = async (): Promise<number> => {\n  try {\n    const maxPayment = await Payment.findOne().sort({ _id: -1 }).select('_id');\n    return maxPayment?._id || 0; // Return 0 if no payments exist\n  } catch (error) {\n    logger.error(`Error fetching max payment ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxOrderId = async (): Promise<number> => {\n  try {\n    const maxOrder = await Order.findOne().sort({ _id: -1 }).select('_id');\n    return maxOrder?._id || 0; // Return 0 if no orders exist\n  } catch (error) {\n    logger.error(`Error fetching max order ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxOrderDetailsId = async (): Promise<number> => {\n  try {\n    const maxOrderDetails = await OrderDetails.findOne().sort({ _id: -1 }).select('_id');\n    return maxOrderDetails?._id || 0; // Return 0 if no order details exist\n  } catch (error) {\n    logger.error(`Error fetching max order details ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxOfferId = async (): Promise<number> => {\n  try {\n    const maxOffer = await Offer.findOne().sort({ _id: -1 }).select('_id');\n    return maxOffer?._id || 0; // Return 0 if no offers exist\n  } catch (error) {\n    logger.error(`Error fetching max offer ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxGameId = async (): Promise<number> => {\n  try {\n    const maxGame = await Game.findOne().sort({ _id: -1 }).select('_id');\n    return maxGame?._id || 0; // Return 0 if no games exist\n  } catch (error) {\n    logger.error(`Error fetching max game ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxWithdrawalId = async (): Promise<number> => {\n  try {\n    const maxWithdrawal = await Withdrawal.findOne().sort({ _id: -1 }).select('_id');\n    return maxWithdrawal?._id || 0; // Return 0 if no withdrawals exist\n  } catch (error) {\n    logger.error(`Error fetching max withdrawal ID: ${error}`);\n    return 0; // Return 0 in case of an error\n  }\n};\n\nexport const getMaxReviewId = async (): Promise<number> => {\n  try {\n    const maxReview = await Review.findOne().sort({ _id: -1 }).select('_id');\n    return maxReview?._id || 0;\n  } catch (error) {\n    logger.error(`Error fetching max review ID: ${error}`);\n    return 0;\n  }\n};\n\nexport const getMaxTransactionId = async (): Promise<number> => {\n  try {\n    const maxTransaction = await Transaction.findOne().sort({ _id: -1 }).select('_id');\n    return maxTransaction?._id || 0;\n  } catch (error) {\n    logger.error(`Error fetching max transaction ID: ${error}`);\n    return 0;\n  }\n};\n\nexport const getMaxReferralId = async (): Promise<number> => {\n  try {\n    const maxReferral = await Referral.findOne().sort({ _id: -1 }).select('_id');\n    return maxReferral?._id || 0;\n  } catch (error) {\n    logger.error(`Error fetching max referral ID: ${error}`);\n    return 0;\n  }\n};\n","size_bytes":3442},"bot/src/config/config.service.ts":{"content":"import { config } from 'dotenv';\nimport { resolve } from 'path';\n\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\nconfig();\n\n/**\n * üîß –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\n * –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\n */\nexport class ConfigService {\n  private static instance: ConfigService;\n  private config: Record<string, any> = {};\n\n  private constructor() {\n    this.loadAndValidateConfig();\n  }\n\n  public static getInstance(): ConfigService {\n    if (!ConfigService.instance) {\n      ConfigService.instance = new ConfigService();\n    }\n    return ConfigService.instance;\n  }\n\n  /**\n   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é\n   */\n  private loadAndValidateConfig(): void {\n    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n    const requiredVars = {\n      BOT_TOKEN: process.env.BOT_TOKEN,\n      BOT_USERNAME: process.env.BOT_USERNAME,\n    };\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n    for (const [key, value] of Object.entries(requiredVars)) {\n      if (!value) {\n        throw new Error(`‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ${key} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`);\n      }\n    }\n\n    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n    this.config = {\n      // ü§ñ Telegram Bot\n      bot: {\n        token: this.getEnvVar('BOT_TOKEN'),\n        username: this.getEnvVar('BOT_USERNAME'),\n      },\n\n      // üë®‚Äçüíª –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ\n      admin: {\n        id: this.getEnvVar('ADMIN_ID'),\n      },\n\n      // üì¢ –ö–∞–Ω–∞–ª—ã –∏ —Å—Å—ã–ª–∫–∏\n      channels: {\n        channelUrl: this.getEnvVar('CHANNEL_URL', 'https://t.me/tiptop_mgn'),\n        catalogUrl: this.getEnvVar('CATALOG_URL', 'https://t.me/mobile_games_tp'),\n        supportUrl: this.getEnvVar('SUPPORT_URL', 'https://t.me/tiptop_support'),\n      },\n\n      // üåê Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n      webApp: {\n        url: this.getEnvVar('WEB_APP_URL', 'https://mobile-games.online/'),\n        googlePlayUrl: this.getEnvVar('DEFAULT_GOOGLE_PLAY_URL', 'https://play.google.com'),\n        appStoreUrl: this.getEnvVar('DEFAULT_APP_STORE_URL', 'https://www.apple.com/app-store/'),\n      },\n\n      // üéÆ –ú–µ–¥–∏–∞ —Ä–µ—Å—É—Ä—Å—ã\n      media: {\n        welcomeGifRu: this.getEnvVar('WELCOME_GIF_RU', 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcHppdWQzb3MxbzNndjhlZTFiMHpwYnI3Z2l0dGp4czc4dGppZGJiYyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/NjCzN2GiZFlLjgHJO4/giphy.gif'),\n        welcomeGifEn: this.getEnvVar('WELCOME_GIF_EN', 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcHppdWQzb3MxbzNndjhlZTFiMHpwYnI3Z2l0dGp4czc4dGppZGJiYyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/NjCzN2GiZFlLjgHJO4/giphy.gif'),\n        subscribeRequestGif: this.getEnvVar('SUBSCRIBE_REQUEST_GIF', 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif'),\n        defaultGifUrl: this.getEnvVar('DEFAULT_GIF_URL', 'https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif'),\n        cabinetGifUrl: this.getEnvVar('CABINET_GIF_URL', 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif'),\n        placeholderImageUrl: this.getEnvVar('PLACEHOLDER_IMAGE_URL', 'https://via.placeholder.com/800x400?text=Game+Not+Available'),\n      },\n\n      // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n      performance: {\n        messageUpdateDebounceDelay: this.getEnvNumber('MESSAGE_UPDATE_DEBOUNCE_DELAY', 100),\n        maxPendingUpdateTime: this.getEnvNumber('MAX_PENDING_UPDATE_TIME', 5000),\n        cleanupInterval: this.getEnvNumber('CLEANUP_INTERVAL', 30000),\n      },\n\n      // üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n      security: {\n        rateLimitMaxRequests: this.getEnvNumber('RATE_LIMIT_MAX_REQUESTS', 30),\n        rateLimitWindowMs: this.getEnvNumber('RATE_LIMIT_WINDOW_MS', 60000),\n      },\n\n      // üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\n      logging: {\n        level: this.getEnvVar('LOG_LEVEL', 'info'),\n        toFile: this.getEnvBoolean('LOG_TO_FILE', false),\n        filePath: this.getEnvVar('LOG_FILE_PATH', './logs/bot.log'),\n      },\n\n      // üåç –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è\n      localization: {\n        defaultLanguage: this.getEnvVar('DEFAULT_LANGUAGE', 'ru'),\n      },\n\n      // üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\n      database: {\n        useMockData: this.getEnvBoolean('USE_MOCK_DATA', true),\n        mockDataPath: this.getEnvVar('MOCK_DATA_PATH', './src/mock/data.ts'),\n      },\n\n      // üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è\n      automation: {\n        slideshowInterval: this.getEnvNumber('SLIDESHOW_INTERVAL', 3000),\n        slideshowMaxDuration: this.getEnvNumber('SLIDESHOW_MAX_DURATION', 30000),\n      },\n    };\n\n    console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞');\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n   */\n  private getEnvVar(key: string, defaultValue?: string): string {\n    const value = process.env[key];\n    if (value === undefined) {\n      if (defaultValue !== undefined) {\n        console.warn(`‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è ${key} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultValue}`);\n        return defaultValue;\n      }\n      throw new Error(`‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ${key} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!`);\n    }\n    return value;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —á–∏—Å–ª–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è\n   */\n  private getEnvNumber(key: string, defaultValue: number): number {\n    const value = process.env[key];\n    if (value === undefined) {\n      console.warn(`‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è ${key} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultValue}`);\n      return defaultValue;\n    }\n    const parsed = parseInt(value, 10);\n    if (isNaN(parsed)) {\n      console.warn(`‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è ${key} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultValue}`);\n      return defaultValue;\n    }\n    return parsed;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –±—É–ª–µ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è\n   */\n  private getEnvBoolean(key: string, defaultValue: boolean): boolean {\n    const value = process.env[key];\n    if (value === undefined) {\n      console.warn(`‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è ${key} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultValue}`);\n      return defaultValue;\n    }\n    return value.toLowerCase() === 'true';\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ –ø—É—Ç–∏\n   */\n  public get<T = any>(path: string): T {\n    const keys = path.split('.');\n    let current = this.config;\n    \n    for (const key of keys) {\n      if (current[key] === undefined) {\n        throw new Error(`‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ –ø—É—Ç–∏ '${path}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);\n      }\n      current = current[key];\n    }\n    \n    return current as T;\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è\n   */\n  public has(path: string): boolean {\n    try {\n      this.get(path);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)\n   */\n  public getAll(): Record<string, any> {\n    return { ...this.config };\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å fallback\n   */\n  public getString(key: string, defaultValue?: string): string {\n    try {\n      // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\n      const value = this.get<string>(key);\n      return value;\n    } catch {\n      // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ env\n      const envValue = process.env[key];\n      if (envValue !== undefined) {\n        return envValue;\n      }\n      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É\n      if (defaultValue !== undefined) {\n        return defaultValue;\n      }\n      throw new Error(`‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è '${key}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);\n    }\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å fallback\n   */\n  public getNumber(key: string, defaultValue?: number): number {\n    try {\n      const value = this.get<number>(key);\n      return value;\n    } catch {\n      const envValue = process.env[key];\n      if (envValue !== undefined) {\n        const parsed = parseInt(envValue, 10);\n        if (!isNaN(parsed)) {\n          return parsed;\n        }\n      }\n      if (defaultValue !== undefined) {\n        return defaultValue;\n      }\n      throw new Error(`‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è '${key}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);\n    }\n  }\n\n  /**\n   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è production\n   */\n  public validateForProduction(): void {\n    const productionRequiredVars = [\n      'bot.token',\n      'bot.username',\n      'admin.id',\n      'channels.channelUrl',\n      'webApp.url',\n    ];\n\n    const missingVars: string[] = [];\n    \n    for (const varPath of productionRequiredVars) {\n      if (!this.has(varPath)) {\n        missingVars.push(varPath);\n      }\n    }\n\n    if (missingVars.length > 0) {\n      throw new Error(`‚ùå –î–ª—è production –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${missingVars.join(', ')}`);\n    }\n\n    console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –¥–ª—è production');\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–Ω–≥–ª—Ç–æ–Ω\nexport const configService = ConfigService.getInstance();","size_bytes":9976},"server/index.ts":{"content":"import express, { Request, Response } from 'express';\nimport cors from 'cors';\nimport session from 'express-session';\nimport { randomBytes } from 'crypto';\nimport dotenv from 'dotenv';\nimport path from 'path';\nimport morgan from 'morgan';\nimport http from 'http'; // CHANGED: Was https, now http\nimport { Server } from 'socket.io';\n\n// --- fs is no longer needed, can be removed or kept, it's unused ---\n// import fs from 'fs';\n\n// MONGO BACKUP: import { connectDB } from './src/config/database';\nimport { connectDatabase, chatRepository, orderRepository, gameRepository, offerRepository, paymentRepository, referralRepository, userRepository } from './src/db';\nimport { logger, stream } from './src/config/logger';\n\nimport gameRoutes from './src/routes/gameRoutes';\nimport offerRoutes from './src/routes/offerRoutes';\nimport userRoutes from './src/routes/userRoutes';\nimport orderRoutes from './src/routes/orderRoutes';\nimport orderDetailsRoutes from './src/routes/orderDetailsRoutes';\nimport paymentRoutes from './src/routes/paymentRoutes';\nimport reviewRoutes from './src/routes/reviewRoutes';\nimport withdrawalRoutes from './src/routes/withdrawalRoutes';\nimport webhookRoutes from './src/routes/webhookRoutes';\nimport chatRoutes from './src/routes/chatRoutes';\nimport referralRoutes from './src/routes/referralRoutes';\nimport transactionRoutes from './src/routes/transactionRoutes';\nimport adminRoutes from './src/routes/adminRoutes';\n\n// MONGO BACKUP: import { Chat, IMessage } from \"./src/models/Chat\";\n// MONGO BACKUP: import Order, { IOrder } from \"./src/models/Order\";\n// MONGO BACKUP: import Offer from \"./src/models/Offer\";\n// MONGO BACKUP: import Game from \"./src/models/Game\";\n// MONGO BACKUP: import Payment from \"./src/models/Payment\";\nimport process from \"node:process\";\n// MONGO BACKUP: import Referral from \"./src/models/Referral\";\n// MONGO BACKUP: import User from \"./src/models/User\";\nimport axios from \"axios\";\n\ndotenv.config();\n\nconst app = express();\nconst PORT = process.env.PORT || 3000; // CHANGED: Port for internal use\n\n// --- ENTIRE BLOCK WITH SSL CERTIFICATES REMOVED ---\n\nconst httpServer = http.createServer(app);\n\nconst allowedOrigins = [\n    process.env.CLIENT_URL,\n    'http://localhost:5173',\n    'http://localhost:5174'\n];\n\nexport const io = new Server(httpServer, {\n    cors: {\n        origin: (origin, callback) => {\n            if (!origin || allowedOrigins.includes(origin)) {\n                callback(null, true);\n            } else {\n                callback(new Error('Not allowed by CORS'));\n            }\n        },\n        methods: ['GET', 'POST']\n    }\n});\n\napp.use(cors());\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\napp.use(morgan('combined', { stream }));\n\nconst secretKey = randomBytes(16).toString('hex');\n\napp.use(session({\n    secret: secretKey,\n    resave: false,\n    saveUninitialized: false,\n    cookie: { secure: false }\n}));\n\nexport const clients = new Map<number, string>();\n\nio.on('connection', socket => {\n    socket.on('register_client', async (userId: number) => {\n        clients.set(userId, socket.id);\n        socket.join(`userId-${userId}`);\n\n        // MONGO BACKUP: let chat = await Chat.findOne({ userId });\n        // MONGO BACKUP: if (chat) {\n        // MONGO BACKUP:     chat.lastReadByUser = new Date();\n        // MONGO BACKUP:     chat.unreadAdminCount = 0;\n        // MONGO BACKUP:     await chat.save();\n        // MONGO BACKUP: \n        // MONGO BACKUP:     socket.emit('chat_history', chat.messages);\n        // MONGO BACKUP: \n        // MONGO BACKUP:     const unreadCount = chat.messages.filter(\n        // MONGO BACKUP:         m => m.timestamp > (chat.lastReadByUser || new Date(0)) && m.sender === 0\n        // MONGO BACKUP:     ).length;\n        // MONGO BACKUP:     socket.emit('unread_count', unreadCount);\n        // MONGO BACKUP: } else {\n        // MONGO BACKUP:     socket.emit('chat_history', []);\n        // MONGO BACKUP:     socket.emit('unread_count', 0);\n        // MONGO BACKUP: }\n\n        let chat = await chatRepository.findByUserId(userId);\n        if (chat) {\n            await chatRepository.markAsReadByUser(chat.id);\n            \n            socket.emit('chat_history', chat.messages);\n            \n            const unreadCount = chat.messages.filter(\n                m => m.timestamp > (chat.lastReadByUser || new Date(0)) && m.sender === 0\n            ).length;\n            socket.emit('unread_count', unreadCount);\n        } else {\n            socket.emit('chat_history', []);\n            socket.emit('unread_count', 0);\n        }\n    });\n\n    socket.on('register_admin', async () => {\n        socket.join('admin');\n        // MONGO BACKUP: const allChats = await Chat.find({});\n        // MONGO BACKUP: const chatMap: Record<number, IMessage[]> = {};\n        // MONGO BACKUP: const unreadCounts: Record<number, number> = {};\n        // MONGO BACKUP: \n        // MONGO BACKUP: allChats.forEach(chat => {\n        // MONGO BACKUP:     chatMap[chat.userId] = chat.messages;\n        // MONGO BACKUP:     unreadCounts[chat.userId] = chat.unreadAdminCount;\n        // MONGO BACKUP: });\n        // MONGO BACKUP: \n        // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n        // MONGO BACKUP: \n        // MONGO BACKUP: socket.emit('chat_history', chatMap);\n        // MONGO BACKUP: socket.emit('orders_history', orders);\n        // MONGO BACKUP: socket.emit('unread_counts', unreadCounts);\n\n        const allChats = await chatRepository.findAll();\n        const chatMap: Record<number, any[]> = {};\n        const unreadCounts: Record<number, number> = {};\n        \n        allChats.forEach(chat => {\n            chatMap[chat.userId] = chat.messages;\n            unreadCounts[chat.userId] = chat.unreadAdminCount;\n        });\n        \n        const orders = await orderRepository.findAll();\n        \n        socket.emit('chat_history', chatMap);\n        socket.emit('orders_history', orders);\n        socket.emit('unread_counts', unreadCounts);\n    });\n\n    socket.on('admin_select_chat', async (userId: number) => {\n        // MONGO BACKUP: const chat = await Chat.findOne({ userId });\n        // MONGO BACKUP: if (chat) {\n        // MONGO BACKUP:     chat.lastReadByAdmin = new Date();\n        // MONGO BACKUP:     chat.unreadAdminCount = 0;\n        // MONGO BACKUP:     await chat.save();\n        // MONGO BACKUP: \n        // MONGO BACKUP:     socket.emit('chat_history', chat.messages);\n        // MONGO BACKUP:     socket.emit('unread_count', 0);\n        // MONGO BACKUP: \n        // MONGO BACKUP:     io.to('admin').emit('update_unread_count', { userId, unreadAdmin: 0 });\n        // MONGO BACKUP: }\n\n        const chat = await chatRepository.findByUserId(userId);\n        if (chat) {\n            await chatRepository.markAsReadByAdmin(chat.id);\n            \n            socket.emit('chat_history', chat.messages);\n            socket.emit('unread_count', 0);\n            \n            io.to('admin').emit('update_unread_count', { userId, unreadAdmin: 0 });\n        }\n    });\n\n    socket.on('send_message', async ({ sender, userId, content }) => {\n        // MONGO BACKUP: const message: IMessage = { sender, content, timestamp: new Date(), isSystemMessage: false };\n        // MONGO BACKUP: \n        // MONGO BACKUP: let chat = await Chat.findOne({ userId });\n        // MONGO BACKUP: if (!chat) {\n        // MONGO BACKUP:     chat = new Chat({\n        // MONGO BACKUP:         userId,\n        // MONGO BACKUP:         messages: [message],\n        // MONGO BACKUP:         lastReadByUser: new Date(),\n        // MONGO BACKUP:         lastReadByAdmin: new Date(0),\n        // MONGO BACKUP:         unreadAdminCount: sender !== 0 ? 1 : 0,\n        // MONGO BACKUP:     });\n        // MONGO BACKUP: } else {\n        // MONGO BACKUP:     chat.messages.push(message);\n        // MONGO BACKUP:     if (sender !== 0) chat.unreadAdminCount = (chat.unreadAdminCount || 0) + 1;\n        // MONGO BACKUP: }\n        // MONGO BACKUP: await chat.save();\n        // MONGO BACKUP: \n        // MONGO BACKUP: io.to('admin').emit('new_message', { ...message, userId, unreadAdmin: chat.unreadAdminCount });\n\n        let chat = await chatRepository.findOrCreate(userId);\n        \n        const message = await chatRepository.addMessage(chat.id, {\n            sender,\n            content,\n            timestamp: new Date(),\n            isSystemMessage: false,\n        });\n        \n        if (sender !== 0) {\n            await chatRepository.incrementUnreadAdminCount(chat.id);\n            chat = await chatRepository.findById(chat.id);\n        }\n        \n        io.to('admin').emit('new_message', { ...message, userId, unreadAdmin: chat.unreadAdminCount });\n    });\n\n    socket.on('admin_reply', async ({ userId, content }) => {\n        // MONGO BACKUP: const message: IMessage = { sender: 0, content, timestamp: new Date(), isSystemMessage: false };\n        // MONGO BACKUP: const chat = await Chat.findOne({ userId });\n        // MONGO BACKUP: if (chat) {\n        // MONGO BACKUP:     chat.messages.push(message);\n        // MONGO BACKUP:     await chat.save();\n        // MONGO BACKUP: \n        // MONGO BACKUP:     const clientSocketId = clients.get(userId);\n        // MONGO BACKUP:     if (clientSocketId) io.to(clientSocketId).emit('new_message', { ...message });\n        // MONGO BACKUP: \n        // MONGO BACKUP:     const botToken = process.env.BOT_TOKEN;\n        // MONGO BACKUP:     const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n        // MONGO BACKUP: \n        // MONGO BACKUP:     await axios.post(url, {\n        // MONGO BACKUP:         chat_id: userId,\n        // MONGO BACKUP:         text: `–í —á–∞—Ç–µ –ø–æ—è–≤–∏–ª–æ—Å—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.`,\n        // MONGO BACKUP:         reply_markup: {\n        // MONGO BACKUP:             inline_keyboard: [[\n        // MONGO BACKUP:                 {\n        // MONGO BACKUP:                     text: \"üí¨ –ß–∞—Ç\",\n        // MONGO BACKUP:                     web_app: {\n        // MONGO BACKUP:                         url: process.env.CLIENT_URL + \"/chat\"\n        // MONGO BACKUP:                     }\n        // MONGO BACKUP:                 }\n        // MONGO BACKUP:             ]]\n        // MONGO BACKUP:         }\n        // MONGO BACKUP:     });\n        // MONGO BACKUP: }\n\n        const chat = await chatRepository.findByUserId(userId);\n        if (chat) {\n            const message = await chatRepository.addMessage(chat.id, {\n                sender: 0,\n                content,\n                timestamp: new Date(),\n                isSystemMessage: false,\n            });\n            \n            const clientSocketId = clients.get(userId);\n            if (clientSocketId) io.to(clientSocketId).emit('new_message', { ...message });\n            \n            const botToken = process.env.BOT_TOKEN;\n            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n            \n            await axios.post(url, {\n                chat_id: userId,\n                text: `–í —á–∞—Ç–µ –ø–æ—è–≤–∏–ª–æ—Å—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.`,\n                reply_markup: {\n                    inline_keyboard: [[\n                        {\n                            text: \"üí¨ –ß–∞—Ç\",\n                            web_app: {\n                                url: process.env.CLIENT_URL + \"/chat\"\n                            }\n                        }\n                    ]]\n                }\n            });\n        }\n    });\n\n    socket.on('admin_order_status_changed', async (data: { orderId: string }) => {\n        // MONGO BACKUP: if (!data.orderId) return;\n        // MONGO BACKUP: \n        // MONGO BACKUP: const id = Number(data.orderId);\n        // MONGO BACKUP: if (isNaN(id)) return;\n        // MONGO BACKUP: \n        // MONGO BACKUP: const order = await Order.findOne({ _id: id });\n        // MONGO BACKUP: if (!order) return;\n        // MONGO BACKUP: \n        // MONGO BACKUP: const offer = await Offer.findOne({ _id: order.offerId });\n        // MONGO BACKUP: const game = await Game.findOne({ _id: offer?.gameId });\n        // MONGO BACKUP: const payment = await Payment.findOne({ orderId: order._id });\n        // MONGO BACKUP: \n        // MONGO BACKUP: const orderMsg = `üì¶ *Order status changed*\\nüÜî Order ID: ${order._id}\\nüéÆ Game: ${game?.title}\\nüéÆ Offer: ${offer?.title}\\nüí∞ Amount: ${payment?.amountToPay} ${order.currency}\\nüìå Status: ${order.status.toUpperCase()}\\nüïí Created: ${new Date(order.createdAt).toLocaleString()}\\nüïí Modified: ${new Date(order.updatedAt).toLocaleString()}\\n`;\n        // MONGO BACKUP: \n        // MONGO BACKUP: const message: IMessage = { sender: -1, content: orderMsg, timestamp: new Date(), isSystemMessage: true };\n        // MONGO BACKUP: const message2: IMessage = { sender: -1, content: \"Please leave a review for order ‚Ññ\" + order._id, timestamp: new Date(), isSystemMessage: true };\n        // MONGO BACKUP: \n        // MONGO BACKUP: let chat = await Chat.findOne({ userId: order.userId });\n        // MONGO BACKUP: if (!chat) {\n        // MONGO BACKUP:     chat = new Chat({\n        // MONGO BACKUP:         userId: order.userId,\n        // MONGO BACKUP:         messages: [message],\n        // MONGO BACKUP:         lastReadByUser: new Date(),\n        // MONGO BACKUP:         lastReadByAdmin: new Date(0),\n        // MONGO BACKUP:         unreadAdminCount: 0,\n        // MONGO BACKUP:     });\n        // MONGO BACKUP: } else {\n        // MONGO BACKUP:     chat.messages.push(message);\n        // MONGO BACKUP:     chat.messages.push(message2);\n        // MONGO BACKUP: }\n        // MONGO BACKUP: await chat.save();\n        // MONGO BACKUP: \n        // MONGO BACKUP: const clientSocketId = clients.get(order.userId);\n        // MONGO BACKUP: if (clientSocketId) {\n        // MONGO BACKUP:     io.to(clientSocketId).emit('new_message', { sender: -1, content: orderMsg });\n        // MONGO BACKUP:     if (order.status === 'completed') io.to(clientSocketId).emit('new_message', { sender: -1, content: \"Please leave a review for order ‚Ññ\" + order._id });\n        // MONGO BACKUP: }\n        // MONGO BACKUP: \n        // MONGO BACKUP: if (order.status === 'completed') {\n        // MONGO BACKUP:     const userId = order.userId;\n        // MONGO BACKUP:     const referId = await Referral.findOne({ userId });\n        // MONGO BACKUP:     const refer = await User.findOne({ _id: referId });\n        // MONGO BACKUP: \n        // MONGO BACKUP:     if (referId && refer && payment) {\n        // MONGO BACKUP:         const amountForRefer = (payment.amountToPay / 100) * refer.referralPercent;\n        // MONGO BACKUP: \n        // MONGO BACKUP:         const botToken = process.env.BOT_TOKEN;\n        // MONGO BACKUP:         const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n        // MONGO BACKUP: \n        // MONGO BACKUP:         await axios.post(url, {\n        // MONGO BACKUP:             chat_id: referId,\n        // MONGO BACKUP:             text: `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${amountForRefer + \" \" + payment.currency} –∑–∞ –∑–∞–∫–∞–∑, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –≤–∞—à–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º ${userId}.`,\n        // MONGO BACKUP:         });\n        // MONGO BACKUP:     }\n        // MONGO BACKUP: }\n        // MONGO BACKUP: \n        // MONGO BACKUP: if (order.status === 'canceled') {\n        // MONGO BACKUP:     const userId = order.userId;\n        // MONGO BACKUP: \n        // MONGO BACKUP:     const botToken = process.env.BOT_TOKEN;\n        // MONGO BACKUP:     const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n        // MONGO BACKUP: \n        // MONGO BACKUP:     await axios.post(url, {\n        // MONGO BACKUP:         chat_id: userId,\n        // MONGO BACKUP:         text: `–ó–∞–∫–∞–∑ ‚Ññ${order._id} –æ—Ç–º–µ–Ω—ë–Ω.`,\n        // MONGO BACKUP:     });\n        // MONGO BACKUP: }\n        // MONGO BACKUP: \n        // MONGO BACKUP: if (order.status === 'invalid') {\n        // MONGO BACKUP:     const userId = order.userId;\n        // MONGO BACKUP: \n        // MONGO BACKUP:     const botToken = process.env.BOT_TOKEN;\n        // MONGO BACKUP:     const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n        // MONGO BACKUP: \n        // MONGO BACKUP:     await axios.post(url, {\n        // MONGO BACKUP:         chat_id: userId,\n        // MONGO BACKUP:         text: `–í –∑–∞–∫–∞–∑–µ ‚Ññ${order._id} —É–∫–∞–∑–∞–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.`,\n        // MONGO BACKUP:         reply_markup: {\n        // MONGO BACKUP:             inline_keyboard: [[\n        // MONGO BACKUP:                 {\n        // MONGO BACKUP:                     text: \"üí¨ –ß–∞—Ç\",\n        // MONGO BACKUP:                     web_app: {\n        // MONGO BACKUP:                         url: process.env.CLIENT_URL + \"/chat\"\n        // MONGO BACKUP:                     }\n        // MONGO BACKUP:                 }\n        // MONGO BACKUP:             ]]\n        // MONGO BACKUP:         }\n        // MONGO BACKUP:     });\n        // MONGO BACKUP: }\n        // MONGO BACKUP: \n        // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n        // MONGO BACKUP: socket.emit('orders_history', orders);\n        // MONGO BACKUP: \n        // MONGO BACKUP: logger.info('New order notification sent via WebSocket', { context: { orderId: order._id } });\n\n        if (!data.orderId) return;\n        \n        const id = Number(data.orderId);\n        if (isNaN(id)) return;\n        \n        const order = await orderRepository.findById(id);\n        if (!order) return;\n        \n        const game = order.offer?.game;\n        const offer = order.offer;\n        const payment = order.payment;\n        \n        const orderMsg = `üì¶ *Order status changed*\\nüÜî Order ID: ${order.id}\\nüéÆ Game: ${game?.title}\\nüéÆ Offer: ${offer?.title}\\nüí∞ Amount: ${payment?.amountToPay} ${order.currency}\\nüìå Status: ${order.status.toUpperCase()}\\nüïí Created: ${new Date(order.createdAt).toLocaleString()}\\nüïí Modified: ${new Date(order.updatedAt).toLocaleString()}\\n`;\n        \n        const chat = await chatRepository.findOrCreate(order.userId);\n        \n        await chatRepository.addMessage(chat.id, {\n            sender: -1,\n            content: orderMsg,\n            timestamp: new Date(),\n            isSystemMessage: true,\n        });\n        \n        if (order.status === 'completed') {\n            await chatRepository.addMessage(chat.id, {\n                sender: -1,\n                content: \"Please leave a review for order ‚Ññ\" + order.id,\n                timestamp: new Date(),\n                isSystemMessage: true,\n            });\n        }\n        \n        const clientSocketId = clients.get(order.userId);\n        if (clientSocketId) {\n            io.to(clientSocketId).emit('new_message', { sender: -1, content: orderMsg });\n            if (order.status === 'completed') {\n                io.to(clientSocketId).emit('new_message', { sender: -1, content: \"Please leave a review for order ‚Ññ\" + order.id });\n            }\n        }\n        \n        if (order.status === 'completed') {\n            const userId = order.userId;\n            const referral = await referralRepository.findByUserId(userId);\n            const refer = referral ? await userRepository.findById(referral.referId) : null;\n            \n            if (refer && payment) {\n                const amountForRefer = (payment.amountToPay / 100) * refer.referralPercent;\n                \n                const botToken = process.env.BOT_TOKEN;\n                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n                \n                await axios.post(url, {\n                    chat_id: refer.id,\n                    text: `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${amountForRefer + \" \" + payment.currency} –∑–∞ –∑–∞–∫–∞–∑, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –≤–∞—à–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º ${userId}.`,\n                });\n            }\n        }\n        \n        if (order.status === 'canceled') {\n            const userId = order.userId;\n            \n            const botToken = process.env.BOT_TOKEN;\n            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n            \n            await axios.post(url, {\n                chat_id: userId,\n                text: `–ó–∞–∫–∞–∑ ‚Ññ${order.id} –æ—Ç–º–µ–Ω—ë–Ω.`,\n            });\n        }\n        \n        if (order.status === 'invalid') {\n            const userId = order.userId;\n            \n            const botToken = process.env.BOT_TOKEN;\n            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n            \n            await axios.post(url, {\n                chat_id: userId,\n                text: `–í –∑–∞–∫–∞–∑–µ ‚Ññ${order.id} —É–∫–∞–∑–∞–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.`,\n                reply_markup: {\n                    inline_keyboard: [[\n                        {\n                            text: \"üí¨ –ß–∞—Ç\",\n                            web_app: {\n                                url: process.env.CLIENT_URL + \"/chat\"\n                            }\n                        }\n                    ]]\n                }\n            });\n        }\n        \n        const orders = await orderRepository.findAll();\n        socket.emit('orders_history', orders);\n        \n        logger.info('New order notification sent via WebSocket', { context: { orderId: order.id } });\n    });\n\n    socket.on('disconnect', () => {\n        for (const [userId, id] of clients.entries()) {\n            if (id === socket.id) {\n                clients.delete(userId);\n                break;\n            }\n        }\n    });\n});\n\n// MONGO BACKUP: connectDB()\n// MONGO BACKUP:     .then(() => {\n// MONGO BACKUP:         // Listen on 0.0.0.0 to accept external traffic from Replit reverse proxy\n// MONGO BACKUP:         httpServer.listen(PORT as number, '0.0.0.0', () => {\n// MONGO BACKUP:             logger.info(`Server is running on port ${PORT} and accepting external connections`);\n// MONGO BACKUP:         });\n// MONGO BACKUP:     })\n// MONGO BACKUP:     .catch((error) => {\n// MONGO BACKUP:         logger.error('Failed to start server:', error);\n// MONGO BACKUP:         process.exit(1);\n// MONGO BACKUP:     });\n\n// Start server with Prisma connection\nconnectDatabase()\n    .then(() => {\n        // Listen on 0.0.0.0 to accept external traffic from Replit reverse proxy\n        httpServer.listen(PORT as number, '0.0.0.0', () => {\n            logger.info(`Server is running on port ${PORT} and accepting external connections`);\n        });\n    })\n    .catch((error) => {\n        logger.error('Failed to start server:', error);\n        process.exit(1);\n    });\n\napp.use('/api/games', gameRoutes);\napp.use('/api/offers', offerRoutes);\napp.use('/api/users', userRoutes);\napp.use('/api/orders', orderRoutes);\napp.use('/api/order-details', orderDetailsRoutes);\napp.use('/api/payments', paymentRoutes);\napp.use('/api/reviews', reviewRoutes);\napp.use('/api/withdrawals', withdrawalRoutes);\napp.use('/api/webhooks', webhookRoutes);\napp.use('/api/chats', chatRoutes);\napp.use('/api/transactions', transactionRoutes);\napp.use('/api/referrals', referralRoutes);\napp.use('/api/admin', adminRoutes);\n\nif (process.env.NODE_ENV === 'production') {\n    // –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å\n    app.use(express.static(path.join(__dirname, '../../client/dist')));\n    app.get('/', (req: Request, res: Response) => {\n        res.sendFile(path.join(__dirname, '../../client/dist/index.html'));\n    });\n\n    // –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n    app.use('/admin', express.static(path.join(__dirname, '../../admin/dist')));\n    app.get('/admin/*', (req: Request, res: Response) => {\n        res.sendFile(path.join(__dirname, '../../admin/dist/index.html'));\n    });\n}\n\napp.use((req: Request, res: Response) => {\n    res.status(404).json({ success: false, message: 'Route not found' });\n});\n\napp.use((err: Error, req: Request, res: Response) => {\n    logger.error(err.stack);\n    res.status(500).json({\n        success: false,\n        message: 'Internal Server Error',\n        error: process.env.NODE_ENV === 'development' ? err.message : undefined\n    });\n});\n","size_bytes":24321},"client/src/pages/Order.tsx":{"content":"import { useEffect } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useNavigate, useParams } from \"react-router-dom\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport {fetchOffer, fetchOffers} from \"../store/features/offersSlice.ts\";\nimport { useTranslation } from \"react-i18next\";\nimport { createCryptoPayment } from \"../store/features/paymentsSlice.ts\";\nimport {fetchGame} from \"../store/features/gamesSlice.ts\";\n\nconst Order = () => {\n  const { gameId, offerId } = useParams<{ gameId: string, offerId: string }>();\n  const dispatch = useDispatch<AppDispatch>();\n  const { t } = useTranslation();\n  const navigate = useNavigate();\n  const offers = useSelector((state: RootState) => state.offers);\n  const game = useSelector((state: RootState) => state.games.game);\n\n  useEffect(() => {\n    dispatch(fetchGame(Number(gameId)))\n    dispatch(fetchOffers({gameId: Number(gameId), isEnabled: true}))\n    dispatch(fetchOffer(Number(offerId)));\n  }, [dispatch, offerId]);\n\n  if (offers?.loading) return <p>Loading...</p>;\n  if (offers?.error) return <p>Error: {offers.error}</p>;\n  if (!offers?.offer) return <p>No offer data available</p>;\n\n  const handleOrder = async () => {\n    const paymentData = {\n      gameName: game?.title ?? \"Unknown Game\",\n      offerName: offers?.offer?.title ?? \"Unknown Offer\",\n      price: offers?.offer?.priceUSDT ?? 0,\n    };\n\n    const response = await dispatch(createCryptoPayment(paymentData));\n\n    if (createCryptoPayment.fulfilled.match(response)) {\n      window.open(response.payload.invoice.miniAppInvoiceUrl, \"_blank\");\n    } else {\n      console.error(\"Payment creation failed\", response);\n    }\n  };\n\n  const handleRubOrder = async () => {\n    const paymentData = {\n      gameName: game?.title ?? \"Unknown Game\",\n      offerName: offers?.offer?.title ?? \"Unknown Offer\",\n      price: offers?.offer?.priceRUB ?? 0,\n    };\n\n    const response = await dispatch(createCryptoPayment(paymentData));\n\n    if (createCryptoPayment.fulfilled.match(response)) {\n      window.open(response.payload.invoice.payUrl, \"_blank\");\n    } else {\n      console.error(\"Payment creation failed\", response);\n    }\n  };\n\n  return (\n    <div className=\"text-white flex flex-col gap-1 max-w-[28rem] w-full h-full overflow-hidden pt-2\">\n      <div className=\"flex flex-col w-full items-center justify-start px-2\">\n        <h1 className=\"text-lg max-[350px]:text-base font-bold pb-2 max-[350px]:pb-1\">{offers.offer.title}</h1>\n        <img className=\"w-fit max-h-[160px] object-contain rounded-[10px]\" src={offers.offer.imageUrl} alt={offers.offer.title} />\n      </div>\n      <div className=\"flex flex-col flex-1 gap-2.5 justify-start items-center px-2 h-[200px]\">\n        {/*<p>{t('order.text')}</p>*/}\n        <div className=\"flex flex-col pt-2 max-[350px]:pt-1 gap-2 max-[350px]:gap-1.5 w-full\">\n          <div className=\"flex flex-row gap-2 max-[350px]:gap-1.5 w-full\">\n            <button onClick={handleOrder} className=\"flex flex-row w-[50%] gap-2 justify-between px-4 py-2 max-[350px]:py-1.5 rounded-lg bg-[#1A1B1E] border  border-[#27282C] cursor-pointer\">\n              <div className=\"flex flex-row gap-2\">\n                <img src=\"/USDT.png\" alt=\"usd\" className=\"w-[20px] max-[350px]:w-[18px] object-contain rounded-[10px] text-[#8F96A3]\" />\n                <span className=\"max-[350px]:text-sm\">{offers.offer.priceUSDT}</span>\n              </div>\n              <span className=\"max-[350px]:text-sm\">USDT</span>\n            </button>\n            {<button onClick={handleRubOrder} className=\"flex flex-row w-[50%] gap-2 justify-between px-4 py-2 max-[350px]:py-1.5 rounded-lg bg-[#1A1B1E] border  border-[#27282C] cursor-pointer\">\n              <div className=\"flex flex-row gap-2\">\n                <img src=\"/RUB.png\" alt=\"usd\" className=\"w-[20px] max-[350px]:w-[18px] object-contain rounded-[10px] text-[#8F96A3]\" />\n                <span className=\"max-[350px]:text-sm\">{offers.offer.priceRUB}</span>\n              </div>\n              <span className=\"max-[350px]:text-sm\">RUB</span>\n            </button>}\n          </div>\n          <div className=\"flex flex-row gap-2 justify-center px-4 py-2 max-[350px]:py-1.5 rounded-lg bg-[#1A1B1E] border  border-[#27282C] cursor-pointer\">\n            <button className=\"cursor-pointer max-[350px]:text-sm\" onClick={() => navigate(`/offers/${offers.offer?.gameId}`)}>{t('order.cancel')}</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\nexport default Order\n","size_bytes":4501},"server/src/controllers/offerController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import GameOffer from '../models/Offer';\nimport { logger } from '../config/logger';\nimport { prisma } from '../db/client';\nimport { offerRepository } from '../db';\n\n// -> User\n\n// Get game offers by game ID\nexport const getOffersByGameId = async (req: Request, res: Response): Promise<void> => {\n  try {\n    const { gameId } = req.params;\n    const { isEnabled } = req.query;\n\n    logger.info('Fetching game offers by game ID', { context: { gameId, isEnabled } });\n\n    // MONGO BACKUP: const filter: any = { gameId: gameId };\n    // MONGO BACKUP: if (isEnabled !== undefined) {\n    // MONGO BACKUP:   filter.isEnabled = isEnabled === 'true';\n    // MONGO BACKUP: }\n    // MONGO BACKUP: const gameOffers = await GameOffer.find(filter).sort({ price: 1 });\n\n    const where: any = { gameId: parseInt(gameId) };\n    if (isEnabled !== undefined) {\n      where.isEnabled = isEnabled === 'true';\n    }\n\n    const gameOffers = await prisma.offer.findMany({\n      where,\n      orderBy: { priceRUB: 'asc' },\n      include: { game: true }\n    });\n\n    logger.info('Game offers fetched successfully by game ID', {\n      context: { gameId, count: gameOffers.length },\n    });\n    res.status(200).json(gameOffers);\n  } catch (error) {\n    logger.error(`Error fetching game offers for game ID ${req.params.gameId}`, { context: { error } });\n    res.status(500).json({ message: 'Failed to fetch game offers', error });\n  }\n};\n\n// Get a game offer by ID\nexport const getOfferById = async (req: Request, res: Response): Promise<void> => {\n  try {\n    const { id } = req.params;\n    logger.info('Fetching game offer by ID', { context: { offerId: id } });\n\n    // MONGO BACKUP: const gameOffer = await GameOffer.findById(id);\n    const gameOffer = await offerRepository.findById(parseInt(id));\n\n    if (!gameOffer) {\n      logger.warn('Game offer not found', { context: { offerId: id } });\n      res.status(404).json({ message: 'Game offer not found' });\n      return;\n    }\n\n    logger.info('Game offer fetched successfully', { context: { offerId: gameOffer.id } });\n    res.status(200).json(gameOffer);\n  } catch (error) {\n    logger.error(`Error fetching game offer with ID ${req.params.id}`, { context: { error } });\n    res.status(500).json({ message: 'Failed to fetch game offer', error });\n  }\n};\n\n// -> Admin\n\n// Create a new game offer\nexport const createOffer = async (req: Request, res: Response): Promise<void> => {\n  try {\n    logger.info('Creating a new game offer', { context: { body: req.body } });\n    const { _id, gameId, title, imageUrl, priceRUB, priceUSDT, isEnabled } = req.body;\n\n    if (!gameId || !title || !imageUrl || !priceRUB || !priceUSDT) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      res.status(400).json({ message: 'Invalid request body' });\n      return;\n    }\n\n    // MONGO BACKUP: const existingGameOffer = await GameOffer.findOne({ gameId, title });\n    const existingGameOffer = await prisma.offer.findFirst({\n      where: {\n        gameId: parseInt(gameId),\n        title\n      }\n    });\n\n    if (existingGameOffer) {\n      logger.warn('Game offer already exists', { context: { gameId, title } });\n      res.status(400).json({ message: 'Game offer already exists' });\n      return;\n    }\n\n    if (priceRUB < 0 || priceUSDT < 0) {\n      logger.warn('Invalid price', { context: { priceRUB, priceUSDT } });\n      res.status(400).json({ message: 'Invalid price' });\n      return;\n    }\n\n    if (typeof priceUSDT !== 'number' || typeof priceRUB !== 'number') {\n      logger.warn('Invalid price type', { context: { priceRUB, priceUSDT } });\n      res.status(400).json({ message: 'Invalid price type' });\n    }\n\n    // MONGO BACKUP: const gameOffer = new GameOffer({\n    // MONGO BACKUP:   _id,\n    // MONGO BACKUP:   gameId,\n    // MONGO BACKUP:   title,\n    // MONGO BACKUP:   imageUrl,\n    // MONGO BACKUP:   priceRUB,\n    // MONGO BACKUP:   priceUSDT,\n    // MONGO BACKUP:   isEnabled: isEnabled !== undefined ? isEnabled : true,\n    // MONGO BACKUP: });\n    // MONGO BACKUP: await gameOffer.save();\n\n    const gameOffer = await offerRepository.create({\n      game: { connect: { id: parseInt(gameId) } },\n      title,\n      imageUrl,\n      priceRUB,\n      priceUSDT,\n      isEnabled: isEnabled !== undefined ? isEnabled : true,\n    });\n\n    logger.info('Game offer created successfully', { context: { offerId: gameOffer.id } });\n    res.status(201).json(gameOffer);\n  } catch (error) {\n    logger.error('Error creating game offer', { context: { error } });\n    res.status(400).json({ message: 'Failed to create game offer', error });\n  }\n};\n\n// Update a game offer\nexport const updateOffer = async (req: Request, res: Response): Promise<void> => {\n  try {\n    const { id } = req.params;\n    logger.info('Updating game offer', { context: { offerId: id, body: req.body } });\n\n    // MONGO BACKUP: const gameOffer = await GameOffer.findByIdAndUpdate(id, req.body, { new: true, runValidators: true });\n    const gameOffer = await offerRepository.update(parseInt(id), req.body);\n\n    if (!gameOffer) {\n      logger.warn('Game offer not found for update', { context: { offerId: id } });\n      res.status(404).json({ message: 'Game offer not found' });\n      return;\n    }\n\n    logger.info('Game offer updated successfully', { context: { offerId: gameOffer.id } });\n    res.status(200).json(gameOffer);\n  } catch (error) {\n    logger.error(`Error updating game offer with ID ${req.params.id}`, { context: { error } });\n    res.status(400).json({ message: 'Failed to update game offer', error });\n  }\n};\n\n// Delete a game offer\nexport const deleteOffer = async (req: Request, res: Response): Promise<void> => {\n  try {\n    const { id } = req.params;\n    logger.info('Deleting game offer', { context: { offerId: id } });\n\n    // MONGO BACKUP: const gameOffer = await GameOffer.findByIdAndDelete(id);\n    const gameOffer = await offerRepository.delete(parseInt(id));\n\n    if (!gameOffer) {\n      logger.warn('Game offer not found for deletion', { context: { offerId: id } });\n      res.status(404).json({ message: 'Game offer not found' });\n      return;\n    }\n\n    logger.info('Game offer deleted successfully', { context: { offerId: gameOffer.id } });\n    res.status(200).json({ message: 'Game offer deleted successfully' });\n  } catch (error) {\n    logger.error(`Error deleting game offer with ID ${req.params.id}`, { context: { error } });\n    res.status(500).json({ message: 'Failed to delete game offer', error });\n  }\n};\n","size_bytes":6535},"client/src/components/OrientationWarning.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport {useTranslation} from \"react-i18next\";\n\nconst OrientationWarning = () => {\n    const [isLandscape, setIsLandscape] = useState(false);\n\n    const { t } = useTranslation();\n\n    const checkOrientation = () => {\n        setIsLandscape(window.innerWidth > window.innerHeight);\n    };\n\n    useEffect(() => {\n        checkOrientation();\n        window.addEventListener(\"resize\", checkOrientation);\n        window.addEventListener(\"orientationchange\", checkOrientation);\n        return () => {\n            window.removeEventListener(\"resize\", checkOrientation);\n            window.removeEventListener(\"orientationchange\", checkOrientation);\n        };\n    }, []);\n\n    if (!isLandscape) return null;\n\n    return (\n        <div style={{\n            position: \"fixed\",\n            top: 0,\n            left: 0,\n            width: \"100vw\",\n            height: \"100vh\",\n            backgroundColor: \"#000\",\n            color: \"#fff\",\n            display: \"flex\",\n            justifyContent: \"center\",\n            alignItems: \"center\",\n            zIndex: 9999,\n            fontSize: \"20px\",\n            textAlign: \"center\"\n        }}>\n            {t('orientationWarning.text')}\n        </div>\n    );\n};\n\nexport default OrientationWarning;\n","size_bytes":1279},"server/src/models/Order.ts":{"content":"// MONGO BACKUP: import { getMaxOrderId } from '../helpers/index';\n// MONGO BACKUP: import mongoose, { Schema } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IOrder {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   paymentId: number;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   offerId: number;\n// MONGO BACKUP:   orderDetailsId: number | null;\n// MONGO BACKUP:   status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid';\n// MONGO BACKUP:   currency: 'USDT' | 'RUB';\n// MONGO BACKUP:   createdAt: Date;\n// MONGO BACKUP:   updatedAt: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const OrderSchema: Schema = new Schema({\n// MONGO BACKUP:   _id: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: false,\n// MONGO BACKUP:   },\n// MONGO BACKUP:   paymentId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true\n// MONGO BACKUP:   },\n// MONGO BACKUP:   userId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     ref: 'User'\n// MONGO BACKUP:   },\n// MONGO BACKUP:   offerId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     ref: 'Offer'\n// MONGO BACKUP:   },\n// MONGO BACKUP:   orderDetailsId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: false,\n// MONGO BACKUP:     ref: 'OrderDetails'\n// MONGO BACKUP:   },\n// MONGO BACKUP:   status: {\n// MONGO BACKUP:     type: String,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     enum: ['pending', 'process', 'completed', 'canceled', 'invalid'],\n// MONGO BACKUP:     default: 'pending'\n// MONGO BACKUP:   },\n// MONGO BACKUP:   currency: {\n// MONGO BACKUP:     type: String,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     enum: ['USDT', 'RUB']\n// MONGO BACKUP:   }\n// MONGO BACKUP: }, {\n// MONGO BACKUP:   timestamps: true,\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Pre-save hook to set _id automatically\n// MONGO BACKUP: OrderSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxOrderId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Indexes\n// MONGO BACKUP: OrderSchema.index({ userId: 1 });\n// MONGO BACKUP: OrderSchema.index({ status: 1 });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IOrder>('Order', OrderSchema);\n","size_bytes":2524},"bot/src/main.ts":{"content":"import 'dotenv/config';\nimport { Telegraf, Markup } from 'telegraf';\nimport { InlineQueryResultArticle } from 'telegraf/typings/core/types/typegram';\nimport { handleStart, showMainMenu } from './handlers/start.handler';\nimport { handleCallbackQuery } from './handlers/callback.handler';\nimport { localization, SUPPORT_URL, PLACEHOLDER_IMAGE_URL, DEFAULT_GOOGLE_PLAY_URL, DEFAULT_APP_STORE_URL, WEB_APP_URL, BOT_URL } from './config/localization';\nimport { NotificationService } from './utils/notifications';\n\n// üîß –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ middleware\nimport { configService } from './config/config.service';\nimport { errorHandler } from './utils/errorHandler';\nimport { rateLimitMiddleware } from './middleware/rateLimiter';\nimport { userMiddleware } from './middleware/userMiddleware';\nimport { loggingMiddleware, loggerMiddleware } from './middleware/logger';\nimport {userService} from \"./services/user.service\";\nimport {gameService} from \"./services/game.service\";\n\n// üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\ntry {\n  configService.validateForProduction();\n  errorHandler.logInfo('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');\n} catch (error) {\n  console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);\n  process.exit(1);\n}\n\nexport const bot = new Telegraf(configService.get<string>('bot.token'));\nconst notificationService = new NotificationService(bot);\n\n// üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º NotificationService –≤ ErrorHandler\nerrorHandler.setNotificationService(notificationService);\n\n// üõ°Ô∏è –ü–æ–¥–∫–ª—é—á–∞–µ–º middleware\nbot.use(loggingMiddleware); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–≤—ã–º\nbot.use(userMiddleware);\nbot.use(rateLimitMiddleware); // Rate limiting –≤—Ç–æ—Ä—ã–º\n\n// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start\nbot.start((ctx) => handleStart(ctx, notificationService));\n\n// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤\nbot.on('callback_query', handleCallbackQuery);\n\n// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–∞–Ω–¥ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)\nbot.on('text', async (ctx) => {\n  try {\n    if (!ctx.from || !ctx.message || !('text' in ctx.message)) return;\n    \n    const userId = ctx.from.id.toString();\n    const messageText = ctx.message.text;\n    \n    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    const user = await userService.getUserById(Number(userId));\n    const language = user?.language || 'ru';\n    const l = localization(language);\n    \n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n    if (messageText === l.buttons.menu) {\n      await showMainMenu(ctx, false);\n      return;\n    }\n    \n    if (messageText === l.buttons.support) {\n      const keyboard = {\n        inline_keyboard: [\n          [{ text: l.buttons.supportChat, url: configService.get<string>('channels.supportUrl') }],\n          [{ text: l.buttons.back, callback_data: 'back_to_menu' }]\n        ]\n      };\n      \n      await ctx.replyWithHTML(l.pages.support, {\n        reply_markup: keyboard\n      });\n      return;\n    }\n\n    ctx.reply(l.buttons.reply, Markup.inlineKeyboard([\n      Markup.button.webApp(l.buttons.supportChat, 'https://mobile-games.online/chat')\n    ]));\n    \n  } catch (error) {\n    await errorHandler.handleBotError(\n      error instanceof Error ? error : new Error(String(error)),\n      ctx,\n      'text_handler'\n    );\n  }\n});\n\n// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline-–∑–∞–ø—Ä–æ—Å–æ–≤\nbot.on('inline_query', async (ctx) => {\n  try {\n    if (!ctx.from || !ctx.inlineQuery) return;\n\n    const userId = ctx.from.id.toString();\n    const user = await userService.getUserById(Number(userId));\n    const language = user?.language || 'ru';\n    const l = localization(language);\n    const input = ctx.inlineQuery.query || ''; // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞\n    const offset = parseInt(ctx.inlineQuery.offset, 10) || 0;\n\n    console.log(`üìù Inline query: \"${input}\" from user ${userId}`);\n\n    // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–≥—Ä—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    const allGames = await gameService.getEnabledGames(); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–≥—Ä—ã\n    console.log(`üéÆ Total games: ${allGames.length}`);\n\n    // 2. –§–∏–ª—å—Ç—Ä—É–µ–º –∏–≥—Ä—ã –ø–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É\n    const filteredGames = allGames.filter((game) =>\n      game.title.toLowerCase().includes(input.toLowerCase()),\n    );\n    console.log(`üîç Filtered games: ${filteredGames.length}`);\n\n    // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é\n    const nextResults = filteredGames.slice(offset, offset + 50);\n\n    // 4. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Telegram\n    const inlineResults: InlineQueryResultArticle[] = nextResults.map((game) => {\n      // –ò—Å–ø–æ–ª—å–∑—É–µ–º GIF –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É\n      const mediaUrl = game.gifUrl || game.imageUrl || PLACEHOLDER_IMAGE_URL;\n      \n      return {\n        type: 'article' as const,\n        id: game._id.toString(),\n        title: game.title,\n        thumb_url: game.imageUrl || PLACEHOLDER_IMAGE_URL,\n        thumb_width: 300,\n        thumb_height: 300,\n        input_message_content: {\n          message_text: `<b>${game.title}</b><a href='${mediaUrl}'>&#8203;</a>`,\n          parse_mode: 'HTML' as const,\n        },\n        reply_markup: {\n        inline_keyboard: [\n          [\n            {\n              text: l.inline.playMarket,\n              url: game.googlePlayUrl || DEFAULT_GOOGLE_PLAY_URL,\n            },\n            {\n              text: l.inline.appStore,\n              url: game.appStoreUrl || DEFAULT_APP_STORE_URL,\n            },\n          ],\n          [\n            { text: l.inline.store, url: 'https://t.me/TipTop999_bot/Games' },\n            { text: l.inline.bot, url: BOT_URL },\n          ],\n        ],\n        },\n      };\n    });\n\n    // 5. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π offset\n    const nextOffset =\n      offset + 50 < filteredGames.length ? String(offset + 50) : '';\n\n    // 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\n    await ctx.answerInlineQuery(inlineResults, {\n      next_offset: nextOffset,\n      button: {\n        text: l.buttons.goToBot,\n        start_parameter: 'inline_share'\n      },\n    });\n\n    console.log(`‚úÖ Sent ${inlineResults.length} inline results`);\n  } catch (error) {\n    await errorHandler.handleBotError(\n      error instanceof Error ? error : new Error(String(error)),\n      ctx,\n      'inline_query_handler'\n    );\n    await ctx.answerInlineQuery([]);\n  }\n});\n\n// üö® –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ErrorHandler\nbot.catch(async (err, ctx) => {\n  const error = err instanceof Error ? err : new Error(String(err));\n  await errorHandler.handleBotError(error, ctx, 'bot_catch');\n});\n\n// üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nerrorHandler.logInfo('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞...');\nerrorHandler.logInfo(`üîë –¢–æ–∫–µ–Ω: ${configService.get<string>('bot.token') ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}`);\nerrorHandler.logInfo(`üë§ Username: ${configService.get<string>('bot.username')}`);\nerrorHandler.logInfo(`üõ°Ô∏è Rate Limit: ${configService.get<number>('security.rateLimitMaxRequests')} –∑–∞–ø—Ä–æ—Å–æ–≤/${configService.get<number>('security.rateLimitWindowMs')/1000}—Å`);\nerrorHandler.logInfo(`üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: ${configService.get<string>('logging.level')} —É—Ä–æ–≤–µ–Ω—å`);\n\nbot.launch()\n  .then(async () => {\n    errorHandler.logInfo('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');\n    errorHandler.logInfo(`üì± Bot username: @${configService.get<string>('bot.username')}`);\n    errorHandler.logInfo('üéÆ –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:');\n    // errorHandler.logInfo(`   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${mockDatabaseService.getAllUsers().length}`);\n    const enabledGames = await gameService.getEnabledGames();\n    errorHandler.logInfo(`   üéØ –ò–≥—Ä: ${enabledGames.length}`);\n    errorHandler.logInfo('üîÑ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...');\n    \n    // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É middleware\n    await loggerMiddleware.logSystemEvent('bot_started', {\n      // usersCount: mockDatabaseService.getAllUsers().length,\n      gamesCount: enabledGames.length,\n      config: {\n        rateLimit: configService.get('security'),\n        logging: configService.get('logging'),\n      }\n    });\n  })\n  .catch(async (error) => {\n    errorHandler.logWarning('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);\n    \n    let errorDetails = '';\n    if (error.message.includes('404')) {\n      errorDetails = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BOT_TOKEN –≤ .env —Ñ–∞–π–ª–µ.\\nüí° –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ —É @BotFather –≤ Telegram.';\n    } else if (error.message.includes('401')) {\n      errorDetails = '‚ùå –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.';\n    } else if (error.message.includes('ENOTFOUND') || error.message.includes('ECONNREFUSED')) {\n      errorDetails = '‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Telegram API.';\n    }\n    \n    errorHandler.logWarning(errorDetails);\n    \n    // –õ–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –∑–∞–ø—É—Å–∫–∞\n    await loggerMiddleware.logSystemEvent('bot_startup_failed', {\n      error: error.message,\n      stack: error.stack,\n      details: errorDetails\n    }, 'error');\n    \n    process.exit(1);\n  });\n\n// üîÑ Graceful shutdown –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è ErrorHandler –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ—Ç–∞\nprocess.once('SIGINT', async () => {\n  errorHandler.logInfo('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...');\n  await loggerMiddleware.logSystemEvent('bot_shutdown', { signal: 'SIGINT' });\n  bot.stop('SIGINT');\n});\n\nprocess.once('SIGTERM', async () => {\n  errorHandler.logInfo('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...');\n  await loggerMiddleware.logSystemEvent('bot_shutdown', { signal: 'SIGTERM' });\n  bot.stop('SIGTERM');\n});","size_bytes":10255},"replit.md":{"content":"# Tip-Top Gaming Platform\n\n## Overview\n\nTip-Top is a multi-component gaming marketplace platform built for Telegram, enabling users to browse games, purchase in-game offers, and interact with support through an integrated chat system. The platform consists of four main components:\n\n1. **Client** - React-based Telegram Web App for end users\n2. **Bot** - Telegraf-powered Telegram bot for user interaction\n3. **Server** - Express.js backend API with Socket.IO for real-time features\n4. **Admin** - React-based admin panel for managing games, offers, and orders\n\nThe platform supports multiple languages (Russian/English), cryptocurrency payments (USDT), and includes a referral system with rewards.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Multi-Component Architecture\n\nThe application uses a monorepo structure with four distinct services that run concurrently:\n\n- **Root Launcher** (`index.js`) - Orchestrates all four components, validates environment variables, and manages process lifecycle\n- **Component Isolation** - Each service maintains its own dependencies, build process, and runtime configuration\n- **Shared Environment** - Services communicate via environment variables and shared MongoDB database\n\n### Frontend Architecture\n\n**Client Application (Telegram Web App)**\n- **Framework**: React 19 + TypeScript + Vite\n- **State Management**: Redux Toolkit for centralized application state\n- **Routing**: React Router v7 for navigation between pages\n- **Styling**: Tailwind CSS v4 with custom theme\n- **i18n**: react-i18next for Russian/English localization\n- **Real-time**: Socket.IO client for chat functionality\n- **Telegram Integration**: Telegram Web App SDK for native integration\n\n**Admin Panel**\n- **Framework**: React 19 + TypeScript + Vite\n- **State Management**: Redux Toolkit (separate store from client)\n- **Styling**: Tailwind CSS v4\n- **Authentication**: Token-based auth with protected routes\n- **Real-time**: Socket.IO for live order updates and chat management\n\n### Backend Architecture\n\n**Server (Express.js)**\n- **Framework**: Express.js with TypeScript\n- **Real-time Engine**: Socket.IO server for bidirectional communication\n- **Session Management**: express-session with in-memory store\n- **Request Handling**: Morgan for HTTP logging, Winston for application logging\n- **CORS**: Configured for multiple allowed origins (client, admin, bot)\n- **API Design**: RESTful routes organized by domain (games, offers, users, orders, etc.)\n\n**Bot (Telegraf)**\n- **Framework**: Telegraf v4 for Telegram Bot API\n- **Language**: TypeScript with ts-node-dev for development\n- **Architecture Patterns**:\n  - Service layer pattern (UserService, GameService, MessageService)\n  - Middleware pattern (rate limiting, user management, logging)\n  - Centralized configuration (ConfigService)\n  - Error handling (ErrorHandler with admin notifications)\n- **Features**: Inline keyboards, subscription checks, slideshow banners, referral tracking\n\n### Data Storage\n\n**MongoDB with Mongoose ODM**\n- **Database**: MongoDB Atlas (cloud-hosted)\n- **Models**: \n  - User (authentication, balance, referral data)\n  - Game (catalog items with metadata)\n  - Offer (purchasable items linked to games)\n  - Order (purchase records with status tracking)\n  - Payment (transaction records)\n  - Chat (support messages)\n  - Review, Withdrawal, Referral, Transaction models\n- **Schema Design**: Relational references between collections (e.g., Order ‚Üí Offer ‚Üí Game)\n\n### Authentication & Authorization\n\n**Multi-Layer Auth System**\n- **Client**: Telegram InitData validation via `@telegram-apps/init-data-node`\n- **Admin**: JWT token-based authentication with protected routes\n- **Bot**: Internal API token (`AUTH_BOT_TOKEN`) for bot-to-server communication\n- **Session Management**: Express sessions for maintaining user state\n\n### Real-Time Communication\n\n**Socket.IO Implementation**\n- **Namespaces**: Default namespace for all real-time features\n- **Events**:\n  - `register_client` / `register_admin` - User/admin connection\n  - `send_message` - Chat message exchange\n  - `chat_history` - Historical messages delivery\n  - `orders_history` - Live order updates\n  - `order_status_update` - Status change notifications\n- **Architecture**: Event-driven with separate handlers for client and admin connections\n\n### Payment Integration\n\n**Cryptocurrency Payments**\n- **Provider**: CryptoPay API (`@foile/crypto-pay-api`)\n- **Currency**: USDT (Tether)\n- **Flow**: \n  1. Client creates payment intent via server API\n  2. Server generates CryptoPay invoice\n  3. User redirected to payment page\n  4. Webhook confirms payment completion\n- **Alternative**: RUB (Russian Ruble) payments via separate integration\n\n### Internationalization (i18n)\n\n**Multi-Language Support**\n- **Libraries**: i18next + react-i18next\n- **Languages**: Russian (default), English\n- **Storage**: JSON locale files (`/client/src/locales/`)\n- **User Preference**: Stored in database, synced on login\n- **Coverage**: All user-facing strings in client and bot\n\n### Build & Deployment\n\n**Development Workflow**\n- **Concurrent Execution**: Root `package.json` uses custom launcher to run all services\n- **Hot Reload**: Each service uses its own dev server (Vite for frontends, ts-node-dev for backend/bot)\n- **Type Safety**: TypeScript across all components with strict mode enabled\n\n**Production Build**\n- **Build Script**: `bash build-all.sh` compiles all TypeScript projects\n- **Output**: Compiled JavaScript in respective `dist/` directories\n- **Start Command**: `node index.js` launches all services via production-ready process spawner\n\n**Replit-Specific Configuration**\n- **Port**: Uses Replit's `PORT` environment variable (default 5000)\n- **URL Detection**: Automatically constructs `CLIENT_URL` from `REPL_SLUG` and `REPL_OWNER`\n- **Secrets**: Sensitive data stored in Replit Secrets (not `.env` files)\n\n## External Dependencies\n\n### Third-Party Services\n\n**MongoDB Atlas**\n- **Purpose**: Primary database (NoSQL document store)\n- **Configuration**: Connection via `MONGODB_URI` environment variable\n- **Free Tier**: M0 cluster suitable for development and small-scale production\n\n**Telegram Bot API**\n- **Purpose**: Bot messaging, user authentication, Web App hosting\n- **Requirements**: \n  - `BOT_TOKEN` from @BotFather\n  - `BOT_USERNAME` for inline queries\n  - `ADMIN_ID` for error notifications\n- **Integration**: Telegraf library wraps API calls\n\n**CryptoPay (Crypto Payment Gateway)**\n- **Purpose**: USDT cryptocurrency payment processing\n- **Library**: `@foile/crypto-pay-api`\n- **Configuration**: API token in environment variables\n\n### Key NPM Packages\n\n**Backend**\n- `express` - HTTP server framework\n- `mongoose` - MongoDB ODM\n- `socket.io` - Real-time bidirectional communication\n- `telegraf` - Telegram Bot API wrapper\n- `jsonwebtoken` - JWT authentication\n- `bcryptjs` - Password hashing\n- `winston` - Application logging\n- `axios` - HTTP client for external APIs\n\n**Frontend (Client & Admin)**\n- `react` + `react-dom` - UI framework\n- `@reduxjs/toolkit` - State management\n- `react-router-dom` - Client-side routing\n- `socket.io-client` - Real-time client\n- `axios` - API requests\n- `tailwindcss` - Utility-first CSS framework\n- `lucide-react` - Icon library\n- `i18next` - Internationalization\n\n**Development**\n- `typescript` - Type safety\n- `vite` - Frontend build tool\n- `ts-node-dev` - TypeScript execution with hot reload\n- `eslint` - Code linting\n- `concurrently` / `npm-run-all` - Multi-process orchestration\n\n### Environment Variables\n\n**Required**\n- `BOT_TOKEN` - Telegram bot authentication token\n- `BOT_USERNAME` - Bot's @username\n- `ADMIN_ID` - Telegram ID of admin for notifications\n- `MONGODB_URI` - MongoDB connection string\n- `AUTH_BOT_TOKEN` - Internal API authentication\n\n**Optional/Auto-Generated**\n- `PORT` - Server port (defaults to 3000, Replit sets to 5000)\n- `CLIENT_URL` - Frontend URL (auto-constructed on Replit)\n- `CHANNEL_URL` - Telegram channel for subscription checks\n- `API_URL` - Backend API base URL\n\n### Deployment Platform\n\n**Replit Hosting**\n- **Advantages**: \n  - Zero-configuration deployment\n  - Built-in environment management (Secrets)\n  - Automatic HTTPS and domain provisioning\n  - Always-on hosting for web services\n- **Configuration**: `.replit` file defines run command and environment\n- **Limitations**: Single-region deployment, shared resources on free tier","size_bytes":8453},"server/src/routes/chatRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\n\nconst router = express.Router();\n\n// User routes\n// router.post('/', authenticateUser, createChat);\n// router.get('/:clientId', authenticateUser, getChat);\n// router.post('/:clientId/messages', authenticateUser, sendMessage);\n\n// Admin routes\n// router.get('/', authenticateUser, isAdmin, getAllChats)\n\nexport default router;","size_bytes":412},"server/src/models/Offer.ts":{"content":"// MONGO BACKUP: import { getMaxOfferId } from '../helpers';\n// MONGO BACKUP: import mongoose, { Schema } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IOffer {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   gameId: number;\n// MONGO BACKUP:   title: string;\n// MONGO BACKUP:   imageUrl: string;\n// MONGO BACKUP:   priceRUB: number;\n// MONGO BACKUP:   priceUSDT: number;\n// MONGO BACKUP:   isEnabled: boolean;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const OfferSchema: Schema = new Schema<IOffer>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     gameId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       ref: 'Game',\n// MONGO BACKUP:       index: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     title: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     imageUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     priceRUB: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       min: 0,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     priceUSDT: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       min: 0,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     isEnabled: {\n// MONGO BACKUP:       type: Boolean,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:       default: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true, // Automatically adds createdAt and updatedAt fields\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: OfferSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxOfferId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Indexes for efficient querying\n// MONGO BACKUP: OfferSchema.index({ game_id: 1, is_enabled: 1 });\n// MONGO BACKUP: OfferSchema.index({ title: 1, is_enabled: 1 });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IOffer>('Offer', OfferSchema);\n","size_bytes":2439},"server/src/routes/offerRoutes.ts":{"content":"import express from 'express';\n// import { authenticateUser } from '../middleware/auth';\nimport {\n  createOffer,\n  // createOffer,\n  getOfferById,\n  getOffersByGameId,\n  // updateOffer,\n  // deleteOffer,\n} from '../controllers/offerController';\nimport {authenticateUser} from \"../middleware/auth\";\nimport {isAdmin} from \"../middleware/admin\";\n\nconst router = express.Router();\n\n// User routes\nrouter.get('/game/:gameId', getOffersByGameId);\nrouter.get('/:id', getOfferById);\n\n// Admin-only routes\nrouter.post('/', authenticateUser, isAdmin, createOffer);\n// router.put('/:id', authenticateUser, isAdmin, updateOffer);\n// router.delete('/:id', authenticateUser, isAdmin, deleteOffer);\n\nexport default router;","size_bytes":707},"client/src/main.tsx":{"content":"import { StrictMode } from 'react'\nimport { createRoot } from 'react-dom/client'\nimport App from './App.tsx'\nimport { Provider } from 'react-redux'\nimport store from './store/store.ts'\nimport './styles.css'\nimport './i18n.ts'\n\ncreateRoot(document.getElementById('root')!).render(\n  <StrictMode>\n    <Provider store={store}>\n      <App />\n    </Provider>\n  </StrictMode>,\n)\n","size_bytes":373},"bot/src/config/localization.ts":{"content":"// ============================================================================\n// üåê –°–ò–°–¢–ï–ú–ê –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò TELEGRAM –ë–û–¢–ê\n// ============================================================================\n// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞–º–∏, –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\n// –¥–ª—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ–≥–æ Telegram –±–æ—Ç–∞ —Å –∏–≥—Ä–æ–≤—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º\n\n// ============================================================================\n// üì± –ú–ï–î–ò–ê-–†–ï–°–£–†–°–´\n// ============================================================================\n\n// üé¨ GIF –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞\nconst MEDIA_RESOURCES = {\n  gifs: {\n    welcome: 'https://media.giphy.com/media/3o7abKhOpu0NwenH3O/giphy.gif',\n    loading: 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif',\n    success: 'https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif',\n  },\n} as const;\n\n// üéØ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è GIF –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\nconst WELCOME_GIFS = {\n  ru: 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcHppdWQzb3MxbzNndjhlZTFiMHpwYnI3Z2l0dGp4czc4dGppZGJiYyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/NjCzN2GiZFlLjgHJO4/giphy.gif',\n  en: 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcHppdWQzb3MxbzNndjhlZTFiMHpwYnI3Z2l0dGp4czc4dGppZGJiYyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/NjCzN2GiZFlLjgHJO4/giphy.gif',\n} as const;\n\nconst SUBSCRIBE_REQUEST_GIF =\n  'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif';\nconst DEFAULT_GIF_URL =\n  'https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif';\nconst CABINET_GIF_URL =\n  'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif';\nconst PLACEHOLDER_IMAGE_URL =\n  'https://via.placeholder.com/800x400?text=Game+Not+Available';\n\n// ============================================================================\n// üîó URL-–ö–û–ù–°–¢–ê–ù–¢–´\n// ============================================================================\n\n// üì± –°—Å—ã–ª–∫–∏ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –∫–∞–Ω–∞–ª—ã\nconst URL_CONSTANTS = {\n  stores: {\n    googlePlay: 'https://play.google.com/store/apps/details?id=com.example.app',\n    appStore: 'https://apps.apple.com/app/id123456789',\n  },\n  social: {\n    telegramChannel: 'https://t.me/GameCatalogChannel',\n    supportBot: 'https://t.me/support_bot',\n  },\n  SUPPORT_URL: 'https://t.me/tiptop_support',\n  CATALOG_URL: 'https://t.me/mobile_games_tp',\n} as const;\n\n// üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ URL –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã\nexport const SUPPORT_URL = 'https://t.me/tiptop_support';\nexport const WEB_APP_URL = 'https://mobile-games.online/';\nexport const CHANNEL_URL = 'https://t.me/tiptop_mgn';\nexport const CATALOG_URL = 'https://t.me/mobile_games_tp';\nexport const BOT_URL = 'https://t.me/TipTop999_bot';\nexport const DEFAULT_GOOGLE_PLAY_URL = 'https://play.google.com';\nexport const DEFAULT_APP_STORE_URL = 'https://www.apple.com/app-store/';\n\n// –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–∑ —Å–µ–∫—Ü–∏–∏ –≤—ã—à–µ\n\n// ============================================================================\n// üéÆ –ò–ì–†–û–í–û–ô –ö–û–ù–¢–ï–ù–¢\n// ============================================================================\n\n// üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–≥—Ä —Å —ç–º–æ–¥–∑–∏\nconst GAME_CATEGORIES = {\n  ru: {\n    action: '‚öîÔ∏è –≠–∫—à–µ–Ω',\n    adventure: 'üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',\n    puzzle: 'üß© –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∏',\n    strategy: 'üè∞ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏',\n    racing: 'üèéÔ∏è –ì–æ–Ω–∫–∏',\n    sports: '‚öΩ –°–ø–æ—Ä—Ç',\n    simulation: 'üèóÔ∏è –°–∏–º—É–ª—è—Ç–æ—Ä—ã',\n    rpg: 'üêâ RPG',\n  },\n  en: {\n    action: '‚öîÔ∏è Action',\n    adventure: 'üó∫Ô∏è Adventure',\n    puzzle: 'üß© Puzzle',\n    strategy: 'üè∞ Strategy',\n    racing: 'üèéÔ∏è Racing',\n    sports: '‚öΩ Sports',\n    simulation: 'üèóÔ∏è Simulation',\n    rpg: 'üêâ RPG',\n  },\n} as const;\n\n// üéØ –ë–∞–Ω–Ω–µ—Ä—ã –∏–≥—Ä\nconst GAME_BANNERS = {\n  fallback: {\n    title: '–ò–≥—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞',\n    description: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',\n    image: 'https://via.placeholder.com/800x400?text=Game+Not+Available',\n  },\n} as const;\n\n// ============================================================================\n// üèóÔ∏è –ò–ù–¢–ï–†–§–ï–ô–° –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò\n// ============================================================================\n\nexport interface Localization {\n  // ============================================================================\n  // üéØ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –ò–ù–¢–ï–†–§–ï–ô–° (–ü–†–ò–û–†–ò–¢–ï–¢)\n  // ============================================================================\n\n  // üîò –ö–ù–û–ü–ö–ò –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø\n  buttons: {\n    // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n    store: string;\n    catalog: string;\n    news: string;\n    cabinet: string;\n    about: string;\n    support: string;\n    reviews: string;\n    share: string;\n    language: string;\n    back: string;\n    menu: string;\n\n    // –ü–æ–¥–ø–∏—Å–∫–∞\n    subscribeToChannel: string;\n    checkSubscription: string;\n    subscribe: string;\n\n    // –û–ø–µ—Ä–∞—Ü–∏–∏\n    orders: string;\n    refresh: string;\n    deposit: string;\n    withdraw: string;\n    chat: string;\n    referralProgram: string;\n    update: string;\n\n    // –ú–∞–≥–∞–∑–∏–Ω—ã\n    googlePlay: string;\n    appStore: string;\n\n    // –ú–µ–¥–∏–∞\n    trailer: string;\n\n    // –ù–∞–≤–∏–≥–∞—Ü–∏—è\n    ourBot: string;\n    prev: string;\n    next: string;\n    play: string;\n    stop: string;\n\n    reply: string;\n\n    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n    contactSupport: string;\n    supportChat: string;\n    goToBot: string;\n  };\n\n  // üòÄ –≠–ú–û–î–ó–ò –ò –ò–ö–û–ù–ö–ò\n  emojis: {\n    game: {\n      default: string;\n      controller: string;\n      mobile: string;\n    };\n    fire: string;\n  };\n\n  // üéÆ –û–°–ù–û–í–ù–´–ï –ò–ì–†–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´\n  core: {\n    discount: string;\n    tapToPlay: string;\n  };\n\n  // üí¨ –û–°–ù–û–í–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø\n  messages: {\n    welcome: string;\n    languageSelected: string;\n    echo: string;\n    echoResponse: string;\n  };\n\n  // üì¢ –ü–û–î–ü–ò–°–ö–ê –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø\n  subscription: {\n    request: string;\n    success: string;\n    failed: string;\n  };\n\n  notifications: {\n    purchase: string;\n    deposit: string;\n    supportReply: string;\n    newReferral: string;\n  };\n\n  // üìÑ –ö–û–ù–¢–ï–ù–¢–ù–´–ï –°–¢–†–ê–ù–ò–¶–´\n  pages: {\n    about: string;\n    support: string;\n    reviews: string;\n  };\n\n  // ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –û–®–ò–ë–ö–ò\n  errors: {\n    general: string;\n    userBlocked: string;\n    noGames: string;\n    startError: string;\n  };\n\n  // üîç INLINE –§–£–ù–ö–¶–ò–ò\n  inline: {\n    playMarket: string;\n    appStore: string;\n    store: string;\n    bot: string;\n  };\n\n  // üë§ –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢\n  cabinet: {\n    title: string;\n    user: string;\n    userInfo: string;\n    id: string;\n    orders: string;\n    ordersCount: string;\n    percent: string;\n    referrals: string;\n    balance: string;\n    currency: string;\n    earnings: string;\n    link: string;\n    language: string;\n    referralProgram: string;\n    referralPercent: string;\n    yourReferralLink: string;\n    backButton: string;\n    referralPurchases: string;\n    backToMenu: string;\n    defaultUsername: string;\n    copyLinkText: string;\n  };\n\n  // üì¶ –ó–ê–ö–ê–ó–´\n  orders: {\n    title: string;\n    empty: string;\n  };\n\n  // üé¨ –°–õ–ê–ô–î–®–û–£\n  slideshow: {\n      started: string;\n      stopped: string;\n      stoppedManual: string;\n      stoppedTimer: string;\n      alreadyPlaying: string;\n    };\n\n  // ============================================================================\n  // ‚öôÔ∏è –°–ò–°–¢–ï–ú–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)\n  // ============================================================================\n\n  // üîß –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò\n  system: {\n    languageSelection: string;\n    botName: string;\n    defaultGame: string;\n  };\n\n  // üìä –õ–û–ì–ò –ò –û–¢–õ–ê–î–ö–ê\n  logs: {\n    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\n    channelNotSet: string;\n    noGamesInDatabase: string;\n    noValidGamesInDatabase: string;\n    currentGameUndefined: string;\n\n    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å\n    sendingNewMainMenu: string;\n    bannerNoMessageId: string;\n    bannerUnknownAction: string;\n\n    // –ö–æ–Ω—Ç–µ–∫—Å—Ç\n    invalidContext: string;\n    errorEditingMessage: string;\n    errorSendingFallback: string;\n    fallbackMessageFailed: string;\n\n    // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n    errorInShowMainMenu: string;\n    errorEditingMedia: string;\n    errorEditingCaption: string;\n    errorSendingEditingMessage: string;\n\n    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏\n    errorInHandleAbout: string;\n    errorInHandleSupport: string;\n    errorInHandleReviews: string;\n    errorInHandleStart: string;\n    errorInHandleLanguageChange: string;\n\n    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ\n    startCommandFailed: string;\n    criticalChannelNotSet: string;\n    couldNotDeleteMessage: string;\n    noMessageIdForSubscription: string;\n    missingUserIdOrChatId: string;\n    botTokenNotFound: string;\n\n    // –û–±—â–∏–µ\n    unknownAction: string;\n    actionFailed: string;\n  };\n}\n\n// ============================================================================\n// üåç –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ô\n// ============================================================================\n\nconst localizations: Record<string, Localization> = {\n  // üá∑üá∫ –†–£–°–°–ö–ê–Ø –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø\n  ru: {\n    // üîò –ö–ù–û–ü–ö–ò –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø\n    buttons: {\n      // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n      store: 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω',\n      catalog: 'üìÇ –ö–∞—Ç–∞–ª–æ–≥',\n      news: 'üì± –ù–æ–≤–æ—Å—Ç–∏',\n      cabinet: 'üßô‚Äç‚ôÄÔ∏è –ü—Ä–æ—Ñ–∏–ª—å',\n      about: '‚ùó –û –Ω–∞—Å',\n      support: 'üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞',\n      reviews: '‚úÖ –û—Ç–∑—ã–≤—ã',\n      share: 'üöÄ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è',\n      language: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π',\n      back: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥',\n      menu: 'üì± –ú–µ–Ω—é',\n\n      // –ü–æ–¥–ø–∏—Å–∫–∞\n      subscribeToChannel: 'üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª',\n      checkSubscription: '‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',\n      subscribe: 'üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è',\n\n      // –û–ø–µ—Ä–∞—Ü–∏–∏\n      orders: 'üì¶ –ó–∞–∫–∞–∑—ã',\n      refresh: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',\n      deposit: 'üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å USDT',\n      withdraw: 'üí∏ –í—ã–≤–µ—Å—Ç–∏',\n      chat: 'üí¨ –ß–∞—Ç',\n      referralProgram: 'ü§ù –†–µ—Ñ. –ø—Ä–æ–≥—Ä–∞–º–º–∞',\n      update: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',\n\n      // –ú–∞–≥–∞–∑–∏–Ω—ã\n      googlePlay: 'ü§ñ Google Play',\n      appStore: 'üçé App Store',\n\n      // –ú–µ–¥–∏–∞\n      trailer: 'üé¨ –¢—Ä–µ–π–ª–µ—Ä',\n\n      // –ù–∞–≤–∏–≥–∞—Ü–∏—è\n      ourBot: 'ü§ñ –ë–æ—Ç',\n      prev: '‚èÆ',\n      next: '‚è≠',\n      play: '‚ñ∂Ô∏è',\n      stop: '‚èπ',\n\n      reply: '–û–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–µ',\n\n      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n      contactSupport: 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',\n      supportChat: 'üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏',\n      goToBot: 'ü§ñ –ü–µ—Ä–µ–π—Ç–∏ –∫ –±–æ—Ç—É',\n    },\n\n    // üòÄ –≠–ú–û–î–ó–ò –ò –ò–ö–û–ù–ö–ò\n    emojis: {\n      game: {\n        default: 'üéÆ',\n        controller: 'üéÆ',\n        mobile: 'üì±',\n      },\n      fire: 'üî•',\n    },\n\n    // üéÆ –û–°–ù–û–í–ù–´–ï –ò–ì–†–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´\n    core: {\n      discount: '–°–∫–∏–¥–∫–∞!',\n      tapToPlay: 'üëÜ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å',\n    },\n\n    // üí¨ –û–°–ù–û–í–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø\n    messages: {\n      welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',\n      languageSelected: 'üá∑üá∫ –í—ã–±—Ä–∞–Ω —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',\n      echo: '–Ø –±–æ—Ç –∏ –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤ —á–∞—Ç–µ.üëá',\n      echoResponse:\n        '–Ø –±–æ—Ç –∏ –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤ —á–∞—Ç–µ.üëá',\n    },\n\n    // üì¢ –ü–û–î–ü–ò–°–ö–ê –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø\n    subscription: {\n      request: 'üì¢ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª!',\n      success: '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!',\n      failed: '‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å.',\n    },\n\n    notifications: {\n      purchase: 'üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!',\n      deposit: 'üí∞ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} $!',\n      supportReply: 'üì© –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∏–ª–∞ –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å!',\n      newReferral: 'üë• –£ –≤–∞—Å –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª: {username}!',\n    },\n\n    // üìÑ –ö–û–ù–¢–ï–ù–¢–ù–´–ï –°–¢–†–ê–ù–ò–¶–´\n    pages: {\n      about:\n        '‚ÑπÔ∏è –û –Ω–∞—Å\\n\\n–ú—ã ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏–≥—Ä. –ù–∞—à–∞ —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º –ª—É—á—à–∏–µ –∏–≥—Ä—ã –∏ —É–¥–æ–±–Ω—ã–π —Å–µ—Ä–≤–∏—Å.',\n      support:\n        'üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞\\n\\n–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–∞–º.',\n      reviews: '‚≠ê –û—Ç–∑—ã–≤—ã\\n\\n–í–∞—à–∏ –æ—Ç–∑—ã–≤—ã –ø–æ–º–æ–≥–∞—é—Ç –Ω–∞–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª—É—á—à–µ!',\n    },\n\n    // ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –û–®–ò–ë–ö–ò\n    errors: {\n      general: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',\n      userBlocked: '‚õî –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.',\n      noGames: 'üìõ –ò–≥—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∏–≥—Ä—É.',\n      startError: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',\n    },\n\n    // üîç INLINE –§–£–ù–ö–¶–ò–ò\n    inline: {\n      playMarket: 'ü§ñ Play Market',\n      appStore: 'üçé App Store',\n      store: 'üõç –ú–∞–≥–∞–∑–∏–Ω',\n      bot: 'ü§ñ –ë–æ—Ç',\n    },\n\n    // üë§ –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢\n    cabinet: {\n      title: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',\n      user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:',\n      userInfo: 'üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ',\n      id: 'ID:',\n      orders: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤:',\n      ordersCount: '–í–∞—à–∏ –ü–æ–∫—É–ø–∫–∏:',\n      percent: '–ü—Ä–æ—Ü–µ–Ω—Ç —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:',\n      referrals: '–†–µ—Ñ–µ—Ä–∞–ª—ã:',\n      balance: '–ë–∞–ª–∞–Ω—Å:',\n      currency: '–†–£–ë',\n      earnings: '–ó–∞—Ä–∞–±–æ—Ç–æ–∫:',\n      link: '–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:',\n      language: '–Ø–∑—ã–∫:',\n      referralProgram: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:',\n      referralPercent: '–ü—Ä–æ—Ü–µ–Ω—Ç —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:',\n      yourReferralLink: '–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:',\n      backButton: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é',\n      referralPurchases: '–ü–æ–∫—É–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:',\n      backToMenu: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥',\n      defaultUsername: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',\n      copyLinkText: 'üìã –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',\n    },\n\n    // üì¶ –ó–ê–ö–ê–ó–´\n    orders: {\n      title: 'üìú –í–∞—à–∏ –∑–∞–∫–∞–∑—ã:\\n\\n',\n      empty: '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.',\n    },\n\n    // üé¨ –°–õ–ê–ô–î–®–û–£\n    slideshow: {\n      started: '‚ñ∂Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞',\n      stopped: '‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞',\n      stoppedManual: '‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞',\n      stoppedTimer: '‚è∞ –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É',\n      alreadyPlaying: '‚ö†Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞',\n    },\n\n    // ‚öôÔ∏è –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò\n    system: {\n      languageSelection: 'üåê –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Select language',\n      botName: 'Tiptop_dev_bot',\n      defaultGame: 'Default Game',\n    },\n\n    // üìä –õ–û–ì–ò –ò –û–¢–õ–ê–î–ö–ê\n    logs: {\n      channelNotSet:\n        'CHANNEL_TG is not set in the .env file for subscription check.',\n      noGamesInDatabase: 'No games found in database for banners',\n      noValidGamesInDatabase: 'No valid games found in database for banners',\n      currentGameUndefined: 'Current game is undefined or has no title. Index:',\n      sendingNewMainMenu:\n        \"Sending new main menu because 'editMessage' is false (messageId:\",\n      bannerNoMessageId: '[BANNER] No messageId found for user',\n      bannerUnknownAction: '[BANNER] Unknown action',\n      invalidContext: 'handleCabinet: Invalid context',\n      errorEditingMessage: 'Error editing message in',\n      errorSendingFallback: 'Error sending fallback game in showMainMenu:',\n      fallbackMessageFailed: 'Fallback message failed for user',\n      errorInShowMainMenu: 'Error in showMainMenu:',\n      errorEditingMedia: 'Error editing media in showMainMenu:',\n      errorEditingCaption: 'Error editing caption in showMainMenu:',\n      errorSendingEditingMessage:\n        'Error in showMainMenu sending/editing message:',\n      errorInHandleAbout: 'Error editing message in handleAbout:',\n      errorInHandleSupport: 'Error editing message in handleSupport:',\n      errorInHandleReviews: 'Error editing message in handleReviews:',\n      errorInHandleStart: 'Error in handleStart:',\n      errorInHandleLanguageChange: 'Error in handleLanguageChange:',\n      startCommandFailed: 'Start command failed',\n      criticalChannelNotSet:\n        'CRITICAL: CHANNEL_TG is not set in the .env file! Subscription checks will fail.',\n      couldNotDeleteMessage: 'Could not delete message on /start:',\n      noMessageIdForSubscription:\n        'No messageId found for check subscription, showing language selection.',\n      missingUserIdOrChatId:\n        'Missing userId or chatId in editOrSendCabinetMessage',\n      botTokenNotFound: 'BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è',\n      unknownAction: 'Unknown action:',\n      actionFailed: 'Action failed',\n    },\n  },\n\n  // üá¨üáß –ê–ù–ì–õ–ò–ô–°–ö–ê–Ø –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø\n  en: {\n    // üîò –ö–ù–û–ü–ö–ò –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø\n    buttons: {\n      // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n      store: 'üõçÔ∏è Store',\n      catalog: 'üìÇ Catalog',\n      news: 'üì± News',\n      cabinet: 'üßô‚Äç‚ôÄÔ∏è Profile',\n      about: '‚ùó About Us',\n      support: 'üë®‚Äçüíª Support',\n      reviews: '‚úÖ Reviews',\n      share: 'üöÄ Share',\n      language: 'üá¨üáß English',\n      back: '‚¨ÖÔ∏è Back',\n      menu: 'üì± Menu',\n\n      // –ü–æ–¥–ø–∏—Å–∫–∞\n      subscribeToChannel: 'üì¢ Subscribe to Channel',\n      checkSubscription: '‚úÖ Check Subscription',\n      subscribe: 'üì¢ Subscribe',\n\n      // –û–ø–µ—Ä–∞—Ü–∏–∏\n      orders: 'üì¶ Orders',\n      refresh: 'üîÑ Update',\n      deposit: 'üí≥ Deposit USDT',\n      withdraw: 'üí∏ Withdraw',\n      chat: 'üí¨ Chat',\n      referralProgram: 'ü§ù Ref. program',\n      update: 'üîÑ Update',\n\n      // –ú–∞–≥–∞–∑–∏–Ω—ã\n      googlePlay: 'ü§ñ Google Play',\n      appStore: 'üçé App Store',\n\n      // –ú–µ–¥–∏–∞\n      trailer: 'üé¨ Trailer',\n\n      // –ù–∞–≤–∏–≥–∞—Ü–∏—è\n      ourBot: 'ü§ñ Bot',\n      prev: '‚èÆ',\n      next: '‚è≠',\n      play: '‚ñ∂Ô∏è',\n      stop: '‚èπ',\n\n      reply: 'Communication only in chat',\n\n      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n      contactSupport: 'üìû Contact Support',\n      supportChat: 'üí¨ Support Chat',\n      goToBot: 'ü§ñ Go to Bot',\n    },\n\n    // üòÄ –≠–ú–û–î–ó–ò –ò –ò–ö–û–ù–ö–ò\n    emojis: {\n      game: {\n        default: 'üéÆ',\n        controller: 'üéÆ',\n        mobile: 'üì±',\n      },\n      fire: 'üî•',\n    },\n\n    // üéÆ –û–°–ù–û–í–ù–´–ï –ò–ì–†–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´\n    core: {\n      discount: 'Discount!',\n      tapToPlay: 'üëÜ Tap to play',\n    },\n\n    // üí¨ –û–°–ù–û–í–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø\n    messages: {\n      welcome: 'Welcome!',\n      languageSelected: 'üá¨üáß English language selected. Welcome!',\n      echo: \"I'm a bot and I can't process this message. If you have any questions, ask our operator in the chat.üëá\",\n      echoResponse:\n        \"I'm a bot and I can't process this message. If you have any questions, ask our operator in the chat.üëá\",\n    },\n\n    // üì¢ –ü–û–î–ü–ò–°–ö–ê –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø\n    subscription: {\n      request: 'üì¢ You need to subscribe to our channel to use this bot!',\n      success: '‚úÖ Great! Subscription confirmed!',\n      failed: '‚ùå Subscription not found. Please subscribe.',\n    },\n\n    notifications: {\n      purchase: 'üõí New order successfully placed!',\n      deposit: 'üí∞ Balance topped up by {amount} $!',\n      supportReply: 'üì© Support has replied to your request!',\n      newReferral: 'üë• You have a new referral: {username}!',\n    },\n\n    // üìÑ –ö–û–ù–¢–ï–ù–¢–ù–´–ï –°–¢–†–ê–ù–ò–¶–´\n    pages: {\n      about:\n        '‚ÑπÔ∏è About Us\\n\\nWe are a mobile gaming platform. Our goal is to provide you with the best games and convenient service.',\n      support: 'üÜò Support\\n\\nIf you have any questions or issues, contact us.',\n      reviews: '‚≠ê Reviews\\n\\nYour feedback helps us improve!',\n    },\n\n    // ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –û–®–ò–ë–ö–ò\n    errors: {\n      general: '‚ùå An error occurred. Please try again later.',\n      userBlocked: '‚õî You are blocked. Access to the bot is restricted.',\n      noGames: 'üìõ Games are not loaded. Please add at least one game.',\n      startError: 'An error occurred on startup. Please try again later.',\n    },\n\n    // üîç INLINE –§–£–ù–ö–¶–ò–ò\n    inline: {\n      playMarket: 'ü§ñ Play Market',\n      appStore: 'üçé App Store',\n      store: 'üõç Store',\n      bot: 'ü§ñ Bot',\n    },\n\n    // üë§ –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢\n    cabinet: {\n      title: 'üë§ Profile',\n      user: 'User:',\n      userInfo: 'üë§ User Information',\n      id: 'ID:',\n      orders: 'Your purchases:',\n      ordersCount: 'Purchases from referrals:',\n      percent: 'Referral percent:',\n      referrals: 'Referrals:',\n      balance: 'Balance:',\n      currency: 'RUB',\n      earnings: 'Earnings:',\n      link: 'Your referral link:',\n      language: 'Language:',\n      referralProgram: 'Referral program:',\n      referralPercent: 'Referral percent:',\n      yourReferralLink: 'Your referral link:',\n      backButton: '‚¨ÖÔ∏è Back to Menu',\n      referralPurchases: 'Referral Purchases:',\n      backToMenu: '‚¨ÖÔ∏è Back',\n      defaultUsername: 'User',\n      copyLinkText: 'üìã Tap the link above to copy',\n    },\n\n    // üì¶ –ó–ê–ö–ê–ó–´\n    orders: {\n      title: 'üìú Your Orders:\\n\\n',\n      empty: 'You have no orders yet.',\n    },\n\n    // üé¨ –°–õ–ê–ô–î–®–û–£\n    slideshow: {\n      started: '‚ñ∂Ô∏è Slideshow started',\n      stopped: '‚èπÔ∏è Slideshow stopped',\n      stoppedManual: '‚èπÔ∏è Slideshow stopped',\n      stoppedTimer: '‚è∞ Slideshow finished by timer',\n      alreadyPlaying: '‚ö†Ô∏è Slideshow already playing',\n    },\n\n    // ‚öôÔ∏è –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò\n    system: {\n      languageSelection: 'üåê –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Select language',\n      botName: 'Tiptop_dev_bot',\n      defaultGame: 'Default Game',\n    },\n\n    // üìä –õ–û–ì–ò –ò –û–¢–õ–ê–î–ö–ê\n    logs: {\n      channelNotSet:\n        'CHANNEL_TG is not set in the .env file for subscription check.',\n      noGamesInDatabase: 'No games found in database for banners',\n      noValidGamesInDatabase: 'No valid games found in database for banners',\n      currentGameUndefined: 'Current game is undefined or has no title. Index:',\n      sendingNewMainMenu:\n        \"Sending new main menu because 'editMessage' is false (messageId:\",\n      bannerNoMessageId: '[BANNER] No messageId found for user',\n      bannerUnknownAction: '[BANNER] Unknown action',\n      invalidContext: 'handleCabinet: Invalid context',\n      errorEditingMessage: 'Error editing message in',\n      errorSendingFallback: 'Error sending fallback game in showMainMenu:',\n      fallbackMessageFailed: 'Fallback message failed for user',\n      errorInShowMainMenu: 'Error in showMainMenu:',\n      errorEditingMedia: 'Error editing media in showMainMenu:',\n      errorEditingCaption: 'Error editing caption in showMainMenu:',\n      errorSendingEditingMessage:\n        'Error in showMainMenu sending/editing message:',\n      errorInHandleAbout: 'Error editing message in handleAbout:',\n      errorInHandleSupport: 'Error editing message in handleSupport:',\n      errorInHandleReviews: 'Error editing message in handleReviews:',\n      errorInHandleStart: 'Error in handleStart:',\n      errorInHandleLanguageChange: 'Error in handleLanguageChange:',\n      startCommandFailed: 'Start command failed',\n      criticalChannelNotSet:\n        'CRITICAL: CHANNEL_TG is not set in the .env file! Subscription checks will fail.',\n      couldNotDeleteMessage: 'Could not delete message on /start:',\n      noMessageIdForSubscription:\n        'No messageId found for check subscription, showing language selection.',\n      missingUserIdOrChatId:\n        'Missing userId or chatId in editOrSendCabinetMessage',\n      botTokenNotFound: 'BOT_TOKEN not found in environment variables',\n      unknownAction: 'Unknown action:',\n      actionFailed: 'Action failed',\n    },\n  },\n};\n\n// ============================================================================\n// üõ†Ô∏è –£–¢–ò–õ–ò–¢–´ –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò\n// ============================================================================\n\n/**\n * –ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞\n * @param lang - –ö–æ–¥ —è–∑—ã–∫–∞ ('ru' | 'en')\n * @returns –û–±—ä–µ–∫—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏\n */\nexport function localization(lang: string = 'ru'): Localization {\n  return localizations[lang] || localizations.ru;\n}\n\n// ============================================================================\n// üì§ –≠–ö–°–ü–û–†–¢–´\n// ============================================================================\n\n// –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –æ–±—ä–µ–∫—Ç–æ–≤\nexport {\n  MEDIA_RESOURCES,\n  URL_CONSTANTS,\n  GAME_CATEGORIES,\n  GAME_BANNERS,\n  WELCOME_GIFS,\n  SUBSCRIBE_REQUEST_GIF,\n  DEFAULT_GIF_URL,\n  CABINET_GIF_URL,\n  PLACEHOLDER_IMAGE_URL,\n  localizations,\n};\n\n// –≠–∫—Å–ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\nexport default localizations;\n","size_bytes":26283},"server/src/middleware/admin.ts":{"content":"import {NextFunction, Request, Response} from \"express\";\nimport console from \"node:console\";\nimport User, {IUser} from \"../models/User\";\nimport {logger} from \"../config/logger\";\n\nexport const isAdmin = async (req: Request, res: Response, next: NextFunction) => {\n    try {\n        const userId = req.telegramUser?.id;\n\n        if (!userId) {\n            return res.status(401).json({ message: 'Missing userId' });\n        }\n\n        const user: any = await User.findById(userId);\n\n        if (!user) {\n            return res.status(401).json({ message: 'Invalid user data' });\n        }\n\n        if (!user.isAdmin) {\n            return res.status(401).json({ message: 'User is not admin' });\n        }\n\n        next();\n    } catch (error) {\n        logger.error('Admin middleware error:', error);\n        res.status(401).json({ message: 'Admin middleware failed' });\n    }\n};","size_bytes":875},"DEPLOYMENT_GUIDE.md":{"content":"# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é Tip-Top –Ω–∞ Replit\n\n## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç\n\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Replit** - –Ω–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!\n\n### –®–∞–≥ 1: PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ\n\n**–£–∂–µ –≥–æ—Ç–æ–≤–∞!** PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞ –≤ Replit –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.\n\n- ‚úÖ DATABASE_URL —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω\n- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã\n- ‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã\n\n–ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!\n\n### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ë–æ—Ç–∞ (2 –º–∏–Ω—É—Ç—ã)\n\n1. **–û—Ç–∫—Ä–æ–π—Ç–µ Telegram** –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ **@BotFather**\n2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É** `/newbot`\n3. **–í–≤–µ–¥–∏—Ç–µ –∏–º—è** –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `Tip-Top Games`)\n4. **–í–≤–µ–¥–∏—Ç–µ username** (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `bot`, –Ω–∞–ø—Ä–∏–º–µ—Ä: `tiptop_games_bot`)\n5. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω** –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –≤—ã–¥–∞—Å—Ç BotFather (–≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)\n6. **–£–∑–Ω–∞–π—Ç–µ –≤–∞—à Telegram ID**:\n   - –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ **@userinfobot** –≤ Telegram\n   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID (—ç—Ç–æ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: `123456789`)\n\n### –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Replit (1 –º–∏–Ω—É—Ç–∞)\n\n1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å Secrets –≤ Replit**:\n   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É üîí (Secrets) –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ Tools\n   - –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+K –∏ –Ω–∞–π–¥–∏—Ç–µ \"Secrets\"\n\n2. **–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã** (–Ω–∞–∂–º–∏—Ç–µ \"Add new secret\" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ):\n\n   ```\n   BOT_TOKEN = –≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather\n   BOT_USERNAME = @–≤–∞—à_–±–æ—Ç_username\n   ADMIN_ID = –≤–∞—à_telegram_id\n   ```\n\n   **–ü—Ä–∏–º–µ—Ä:**\n   ```\n   BOT_TOKEN = 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz\n   BOT_USERNAME = @tiptop_games_bot\n   ADMIN_ID = 123456789\n   ```\n\n   **–í–ê–ñ–ù–û:** `DATABASE_URL` —É–∂–µ –µ—Å—Ç—å (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è PostgreSQL), `CLIENT_URL` –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!\n\n### –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã üöÄ\n\n**–í–ê–ñ–ù–û: Development vs Production —Ä–µ–∂–∏–º—ã**\n\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:\n\n#### üîß Development —Ä–µ–∂–∏–º (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ Replit)\n\n–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ **\"Run\"** –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **Server (API + Socket.IO)** –∏ **Telegram Bot**.  \n–≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ Replit.\n\n**–ß—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**\n- ‚úÖ Express API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 5000)\n- ‚úÖ PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)\n- ‚úÖ Socket.IO –¥–ª—è real-time —á–∞—Ç–∞\n- ‚úÖ Telegram –±–æ—Ç\n\n**–ß—Ç–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (—Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤):**\n- ‚ö†Ô∏è React Client (UI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)\n- ‚ö†Ô∏è React Admin (–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n\n–î–ª—è –ü–û–õ–ù–û–ì–û dev –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ—Ç–∫—Ä–æ–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã:\n```bash\n# –¢–µ—Ä–º–∏–Ω–∞–ª 2 - –ö–ª–∏–µ–Ω—Ç\ncd client && npm install && npm run dev\n\n# –¢–µ—Ä–º–∏–Ω–∞–ª 3 - –ê–¥–º–∏–Ω\ncd admin && npm install && npm run dev\n```\n\n#### üöÄ Production —Ä–µ–∂–∏–º (–¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)\n\n–ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (Deploy) —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–¥–∞–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–µ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–∞–∫ —Å—Ç–∞—Ç–∏–∫—É:\n- ‚úÖ Client –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º URL: `https://–≤–∞—à-–¥–æ–º–µ–Ω.repl.co/`\n- ‚úÖ Admin –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: `https://–≤–∞—à-–¥–æ–º–µ–Ω.repl.co/admin`\n- ‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: `https://–≤–∞—à-–¥–æ–º–µ–Ω.repl.co/api/*`\n- ‚úÖ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n–í—Å–µ 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –ø–æ—Ä—Ç!\n\n---\n\n**–ó–∞–ø—É—Å–∫ –≤ Development:**\n\n–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤:\n\n1. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"Run\"** –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ Replit\n2. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ** –ø–æ–∫–∞ —É—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (2-3 –º–∏–Ω—É—Ç—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)\n3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:\n   ```\n   ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!\n   üöÄ –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Tip-Top...\n   ‚úÖ PostgreSQL connected successfully via Prisma\n   ‚úÖ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω\n   ```\n\n### –®–∞–≥ 5: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞ üåê\n\n1. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"Deploy\"** –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ Replit\n2. **–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ–ø–ª–æ—è**: Autoscale (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)\n3. **–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** –¥–µ–ø–ª–æ—è\n4. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL** –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±—É–¥–µ—Ç –≤–∏–¥–∞: `https://tip-top.username.repl.co`)\n5. **–û–±–Ω–æ–≤–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç CLIENT_URL** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):\n   - –û—Ç–∫—Ä–æ–π—Ç–µ Secrets\n   - –î–æ–±–∞–≤—å—Ç–µ `CLIENT_URL` = –≤–∞—à URL –¥–µ–ø–ª–æ—è (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)\n6. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π**\n\n### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –°–≤–æ–π –¥–æ–º–µ–Ω\n\n–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–≤–æ–π –¥–æ–º–µ–Ω:\n\n1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Deployments** ‚Üí **Settings** ‚Üí **Link a domain**\n2. –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω\n3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –∑–∞–ø–∏—Å–∏ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ Replit\n4. –û–±–Ω–æ–≤–∏—Ç–µ `CLIENT_URL` –≤ Secrets –Ω–∞ –≤–∞—à –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω\n\n---\n\n## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\n\n### PostgreSQL (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤ Replit)\n\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Replit** —Å **Prisma ORM**.\n\n**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞\n- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\n- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Prisma\n- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Prisma\n- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n\n**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã:**\n- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã\n- `games` - –∫–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä\n- `offers` - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –∏–≥—Ä–∞—Ö\n- `orders` - –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- `order_details` - –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–æ–≤\n- `payments` - –ø–ª–∞—Ç–µ–∂–∏ (USDT/RUB)\n- `chats` + `chat_messages` - —Å–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞\n- `reviews` - –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- `referrals` - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n- `transactions` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n- `withdrawals` - –≤—ã–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤\n\n### –ú–∏–≥—Ä–∞—Ü–∏–∏\n\n–í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ!\n\n–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º—É:\n\n```bash\ncd server\nnpx prisma migrate dev --name –Ω–∞–∑–≤–∞–Ω–∏–µ_–º–∏–≥—Ä–∞—Ü–∏–∏\n```\n\n### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Prisma Studio:\n\n```bash\ncd server\nnpx prisma studio\n```\n\n–û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.\n\n---\n\n## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º\n\n### –ü—Ä–æ–±–ª–µ–º–∞: DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω\n\n**–†–µ—à–µ–Ω–∏–µ:**\nPostgreSQL –±–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ –Ω–µ—Ç:\n1. –ù–∞–∂–º–∏—Ç–µ \"Database\" –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ Replit\n2. –í—ã–±–µ—Ä–∏—Ç–µ \"PostgreSQL\"\n3. DATABASE_URL –¥–æ–±–∞–≤–∏—Ç—Å—è –≤ Secrets –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Prisma\n\n**–†–µ—à–µ–Ω–∏–µ:**\n```bash\ncd server\nnpx prisma migrate reset\nnpx prisma migrate dev --name init\n```\n\n### –ü—Ä–æ–±–ª–µ–º–∞: Telegram –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç\n\n**–†–µ—à–µ–Ω–∏–µ:**\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å BOT_TOKEN –≤ Secrets\n2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ BOT_USERNAME –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @\n3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n\n### –ü—Ä–æ–±–ª–µ–º–∞: Socket.IO –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\n\n**–†–µ—à–µ–Ω–∏–µ:**\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ CLIENT_URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω\n2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ server/index.ts\n3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5000\n\n---\n\n## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n\n### –õ–æ–≥–∏ –≤ Development\n\n–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—ã–≤–æ–¥—è—Ç –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å:\n- üü¢ Server: –ª–æ–≥–∏ Express + Prisma\n- üîµ Bot: –ª–æ–≥–∏ Telegram –±–æ—Ç–∞\n- üü° Client: –ª–æ–≥–∏ React dev server\n- üü† Admin: –ª–æ–≥–∏ React dev server\n\n### –õ–æ–≥–∏ –≤ Production\n\n–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ **Deployments** ‚Üí **Logs**\n\n---\n\n## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n\n1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã** –≤ Git\n2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Replit Secrets** –¥–ª—è –≤—Å–µ—Ö —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n3. PostgreSQL DATABASE_URL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—â–µ–Ω\n4. –í—Å–µ –ø–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ bcryptjs\n5. JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏\n\n---\n\n## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n\n```\ntip-top/\n‚îú‚îÄ‚îÄ server/          # Express API + Socket.IO\n‚îÇ   ‚îú‚îÄ‚îÄ prisma/      # Prisma —Å—Ö–µ–º–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏\n‚îÇ   ‚îú‚îÄ‚îÄ src/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/      # Prisma repositories\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/  # API —Ä–æ—É—Ç—ã\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ controllers/ # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞\n‚îú‚îÄ‚îÄ bot/             # Telegram –±–æ—Ç (Telegraf)\n‚îú‚îÄ‚îÄ client/          # React –∫–ª–∏–µ–Ω—Ç (Telegram Web App)\n‚îú‚îÄ‚îÄ admin/           # React –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n‚îú‚îÄ‚îÄ index.js         # –ì–ª–∞–≤–Ω—ã–π launcher\n‚îî‚îÄ‚îÄ DEPLOYMENT_GUIDE.md\n```\n\n---\n\n## üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã\n\n```bash\n# –ó–∞–ø—É—Å–∫ –≤ dev —Ä–µ–∂–∏–º–µ\nnpm run dev\n\n# –°–±–æ—Ä–∫–∞ –¥–ª—è production\nnpm run build\n\n# –ó–∞–ø—É—Å–∫ –≤ production\nnpm start\n\n# Prisma –º–∏–≥—Ä–∞—Ü–∏–∏\ncd server && npx prisma migrate dev\n\n# Prisma Studio (–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö)\ncd server && npx prisma studio\n\n# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client\ncd server && npx prisma generate\n```\n\n---\n\n## üéâ –ì–æ—Ç–æ–≤–æ!\n\n–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!\n\n**–ß—Ç–æ –¥–∞–ª—å—à–µ:**\n1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É (CryptoPay –¥–ª—è USDT)\n2. –î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É\n4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏\n\n–£–¥–∞—á–∏! üöÄ\n","size_bytes":10908},"server/src/controllers/userController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import User from '../models/User';\nimport { logger } from '../config/logger';\nimport process from \"node:process\";\nimport console from \"node:console\";\nimport { prisma } from '../db/client';\nimport { userRepository } from '../db';\n\n// -> User\n\n// Create a new user\nexport const createUser = async (req: Request, res: Response) => {\n  try {\n    if (!req.telegramUser) {\n      logger.warn('Missing telegramUser in request');\n      return res.status(400).json({ error: 'Missing telegramUser in request' });\n    }\n    \n    const userId = req.telegramUser?.id;\n    const username = req.telegramUser?.first_name;\n    const avatarUrl = req.telegramUser?.photo_url;\n\n    logger.info('Creating a new user', { context: { userId: userId } });\n\n    // Validate telegram data\n    if (!userId || !username) {\n      logger.warn('Invalid request tg data', { context: { telegramUser: req.telegramUser } });\n      return res.status(400).json({ error: 'Invalid request tg data' });\n    }\n\n    // MONGO BACKUP: const user1 = await User.findOne({ _id: userId });\n    const user1 = await prisma.user.findUnique({ where: { id: userId } });\n    if (user1) {\n      if (user1.id === userId) {\n        logger.warn(`User with id ${userId} is already exists`);\n        return res.status(200).json({})\n      }\n    }\n\n    // MONGO BACKUP: const newUser = {\n    // MONGO BACKUP:   _id: userId,\n    // MONGO BACKUP:   username: username,\n    // MONGO BACKUP:   avatarUrl: avatarUrl,\n    // MONGO BACKUP: };\n    // MONGO BACKUP: logger.info('New user data: ', { context: { user: newUser } });\n    // MONGO BACKUP: const user = new User(newUser);\n    // MONGO BACKUP: await user.save();\n\n    const user = await userRepository.create({\n      id: userId,\n      username: username,\n      avatarUrl: avatarUrl || null,\n    });\n\n    logger.info('User created successfully', { context: { userId: user.id } });\n    res.status(201).json(user);\n  } catch (error) {\n    logger.error('Error creating user', { context: { error } });\n    res.status(400).json({ error: 'Error creating user', details: error });\n  }\n};\n\nexport const createUserBot = async (req: Request, res: Response) => {\n  try {\n    logger.info('Creating a new user', { context: { body: req.body } });\n\n    const token = req.get('Token');\n    if (token !== process.env.AUTH_BOT_TOKEN) {\n      logger.warn('Invalid request token', { context: { token: token } });\n      return res.status(400).json({ error: 'Invalid request token' });\n    }\n\n    // Validate telegram data\n    if (!req.body.userId || !req.body.username) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      return res.status(400).json({ error: 'Invalid request body' });\n    }\n\n    // MONGO BACKUP: const user1 = await User.findOne({ _id: req.body.userId });\n    const user1 = await prisma.user.findUnique({ where: { id: req.body.userId } });\n    if (user1) {\n      if (user1.id === req.body.userId) {\n        logger.warn(`User with id ${req.body.userId} is already exists`);\n        return res.status(200).json({})\n      }\n    }\n\n    // Validate request body\n    if (!req.body.avatarUrl) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      return res.status(400).json({ error: 'Invalid request body' });\n    }\n\n    // MONGO BACKUP: const newUser = {\n    // MONGO BACKUP:   _id: req.body.userId,\n    // MONGO BACKUP:   username: req.body.username,\n    // MONGO BACKUP:   avatarUrl: req.body.avatarUrl,\n    // MONGO BACKUP: };\n    // MONGO BACKUP: const user = new User(newUser);\n    // MONGO BACKUP: await user.save();\n\n    const user = await userRepository.create({\n      id: req.body.userId,\n      username: req.body.username,\n      avatarUrl: req.body.avatarUrl,\n    });\n\n    logger.info('User created successfully', { context: { userId: user.id } });\n    res.status(201).json(user);\n  } catch (error) {\n    logger.error('Error creating user', { context: { error } });\n    res.status(400).json({ error: 'Error creating user', details: error });\n  }\n};\n\n// Get user by ID\nexport const getUserByIdBot = async (req: Request, res: Response) => {\n  try {\n    const userId = req.params.userId;\n    const token = req.get('Token');\n\n    logger.info('Fetching user by ID', { context: { userId: userId } });\n\n    if (token !== process.env.AUTH_BOT_TOKEN) {\n      logger.warn('Invalid request token', { context: { token: token } });\n      return res.status(400).json({ error: 'Invalid request token' });\n    }\n\n    // MONGO BACKUP: const user = await User.findById(userId);\n    const user = await userRepository.findById(parseInt(userId));\n\n    if (!user) {\n      logger.warn('User not found', { context: { userId: userId } });\n      return res.status(404).json({ error: 'User not found' });\n    }\n\n    logger.info('User fetched successfully', { context: { userId: user.id } });\n    res.json(user);\n  } catch (error) {\n    logger.error('Error fetching user', { context: { error } });\n    res.status(500).json({ error: 'Error fetching user' });\n  }\n};\n\nexport const getUserById = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n\n    logger.info('Fetching user by ID', { context: { userId: userId } });\n\n    // MONGO BACKUP: const user = await User.findById(userId);\n    const user = await userRepository.findById(userId!);\n\n    if (!user) {\n      logger.warn('User not found', { context: { userId: userId } });\n      return res.status(404).json({ error: 'User not found' });\n    }\n\n    logger.info('User fetched successfully', { context: { userId: user.id } });\n    res.json(user);\n  } catch (error) {\n    logger.error('Error fetching user', { context: { error } });\n    res.status(500).json({ error: 'Error fetching user' });\n  }\n};\n\n\nexport const updateLanguageBot = async (req: Request, res: Response) => {\n  const userId = req.params.userId;\n  const language = req.body.language;\n  const token = req.get('Token');\n\n  logger.info('Updating user language by ID', { context: { userId: userId } });\n\n  if (token !== process.env.AUTH_BOT_TOKEN) {\n    logger.warn('Invalid request token', { context: { token: token } });\n    return res.status(400).json({ error: 'Invalid request token' });\n  }\n\n  // MONGO BACKUP: const user = await User.findById(userId);\n  const user = await userRepository.findById(parseInt(userId));\n\n  if (!user) {\n    logger.warn('User not found', { context: { userId: userId } });\n    return res.status(404).json({ error: 'User not found' });\n  }\n\n  // MONGO BACKUP: user.language = language;\n  // MONGO BACKUP: await user.save();\n  const updatedUser = await userRepository.update(parseInt(userId), { language });\n\n  logger.info('User language updated successfully', { context: { userId: updatedUser.id } });\n  res.json(updatedUser);\n}\n\nexport const updateSubscriptionBot = async (req: Request, res: Response) => {\n  const userId = req.params.userId;\n  const isSubscribed = req.body.isSubscribed;\n  const token = req.get('Token');\n\n  logger.info('Updating user subscription by ID', { context: { userId: userId } });\n\n  if (token !== process.env.AUTH_BOT_TOKEN) {\n    logger.warn('Invalid request token', { context: { token: token } });\n    return res.status(400).json({ error: 'Invalid request token' });\n  }\n\n  // MONGO BACKUP: const user = await User.findById(userId);\n  const user = await userRepository.findById(parseInt(userId));\n\n  if (!user) {\n    logger.warn('User not found', { context: { userId: userId } });\n    return res.status(404).json({ error: 'User not found' });\n  }\n\n  // MONGO BACKUP: user.isSubscribed = isSubscribed;\n  // MONGO BACKUP: await user.save();\n  const updatedUser = await userRepository.updateSubscriptionStatus(parseInt(userId), isSubscribed);\n\n  logger.info('User isSubscribed updated successfully', { context: { userId: updatedUser.id } });\n  res.json(updatedUser);\n}\n\nexport const updateLanguage = async (req: Request, res: Response) => {\n  const userId = req.telegramUser?.id;\n  const language = req.body.language;\n\n  logger.info('Updating user language by ID', { context: { userId: userId } });\n\n  // MONGO BACKUP: const user = await User.findById(userId);\n  const user = await userRepository.findById(userId!);\n\n  if (!user) {\n    logger.warn('User not found', { context: { userId: userId } });\n    return res.status(404).json({ error: 'User not found' });\n  }\n\n  // MONGO BACKUP: user.language = language;\n  // MONGO BACKUP: await user.save();\n  const updatedUser = await userRepository.update(userId!, { language });\n\n  logger.info('User language updated successfully', { context: { userId: updatedUser.id } });\n  res.json(updatedUser);\n}\n\n// -> Admin\n\n// Get all users\n// export const getUsers = async (req: Request, res: Response) => {\n//   try {\n//     logger.info('Fetching all users');\n//     const users = await User.find();\n//     logger.info('Users fetched successfully', { context: { count: users.length } });\n//     res.json(users);\n//   } catch (error) {\n//     logger.error('Error fetching users', { context: { error } });\n//     res.status(500).json({ error: 'Error fetching users' });\n//   }\n// };\n//\n// // Delete user\n// export const deleteUser = async (req: Request, res: Response) => {\n//   try {\n//     logger.info('Deleting user', { context: { userId: req.params.id } });\n//     const user = await User.findByIdAndDelete(req.params.id);\n//     if (!user) {\n//       logger.warn('User not found for deletion', { context: { userId: req.params.id } });\n//       return res.status(404).json({ error: 'User not found' });\n//     }\n//     logger.info('User deleted successfully', { context: { userId: user._id } });\n//     res.json({ message: 'User deleted successfully' });\n//   } catch (error) {\n//     logger.error('Error deleting user', { context: { error } });\n//     res.status(500).json({ error: 'Error deleting user' });\n//   }\n// };\n","size_bytes":9857},"server/src/models/Transaction.ts":{"content":"// MONGO BACKUP: import { Schema, model } from 'mongoose';\n// MONGO BACKUP: import { getMaxTransactionId } from '../helpers/index';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface ITransaction {\n// MONGO BACKUP:   _id?: number;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   referId?: number;\n// MONGO BACKUP:   amount: number;\n// MONGO BACKUP:   currency: 'RUB' | 'USDT';\n// MONGO BACKUP:   earned?: number;\n// MONGO BACKUP:   type: string;\n// MONGO BACKUP:   createdAt?: Date;\n// MONGO BACKUP:   updatedAt?: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const TransactionSchema = new Schema<ITransaction>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     userId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       ref: 'User'\n// MONGO BACKUP:     },\n// MONGO BACKUP:     referId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:       ref: 'User'\n// MONGO BACKUP:     },\n// MONGO BACKUP:     amount: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true  \n// MONGO BACKUP:     },\n// MONGO BACKUP:     currency: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       enum: ['RUB', 'USDT']\n// MONGO BACKUP:     },\n// MONGO BACKUP:     earned: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false\n// MONGO BACKUP:     },\n// MONGO BACKUP:     type: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       enum: ['order', 'refund']\n// MONGO BACKUP:     }\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: TransactionSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxTransactionId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export default model<ITransaction>('Transaction', TransactionSchema); \n","size_bytes":2284},"server/src/controllers/webhookController.ts":{"content":"import { Request, Response } from 'express';\nimport { createHash, createHmac } from 'crypto';\nimport axios from 'axios';\n// MONGO BACKUP: import Order, {IOrder} from '../models/Order';\n// MONGO BACKUP: import User from '../models/User';\n// MONGO BACKUP: import Payment from '../models/Payment';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import Offer from '../models/Offer';\n// MONGO BACKUP: import Game from '../models/Game';\nimport {clients, io} from '../../index';\n// MONGO BACKUP: import {Chat, IMessage} from \"../models/Chat\";\nimport console from \"node:console\";\nimport {sign} from \"@telegram-apps/init-data-node\";\nimport process from \"node:process\";\nimport { prisma } from '../db/client';\nimport { orderRepository, paymentRepository, chatRepository } from '../db';\n\nexport const handleCryptoWebhook = async (req: Request, res: Response) => {\n  try {\n    logger.info('Received crypto webhook request', { context: { headers: req.headers, body: req.body } });\n\n    const { body, headers } = req;\n    const token = process.env.CRYPTOPAY_API_KEY;\n\n    if (process.env.NODE_ENV === 'development') {\n\n    } else {\n      if (!token) {\n        logger.error('CRYPTOPAY_API_KEY is not set');\n        return res.status(500).json({ error: 'Configuration error' });\n      }\n\n      const secret = createHash('sha256').update(token).digest();\n      const checkString = JSON.stringify(body);\n      const hmac = createHmac('sha256', secret).update(checkString).digest('hex');\n\n      if (hmac !== headers['crypto-pay-api-signature']) {\n        logger.error('Webhook signature does not match', { context: { received: headers['crypto-pay-api-signature'] } });\n        return res.status(403).json({ error: 'Invalid signature' });\n      }\n    }\n\n    const { update_type, payload } = body;\n\n    if (!update_type || !payload) {\n      logger.error('Invalid webhook payload', { context: { body } });\n      return res.status(400).json({ error: 'Invalid payload' });\n    }\n\n    logger.info('Processing webhook update', { context: { update_type, payload } });\n\n    if (update_type === 'invoice_paid') {\n      const { invoice_id } = payload;\n\n      logger.info('Processing invoice_paid update', { context: { invoice_id } });\n\n      // MONGO BACKUP: const payment = await Payment.findOne({ externalId: invoice_id });\n      const payment = await prisma.payment.findFirst({\n        where: { externalId: invoice_id }\n      });\n\n      if (!payment) {\n        logger.error('Payment not found for invoice_id', { context: { invoice_id } });\n        return res.status(404).json({ error: 'Payment not found' });\n      }\n\n      // MONGO BACKUP: payment.status = 'completed';\n      // MONGO BACKUP: await payment.save();\n      await prisma.payment.update({\n        where: { id: payment.id },\n        data: { status: 'completed' }\n      });\n      logger.info('Payment status updated to completed', { context: { paymentId: payment.id } });\n\n      // MONGO BACKUP: const order = new Order({\n      // MONGO BACKUP:   paymentId: payment._id,\n      // MONGO BACKUP:   userId: payment.userId,\n      // MONGO BACKUP:   offerId: payment.offerId,\n      // MONGO BACKUP:   status: 'pending',\n      // MONGO BACKUP:   currency: payment.currency,\n      // MONGO BACKUP: });\n      // MONGO BACKUP: await order.save();\n      \n      const order = await orderRepository.create({\n        payment: { connect: { id: payment.id } },\n        user: { connect: { id: payment.userId } },\n        offer: { connect: { id: payment.offerId } },\n        status: 'pending',\n        currency: payment.currency as 'USDT' | 'RUB',\n      });\n      \n      logger.info('Order created successfully', { context: { orderId: order.id } });\n\n      // MONGO BACKUP: const updatedPayment = await Payment.findByIdAndUpdate(payment._id, { orderId: order._id });\n      const updatedPayment = await prisma.payment.update({\n        where: { id: payment.id },\n        data: { orderId: order.id }\n      });\n      \n      if (!updatedPayment) {\n        logger.error('Payment not found for orderId', { context: { orderId: order.id } });\n        return res.status(404).json({ error: 'Payment not found' });\n      }\n\n      // MONGO BACKUP: await User.findByIdAndUpdate(payment.userId, { $inc: { ordersCount: 1 } }, { new: true });\n      await prisma.user.update({\n        where: { id: payment.userId },\n        data: { ordersCount: { increment: 1 } }\n      });\n      logger.info('User order count updated', { context: { userId: payment.userId } });\n\n      // MONGO BACKUP: const offer = await Offer.findOne({ _id: order.offerId });\n      // MONGO BACKUP: const game = await Game.findOne({ _id: offer?.gameId });\n      const offer = await prisma.offer.findUnique({\n        where: { id: order.offerId },\n        include: { game: true }\n      });\n      const game = offer?.game;\n\n      // Send notifications\n      const orderMsg = `üì¶ *Order status changed*\\n` +\n          `üÜî Order ID: ${order.id}\\n` +\n          `üéÆ Game: ${game?.title}\\n` +\n          `üéÆ Offer: ${offer?.title}\\n` +\n          `üí∞ Amount: ${payment?.amountToPay} ${order.currency}\\n` +\n          `üìå Status: ${order.status.toUpperCase()}\\n` +\n          `üïí Created: ${new Date(order.createdAt).toLocaleString()}\\n` +\n          `üïí Modified: ${new Date(order.updatedAt).toLocaleString()}\\n`;\n\n      const message = { sender: -1, content: orderMsg, timestamp: new Date(), isSystemMessage: false };\n\n      // MONGO BACKUP: let chat = await Chat.findOne({ userId: order.userId });\n      // MONGO BACKUP: if (!chat) {\n      // MONGO BACKUP:   chat = new Chat({\n      // MONGO BACKUP:     userId: order.userId,\n      // MONGO BACKUP:     messages: [message],\n      // MONGO BACKUP:     lastReadByUser: new Date(),\n      // MONGO BACKUP:     lastReadByAdmin: new Date(0),\n      // MONGO BACKUP:     unreadAdminCount: 0,\n      // MONGO BACKUP:   });\n      // MONGO BACKUP: } else {\n      // MONGO BACKUP:   chat.messages.push(message);\n      // MONGO BACKUP: }\n      // MONGO BACKUP: await chat.save();\n      \n      await chatRepository.addMessage(order.userId, message);\n\n      const clientSocketId = clients.get(order.userId);\n\n      if (clientSocketId) {\n        io.to(clientSocketId).emit('new_message', { sender: -1, content: orderMsg });\n      }\n\n      // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n      const orders = await orderRepository.findAll();\n\n      io.to('admin').emit('new-order', orders);\n\n      logger.info('New order notification sent via WebSocket', { context: { orderId: order.id } });\n\n      const botToken = process.env.BOT_TOKEN;\n      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n\n      await axios.post(url, {\n        chat_id: order.userId,\n        text: `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–µ ‚Ññ${order.id}.`,\n        reply_markup: {\n          inline_keyboard: [[\n            {\n              text: \"üí¨ –ß–∞—Ç\",\n              web_app: {\n                url: process.env.CLIENT_URL + \"/chat\"\n              }\n            }\n          ]]\n        }\n      });\n    }\n\n    res.status(200).json({ success: true });\n    logger.info('Webhook processed successfully');\n  } catch (error) {\n    logger.error('Webhook processing error', { context: { error } });\n    res.status(500).json({ error: 'Internal Server Error' });\n  }\n};\n\nexport const handleRubWebhook = async (req: Request, res: Response) => {\n  try {\n    logger.info('Received rub webhook request', { context: { headers: req.headers, body: req.body } });\n\n    const { order_id, stage, signature } = req.body;\n    const token = process.env.BLVCKPAY_API_TOKEN;\n\n    if (!token) {\n      logger.error('BLVCKPAY_API_TOKEN is not set');\n      return res.status(500).json({ error: 'Configuration error' });\n    }\n\n    if (!order_id || !stage || !signature) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      return res.status(400).json({ error: 'Invalid request body' });\n    }\n\n    if (signature !== token) {\n      logger.error('Rub webhook signature does not match', { context: { received: signature } });\n      return res.status(403).json({ error: 'Invalid signature' });\n    }\n\n    const invoice_id = order_id;\n\n\n    if (stage === true) {\n      logger.info('Processing rub invoice_paid update', { context: { invoice_id } });\n\n      // MONGO BACKUP: const payment = await Payment.findOne({ externalId: invoice_id });\n      const payment = await prisma.payment.findFirst({\n        where: { externalId: invoice_id }\n      });\n\n      if (!payment) {\n        logger.error('Payment not found for invoice_id', { context: { invoice_id } });\n        return res.status(404).json({ error: 'Payment not found' });\n      }\n\n      // MONGO BACKUP: payment.status = 'completed';\n      // MONGO BACKUP: await payment.save();\n      await prisma.payment.update({\n        where: { id: payment.id },\n        data: { status: 'completed' }\n      });\n      logger.info('Payment status updated to completed', { context: { paymentId: payment.id } });\n\n      // MONGO BACKUP: const order = new Order({\n      // MONGO BACKUP:   paymentId: payment._id,\n      // MONGO BACKUP:   userId: payment.userId,\n      // MONGO BACKUP:   offerId: payment.offerId,\n      // MONGO BACKUP:   status: 'pending',\n      // MONGO BACKUP:   currency: payment.currency,\n      // MONGO BACKUP: });\n      // MONGO BACKUP: await order.save();\n      \n      const order = await orderRepository.create({\n        payment: { connect: { id: payment.id } },\n        user: { connect: { id: payment.userId } },\n        offer: { connect: { id: payment.offerId } },\n        status: 'pending',\n        currency: payment.currency as 'USDT' | 'RUB',\n      });\n      \n      logger.info('Order created successfully', { context: { orderId: order.id } });\n\n      // MONGO BACKUP: const updatedPayment = await Payment.findByIdAndUpdate(payment._id, { orderId: order._id });\n      const updatedPayment = await prisma.payment.update({\n        where: { id: payment.id },\n        data: { orderId: order.id }\n      });\n      \n      if (!updatedPayment) {\n        logger.error('Payment not found for orderId', { context: { orderId: order.id } });\n        return res.status(404).json({ error: 'Payment not found' });\n      }\n\n      // MONGO BACKUP: await User.findByIdAndUpdate(payment.userId, { $inc: { ordersCount: 1 } }, { new: true });\n      await prisma.user.update({\n        where: { id: payment.userId },\n        data: { ordersCount: { increment: 1 } }\n      });\n      logger.info('User order count updated', { context: { userId: payment.userId } });\n\n      // MONGO BACKUP: const offer = await Offer.findOne({ _id: order.offerId });\n      // MONGO BACKUP: const game = await Game.findOne({ _id: offer?.gameId });\n      const offer = await prisma.offer.findUnique({\n        where: { id: order.offerId },\n        include: { game: true }\n      });\n      const game = offer?.game;\n\n      // Send notifications\n      const orderMsg = `üì¶ *Order status changed*\\n` +\n          `üÜî Order ID: ${order.id}\\n` +\n          `üéÆ Game: ${game?.title}\\n` +\n          `üéÆ Offer: ${offer?.title}\\n` +\n          `üí∞ Amount: ${payment?.amountToPay} ${order.currency}\\n` +\n          `üìå Status: ${order.status.toUpperCase()}\\n` +\n          `üïí Created: ${new Date(order.createdAt).toLocaleString()}\\n` +\n          `üïí Modified: ${new Date(order.updatedAt).toLocaleString()}\\n`;\n\n      const message = { sender: -1, content: orderMsg, timestamp: new Date(), isSystemMessage: false };\n\n      // MONGO BACKUP: let chat = await Chat.findOne({ userId: order.userId });\n      // MONGO BACKUP: if (!chat) {\n      // MONGO BACKUP:   chat = new Chat({\n      // MONGO BACKUP:     userId: order.userId,\n      // MONGO BACKUP:     messages: [message],\n      // MONGO BACKUP:     lastReadByUser: new Date(),\n      // MONGO BACKUP:     lastReadByAdmin: new Date(0),\n      // MONGO BACKUP:     unreadAdminCount: 0,\n      // MONGO BACKUP:   });\n      // MONGO BACKUP: } else {\n      // MONGO BACKUP:   chat.messages.push(message);\n      // MONGO BACKUP: }\n      // MONGO BACKUP: await chat.save();\n      \n      await chatRepository.addMessage(order.userId, message);\n\n      const clientSocketId = clients.get(order.userId);\n\n      if (clientSocketId) {\n        io.to(clientSocketId).emit('new_message', { sender: -1, content: orderMsg });\n      }\n\n      // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n      const orders = await orderRepository.findAll();\n\n      io.to('admin').emit('new-order', orders);\n\n      logger.info('New order notification sent via WebSocket', { context: { orderId: order.id } });\n\n      const botToken = process.env.BOT_TOKEN;\n      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n\n      await axios.post(url, {\n        chat_id: order.userId,\n        text: `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–µ ‚Ññ${order.id}.`,\n        reply_markup: {\n          inline_keyboard: [[\n            {\n              text: \"üí¨ –ß–∞—Ç\",\n              web_app: {\n                url: process.env.CLIENT_URL + \"/chat\"\n              }\n            }\n          ]]\n        }\n      });\n\n      res.status(200).json({\n        \"order_id\": order_id,\n        \"status\": \"Paid\",\n        \"amount\": payment.amountToPay,\n        \"description\": \"Order \" + order_id,\n      });\n    } else {\n      // MONGO BACKUP: const payment = await Payment.findOne({ externalId: invoice_id });\n      const payment = await prisma.payment.findFirst({\n        where: { externalId: invoice_id }\n      });\n      \n      if (!payment) {\n        logger.error('Payment not found for invoice_id', { context: { invoice_id } });\n        return res.status(404).json({ error: 'Payment not found' });\n      }\n\n      res.status(200).json({\n        \"order_id\": order_id,\n        \"status\": \"Expired\",\n        \"amount\": payment.amountToPay,\n        \"description\": \"Order \" + order_id,\n      });\n    }\n\n    logger.info('Webhook processed successfully');\n  } catch (error) {\n    logger.error('Webhook processing error', { context: { error } });\n    res.status(500).json({ error: 'Internal Server Error' });\n  }\n};\n","size_bytes":14194},"server/src/routes/transactionRoutes.ts":{"content":"import { Router } from 'express';\nimport {\n  getTransactionsByRefer\n} from '../controllers/transactionController';\nimport {authenticateUser} from \"../middleware/auth\";\n\nconst router = Router();\n\n// Get transactions by refer\nrouter.get('/refer', authenticateUser, getTransactionsByRefer);\n\nexport default router;\n","size_bytes":312},"server/src/models/OrderDetails.ts":{"content":"// MONGO BACKUP: import { getMaxOrderDetailsId } from \"../helpers/index\";\n// MONGO BACKUP: import mongoose, {Schema} from \"mongoose\";\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IOrderDetails {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   orderId: number;\n// MONGO BACKUP:   entry: string | null;\n// MONGO BACKUP:   login: string | null;\n// MONGO BACKUP:   password: string | null;\n// MONGO BACKUP:   code: string | null;\n// MONGO BACKUP:   server: string;\n// MONGO BACKUP:   nickname: string;\n// MONGO BACKUP:   userInGameId: number | null;\n// MONGO BACKUP:   createdAt?: Date;\n// MONGO BACKUP:   updatedAt?: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const OrderDetailsSchema: Schema = new Schema<IOrderDetails>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     orderId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       ref: \"Order\",\n// MONGO BACKUP:     },\n// MONGO BACKUP:     entry: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     login: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     password: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     code: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     server: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     nickname: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     userInGameId: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       default: null,\n// MONGO BACKUP:     },\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true,\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: // Pre-save hook to set _id automatically\n// MONGO BACKUP: OrderDetailsSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxOrderDetailsId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Add index for efficient querying\n// MONGO BACKUP: OrderDetailsSchema.index({ orderId: 1 });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IOrderDetails>(\"OrderDetails\", OrderDetailsSchema);\n","size_bytes":2733},"client/src/store/store.ts":{"content":"import { configureStore } from \"@reduxjs/toolkit\";\nimport gamesReducer from \"./features/gamesSlice.ts\";\nimport offersReducer from \"./features/offersSlice.ts\";\nimport userReducer from \"./features/userSlice.ts\";\nimport ordersReducer from \"./features/ordersSlice.ts\";\nimport orderDetailsReducer from \"./features/orderDetailsSlice.ts\";\nimport paymentsReducer from \"./features/paymentsSlice.ts\";\nimport transactionsReducer from \"./features/transactionsSlice.ts\";\nimport referralsReducer from \"./features/referralsSlice.ts\";\nimport withdrawalsReducer from \"./features/withdrawalsSlice.ts\";\nimport reviewsReducer from \"./features/reviewsSlice.ts\";\n\nconst store = configureStore({\n  reducer: {\n    // Add your reducers here\n    games: gamesReducer,\n    offers: offersReducer,\n    user: userReducer,\n    orders: ordersReducer,\n    ordersDetails: orderDetailsReducer,\n    payments: paymentsReducer,\n    transactions: transactionsReducer,\n    referrals: referralsReducer,\n    withdrawals: withdrawalsReducer,\n    reviews: reviewsReducer\n  },\n});\n\nexport type RootState = ReturnType<typeof store.getState>;\nexport type AppDispatch = typeof store.dispatch;\nexport default store;","size_bytes":1165},"server/src/controllers/reviewController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Review from '../models/Review';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import Order from \"../models/Order\";\nimport { prisma } from '../db/client';\nimport { reviewRepository, orderRepository } from '../db';\n\nexport const createReview = async (req: Request, res: Response) => {\n  try {\n    const { orderId, rating, comment } = req.body;\n    const userId = req.telegramUser?.id;\n    const username = req.telegramUser?.username;\n\n    // MONGO BACKUP: const order = await Order.findById(orderId);\n    const order = await orderRepository.findById(parseInt(orderId));\n    if (!order) return res.status(404).json({ message: 'Order not found' });\n\n    if (order.userId !== userId) return res.status(400).json({ message: 'Order does not belong to user' });\n\n    if (rating < 1 || rating > 5) return res.status(400).json({ message: 'Rating must be between 1 and 5' });\n\n    // MONGO BACKUP: const reviewCheck = await Review.findOne({ orderId });\n    const reviewCheck = await prisma.review.findUnique({\n      where: { orderId: parseInt(orderId) }\n    });\n    if (reviewCheck) return res.status(400).json({ message: 'Review already exists' });\n\n    // MONGO BACKUP: const payload = {\n    // MONGO BACKUP:   userId,\n    // MONGO BACKUP:   orderId,\n    // MONGO BACKUP:   username,\n    // MONGO BACKUP:   rating,\n    // MONGO BACKUP:   comment\n    // MONGO BACKUP: }\n    // MONGO BACKUP: const review = new Review(payload);\n    // MONGO BACKUP: await review.save();\n    \n    const review = await reviewRepository.create({\n      user: { connect: { id: userId! } },\n      order: { connect: { id: parseInt(orderId) } },\n      username: username || '',\n      rating,\n      comment\n    });\n\n    res.status(201).json(review);\n  } catch (error) {\n    logger.error(`Error creating review: ${error}`);\n    res.status(400).json({ message: 'Error creating review', error });\n  }\n};\n\nexport const getReviews = async (req: Request, res: Response) => {\n  try {\n    // MONGO BACKUP: const reviews = await Review.find().sort({ createdAt: -1 });\n    const reviews = await reviewRepository.findAll();\n    \n    // Format dates\n    const formattedReviews = reviews.map(review => {\n      const date = new Date(review.createdAt);\n      const day = String(date.getDate()).padStart(2, '0');\n      const month = String(date.getMonth() + 1).padStart(2, '0');\n      const year = date.getFullYear();\n      const hours = String(date.getHours()).padStart(2, '0');\n      const minutes = String(date.getMinutes()).padStart(2, '0');\n      const seconds = String(date.getSeconds()).padStart(2, '0');\n      \n      const formattedDate = `${day}.${month}.${year} - ${hours}:${minutes}:${seconds}`;\n      \n      return {\n        ...review,\n        created_at: formattedDate\n      };\n    });\n    \n    res.json(formattedReviews);\n  } catch (error) {\n    logger.error(`Error fetching reviews: ${error}`);\n    res.status(500).json({ message: 'Error fetching reviews', error });\n  }\n};\n","size_bytes":3019},"start-prod.sh":{"content":"#!/bin/bash\n\n# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\nbash check-env.sh || exit 1\n\nexport NODE_ENV=production\n\necho \"üöÄ –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Tip-Top –≤ —Ä–µ–∂–∏–º–µ production...\"\necho \"\"\n\n# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä (–æ–Ω –æ—Ç–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç –∏ –∞–¥–º–∏–Ω–∫—É –∫–∞–∫ —Å—Ç–∞—Ç–∏–∫—É)\ncd /home/runner/workspace/server && npm run start &\nSERVER_PID=$!\n\n# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞\ncd /home/runner/workspace/bot && npm run start &\nBOT_PID=$!\n\necho \"‚úÖ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top –∑–∞–ø—É—â–µ–Ω–∞ –≤ production —Ä–µ–∂–∏–º–µ!\"\necho \"\"\n\n# –î–µ—Ä–∂–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–Ω—ã–º\nwait $SERVER_PID $BOT_PID\n","size_bytes":650},"client/src/api/axiosInstance.ts":{"content":"import axios from 'axios';\nimport { getInitData } from '../utils/telegram';\n\nconst axiosInstance = axios.create({\n    baseURL: `${import.meta.env.VITE_API_URL}/api`,\n    headers: {\n        'Content-Type': 'application/json',\n    },\n});\n\naxiosInstance.interceptors.request.use((config) => {\n    config.headers['X-Telegram-InitData'] = getInitData();\n    return config;\n});\n\nexport default axiosInstance;\n","size_bytes":403},"server/src/controllers/chatController.ts":{"content":"// import { Request, Response } from 'express';\n// import { Chat, IMessage } from '../models/Chat';\n// import { logger } from '../config/logger';\n// import mongoose from 'mongoose';\n\n// export const createChat = async (req: Request, res: Response) => {\n//   try {\n//     const { clientId } = req.body;\n//     logger.info('Attempting to create a new chat', { context: { clientId } });\n\n//     const existingChat = await Chat.findOne({ client: clientId });\n//     if (existingChat) {\n//       logger.warn('Chat already exists for this client', { context: { clientId } });\n//       return res.status(400).json({ message: 'Chat already exists for this client' });\n//     }\n\n//     const chat = new Chat({ client: clientId });\n//     await chat.save();\n\n//     logger.info('Chat created successfully', { context: { clientId, chatId: chat._id } });\n//     res.status(201).json(chat);\n//   } catch (error) {\n//     logger.error('Error creating chat', { context: { error } });\n//     res.status(500).json({ message: 'Internal server error' });\n//   }\n// };\n\n// export const getChat = async (req: Request, res: Response) => {\n//   try {\n//     const { clientId } = req.params;\n//     logger.info('Fetching chat for client', { context: { clientId } });\n\n//     const chat = await Chat.findOne({ client: clientId }).populate('messages.sender', 'username');\n//     if (!chat) {\n//       logger.warn('Chat not found for client', { context: { clientId } });\n//       return res.status(404).json({ message: 'Chat not found' });\n//     }\n\n//     logger.info('Chat fetched successfully', { context: { clientId, chatId: chat._id } });\n//     res.json(chat);\n//   } catch (error) {\n//     logger.error('Error fetching chat', { context: { error } });\n//     res.status(500).json({ message: 'Internal server error' });\n//   }\n// };\n\n// export const getAllChats = async (req: Request, res: Response) => {\n//   try {\n//     logger.info('Fetching all chats');\n//     const chats = await Chat.find().populate('client', 'username').populate('messages.sender', 'username');\n\n//     logger.info('All chats fetched successfully', { context: { chatCount: chats.length } });\n//     res.json(chats);\n//   } catch (error) {\n//     logger.error('Error fetching all chats', { context: { error } });\n//     res.status(500).json({ message: 'Internal server error' });\n//   }\n// };\n\n// export const sendMessage = async (req: Request, res: Response) => {\n//   try {\n//     const { clientId } = req.params;\n//     const { content, senderId, isSystemMessage = false } = req.body;\n\n//     logger.info('Attempting to send a message', { context: { clientId, senderId, isSystemMessage } });\n\n//     const chat = await Chat.findOne({ client: clientId });\n//     if (!chat) {\n//       logger.warn('Chat not found for client', { context: { clientId } });\n//       return res.status(404).json({ message: 'Chat not found' });\n//     }\n\n//     const messageInput: IMessage = {\n//       sender: new mongoose.Types.ObjectId(senderId.toString()),\n//       content,\n//       timestamp: new Date(),\n//       isSystemMessage,\n//     };\n\n//     chat.messages.push(messageInput as any);\n//     await chat.save();\n\n//     logger.info('Message sent successfully', { context: { clientId, senderId, messageId: messageInput.sender } });\n//     res.status(201).json(messageInput);\n//   } catch (error) {\n//     logger.error('Error sending message', { context: { error } });\n//     res.status(500).json({ message: 'Internal server error' });\n//   }\n// };\n\n// export const sendSystemMessage = async (clientId: string, content: string) => {\n//   try {\n//     logger.info('Attempting to send a system message', { context: { clientId, content } });\n\n//     const chat = await Chat.findOne({ client: clientId });\n//     if (!chat) {\n//       logger.warn('Chat not found for client', { context: { clientId } });\n//       throw new Error('Chat not found');\n//     }\n\n//     const messageInput: IMessage = {\n//       sender: new mongoose.Types.ObjectId((process.env.SYSTEM_USER_ID || '000000000000000000000000').toString()),\n//       content,\n//       timestamp: new Date(),\n//       isSystemMessage: true,\n//     };\n\n//     chat.messages.push(messageInput as any);\n//     await chat.save();\n\n//     logger.info('System message sent successfully', { context: { clientId, messageId: messageInput.sender } });\n//     return messageInput;\n//   } catch (error) {\n//     logger.error('Error sending system message', { context: { error } });\n//     throw error;\n//   }\n// };","size_bytes":4494},"admin/src/components/ChatsPanel.tsx":{"content":"import { useEffect, useRef } from 'react';\nimport {LucideArrowLeft} from \"lucide-react\";\n\ninterface Message {\n    sender: number;\n    content: string;\n    timestamp: string;\n}\n\nconst ChatsPanel = ({\n                        chatMap,\n                        selectedUserId,\n                        chatVisible,\n                        setChatVisible,\n                        setSelectedUserId,\n                        handleSelectedUserId,\n                        input,\n                        setInput,\n                        handleReply,\n                        unreadCounts,\n                    }: {\n    chatMap: Record<number, Message[]>;\n    selectedUserId: number | null;\n    chatVisible: boolean;\n    setChatVisible: (visible: boolean) => void;\n    setSelectedUserId: (id: number | null) => void;\n    handleSelectedUserId: (id: number | null) => void;\n    input: string;\n    setInput: (value: string) => void;\n    handleReply: () => void;\n    unreadCounts: Record<number, number>;\n}) => {\n    const messagesEndRef = useRef<HTMLDivElement | null>(null);\n\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }, [selectedUserId, chatMap]);\n\n    const closeChat = () => {\n        setSelectedUserId(null);\n        setChatVisible(false);\n    }\n\n    return (\n        <>\n            <div style={chatVisible ? {display: \"none\"} : {display: \"block\"}} className=\"w-fit border-r border-gray-700 p-4 overflow-y-auto overflow-x-hidden\">\n                <h2 className=\"text-xl font-bold mb-4 border-b border-gray-700 pb-2\">Users</h2>\n                {Object.keys(chatMap).length === 0 && (\n                    <p className=\"text-gray-400\">No active chats</p>\n                )}\n                {Object.keys(chatMap).map((userId) => {\n                    const idNum = Number(userId);\n                    const unread = unreadCounts[idNum] || 0;\n                    return (\n                        <div\n                            key={userId}\n                            onClick={() => handleSelectedUserId(idNum)}\n                            className={`cursor-pointer p-3 rounded mb-1 ${\n                                selectedUserId === idNum ? \"bg-blue-600\" : \"hover:bg-gray-700\"\n                            } flex justify-between items-center`}\n                        >\n                            <span>User {userId}</span>\n                            {unread > 0 && (\n                                <span className=\"bg-red-600 text-xs px-2 py-0.5 rounded-full font-semibold\">\n                    {unread}\n                  </span>\n                            )}\n                        </div>\n                    );\n                })}\n            </div>\n            <div style={chatVisible ? {display: \"flex\"} : {display: \"none\"}} className=\"w-screen flex flex-col p-4\">\n                {selectedUserId !== null ? (\n                    <>\n                        <button onClick={() => closeChat()} className=\"w-[40px] py-1 rounded-lg mb-2 flex justify-center bg-blue-600 text-white transition cursor-pointer\">\n                            <LucideArrowLeft />\n                        </button>\n                        <div className=\"w-full overflow-y-auto mb-4 space-y-3 bg-gray-800 p-4 rounded\">\n                            {chatMap[selectedUserId]?.map((msg, idx) => (\n                                <div\n                                    key={idx}\n                                    className={`p-3 rounded max-w-md break-words ${\n                                        msg.sender === 0\n                                            ? \"ml-auto bg-blue-600 text-white\"\n                                            : \"mr-auto bg-gray-700 text-gray-200\"\n                                    }`}\n                                >\n                                    {msg.content}\n                                </div>\n                            ))}\n                            <div ref={messagesEndRef} />\n                        </div>\n                        <div className=\"flex\">\n                            <input\n                                type=\"text\"\n                                className=\"flex-1 border border-gray-600 bg-gray-700 px-4 py-2 rounded-l text-white focus:outline-none\"\n                                value={input}\n                                onChange={(e) => setInput(e.target.value)}\n                                onKeyDown={(e) => e.key === \"Enter\" && handleReply()}\n                                placeholder=\"Reply to user...\"\n                                autoFocus\n                            />\n                            <button\n                                onClick={handleReply}\n                                className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-r transition\"\n                            >\n                                Send\n                            </button>\n                        </div>\n                    </>\n                ) : (\n                    <p className=\"text-gray-400\">Select a user to start chatting</p>\n                )}\n            </div>\n        </>\n    );\n}\n\nexport default ChatsPanel;","size_bytes":5148},"server/src/controllers/paymentController.ts":{"content":"import { Request, Response } from 'express';\nimport { CryptoPay } from '@foile/crypto-pay-api';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import Payment from '../models/Payment';\n// MONGO BACKUP: import Game from '../models/Game';\n// MONGO BACKUP: import Offer from '../models/Offer';\nimport axios from \"axios\";\nimport { prisma } from '../db/client';\nimport { paymentRepository } from '../db';\n\nconst cryptoPay = new CryptoPay(process.env.CRYPTOPAY_API_KEY!);\n\nexport const createCryptoInvoice = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    const { gameName, offerName, price } = req.body;\n\n    // Validate price\n    const amountToPay = parseFloat(price);\n    if (isNaN(amountToPay) || amountToPay <= 0) {\n      logger.error(\"Validation data for new crypto invoice failed: Invalid price provided\", {\n        context: { userId, gameName, offerName, price, stack: new Error(\"Invalid price provided\").stack },\n      });\n      return res.status(400).json({ error: \"Invalid price\" });\n    }\n\n    if (!userId || userId <= 0) {\n      logger.error(\"Validation data for new crypto invoice failed: Invalid userId provided\", {\n        context: { userId, gameName, offerName, price, stack: new Error(\"Invalid userId provided\").stack },\n      });\n      return res.status(400).json({ error: \"Invalid userId\" });\n    }\n\n    // MONGO BACKUP: const game = await Game.findOne({ title: gameName }).select('_id').lean().exec();\n    // MONGO BACKUP: const gameIdValue = game?._id;\n    const game = await prisma.game.findFirst({\n      where: { title: gameName },\n      select: { id: true }\n    });\n    const gameIdValue = game?.id;\n    \n    if (!gameIdValue) {\n      logger.error(\"Validation data for new crypto invoice failed: Game not found\", {\n        context: { userId, gameName, offerName, price },\n      });\n      return res.status(404).json({ error: \"Game not found\" });\n    }\n\n    // MONGO BACKUP: const offer = await Offer.findOne({ title: offerName, gameId: gameIdValue }).select('_id').lean().exec();\n    // MONGO BACKUP: const offerIdValue = offer?._id;\n    const offer = await prisma.offer.findFirst({\n      where: { \n        title: offerName, \n        gameId: gameIdValue \n      },\n      select: { id: true }\n    });\n    const offerIdValue = offer?.id;\n    \n    if (!offerIdValue) {\n      logger.error(\"Validation data for new crypto invoice failed: Offer not found\", {\n        context: { userId, gameName, offerName, price },\n      });\n      return res.status(404).json({ error: \"Offer not found\" });\n    }\n\n    // Construct hidden message for the invoice\n    const hiddenMessage = `üîó Bot: https://t.me/TipTop999_bot\\nüõí Please visit the bot to complete your order üëá`;\n\n    logger.info(\"Creating crypto invoice\", {\n      context: { userId, offerId: offerIdValue },\n    });\n\n    // Create invoice using CryptoPay API\n    const invoice = await cryptoPay.createInvoice(\"USDT\", amountToPay, {\n      hidden_message: hiddenMessage,\n      allow_comments: true,\n      allow_anonymous: false,\n      paid_btn_name: \"openBot\",\n      paid_btn_url: `https://t.me/TipTop999_bot`,\n    });\n\n    if (!invoice || !invoice.pay_url) {\n      logger.error(\"Crypto invoice creation failed or missing payment URL\", {\n        context: { userId, payUrl: invoice?.pay_url, offerId: offerIdValue, stack: new Error(\"Invoice creation failed\").stack },\n      });\n      return res.status(500).json({ error: \"Invoice creation failed\" });\n    }\n\n    logger.info(\"Invoice created successfully\", {\n      context: { userId, invoiceId: invoice.invoice_id, orderId: null, offerId: offerIdValue },\n    });\n\n    // MONGO BACKUP: const payment = new Payment({\n    // MONGO BACKUP:   externalId: invoice.invoice_id,\n    // MONGO BACKUP:   userId: userId,\n    // MONGO BACKUP:   orderId: null,\n    // MONGO BACKUP:   offerId: offerIdValue,\n    // MONGO BACKUP:   amountToPay: amountToPay,\n    // MONGO BACKUP:   currency: \"USDT\",\n    // MONGO BACKUP:   status: \"pending\",\n    // MONGO BACKUP: });\n    // MONGO BACKUP: await payment.save();\n\n    const payment = await paymentRepository.create({\n      externalId: invoice.invoice_id,\n      user: { connect: { id: userId } },\n      offer: { connect: { id: offerIdValue } },\n      amountToPay: amountToPay,\n      currency: \"USDT\",\n      status: \"pending\",\n    });\n\n    logger.info(\"Payment record saved successfully\", {\n      context: { userId, paymentId: payment.id, invoiceId: invoice.invoice_id },\n    });\n\n    // Respond with the invoice details\n    return res.status(201).json({\n      success: true,\n      invoice: {\n        status: invoice.status,\n        payUrl: invoice.pay_url,\n        miniAppInvoiceUrl: invoice.mini_app_invoice_url,\n      }\n    });\n  } catch (error) {\n    logger.error(\"Error creating crypto invoice\", {\n      context: { stack: error },\n    });\n    return res.status(500).json({ error: \"Failed to create invoice\" });\n  }\n};\n\nexport const getAllByMe = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n\n    if (!userId || userId <= 0) {\n      logger.error(\"Validation data for fetching payments failed: Invalid userId provided\", {\n        context: { userId, stack: new Error(\"Invalid userId provided\").stack },\n      });\n      return res.status(400).json({ error: \"Invalid userId\" });\n    }\n\n    // MONGO BACKUP: const payments = await Payment.find({ userId }).exec();\n    const payments = await paymentRepository.findByUserId(userId);\n\n    if (!payments || payments.length === 0) {\n      logger.info(\"No payments found for the given userId\", {\n        context: { userId },\n      });\n      return res.status(404).json({ error: \"No payments found\" });\n    }\n\n    return res.status(200).json(payments);\n  } catch (error) {\n    logger.error(\"Error fetching payments\", {\n      context: { stack: error },\n    });\n    return res.status(500).json({ error: \"Failed to fetch payments\" });\n  }\n}\n\nexport const createRubInvoice = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    const { gameName, offerName, price } = req.body;\n\n    // Validate price\n    const amountToPay = parseFloat(price);\n    if (isNaN(amountToPay) || amountToPay < 100) {\n      logger.error(\"Validation data for new rub invoice failed: Invalid price provided\", {\n        context: { userId, gameName, offerName, price, stack: new Error(\"Invalid price provided\").stack },\n      });\n      return res.status(400).json({ error: \"Invalid price\" });\n    }\n\n    if (!userId || userId <= 0) {\n      logger.error(\"Validation data for new rub invoice failed: Invalid userId provided\", {\n        context: { userId, gameName, offerName, price, stack: new Error(\"Invalid userId provided\").stack },\n      });\n      return res.status(400).json({ error: \"Invalid userId\" });\n    }\n\n    // MONGO BACKUP: const game = await Game.findOne({ title: gameName }).select('_id').lean().exec();\n    // MONGO BACKUP: const gameIdValue = game?._id;\n    const game = await prisma.game.findFirst({\n      where: { title: gameName },\n      select: { id: true }\n    });\n    const gameIdValue = game?.id;\n\n    if (!gameIdValue) {\n      logger.error(\"Validation data for new rub invoice failed: Game not found\", {\n        context: { userId, gameName, offerName, price },\n      });\n      return res.status(404).json({ error: \"Game not found\" });\n    }\n\n    // MONGO BACKUP: const offer = await Offer.findOne({ title: offerName, gameId: gameIdValue }).select('_id').lean().exec();\n    // MONGO BACKUP: const offerIdValue = offer?._id;\n    const offer = await prisma.offer.findFirst({\n      where: { \n        title: offerName, \n        gameId: gameIdValue \n      },\n      select: { id: true }\n    });\n    const offerIdValue = offer?.id;\n    \n    if (!offerIdValue) {\n      logger.error(\"Validation data for new rub invoice failed: Offer not found\", {\n        context: { userId, gameName, offerName, price },\n      });\n      return res.status(404).json({ error: \"Offer not found\" });\n    }\n\n    logger.info(\"Creating rub invoice\", {\n      context: { userId, offerId: offerIdValue },\n    });\n\n    // Create a rub invoice using BLVCKPAY API\n    let invoice: {\n      \"urlv2\": string;\n      \"order_id\": string;\n      \"status\": string;\n    };\n\n    try {\n      invoice = await axios.post(\"https://payment.blvckpay.com/sbp/order/create\", {\n        \"amount\": amountToPay,\n        \"signature\": \"b28fa2bb-27dd-47a7-a52d-1448ef716d90\",\n      })\n    } catch (error) {\n      logger.error(\"Error creating rub invoice\", {\n        context: { stack: error },\n      });\n      return res.status(500).json({ error: \"Failed to create invoice\" });\n    }\n\n    if (!invoice || !invoice.urlv2) {\n      logger.error(\"Crypto invoice creation failed or missing payment URL\", {\n        context: { userId, payUrl: invoice?.urlv2, offerId: offerIdValue, stack: new Error(\"Invoice creation failed\").stack },\n      });\n      return res.status(500).json({ error: \"Invoice creation failed\" });\n    }\n\n    logger.info(\"Invoice created successfully\", {\n      context: { userId, invoiceId: invoice.order_id, orderId: null, offerId: offerIdValue },\n    });\n\n    // MONGO BACKUP: const payment = new Payment({\n    // MONGO BACKUP:   externalId: invoice.order_id,\n    // MONGO BACKUP:   userId: userId,\n    // MONGO BACKUP:   orderId: null,\n    // MONGO BACKUP:   offerId: offerIdValue,\n    // MONGO BACKUP:   amountToPay: amountToPay,\n    // MONGO BACKUP:   currency: \"RUB\",\n    // MONGO BACKUP:   status: \"pending\",\n    // MONGO BACKUP: });\n    // MONGO BACKUP: await payment.save();\n\n    const payment = await paymentRepository.create({\n      externalId: invoice.order_id,\n      user: { connect: { id: userId } },\n      offer: { connect: { id: offerIdValue } },\n      amountToPay: amountToPay,\n      currency: \"RUB\",\n      status: \"pending\",\n    });\n\n    logger.info(\"Payment record saved successfully\", {\n      context: { userId, paymentId: payment.id, invoiceId: invoice.order_id },\n    });\n\n    // Respond with the invoice details\n    return res.status(201).json({\n      success: true,\n      invoice: {\n        status: invoice.status,\n        payUrl: invoice.urlv2,\n      }\n    });\n  } catch (error) {\n    logger.error(\"Error creating rub invoice\", {\n      context: { stack: error },\n    });\n    return res.status(500).json({ error: \"Failed to create invoice\" });\n  }\n};\n","size_bytes":10340},"start-dev.sh":{"content":"#!/bin/bash\n\n# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\nbash check-env.sh || exit 1\n\n# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CLIENT_URL –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω\nif [ -z \"$CLIENT_URL\" ]; then\n    export CLIENT_URL=\"https://${REPL_SLUG}.${REPL_OWNER}.repl.co\"\n    echo \"‚ÑπÔ∏è  CLIENT_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: $CLIENT_URL\"\n    echo \"\"\nfi\n\necho \"üöÄ –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Tip-Top –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...\"\necho \"\"\necho \"üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:\"\necho \"   - üñ•Ô∏è  –°–µ—Ä–≤–µ—Ä (Express + Socket.IO + MongoDB)\"\necho \"   - ü§ñ Telegram –ë–æ—Ç\"\necho \"   - üåê –ö–ª–∏–µ–Ω—Ç (React)\"  \necho \"   - üë®‚Äçüíº –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (React)\"\necho \"\"\n\n# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é server –∏ –∑–∞–ø—É—Å–∫–∞–µ–º\ncd /home/runner/workspace/server\n\n# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –∏ –±–æ—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ\necho \"üîß –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞...\"\nnpm run dev &\nSERVER_PID=$!\n\necho \"üîß –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...\"\ncd /home/runner/workspace/bot\nnpm run dev &\nBOT_PID=$!\n\n# –í dev —Ä–µ–∂–∏–º–µ –∫–ª–∏–µ–Ω—Ç –∏ –∞–¥–º–∏–Ω –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ\n# –í production –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–¥–∞–≤–∞—Ç—å—Å—è –∫–∞–∫ —Å—Ç–∞—Ç–∏–∫–∞ –∏–∑ server\n\necho \"\"\necho \"‚úÖ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top –∑–∞–ø—É—â–µ–Ω–∞!\"\necho \"\"\necho \"üìç –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:\"\necho \"   - API —Å–µ—Ä–≤–µ—Ä: http://localhost:3000\"\necho \"   - Telegram –±–æ—Ç: –∞–∫—Ç–∏–≤–µ–Ω\"\necho \"\"\necho \"üí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∞–¥–º–∏–Ω–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã:\"\necho \"   - –ö–ª–∏–µ–Ω—Ç: cd client && npm run dev\"\necho \"   - –ê–¥–º–∏–Ω: cd admin && npm run dev\"\necho \"\"\n\n# –î–µ—Ä–∂–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–Ω—ã–º\nwait $SERVER_PID $BOT_PID\n","size_bytes":1783},"server/src/middleware/auth.ts":{"content":"import { Request, Response, NextFunction } from 'express';\nimport { logger } from '../config/logger';\nimport dotenv from 'dotenv';\nimport console from \"node:console\";\nimport * as process from \"node:process\";\nimport { isValid } from '@telegram-apps/init-data-node';\n\ndotenv.config();\nconst TELEGRAM_BOT_TOKEN = process.env.BOT_TOKEN || '';\nif (!TELEGRAM_BOT_TOKEN) {\n  logger.error('BOT_TOKEN is not defined in the environment variables');\n  throw new Error('BOT_TOKEN is not defined in the environment variables');\n}\n\ninterface TelegramUser {\n  id: number;\n  first_name: string;\n  last_name?: string;\n  username?: string;\n  language_code?: string;\n  photo_url?: string;\n}\n\ndeclare module 'express-serve-static-core' {\n  interface Request {\n    telegramUser?: {\n      id: number;\n      first_name: string;\n      last_name?: string;\n      username?: string;\n      language_code?: string;\n      photo_url?: string;\n    };\n  }\n}\n\nfunction parseInitData(initData: string): TelegramUser | null {\n  const parsed = new URLSearchParams(initData);\n  const userJson = parsed.get('user');\n  if (!userJson) return null;\n  try {\n    return JSON.parse(userJson);\n  } catch {\n    return null;\n  }\n}\n\nexport const authenticateUser = (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const initData = req.headers['x-telegram-initdata'] as string;\n    \n    logger.info('Authentication request received', { context: { initData } });\n\n    if (!initData) {\n      logger.error('Missing initData: ', initData);\n      return res.status(401).json({ message: 'Missing initData' });\n    }\n\n    if (process.env.NODE_ENV === 'production') {\n      if (!isValid(initData, TELEGRAM_BOT_TOKEN)) {\n        logger.error('Invalid initData: ', initData);\n        return res.status(401).json({ message: 'Invalid initData' });\n      }\n    }\n\n    const user = parseInitData(initData);\n    if (!user) {\n      return res.status(401).json({ message: 'Invalid user data' });\n    }\n\n    logger.info('Authentication successful', { context: { userId: user.id } });\n\n    req.telegramUser = user;\n    next();\n  } catch (error) {\n    console.error('Authentication error:', error);\n    res.status(401).json({ message: 'Authentication failed' });\n  }\n};","size_bytes":2217},"client/src/layouts/SecondaryLayout.tsx":{"content":"import Footer from '../components/Footer'\nimport { Outlet } from 'react-router-dom'\nimport SwitchGamesPanel from '../components/SwitchGamesPanel'\n\nconst SecondaryLayout = () => {\n  return (\n    <div className='flex flex-col h-screen'>\n      <SwitchGamesPanel />\n      <main className='flex justify-center w-full h-screen flex-grow overflow-y-hidden'>\n        <Outlet />\n      </main>\n      <Footer />\n    </div>\n  )\n}\n\nexport default SecondaryLayout\n","size_bytes":450},"server/src/models/Game.ts":{"content":"// MONGO BACKUP: import { getMaxGameId } from '../helpers';\n// MONGO BACKUP: import { Schema, model } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IGame {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   title: string;\n// MONGO BACKUP:   imageUrl: string;\n// MONGO BACKUP:   gifUrl: string;\n// MONGO BACKUP:   hasDiscount: boolean;\n// MONGO BACKUP:   isActual: boolean;\n// MONGO BACKUP:   isEnabled: boolean;\n// MONGO BACKUP:   appleStoreUrl: string;\n// MONGO BACKUP:   googlePlayUrl: string;\n// MONGO BACKUP:   trailerUrl: string;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const GameSchema = new Schema<IGame>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     title: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     imageUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     gifUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     hasDiscount: {\n// MONGO BACKUP:       type: Boolean,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:       default: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     isActual: {\n// MONGO BACKUP:       type: Boolean,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:       default: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     isEnabled: {\n// MONGO BACKUP:       type: Boolean,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:       default: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     appleStoreUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     googlePlayUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     trailerUrl: {\n// MONGO BACKUP:       type: String,\n// MONGO BACKUP:       required: true,\n// MONGO BACKUP:     },\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true,\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: GameSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) {\n// MONGO BACKUP:     this._id = (await getMaxGameId()) + 1;\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export default model<IGame>('Game', GameSchema);\n","size_bytes":2583},"bot/src/services/message.service.ts":{"content":"import { Context } from 'telegraf';\nimport { InlineKeyboardMarkup, ReplyKeyboardMarkup } from 'telegraf/typings/core/types/typegram';\nimport { localization } from '../config/localization';\nimport {Game} from \"./game.service\";\nimport {User} from \"./user.service\";\n\n/**\n * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏\n * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π\n */\nexport class MessageService {\n  private userMessageIds: Map<number, number> = new Map();\n\n  /**\n   * –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  private getLocalization(language?: string) {\n    return language === 'en' ? localization('en') : localization('ru');\n  }\n\n  /**\n   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  storeMessageId(userId: number, messageId: number): void {\n    this.userMessageIds.set(userId, messageId);\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∏—Ç—å ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n   */\n  getMessageIdToEdit(userId: number): number | undefined {\n    return this.userMessageIds.get(userId);\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n   */\n  createPersistentKeyboard(language?: string): ReplyKeyboardMarkup {\n    const loc = this.getLocalization(language);\n    \n    return {\n      keyboard: [\n        [{ text: loc.buttons.menu }],\n        [{ text: loc.buttons.support, web_app: { url: 'https://mobile-games.online/' } }]\n      ],\n      resize_keyboard: true,\n      is_persistent: true\n    };\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n   */\n  createMainMenuKeyboard(language?: string, userId?: number, game?: any, isUserPlaying?: boolean): InlineKeyboardMarkup {\n    const loc = this.getLocalization(language);\n    \n    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤\n    const googlePlayUrl = game?.googlePlayUrl || 'https://play.google.com';\n    const appStoreUrl = game?.appStoreUrl || 'https://apps.apple.com';\n    const webAppUrl = 'https://mobile-games.online/';\n\n    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ Play/Stop\n    const playStopButton = isUserPlaying\n      ? { text: loc.buttons.stop, callback_data: 'banner_stop' }\n      : { text: loc.buttons.play, callback_data: 'banner_play' };\n    \n    return {\n      inline_keyboard: [\n        [\n          { text: loc.buttons.appStore, url: appStoreUrl },\n          { text: loc.buttons.googlePlay, url: googlePlayUrl }\n        ],\n        [\n          { text: loc.buttons.prev, callback_data: 'banner_prev' },\n          playStopButton,\n          { text: loc.buttons.next, callback_data: 'banner_next' }\n        ],\n        [\n          { text: loc.buttons.catalog, url: 'https://t.me/mobile_games_tp' },\n          { text: loc.buttons.news, url: 'https://t.me/tiptop_mgn' }\n        ],\n        [\n          { text: loc.buttons.cabinet, callback_data: 'cabinet' },\n          { text: loc.buttons.about, web_app: { url: webAppUrl + \"about\" } }\n        ],\n        [\n          { text: loc.buttons.support, web_app: { url: webAppUrl + \"chat\" } },\n          { text: loc.buttons.reviews, web_app: { url: webAppUrl + \"reviews\" } }\n        ],\n        [\n          { text: loc.buttons.language, callback_data: 'language' },\n          { text: loc.buttons.share, switch_inline_query: '' }\n        ]\n      ]\n    };\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞\n   */\n  createCabinetKeyboard(l: any, webAppUrl: string): InlineKeyboardMarkup {\n    return {\n        inline_keyboard: [\n            [\n                { text: l.buttons.referralProgram, web_app: { url: webAppUrl } },\n                { text: l.buttons.orders, web_app: { url: webAppUrl } }\n            ],\n            [\n                { text: l.buttons.refresh, callback_data: 'refresh' },\n                { text: l.buttons.withdraw, web_app: { url: webAppUrl } }\n            ],\n            [\n                { text: l.buttons.back, callback_data: 'back_to_menu' },\n                { text: l.buttons.chat, web_app: { url: webAppUrl } }\n            ]\n        ]\n    };\n}\n\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞\n   */\n  createLanguageKeyboard(): InlineKeyboardMarkup {\n    return {\n      inline_keyboard: [\n        [\n          { text: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', callback_data: 'lang_ru' },\n          { text: 'üá¨üáß English', callback_data: 'lang_en' }\n        ]\n      ]\n    };\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É \"–ù–∞–∑–∞–¥\"\n   */\n  createBackKeyboard(language?: string): InlineKeyboardMarkup {\n    const loc = this.getLocalization(language);\n    \n    return {\n      inline_keyboard: [\n        [{ text: loc.buttons.back, callback_data: 'back' }]\n      ]\n    };\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏\n   */\n  createSubscriptionKeyboard(channelUrl: string, language?: string): InlineKeyboardMarkup {\n    const loc = this.getLocalization(language);\n    \n    return {\n      inline_keyboard: [\n        [\n          { text: loc.buttons.subscribe, url: channelUrl }\n        ],\n        [\n          { text: loc.buttons.checkSubscription, callback_data: 'check_subscription' }\n        ]\n      ]\n    };\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–π\n   */\n  async sendOrEditGameMessage(\n    ctx: Context,\n    game: Game,\n    caption: string,\n    keyboard: InlineKeyboardMarkup,\n    useGif: boolean = false\n  ): Promise<void> {\n    const userId = ctx.from?.id;\n    if (!userId) return;\n\n    const messageIdToEdit = this.getMessageIdToEdit(userId);\n    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º GIF –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É\n    const hasGif = game.gifUrl && game.gifUrl.trim() !== '';\n    const mediaUrl = hasGif ? game.gifUrl : game.imageUrl;\n    const isGif = hasGif;\n\n    try {\n      if (messageIdToEdit) {\n        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n        await ctx.telegram.editMessageMedia(\n          ctx.chat!.id,\n          messageIdToEdit,\n          undefined,\n          {\n            type: isGif ? 'animation' : 'photo',\n            media: mediaUrl,\n            caption: caption,\n            parse_mode: 'HTML'\n          },\n          {\n            reply_markup: keyboard\n          }\n        );\n      } else {\n        throw new Error('No message to edit');\n      }\n    } catch (error) {\n      // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n      try {\n        const sentMessage = isGif \n          ? await ctx.replyWithAnimation(mediaUrl, {\n              caption: caption,\n              parse_mode: 'HTML',\n              reply_markup: keyboard\n            })\n          : await ctx.replyWithPhoto(mediaUrl, {\n              caption: caption,\n              parse_mode: 'HTML',\n              reply_markup: keyboard\n            });\n        \n        this.storeMessageId(userId, sentMessage.message_id);\n      } catch (sendError) {\n        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', sendError);\n      }\n    }\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n   */\n  async sendTextMessage(\n    ctx: Context,\n    text: string,\n    keyboard?: InlineKeyboardMarkup,\n    parseMode: 'HTML' | 'Markdown' = 'HTML'\n  ): Promise<void> {\n    try {\n      const sentMessage = await ctx.reply(text, {\n        parse_mode: parseMode,\n        reply_markup: keyboard\n      });\n      \n      if (ctx.from?.id) {\n        this.storeMessageId(ctx.from.id, sentMessage.message_id);\n      }\n    } catch (error) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);\n    }\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å—å –¥–ª—è –∏–≥—Ä—ã\n   */\n  createGameCaption(game: Game, language?: string): string {\n    const loc = this.getLocalization(language);\n    \n    let caption = `<b>${game.title}</b>\n\n`;\n    \n    if (game.hasDiscount) {\n      caption += `${loc.emojis.fire} <b>${loc.core.discount}</b>\n`;\n    }\n    \n    caption += `${loc.core.tapToPlay}`;\n    \n    return caption;\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞\n   */\n  createCabinetMessage(user: User, referralLink: string, language?: string): string {\n    const loc = this.getLocalization(language);\n    \n    return `${loc.cabinet.title}\n\n` +\n           `${loc.cabinet.balance}: <b>${user.balanceRUB} ${loc.cabinet.currency}</b>\n` +\n           `${loc.cabinet.referrals}: <b>${user.referralPercent}%</b>\n` +\n           `${loc.cabinet.earnings}: <b>${user.balanceUSDT} USDT</b>\n` +\n           `${loc.cabinet.orders}: <b>${user.ordersCount}</b>\n\n` +\n           `${loc.cabinet.yourReferralLink}:\n<code>${referralLink}</code>`;\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ \"–û –±–æ—Ç–µ\"\n   */\n  createAboutMessage(language?: string): string {\n    const loc = this.getLocalization(language);\n    return loc.pages.about;\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\n   */\n  createSupportMessage(supportUrl: string, language?: string): string {\n    const loc = this.getLocalization(language);\n    return `${loc.pages.support}\n\n${supportUrl}`;\n  }\n\n  /**\n   * –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  async deleteUserMessage(ctx: Context): Promise<void> {\n    try {\n      await ctx.deleteMessage();\n    } catch (error) {\n      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–æ)\n    }\n  }\n\n  /**\n   * –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback query\n   */\n  async answerCallbackQuery(ctx: Context, text?: string, showAlert: boolean = false): Promise<void> {\n    try {\n      await ctx.answerCbQuery(text, { show_alert: showAlert });\n    } catch (error) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback query:', error);\n    }\n  }\n\n  /**\n   * –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ ID —Å–æ–æ–±—â–µ–Ω–∏–π\n   */\n  clearMessageIds(): void {\n    this.userMessageIds.clear();\n  }\n\n  /**\n   * –£–¥–∞–ª–∏—Ç—å ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  removeMessageId(userId: number): void {\n    this.userMessageIds.delete(userId);\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º singleton instance\nexport const messageService = new MessageService();\n","size_bytes":10400},"server/src/models/User.ts":{"content":"// MONGO BACKUP: import mongoose, { Schema } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IUser {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   username: string;\n// MONGO BACKUP:   language: string;\n// MONGO BACKUP:   isBanned: boolean;\n// MONGO BACKUP:   isSubscribed: boolean;\n// MONGO BACKUP:   avatarUrl?: string;\n// MONGO BACKUP:   balanceRUB: number;\n// MONGO BACKUP:   balanceUSDT: number;\n// MONGO BACKUP:   ordersCount: number;\n// MONGO BACKUP:   referralPercent: number;\n// MONGO BACKUP:   acceptedPrivacyConsent: boolean;\n// MONGO BACKUP:   createdAt?: Date;\n// MONGO BACKUP:   updatedAt?: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const UserSchema: Schema = new Schema({\n// MONGO BACKUP:   _id: { type: Number, required: true },\n// MONGO BACKUP:   username: { type: String, required: true },\n// MONGO BACKUP:   language: { type: String, default: 'ru' },\n// MONGO BACKUP:   isBanned: { type: Boolean, default: false },\n// MONGO BACKUP:   isSubscribed: { type: Boolean, default: false },\n// MONGO BACKUP:   avatarUrl: { type: String, default: '' },\n// MONGO BACKUP:   balanceRUB: { type: Number, default: 0 },\n// MONGO BACKUP:   balanceUSDT: { type: Number, default: 0 },\n// MONGO BACKUP:   ordersCount: { type: Number, default: 0 },\n// MONGO BACKUP:   referralPercent: { type: Number, default: 1 },\n// MONGO BACKUP:   acceptedPrivacyConsent: { type: Boolean, default: false },\n// MONGO BACKUP: }, {\n// MONGO BACKUP:   timestamps: true\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IUser>('User', UserSchema);\n","size_bytes":1607},"bot/README.md":{"content":"# üéÆ Telegram Bot - Tip-Top Games\n\n> ü§ñ Production-ready Telegram –±–æ—Ç –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ —Å enterprise-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –ø–æ–ª–Ω—ã–º middleware —Å—Ç–µ–∫–æ–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.\n\n[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)\n[![Telegraf](https://img.shields.io/badge/Telegraf-2CA5E0?style=for-the-badge&logo=telegram&logoColor=white)](https://telegraf.js.org/)\n[![Node.js](https://img.shields.io/badge/Node.js-43853D?style=for-the-badge&logo=node.js&logoColor=white)](https://nodejs.org/)\n\n## üèÜ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞: PRODUCTION READY ‚úÖ\n\n**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –Ø–Ω–≤–∞—Ä—å 2025  \n**TypeScript –æ—à–∏–±–∫–∏:** 0 ‚ùå‚û°Ô∏è‚úÖ  \n**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Enterprise-level  \n**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ì–æ—Ç–æ–≤ –∫ –Ω–∞–≥—Ä—É–∑–∫–∞–º\n\n## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç\n\n### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\n```bash\nnpm install\n```\n\n### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è\n1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather) –≤ Telegram\n2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞\n3. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:\n\n```env\n# ü§ñ Bot Configuration\nBOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather\nBOT_USERNAME=–∏–º—è_–≤–∞—à–µ–≥–æ_–±–æ—Ç–∞\nWEB_APP_URL=https://–≤–∞—à-–≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.com\nCHANNEL_URL=https://t.me/–≤–∞—à_–∫–∞–Ω–∞–ª\nSUPPORT_URL=https://t.me/–≤–∞—à–∞_–ø–æ–¥–¥–µ—Ä–∂–∫–∞\nCHANNEL_USERNAME=@–≤–∞—à_–∫–∞–Ω–∞–ª\nADMIN_ID=–≤–∞—à_telegram_id\n\n# üõ°Ô∏è Security & Rate Limiting\nRATE_LIMIT_WINDOW=60000          # 1 –º–∏–Ω—É—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö\nRATE_LIMIT_MAX_REQUESTS=10       # –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –æ–∫–Ω–æ\nRATE_LIMIT_BLOCK_DURATION=300000 # 5 –º–∏–Ω—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏\n\n# üéÆ Game Features\nSLIDESHOW_INTERVAL=6000          # 6 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–ª–∞–π–¥–∞–º–∏\nGAMES_PER_PAGE=5                 # –ò–≥—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞\n\n# üåç Localization\nDEFAULT_LANGUAGE=ru              # ru | en\nSUPPORTED_LANGUAGES=ru,en\n\n# üìä Logging & Monitoring\nLOG_LEVEL=info                   # debug | info | warn | error\nLOG_USER_ACTIONS=true            # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nLOG_PERFORMANCE=true             # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n\n# üîÑ Message Management\nMESSAGE_UPDATE_TIMEOUT=5000      # –¢–∞–π–º–∞—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\nMESSAGE_RETRY_ATTEMPTS=3         # –ü–æ–ø—ã—Ç–∫–∏ –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ\n```\n\n## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n\n### üîß **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**\n\n| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |\n|------------|--------------|----------|----------------------|\n| `BOT_TOKEN` | ‚úÖ | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | - |\n| `WEB_APP_URL` | ‚úÖ | URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | - |\n| `CHANNEL_USERNAME` | ‚úÖ | Username –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ | - |\n| `ADMIN_ID` | ‚úÖ | Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | - |\n| `RATE_LIMIT_MAX_REQUESTS` | ‚ùå | –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É | 10 |\n| `SLIDESHOW_INTERVAL` | ‚ùå | –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–ª–∞–π–¥—à–æ—É (–º—Å) | 6000 |\n| `DEFAULT_LANGUAGE` | ‚ùå | –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | ru |\n| `LOG_LEVEL` | ‚ùå | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | info |\n\n### 3. –ó–∞–ø—É—Å–∫\n\n```bash\n# üî• Development (Hot Reload)\nnpm run dev\n\n# üèóÔ∏è Production Build\nnpm run build\n\n# üöÄ Production Start\nnpm start\n\n# üßπ Clean Build Directory\nnpm run clean\n```\n\n## üöÄ Production Deployment\n\n### **–°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è**\n- Node.js 18+ LTS\n- RAM: –º–∏–Ω–∏–º—É–º 512MB, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1GB+\n- CPU: 1 vCore (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2+)\n- Disk: 1GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞\n\n### **Production Checklist**\n- ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã\n- ‚úÖ `NODE_ENV=production`\n- ‚úÖ `LOG_LEVEL=warn` –∏–ª–∏ `error`\n- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É\n- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω\n- ‚úÖ Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞\n\n### **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π Production Stack**\n```bash\n# Process Manager\nnpm install -g pm2\n\n# Start with PM2\npm2 start dist/main.js --name \"tip-top-bot\"\n\n# Monitor\npm2 monit\n\n# Logs\npm2 logs tip-top-bot\n```\n\n## ‚ú® –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n### üèóÔ∏è **Enterprise Architecture**\n- ‚úÖ **Singleton –ø–∞—Ç—Ç–µ—Ä–Ω—ã** - ConfigService, ErrorHandler, LoggerMiddleware, RateLimiter\n- ‚úÖ **Dependency Injection** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Å –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞\n- ‚úÖ **Service Layer** - UserService, GameService, MessageService\n- ‚úÖ **Middleware Stack** - Logger, RateLimiter, Error Handler\n\n### üõ°Ô∏è **Production Security & Stability**\n- ‚úÖ **Rate Limiting** - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏\n- ‚úÖ **Error Handling** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫\n- ‚úÖ **Request Debouncing** - MessageUpdateManager –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n- ‚úÖ **Graceful Shutdown** - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã\n- ‚úÖ **Mutex Protection** - –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–æ–±—â–µ–Ω–∏–π\n\n### üìä **Monitoring & Logging**\n- ‚úÖ **Structured Logging** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π\n- ‚úÖ **Performance Tracking** - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤\n- ‚úÖ **User Activity Tracking** - –ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- ‚úÖ **System Events** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π\n- ‚úÖ **Admin Notifications** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö\n\n### üéÆ **Core Features**\n- ‚úÖ **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å** - –†—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏\n- ‚úÖ **–ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä** - –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä —Å GIF-–∞–Ω–∏–º–∞—Ü–∏–µ–π\n- ‚úÖ **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç** - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –±–∞–ª–∞–Ω—Å–µ\n- ‚úÖ **–°–ª–∞–π–¥—à–æ—É** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∏–≥—Ä–∞–º–∏ (6 —Å–µ–∫/—Å–ª–∞–π–¥)\n- ‚úÖ **Subscription Check** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª\n- ‚úÖ **Referral System** - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n- ‚úÖ **Web App Integration** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º\n\n### üîß **Development Tools**\n- ‚úÖ **TypeScript** - –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫\n- ‚úÖ **Hot Reload** - ts-node-dev –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\n- ‚úÖ **Environment Config** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n- ‚úÖ **Mock Data Service** - –ì–æ—Ç–æ–≤—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n\n```\nBot/\n‚îú‚îÄ‚îÄ src/\n‚îÇ   ‚îú‚îÄ‚îÄ config/\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.service.ts      # üîß Singleton –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)\n‚îÇ   ‚îú‚îÄ‚îÄ handlers/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ callback.handler.ts    # üéØ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∑–∞–ø—Ä–æ—Å–æ–≤\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ start.handler.ts       # üöÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start\n‚îÇ   ‚îú‚îÄ‚îÄ services/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ game.service.ts        # üéÆ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–≥—Ä\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message.service.ts     # üí¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.service.ts        # üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏\n‚îÇ   ‚îú‚îÄ‚îÄ utils/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data.ts               # üíæ Mock Database Service + –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts       # üõ°Ô∏è Singleton —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts             # üìä Singleton middleware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.ts        # üö¶ Singleton –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messageUpdateManager.ts # üîÑ Mutex-–∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications.ts      # üì¢ –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ subscription.ts       # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ inline.d.ts           # üìù TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è Telegram\n‚îÇ   ‚îî‚îÄ‚îÄ main.ts                   # üéØ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ + middleware —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è\n‚îú‚îÄ‚îÄ package.json                  # üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (telegraf, axios, dotenv)\n‚îú‚îÄ‚îÄ tsconfig.json                 # ‚öôÔ∏è TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n‚îî‚îÄ‚îÄ README.md                     # üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\n```\n\n### üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**\n\n- **Singleton Pattern** - –í—Å–µ core —Å–µ—Ä–≤–∏—Å—ã (Config, Logger, RateLimiter, ErrorHandler)\n- **Service Layer** - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø–æ –¥–æ–º–µ–Ω–∞–º\n- **Middleware Chain** - Logger ‚Üí RateLimiter ‚Üí ErrorHandler\n- **Mutex Protection** - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n- **Centralized Configuration** - –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\n- **Type Safety** - 100% TypeScript –ø–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫\n\n## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫\n\n### **Core Technologies**\n- **[Telegraf 4.x](https://telegraf.js.org/)** - Enterprise Telegram Bot Framework\n- **[TypeScript 5.x](https://www.typescriptlang.org/)** - –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫\n- **[Node.js 18+](https://nodejs.org/)** - JavaScript runtime\n- **[Axios](https://axios-http.com/)** - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API\n- **[dotenv](https://github.com/motdotla/dotenv)** - Environment configuration\n\n### **Development Tools**\n- **ts-node-dev** - Hot reload –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\n- **rimraf** - Cross-platform file cleanup\n- **@types/node** - TypeScript —Ç–∏–ø—ã –¥–ª—è Node.js\n\n## üìà –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞\n\n### ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–Ø–Ω–≤–∞—Ä—å 2025)**\n\n#### üîß **TypeScript Compilation Fixes**\n- **–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤ `callback.handler.ts` –∏ `start.handler.ts`\n- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –æ—à–∏–±–æ–∫, —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –º–µ—Ç–æ–¥–æ–≤, —É–¥–∞–ª–µ–Ω—ã –ª–∏—à–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã\n- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 0 TypeScript –æ—à–∏–±–æ–∫, —á–∏—Å—Ç–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è\n\n#### üèóÔ∏è **Architecture Improvements**\n- **Singleton Pattern** - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è –≤—Å–µ—Ö core —Å–µ—Ä–≤–∏—Å–æ–≤\n- **Error Handling** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏\n- **Middleware Stack** - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤\n- **Mutex Protection** - –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions –≤ MessageUpdateManager\n\n#### üìä **Production Features**\n- **Rate Limiting** - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏\n- **Structured Logging** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n- **Admin Notifications** - –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö\n- **Graceful Shutdown** - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã\n\n### üéØ **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å**\n- ‚úÖ **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:** –ë–µ–∑ –æ—à–∏–±–æ–∫\n- ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Enterprise-level\n- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Production-ready\n- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ\n- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ê–∫—Ç—É–∞–ª—å–Ω–∞—è\n\n## üó∫Ô∏è Roadmap –∏ –ø–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è\n\n### üöÄ **Phase 1: Database Integration** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π)\n- üîÑ **PostgreSQL/MongoDB** - –ó–∞–º–µ–Ω–∞ mock –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î\n- üîÑ **Prisma ORM** - Type-safe database access\n- üîÑ **Migrations** - –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î\n- üîÑ **Connection Pooling** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π\n\n### üõí **Phase 2: E-commerce Features** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π)\n- üîÑ **Payment Integration** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º\n- üîÑ **Order Management** - –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤\n- üîÑ **Inventory Tracking** - –£—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤\n- üîÑ **Digital Delivery** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ –∫–ª—é—á–µ–π\n\n### üìä **Phase 3: Analytics & Admin** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π)\n- üîÑ **Admin Panel** - Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n- üîÑ **Analytics Dashboard** - –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n- üîÑ **A/B Testing** - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤\n- üîÑ **Revenue Tracking** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤\n\n### üîß **Phase 4: Infrastructure** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π)\n- üîÑ **Docker Containerization** - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è\n- üîÑ **CI/CD Pipeline** - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è\n- üîÑ **Load Balancing** - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏\n- üîÑ **Monitoring Stack** - Prometheus + Grafana\n\n### üéÆ **Phase 5: Advanced Features** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π)\n- üîÑ **AI Recommendations** - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–≥—Ä\n- üîÑ **Social Features** - –û—Ç–∑—ã–≤—ã, —Ä–µ–π—Ç–∏–Ω–≥–∏\n- üîÑ **Loyalty Program** - –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏\n- üîÑ **Multi-tenant** - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤\n\n## üìã API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\n\n### **–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞**\n- `/start` - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é\n\n### **Callback Actions**\n- `games` - –ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π\n- `profile` - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–∞–ª–∞–Ω—Å–æ–º\n- `language_ru/en` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞\n- `game_{id}` - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ\n- `prev_game/next_game` - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–ª–∞–π–¥—à–æ—É\n- `back_to_menu` - –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n- `web_app` - –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n### Bot Routes (–¥–ª—è Telegram-–±–æ—Ç–∞)\n\n**–ë–∞–∑–æ–≤—ã–π URL:** `/api/users`  \n**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** Header `Token: {AUTH_BOT_TOKEN}`\n\n#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n\n| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |\n|-------|----------|----------|\n| `POST` | `/api/users/bot` | –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞ |\n| `GET` | `/api/users/bot/:userId` | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID |\n| `PUT` | `/api/users/bot/:userId/language` | –û–±–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |\n| `PUT` | `/api/users/bot/:userId/isSubscribed` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ |\n\n**–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**\n```json\n// POST /api/users/bot\n{\n  \"_id\": 123456789,\n  \"username\": \"john_doe\",\n  \"avatarUrl\": \"https://example.com/avatar.jpg\"\n}\n```\n\n**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**\n```json\n{\n  \"_id\": 123456789,\n  \"username\": \"john_doe\",\n  \"avatarUrl\": \"https://example.com/avatar.jpg\",\n  \"language\": \"ru\",\n  \"isAdmin\": false,\n  \"isBanned\": false,\n  \"isSubscribed\": false,\n  \"balanceRUB\": 0,\n  \"balanceUSDT\": 0,\n  \"ordersCount\": 0,\n  \"referralCode\": \"ABC123\",\n  \"referralPercent\": 1,\n  \"acceptedPrivacyConsent\": false,\n  \"createdAt\": \"2025-01-25T12:00:00.000Z\",\n  \"updatedAt\": \"2025-01-25T12:00:00.000Z\"\n}\n```\n\n### –ü—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã –∏–≥—Ä\n\n**–ë–∞–∑–æ–≤—ã–π URL:** `/api/games`\n\n| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |\n|-------|----------|----------|\n| `GET` | `/api/games` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä |\n| `GET` | `/api/games/active` | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä |\n| `GET` | `/api/games/discounts` | –°–ø–∏—Å–æ–∫ –∏–≥—Ä —Å–æ —Å–∫–∏–¥–∫–∞–º–∏ |\n| `GET` | `/api/games/search?query=–Ω–∞–∑–≤–∞–Ω–∏–µ` | –ü–æ–∏—Å–∫ –∏–≥—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é |\n| `GET` | `/api/games/:id` | –ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä—É –ø–æ ID |\n\n**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –∏–≥—Ä—ã:**\n```json\n{\n  \"_id\": 1,\n  \"title\": \"üÜî Asphalt Legends Unite\",\n  \"imageUrl\": \"https://example.com/image.jpg\",\n  \"gifUrl\": \"https://example.com/animation.gif\",\n  \"hasDiscount\": true,\n  \"isActual\": true,\n  \"isEnabled\": true,\n  \"appStoreUrl\": \"https://apps.apple.com/...\",\n  \"googlePlayUrl\": \"https://play.google.com/...\",\n  \"trailerUrl\": \"https://youtu.be/...\",\n  \"emoji\": \"üèéÔ∏è\",\n  \"createdAt\": \"2025-01-25T12:00:00.000Z\",\n  \"updatedAt\": \"2025-01-25T12:00:00.000Z\"\n}\n```\n\n## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã\n\n### ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏\n\n**–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã:**\n- `TelegramError: 400: Bad Request: canceled by new editMessageMedia request`\n- `TelegramError: 400: Bad Request: message is not modified`\n- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram API\n- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–æ–≤\n\n### üõ°Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è\n\n1. **–ú—å—é—Ç–µ–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**\n   ```typescript\n   const messageUpdateMutex: Map<string, boolean> = new Map();\n   ```\n\n2. **MessageUpdateManager –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞**\n   - –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (100–º—Å –∑–∞–¥–µ—Ä–∂–∫–∞)\n   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\n\n3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**\n   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö –æ—à–∏–±–æ–∫ Telegram API\n   - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\n\n4. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback**\n   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∫–ª–∏–∫–æ–≤\n\n### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  \n‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞  \n‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∫–ª–∏–∫–æ–≤  \n‚úÖ –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  \n‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production –Ω–∞–≥—Ä—É–∑–∫–∞–º  \n\n## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞\n\n### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏:\n\n1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**\n   - –ó–∞–º–µ–Ω–∏—Ç–µ –º–æ–∫-–¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (MongoDB/PostgreSQL)\n   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ `src/config/database.ts`\n\n2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**\n   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª\n   - –î–æ–±–∞–≤—å—Ç–µ rate limiting\n   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è Web App\n\n3. **–ü–ª–∞—Ç–µ–∂–∏**\n   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É\n   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook'–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π\n\n4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**\n   - –î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Winston/Pino)\n   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ (Sentry)\n   - –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n\n### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:\n\n- ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π\n- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –æ—à–∏–±–∫–∏ Telegram API\n- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—å—é—Ç–µ–∫—Å—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π\n- ‚úÖ –õ–æ–≥–∏—Ä—É–π—Ç–µ, –Ω–æ –Ω–µ –ø–∞–Ω–∏–∫—É–π—Ç–µ –ø—Ä–∏ –æ–∂–∏–¥–∞–µ–º—ã—Ö –æ—à–∏–±–∫–∞—Ö\n- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n\n```bash\n# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤\nnpm test\n\n# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º\nnpm run test:coverage\n\n# –õ–∏–Ω—Ç–∏–Ω–≥\nnpm run lint\n```\n\n**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**\n- –ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–æ–≤\n- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–ª–∏–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- –†–∞–±–æ—Ç—É –ø—Ä–∏ –ø–ª–æ—Ö–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏\n- –û–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö\n\n## üìù –õ–∏—Ü–µ–Ω–∑–∏—è\n\nMIT License\n\n## üîç Troubleshooting\n\n### **–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**\n\n#### TypeScript –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏\n```bash\n# –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞\nnpm run clean\nrm -rf node_modules package-lock.json\nnpm install\nnpm run build\n```\n\n#### –ü—Ä–æ–±–ª–µ–º—ã —Å rate limiting\n- –£–≤–µ–ª–∏—á—å—Ç–µ `RATE_LIMIT_MAX_REQUESTS` –≤ `.env`\n- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `RATE_LIMIT_WINDOW` –¥–ª—è –≤–∞—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏\n\n#### –û—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\n- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MESSAGE_UPDATE_TIMEOUT`\n- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n\n### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞**\n```bash\n# –í–∫–ª—é—á–∏—Ç—å debug –ª–æ–≥–∏\nLOG_LEVEL=debug npm run dev\n\n# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏\ntail -f logs/bot.log\n```\n\n## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n\n### **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏**\n- **Response Time** - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã\n- **Error Rate** - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫\n- **Active Users** - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n- **Rate Limit Hits** - –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤\n\n### **–ê–ª–µ—Ä—Ç—ã**\n- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ error rate > 5%\n- Response time > 2 —Å–µ–∫—É–Ω–¥\n- Memory usage > 80%\n- Rate limit violations\n\n## ü§ù Contributing\n\n### **–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞**\n- TypeScript strict mode\n- ESLint + Prettier\n- Conventional Commits\n- 100% type coverage\n\n### **–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**\n1. Fork —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è\n2. –°–æ–∑–¥–∞–π—Ç–µ feature branch\n3. –°–ª–µ–¥—É–π—Ç–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º\n4. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã (–∫–æ–≥–¥–∞ –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)\n5. –°–æ–∑–¥–∞–π—Ç–µ Pull Request\n\n## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n\n### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**\n- üêõ **–ë–∞–≥–∏:** [GitHub Issues](https://github.com/your-username/tip-top-bot/issues)\n- üí° **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** [GitHub Discussions](https://github.com/your-username/tip-top-bot/discussions)\n- üìß **Email:** support@tip-top-games.com\n- üí¨ **Telegram:** [@tip_top_support](https://t.me/tip_top_support)\n\n### **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**\n- üìñ **API Docs:** [docs.tip-top-games.com](https://docs.tip-top-games.com)\n- üé• **Video Guides:** [YouTube Channel](https://youtube.com/tip-top-games)\n- üìö **Knowledge Base:** [help.tip-top-games.com](https://help.tip-top-games.com)\n\n---\n\n## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ\n\n**Tip-Top Games Bot** - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ Telegram –±–æ—Ç, —ç—Ç–æ **enterprise-—Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –ú—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–¥–µ—Ä–∂–∏—Ç –ª—é–±—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞.\n\n### **–ß—Ç–æ –º—ã –¥–æ—Å—Ç–∏–≥–ª–∏:**\n- ‚úÖ **Zero TypeScript errors** - –ß–∏—Å—Ç—ã–π, —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥\n- ‚úÖ **Production-ready architecture** - Enterprise –ø–∞—Ç—Ç–µ—Ä–Ω—ã\n- ‚úÖ **Bulletproof error handling** - –ù–∏–∫–∞–∫–∏—Ö –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–∞–¥–µ–Ω–∏–π\n- ‚úÖ **Advanced monitoring** - –ü–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã\n- ‚úÖ **Scalable foundation** - –ì–æ—Ç–æ–≤ –∫ —Ä–æ—Å—Ç—É\n\n### **–ì–æ—Ç–æ–≤ –∫:**\n- üöÄ **Immediate deployment** - –ó–∞–ø—É—Å–∫ –≤ production\n- üìà **High load** - –¢—ã—Å—è—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ\n- üîß **Easy maintenance** - –ü—Ä–æ—Å—Ç–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n- üéØ **Feature expansion** - –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π\n\n‚≠ê **–ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–ª–µ–∑–Ω—ã–º, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥–æ—á–∫—É –Ω–∞ GitHub!**\n\n---\n\n**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** ‚úÖ Production Ready  \n**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –Ø–Ω–≤–∞—Ä—å 2025  \n**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** [Telegram Support](https://t.me/your_support)\n\n> üí° **–°–æ–≤–µ—Ç:** –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `api-bot-games-docs.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\n\n*–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞*\n","size_bytes":24618},"client/src/components/LangWidget.tsx":{"content":"import React from 'react';\nimport type {RefObject} from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { forwardRef } from 'react';\n\ninterface LangWidgetProps {\n  onSelect: (lang: 'ru' | 'en') => void;\n  ref: RefObject<HTMLDivElement | null>;\n}\n\nconst LangWidget: React.FC<LangWidgetProps> = forwardRef<HTMLDivElement, LangWidgetProps>(({ onSelect }, ref) => {\n  const {t} = useTranslation();\n\n  return (\n    <div ref={ref} className=\"absolute top-[60px] right-[10px] bg-[#1A1B1E] text-white p-4 rounded-lg border  border-[#27282C]\">\n      <h3 className=\"mb-2 text-sm font-medium text-[#8F96A3]\">{t('langWidget.title')}</h3>\n      <div className=\"flex gap-2\">\n        <button\n          className=\"px-4 py-2 text-sm text-[#8F96A3] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => onSelect('ru')}\n        >\n          {t('langWidget.ru')}\n        </button>\n        <button\n          className=\"px-4 py-2 text-sm text-[#8F96A3] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => onSelect('en')}\n        >\n          {t('langWidget.en')}\n        </button>\n      </div>\n    </div>\n  );\n});\n\nexport default LangWidget;","size_bytes":1259},"client/src/store/features/withdrawalsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const fetchWithdrawalsByMe = createAsyncThunk('referrals/fetchWithdrawalsByMe', async (_, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/withdrawals/me`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const createWithdrawal = createAsyncThunk('payments/createWithdrawal', async (withdrawalData: { amount: number }, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.post('/withdrawals', withdrawalData);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\n\ninterface IWithdrawal {\n    _id: number;\n    userId: number;\n    amount: number;\n    status: 'pending' | 'completed' | 'rejected';\n    currency: 'RUB' | 'USDT';\n    createdAt: Date;\n    updatedAt: Date;\n}\n\ninterface IWithdrawalsState {\n    withdrawals: IWithdrawal[];\n    loading: boolean;\n    error: string | null;\n}\n\nconst initialState: IWithdrawalsState = {\n    withdrawals: [],\n    loading: false,\n    error: null,\n};\n\nconst withdrawalsSlice = createSlice({\n    name: 'withdrawals',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchWithdrawalsByMe.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchWithdrawalsByMe.fulfilled, (state, action) => {\n                state.loading = false;\n                state.withdrawals = action.payload;\n            })\n            .addCase(fetchWithdrawalsByMe.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            })\n            .addCase(createWithdrawal.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(createWithdrawal.fulfilled, (state, action) => {\n                state.loading = false;\n                state.withdrawals.push(action.payload);\n            })\n            .addCase(createWithdrawal.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            })\n\n    }\n});\n\nexport default withdrawalsSlice.reducer;","size_bytes":2748},"server/src/types/crypto-pay-api.d.ts":{"content":"declare module '@foile/crypto-pay-api' {\n    export class CryptoPay {\n        constructor(apiKey: string);\n\n        createInvoice(\n            asset: string,\n            amount: number | string,\n            options?: {\n                hidden_message?: string;\n                allow_comments?: boolean;\n                allow_anonymous?: boolean;\n                paid_btn_name?: string;\n                paid_btn_url?: string;\n                expires_in?: number;\n            }\n        ): Promise<{\n            invoice_id: string;\n            status: string;\n            pay_url: string;\n            mini_app_invoice_url?: string;\n        }>;\n\n        createInvoice(options: {\n            asset: string;\n            amount: string;\n            description?: string;\n            paid_btn_name?: string;\n            paid_btn_url?: string;\n        }): Promise<{\n            invoice_id: string;\n            status: string;\n            pay_url: string;\n        }>;\n\n        transfer(\n            user_id: number,\n            asset: string,\n            amount: string,\n            spend_id: string,\n            options?: {\n                comment?: string;\n                disable_send_notification?: boolean;\n            }\n        ): Promise<{\n            transfer_id: number;\n            user_id: number;\n            asset: string;\n            amount: string;\n            status: string;\n            completed_at: string;\n        }>;\n    }\n}\n","size_bytes":1435},"bot/src/utils/errorHandler.ts":{"content":"import { Context } from 'telegraf';\nimport { NotificationService } from './notifications';\nimport { configService } from '../config/config.service';\nimport { localization } from '../config/localization';\n\n/**\n * üö® –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫\n * –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ —Ç–∏–ø–∞–º–∏ –æ—à–∏–±–æ–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n */\nexport class ErrorHandler {\n  private static instance: ErrorHandler;\n  private notificationService: NotificationService | null = null;\n\n  private constructor() {\n    // NotificationService –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–∑–∂–µ —Å —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –±–æ—Ç–∞\n    this.setupGlobalErrorHandlers();\n  }\n\n  public setNotificationService(notificationService: NotificationService): void {\n    this.notificationService = notificationService;\n  }\n\n  public static getInstance(): ErrorHandler {\n    if (!ErrorHandler.instance) {\n      ErrorHandler.instance = new ErrorHandler();\n    }\n    return ErrorHandler.instance;\n  }\n\n  /**\n   * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫\n   */\n  private setupGlobalErrorHandlers(): void {\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π\n    process.on('uncaughtException', (error: Error) => {\n      console.error('üî• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:', error);\n      this.handleCriticalError(error, 'uncaughtException');\n    });\n\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–∏—Å–æ–≤\n    process.on('unhandledRejection', (reason: any, promise: Promise<any>) => {\n      console.error('üî• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', reason);\n      this.handleCriticalError(new Error(String(reason)), 'unhandledRejection');\n    });\n\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\n    process.on('SIGTERM', () => this.handleGracefulShutdown('SIGTERM'));\n    process.on('SIGINT', () => this.handleGracefulShutdown('SIGINT'));\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Telegram –±–æ—Ç–∞\n   */\n  public async handleBotError(\n    error: Error,\n    ctx?: Context,\n    operation?: string\n  ): Promise<void> {\n    const errorInfo = {\n      message: error.message,\n      stack: error.stack,\n      operation: operation || 'unknown',\n      userId: ctx?.from?.id,\n      username: ctx?.from?.username,\n      chatId: ctx?.chat?.id,\n      timestamp: new Date().toISOString(),\n    };\n\n    console.error('ü§ñ –û—à–∏–±–∫–∞ –±–æ—Ç–∞:', errorInfo);\n\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É\n    if (this.notificationService) {\n      try {\n        await this.notificationService.notifyError(\n          error,\n          `–û–ø–µ—Ä–∞—Ü–∏—è: ${errorInfo.operation}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${errorInfo.userId} (@${errorInfo.username}), –ß–∞—Ç: ${errorInfo.chatId}`\n        );\n      } catch (notificationError) {\n        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:', notificationError);\n      }\n    }\n\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ\n    if (ctx) {\n      await this.sendUserErrorMessage(ctx);\n    }\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã\n   */\n  private async handleCriticalError(error: Error, type: string): Promise<void> {\n    const errorInfo = {\n      type,\n      message: error.message,\n      stack: error.stack,\n      timestamp: new Date().toISOString(),\n      pid: process.pid,\n      memory: process.memoryUsage(),\n    };\n\n    console.error('üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', errorInfo);\n\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n    if (this.notificationService) {\n      try {\n        await this.notificationService.notifyCriticalError(\n          error,\n          `–¢–∏–ø: ${errorInfo.type}, PID: ${errorInfo.pid}, –ü–∞–º—è—Ç—å: ${Math.round(errorInfo.memory.heapUsed / 1024 / 1024)}MB`\n        );\n      } catch (notificationError) {\n        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', notificationError);\n      }\n    }\n\n    // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –º–æ–∂–µ–º –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å graceful shutdown\n    if (type === 'uncaughtException') {\n      console.log('üîÑ –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è graceful shutdown –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏...');\n      setTimeout(() => {\n        process.exit(1);\n      }, 5000); // –î–∞–µ–º 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n    }\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏\n   */\n  public handleValidationError(error: Error, field?: string): void {\n    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', {\n      field,\n      message: error.message,\n      timestamp: new Date().toISOString(),\n    });\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏/API\n   */\n  public async handleNetworkError(\n    error: Error,\n    endpoint?: string,\n    retryCount?: number\n  ): Promise<void> {\n    const errorInfo = {\n      endpoint: endpoint || 'unknown',\n      message: error.message,\n      retryCount: retryCount || 0,\n      timestamp: new Date().toISOString(),\n    };\n\n    console.error('üåê –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', errorInfo);\n\n    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –æ—à–∏–±–∫–∞, —É–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n    if (retryCount && retryCount > 3 && this.notificationService) {\n      try {\n        await this.notificationService.notifyError(\n          error,\n          `–ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. Endpoint: ${errorInfo.endpoint}, –ü–æ–ø—ã—Ç–æ–∫: ${errorInfo.retryCount}`\n        );\n      } catch (notificationError) {\n        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ:', notificationError);\n      }\n    }\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ\n   */\n  private async sendUserErrorMessage(ctx: Context): Promise<void> {\n    try {\n      const userLang = (ctx as any).session?.language || 'ru';\n      const l = localization(userLang);\n      const errorMessage = l.errors?.general || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.';\n\n      await ctx.reply(errorMessage);\n    } catch (replyError) {\n      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', replyError);\n    }\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç graceful shutdown\n   */\n  private async handleGracefulShutdown(signal: string): Promise<void> {\n    console.log(`üîÑ –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª ${signal}, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è graceful shutdown...`);\n\n    if (this.notificationService) {\n      try {\n        // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã\n        await this.notificationService.notifyError(\n          new Error(`–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ —Å–∏–≥–Ω–∞–ª—É ${signal}`),\n          `Graceful shutdown`\n        );\n      } catch (error) {\n        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã:', error);\n      }\n    }\n\n    console.log('‚úÖ Graceful shutdown –∑–∞–≤–µ—Ä—à–µ–Ω');\n    process.exit(0);\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n   */\n  public logInfo(message: string, data?: any): void {\n    const logLevel = configService.get<string>('logging.level');\n    if (['debug', 'info', 'warn', 'error'].includes(logLevel)) {\n      console.log(`‚ÑπÔ∏è ${message}`, data ? JSON.stringify(data, null, 2) : '');\n    }\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ\n   */\n  public logWarning(message: string, data?: any): void {\n    const logLevel = configService.get<string>('logging.level');\n    if (['debug', 'info', 'warn', 'error'].includes(logLevel)) {\n      console.warn(`‚ö†Ô∏è ${message}`, data ? JSON.stringify(data, null, 2) : '');\n    }\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n   */\n  public logDebug(message: string, data?: any): void {\n    const logLevel = configService.get<string>('logging.level');\n    if (logLevel === 'debug') {\n      console.debug(`üêõ ${message}`, data ? JSON.stringify(data, null, 2) : '');\n    }\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É\n   */\n  public logError(message: string, error?: any): void {\n    const logLevel = configService.get<string>('logging.level');\n    if (['debug', 'info', 'warn', 'error'].includes(logLevel)) {\n      console.error(`‚ùå ${message}`, error ? (error instanceof Error ? error.stack : JSON.stringify(error, null, 2)) : '');\n    }\n  }\n\n  /**\n   * –°–æ–∑–¥–∞–µ—Ç –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n   */\n  public wrapAsync<T extends any[], R>(\n    fn: (...args: T) => Promise<R>,\n    operation?: string\n  ): (...args: T) => Promise<R | undefined> {\n    return async (...args: T): Promise<R | undefined> => {\n      try {\n        return await fn(...args);\n      } catch (error) {\n        await this.handleBotError(\n          error instanceof Error ? error : new Error(String(error)),\n          undefined,\n          operation\n        );\n        return undefined;\n      }\n    };\n  }\n\n  /**\n   * –°–æ–∑–¥–∞–µ—Ç –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º\n   */\n  public wrapContext<T extends any[], R>(\n    fn: (ctx: Context, ...args: T) => Promise<R>,\n    operation?: string\n  ): (ctx: Context, ...args: T) => Promise<R | undefined> {\n    return async (ctx: Context, ...args: T): Promise<R | undefined> => {\n      try {\n        return await fn(ctx, ...args);\n      } catch (error) {\n        await this.handleBotError(\n          error instanceof Error ? error : new Error(String(error)),\n          ctx,\n          operation\n        );\n        return undefined;\n      }\n    };\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–Ω–≥–ª—Ç–æ–Ω\nexport const errorHandler = ErrorHandler.getInstance();","size_bytes":10326},"bot/src/handlers/start.handler.ts":{"content":"import { Context } from 'telegraf';\nimport { localization, WELCOME_GIFS, DEFAULT_GIF_URL, SUBSCRIBE_REQUEST_GIF, CHANNEL_URL, WEB_APP_URL, URL_CONSTANTS, DEFAULT_GOOGLE_PLAY_URL, PLACEHOLDER_IMAGE_URL } from '../config/localization';\nimport { checkUserSubscription } from '../utils/subscription';\nimport { NotificationService } from '../utils/notifications';\nimport { userService } from '../services/user.service';\nimport { gameService } from '../services/game.service';\nimport { messageService } from '../services/message.service';\nimport { stopSlideshowForUser } from './callback.handler';\nimport { messageUpdateManager } from '../utils/messageUpdateManager';\nimport { ConfigService } from '../config/config.service';\nimport { ErrorHandler } from '../utils/errorHandler';\nimport { LoggerMiddleware } from '../middleware/logger';\n\n// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã\nimport { configService } from '../config/config.service';\nimport { errorHandler } from '../utils/errorHandler';\nimport { loggerMiddleware } from '../middleware/logger';\n\n// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nconst userMessageIds: { [key: string]: number } = {};\nexport const bannerIndex: { [key: string]: number } = {};\nexport const isPlaying: { [key: string]: boolean } = {};\nexport const slideshowIntervals: Map<string, {\n  interval: NodeJS.Timeout;\n  timeout: NodeJS.Timeout;\n  messageId: number;\n  chatId: number;\n}> = new Map();\n\n// –ú—å—é—Ç–µ–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–æ–±—â–µ–Ω–∏–π\nconst messageUpdateMutex: Map<string, boolean> = new Map();\n\n// –ü–æ–ª—É—á–∞–µ–º URL –∫–∞–Ω–∞–ª–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\nconst getChannelUrl = () => configService.getString('CHANNEL_URL', CHANNEL_URL);\n\nexport async function handleStart(ctx: Context, notificationService?: NotificationService) {\n  try {\n    if (!ctx.from) return;\n    const userId = ctx.from.id;\n    const username = ctx.from.username;\n    const firstName = ctx.from.first_name;\n    const languageCode = ctx.from.language_code;\n\n    errorHandler.logInfo(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} (${username || firstName || 'Unknown'}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`);\n    await loggerMiddleware.logUserAction(userId, 'bot_start', { username, firstName, languageCode });\n\n    // –ò–∑–≤–ª–µ–∫–∞–µ–º referral ID –∏–∑ –∫–æ–º–∞–Ω–¥—ã start\n    const startPayload = ctx.message && 'text' in ctx.message ? ctx.message.text.split(' ')[1] : undefined;\n    const referralId = startPayload ? parseInt(startPayload, 10) : undefined;\n\n    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å\n    const { user, isNew } = await userService.getOrCreateUser({\n      _id: userId,\n      username,\n      language: languageCode !== 'ru' ? 'en' : 'ru',\n      referredBy: referralId\n    });\n\n    if (isNew) {\n      errorHandler.logInfo(`‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`);\n      await loggerMiddleware.logUserAction(userId, 'user_created', { referralId });\n\n      // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ\n      if (notificationService) {\n        await notificationService.notifyNewUser(\n          `üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${firstName || username || userId}`\n        );\n      }\n    } else {\n      errorHandler.logInfo(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`);\n      await loggerMiddleware.logUserAction(userId, 'bot_restart', {});\n      \n      if (user.isBanned) {\n        errorHandler.logWarning(`User ${userId} is banned. Access denied.`);\n        await loggerMiddleware.logUserAction(userId, 'access_denied_banned', {});\n        const l = localization(user.language || 'ru');\n        await ctx.reply(l.errors.userBlocked);\n        return;\n      }\n    }\n\n    // –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É /start\n    if ('message' in ctx && ctx.message?.message_id) {\n      try {\n        await ctx.deleteMessage();\n      } catch (error) {\n        errorHandler.logWarning('Could not delete start message:', error);\n      }\n    }\n\n    await showLanguageSelection(ctx);\n  } catch (error) {\n    await errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'handleStart');\n    if (ctx.from) {\n      const user = await userService.getUserById(ctx.from.id);\n      const language = user?.language || 'ru';\n      const l = localization(language);\n      await loggerMiddleware.logUserAction(ctx, 'start_error', { error: error instanceof Error ? error.message : String(error) });\n      await ctx.reply(l.errors.startError);\n    }\n  }\n}\n\nexport async function handleLanguageChange(ctx: Context, language: string) {\n  if (!ctx.from || !ctx.chat?.id) {\n    errorHandler.logWarning(`handleLanguageChange: Invalid context (from: ${ctx.from?.id}, chat: ${ctx.chat?.id})`);\n    return;\n  }\n\n  const userId = ctx.from.id;\n  const l = localization(language);\n  const messageId = messageService.getMessageIdToEdit(ctx.from.id);\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–æ –ª–∏ —Å–ª–∞–π–¥—à–æ—É –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ\n  const slideshowStopped = stopSlideshowForUser(userId.toString());\n\n\n  try {\n    await userService.updateLanguage(userId, { language });\n    errorHandler.logInfo(`Language updated to ${language} for user ${userId}`);\n    await loggerMiddleware.logUserAction(ctx, 'language_changed', { language });\n\n    // –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª\n    const isSubscribed = await checkUserSubscription(ctx, userId.toString());\n\n    if (isSubscribed) {\n        await userService.updateSubscription(userId, { isSubscribed: true });\n\n      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é\n      const webAppUrl = configService.getString('WEB_APP_URL', WEB_APP_URL);\n      await ctx.setChatMenuButton({\n        type: 'web_app',\n        text: l.buttons.store,\n        web_app: { url: webAppUrl },\n      });\n\n      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º\n      const persistentKeyboard = messageService.createPersistentKeyboard(language);\n      await ctx.reply(l.messages.languageSelected, {\n        reply_markup: persistentKeyboard,\n      });\n\n      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ\n      if (messageId && ctx.chat?.id) {\n        try {\n          await ctx.telegram.deleteMessage(ctx.chat.id, messageId);\n          errorHandler.logInfo(`Deleted old message ${messageId} before creating new menu for user ${userId}`);\n        } catch (deleteError) {\n          errorHandler.logWarning(`Could not delete old message ${messageId} for user ${userId}:`, deleteError);\n        }\n      }\n      \n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n      await showMainMenu(ctx, false);\n      \n      // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é\n      try {\n          if (slideshowStopped) {\n            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n            await new Promise(resolve => setTimeout(resolve, 100));\n            await ctx.answerCbQuery(l.slideshow.stopped);\n          } else {\n            await ctx.answerCbQuery(l.messages.languageSelected);\n          }\n        } catch (cbError) {\n          console.warn('Callback query already answered or expired:', cbError);\n        }\n    } else {\n      // –õ–æ–≥–∏–∫–∞ –¥–ª—è –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n      if (messageId && ctx.chat?.id) {\n        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ\n        try {\n          await ctx.telegram.deleteMessage(ctx.chat.id, messageId);\n          console.log(`Deleted old message ${messageId} before creating subscription request for user ${userId}`);\n        } catch (deleteError) {\n          console.warn(`Could not delete old message ${messageId} for user ${userId}:`, deleteError);\n        }\n        \n        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ–¥–ø–∏—Å–∫–∏\n        const keyboard = {\n          inline_keyboard: [\n            [{ text: l.buttons.subscribeToChannel, url: getChannelUrl() }],\n            [{ text: l.buttons.checkSubscription, callback_data: 'check_subscription' }],\n          ],\n        };\n        await ctx.replyWithAnimation(SUBSCRIBE_REQUEST_GIF, {\n          caption: l.subscription.request,\n          parse_mode: 'HTML',\n          reply_markup: keyboard,\n        });\n        \n        try {\n          if (slideshowStopped) {\n            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n            await new Promise(resolve => setTimeout(resolve, 100));\n            await ctx.answerCbQuery(l.slideshow.stopped);\n          } else {\n            await ctx.answerCbQuery();\n          }\n        } catch (cbError) {\n          errorHandler.logWarning('Callback query already answered or expired:', cbError);\n        }\n      }\n    }\n  } catch (error) {\n    await errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'handleLanguageChange');\n    await loggerMiddleware.logUserAction(ctx, 'language_change_error', { error: error instanceof Error ? error.message : String(error) });\n    try {\n      await ctx.answerCbQuery(l.errors.general, { show_alert: true });\n    } catch (cbError) {\n      errorHandler.logWarning('Could not answer callback query:', cbError);\n    }\n  }\n}\n\nexport async function handleCheckSubscription(ctx: Context) {\n  if (!ctx.from || !ctx.callbackQuery || !ctx.chat?.id) {\n    errorHandler.logWarning(`handleCheckSubscription: Invalid context (from: ${ctx.from?.id}, chat: ${ctx.chat?.id})`);\n    return;\n  }\n  const userId = ctx.from.id;\n  const data = (ctx.callbackQuery as any)?.data;\n  const callbackMessageId = (ctx.callbackQuery as any)?.message?.message_id;\n\n  const user = await userService.getUserById(userId);\n  if (!user) {\n    await showLanguageSelection(ctx);\n    return;\n  }\n  const l = localization(user.language);\n  const messageId = messageService.getMessageIdToEdit(ctx.from.id);\n\n  if (!messageId) {\n    errorHandler.logWarning('No message ID for subscription check');\n    await showLanguageSelection(ctx);\n    return;\n  }\n\n  try {\n    // –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª\n    const isSubscribed = await checkUserSubscription(ctx, userId.toString());\n    await loggerMiddleware.logUserAction(ctx, 'subscription_check', { isSubscribed });\n\n    if (isSubscribed) {\n      await userService.updateSubscription(userId, { isSubscribed: true });\n      await ctx.answerCbQuery(l.subscription.success);\n      errorHandler.logInfo(`User ${userId} successfully subscribed to channel`);\n\n      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º\n      const persistentKeyboard = messageService.createPersistentKeyboard(user.language);\n      await ctx.reply(l.messages.languageSelected, {\n        reply_markup: persistentKeyboard,\n      });\n\n      let messageSuccessfullyDeleted = false;\n      if (\n        (ctx.callbackQuery as any)?.message?.message_id &&\n        userMessageIds[userId.toString()] === (ctx.callbackQuery as any).message.message_id\n      ) {\n        try {\n          await ctx.deleteMessage(userMessageIds[userId.toString()]);\n          errorHandler.logInfo(`Successfully deleted message ${userMessageIds[userId.toString()]} in handleCheckSubscription for user ${userId}`);\n          delete userMessageIds[userId.toString()];\n          messageSuccessfullyDeleted = true;\n        } catch (e) {\n          errorHandler.logWarning(`Could not delete subscription message ${userMessageIds[userId.toString()]} for user ${userId}:`, e);\n        }\n      }\n\n      if (messageSuccessfullyDeleted) {\n        await showMainMenu(ctx, false);\n      } else {\n        await showMainMenu(ctx, true, messageId);\n      }\n    } else {\n      await ctx.answerCbQuery(l.subscription.failed);\n      await loggerMiddleware.logUserAction(ctx, 'subscription_check_failed', {});\n    }\n  } catch (error) {\n    await errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'handleCheckSubscription');\n    const lang = user?.language || 'ru';\n    const l = localization(lang);\n    await loggerMiddleware.logUserAction(ctx, 'subscription_check_error', { error: error instanceof Error ? error.message : String(error) });\n    await ctx.answerCbQuery(l.errors.general);\n  }\n}\n\nexport async function showMainMenu(ctx: Context, editMessage = true, messageIdToEdit?: number) {\n  if (!ctx.from || !ctx.chat?.id) {\n    errorHandler.logWarning(`showMainMenu: Invalid context (from: ${ctx.from?.id}, chat: ${ctx.chat?.id})`);\n    return;\n  }\n  \n  const userId = ctx.from.id;\n  const mutexKey = `${userId}_${ctx.chat.id}`;\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º—å—é—Ç–µ–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\n  if (messageUpdateMutex.get(mutexKey)) {\n    errorHandler.logInfo(`Skipping showMainMenu for user ${userId} - already updating`);\n    return;\n  }\n  \n  messageUpdateMutex.set(mutexKey, true);\n  \n  try {\n    const userId = ctx.from.id;\n    const chatId = ctx.chat.id;\n    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    const user = await userService.getUserById(userId);\n    const language = user ? user.language : 'ru';\n    const l = localization(language);\n\n    const userIdStr = userId.toString();\n    if (!(userIdStr in bannerIndex)) {\n        bannerIndex[userIdStr] = 0;\n    }\n    if (!(userIdStr in isPlaying)) {\n        isPlaying[userIdStr] = false;\n    }\n\n    const games = await gameService.getEnabledGames();\n    if (!games || games.length === 0) {\n      errorHandler.logError('No games in database');\n      await loggerMiddleware.logUserAction(userId, 'no_games_error', {});\n      await ctx.reply(l.errors.noGames);\n      return;\n    }\n\n    if (bannerIndex[userIdStr] >= games.length) {\n        bannerIndex[userIdStr] = 0;\n    }\n\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –∏–≥—Ä—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞–ª–∏—á–∏—è GIF\n    const validGames = games.filter((game) => game.title);\n    if (validGames.length === 0) {\n      errorHandler.logError('No valid games in database');\n      // –§–æ–ª–ª–±—ç–∫ –∏–≥—Ä–∞\n      const fallbackGame = {\n        _id: 0,\n        title: l.system.defaultGame,\n        imageUrl: PLACEHOLDER_IMAGE_URL,\n        gifUrl: DEFAULT_GIF_URL,\n        hasDiscount: false,\n        isEnabled: true,\n        appStoreUrl: '',\n        googlePlayUrl: DEFAULT_GOOGLE_PLAY_URL,\n        trailerUrl: '',\n        createdAt: new Date(),\n        updatedAt: new Date()\n      };\n      const menuTextFallback = `${fallbackGame.title}`;\n      const keyboardFallback = messageService.createMainMenuKeyboard(language, userId, fallbackGame, isPlaying[userIdStr]);\n      \n      try {\n        if (editMessage && messageIdToEdit && chatId) {\n          messageService.storeMessageId(ctx.from.id, messageIdToEdit);\n        }\n        await messageService.sendOrEditGameMessage(ctx, fallbackGame, menuTextFallback, keyboardFallback);\n      } catch (error) {\n          errorHandler.logError('Error sending fallback game:', error);\n          await ctx.reply(menuTextFallback, {\n            parse_mode: 'HTML',\n            reply_markup: keyboardFallback,\n          });\n        }\n        return;\n      }\n\n      bannerIndex[userIdStr] = bannerIndex[userIdStr] % validGames.length;\n      const currentGame = validGames[bannerIndex[userIdStr]];\n\n      if (!currentGame || !currentGame.title) {\n        errorHandler.logError(`Current game undefined at index ${bannerIndex[userIdStr]}, ValidGames length: ${validGames.length}`);\n        bannerIndex[userIdStr] = 0;\n        const fallbackGame = validGames[0];\n        const menuText = `${fallbackGame.title}`;\n        const keyboard = messageService.createMainMenuKeyboard(language, userId, fallbackGame, isPlaying[userIdStr]);\n        \n        try {\n          await messageService.sendOrEditGameMessage(ctx, fallbackGame, menuText, keyboard);\n        } catch (error) {\n          errorHandler.logError('Error sending fallback game:', error);\n          await ctx.reply(menuText, {\n            parse_mode: 'HTML',\n            reply_markup: keyboard,\n          });\n        }\n        return;\n      }\n\n      const menuText = `${currentGame.title}`;\n      errorHandler.logInfo(`Showing main menu for user ${userId}. Language: ${language}.`);\n      errorHandler.logInfo(`Current banner text: \"${menuText}\", animation URL: \"${currentGame.gifUrl}\"`);\n      await loggerMiddleware.logUserAction(userId, 'main_menu_shown', { gameId: currentGame._id, gameTitle: currentGame.title });\n\n      const keyboard = messageService.createMainMenuKeyboard(language, userId, currentGame, isPlaying[userIdStr]);\n      errorHandler.logInfo(`Building keyboard for language: ${language}`);\n    const messageId = messageIdToEdit ?? messageService.getMessageIdToEdit(ctx.from.id);\n\n    try {\n        if (editMessage && messageId && ctx.chat?.id) {\n          // –ò—Å–ø–æ–ª—å–∑—É–µ–º messageService –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –º–µ–¥–∏–∞\n          messageService.storeMessageId(ctx.from.id, messageId);\n          await messageService.sendOrEditGameMessage(ctx, currentGame, menuText, keyboard);\n        } else if (!editMessage && ctx.chat?.id) {\n          errorHandler.logInfo(`Sending new main menu (messageId: ${messageId}, chatId: ${chatId}).`);\n          await messageService.sendOrEditGameMessage(ctx, currentGame, menuText, keyboard);\n        }\n      } catch (error) {\n        errorHandler.logError('Error sending/editing message:', error);\n        // –§–æ–ª–ª–±—ç–∫ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –∞–Ω–∏–º–∞—Ü–∏—é\n        const sentMessage = await ctx.replyWithAnimation(currentGame.gifUrl || currentGame.imageUrl, {\n          caption: menuText,\n          parse_mode: 'HTML',\n          reply_markup: keyboard,\n        });\n        messageService.storeMessageId(ctx.from.id, sentMessage.message_id);\n      }\n    } catch (error) {\n      await errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'showMainMenu');\n      await loggerMiddleware.logUserAction(userId, 'main_menu_error', { error: error instanceof Error ? error.message : String(error) });\n    } finally {\n      // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º—å—é—Ç–µ–∫—Å\n      messageUpdateMutex.delete(mutexKey);\n    }\n}\n\n// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n\n\n\n\n\nasync function showLanguageSelection(ctx: Context) {\n  if (!ctx.from) return;\n  const userId = ctx.from.id;\n\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —è–∑—ã–∫–æ–º –∏ –ø–æ–¥–ø–∏—Å–∫–æ–π\n  const user = await userService.getUserById(userId);\n  if (user && user.language && user.isSubscribed) {\n    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n    const l = localization(user.language);\n    const persistentKeyboard = messageService.createPersistentKeyboard(user.language);\n    \n    await ctx.reply(l.messages.welcome, {\n      reply_markup: persistentKeyboard,\n    });\n    \n    await showMainMenu(ctx, false);\n    return;\n  }\n\n  const keyboard = messageService.createLanguageKeyboard();\n  const langSelectionGif = WELCOME_GIFS?.ru || DEFAULT_GIF_URL;\n\n  // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å\n  const previousMessageId = messageService.getMessageIdToEdit(userId);\n  if (previousMessageId && ctx.chat?.id) {\n    try {\n      await ctx.deleteMessage(previousMessageId);\n      errorHandler.logInfo(`Deleted previous message ${previousMessageId} for user ${userId} before showing language selection.`);\n    } catch (error) {\n      errorHandler.logWarning(`Could not delete message ${previousMessageId} for user ${userId}:`, error);\n    }\n  }\n\n  const l = localization('ru'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞\n  const message = await ctx.replyWithAnimation(langSelectionGif, {\n    caption: l.system.languageSelection,\n    parse_mode: 'HTML',\n    reply_markup: keyboard,\n  });\n\n  if ('message_id' in message) {\n    messageService.storeMessageId(userId, message.message_id);\n  }\n}\n","size_bytes":20481},"server/src/routes/adminRoutes.ts":{"content":"import express from 'express';\nimport {login, protectedRoute} from \"../controllers/adminController\";\n\nconst router = express.Router();\n\nrouter.post('/login', login);\nrouter.get('/protected', protectedRoute);\n\nexport default router;\n","size_bytes":232},"admin/vite.config.ts":{"content":"import { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\nimport tailwindcss from '@tailwindcss/vite'\n\n// https://vite.dev/config/\nexport default defineConfig({\n  plugins: [react(), tailwindcss()],\n})\n","size_bytes":220},"admin/README.md":{"content":"# React + TypeScript + Vite\n\nThis template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.\n\nCurrently, two official plugins are available:\n\n- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) for Fast Refresh\n- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh\n\n## Expanding the ESLint configuration\n\nIf you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:\n\n```js\nexport default tseslint.config([\n  globalIgnores(['dist']),\n  {\n    files: ['**/*.{ts,tsx}'],\n    extends: [\n      // Other configs...\n\n      // Remove tseslint.configs.recommended and replace with this\n      ...tseslint.configs.recommendedTypeChecked,\n      // Alternatively, use this for stricter rules\n      ...tseslint.configs.strictTypeChecked,\n      // Optionally, add this for stylistic rules\n      ...tseslint.configs.stylisticTypeChecked,\n\n      // Other configs...\n    ],\n    languageOptions: {\n      parserOptions: {\n        project: ['./tsconfig.node.json', './tsconfig.app.json'],\n        tsconfigRootDir: import.meta.dirname,\n      },\n      // other options...\n    },\n  },\n])\n```\n\nYou can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:\n\n```js\n// eslint.config.js\nimport reactX from 'eslint-plugin-react-x'\nimport reactDom from 'eslint-plugin-react-dom'\n\nexport default tseslint.config([\n  globalIgnores(['dist']),\n  {\n    files: ['**/*.{ts,tsx}'],\n    extends: [\n      // Other configs...\n      // Enable lint rules for React\n      reactX.configs['recommended-typescript'],\n      // Enable lint rules for React DOM\n      reactDom.configs.recommended,\n    ],\n    languageOptions: {\n      parserOptions: {\n        project: ['./tsconfig.node.json', './tsconfig.app.json'],\n        tsconfigRootDir: import.meta.dirname,\n      },\n      // other options...\n    },\n  },\n])\n```\n","size_bytes":2269},"server/src/controllers/orderController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Order, {IOrder} from '../models/Order';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import Game from '../models/Game';\n// MONGO BACKUP: import Offer from '../models/Offer';\nimport {CryptoPay} from \"@foile/crypto-pay-api\";\nimport process from \"node:process\";\n// MONGO BACKUP: import Payment from \"../models/Payment\";\nimport console from \"node:console\";\nimport {cryptoPay} from \"./withdrawalController\";\n// MONGO BACKUP: import Transaction from \"../models/Transaction\";\nimport {io} from \"../../index\";\nimport { prisma } from '../db/client';\nimport { orderRepository, paymentRepository, transactionRepository } from '../db';\n\n// -> User\n\n// Get orders by user ID\nexport const getOrdersByMe = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    logger.info('Fetching orders by user ID', { context: { userId } });\n\n    // MONGO BACKUP: const orders = await Order.find({ userId }).sort({ created_at: -1 });\n    // MONGO BACKUP: const ordersWithGameTitles = await Promise.all(\n    // MONGO BACKUP:   orders.map(async (order) => {\n    // MONGO BACKUP:     const offer = await Offer.findById(order.offerId);\n    // MONGO BACKUP:     const game = offer ? await Game.findById(offer.gameId) : null;\n    // MONGO BACKUP:     return {\n    // MONGO BACKUP:       ...order.toObject(),\n    // MONGO BACKUP:       gameTitle: game ? game.title : 'Unknown',\n    // MONGO BACKUP:     };\n    // MONGO BACKUP:   })\n    // MONGO BACKUP: );\n\n    const orders = await orderRepository.findByUserId(userId!);\n    \n    const ordersWithGameTitles = orders.map(order => ({\n      ...order,\n      gameTitle: order.offer?.game?.title || 'Unknown',\n    }));\n\n    logger.info('Orders fetched successfully', { context: { userId, orderCount: orders.length } });\n    res.json({ success: true, orders: ordersWithGameTitles });\n  } catch (error) {\n    logger.error('Error fetching user orders', { context: { error } });\n    res.status(500).json({ success: false, error: 'Failed to fetch user orders' });\n  }\n};\n\n// Get order by id\nexport const getOrderById = async (req: Request, res: Response) => {\n  try {\n    const { orderId } = req.params;\n    logger.info('Fetching order by ID', { context: { orderId } });\n\n    // MONGO BACKUP: const order = await Order.findById(orderId);\n    const order = await orderRepository.findById(parseInt(orderId));\n    \n    if (!order) {\n      logger.warn('Order not found', { context: { orderId } });\n      return res.status(404).json({ success: false, error: 'Order not found' });\n    }\n\n    logger.info('Order fetched successfully', { context: { orderId } });\n    res.json(order);\n  } catch (error) {\n    logger.error('Error fetching order', { context: { error } });\n    res.status(500).json({ success: false, error: 'Failed to fetch order' });\n  }\n}\n\n// Get count of orders by status\nexport const getOrdersCountByStatus = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    const { status } = req.params;\n    logger.info('Fetching order count by status', { context: { userId, status } });\n\n    // MONGO BACKUP: const count = await Order.countDocuments({ userId, status });\n    const count = await prisma.order.count({\n      where: { \n        userId: userId!,\n        status: status as any\n      }\n    });\n\n    logger.info('Order count fetched successfully', { context: { userId, status, count } });\n    res.json({ success: true, count });\n  } catch (error) {\n    logger.error('Error getting order count', { context: { error } });\n    res.status(500).json({ success: false, error: 'Failed to get order count' });\n  }\n};\n\n// -> Admin\n\n// Update order status\nexport const updateOrderStatus = async (req: Request, res: Response) => {\n  try {\n    const { orderId, status } = req.params;\n\n    const allowedStatuses = ['pending', 'process', 'completed', 'canceled', 'invalid'] as const;\n    type Status = typeof allowedStatuses[number];\n\n    if (!allowedStatuses.includes(status as Status)) {\n      return res.status(400).json({ success: false, error: 'Invalid status value' });\n    }\n\n    // MONGO BACKUP: const order = await Order.findById(orderId);\n    const order = await orderRepository.findById(parseInt(orderId));\n    \n    if (!order) {\n      return res.status(404).json({ success: false, error: 'Order not found' });\n    }\n\n    // MONGO BACKUP: const payment = await Payment.findOne({ orderId });\n    const payment = await prisma.payment.findUnique({\n      where: { orderId: parseInt(orderId) }\n    });\n\n    if (!payment) {\n      logger.warn('Payment not found', { context: { orderId } });\n      return res.status(404).json({ success: false, error: 'Payment not found' });\n    }\n\n    if (status === \"invalid\" && order.status === \"invalid\") {\n      logger.log('Order is already invalid', { context: { orderId } });\n      return res.json({ success: true, order });\n    }\n\n    if (status === order.status) {\n      logger.warn('Order status is already the same', { context: { orderId, status } });\n      return res.status(400).json({ success: false, error: 'Order status is already the same' });\n    }\n\n    if (status === \"canceled\" && payment) {\n      try {\n        const spend_id = `refund_${Date.now()}`;\n        await cryptoPay.transfer(payment.userId, payment.currency, payment.amountToPay.toString(), spend_id);\n        logger.info('Refund transaction created successfully', { context: { spend_id } });\n\n        // MONGO BACKUP: const transaction = new Transaction({\n        // MONGO BACKUP:   userId: payment.userId,\n        // MONGO BACKUP:   amount: payment.amountToPay,\n        // MONGO BACKUP:   currency: payment.currency,\n        // MONGO BACKUP:   type: \"refund\"\n        // MONGO BACKUP: });\n        // MONGO BACKUP: await transaction.save();\n        \n        const transaction = await transactionRepository.createTransaction(\n          payment.userId,\n          payment.amountToPay,\n          payment.currency as 'USDT' | 'RUB',\n          'refund'\n        );\n        \n        logger.info('Refund transaction created successfully', { context: { transactionId: transaction.id } });\n      } catch (error) {\n        logger.error('Error creating refund, transaction', { context: { error } });\n        return res.status(500).json({ success: false, error: 'Failed to cancel order' });\n      }\n    }\n\n    // MONGO BACKUP: order.status = status as Status;\n    // MONGO BACKUP: await order.save();\n    const updatedOrder = await orderRepository.updateStatus(parseInt(orderId), status as Status);\n\n    // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n    const orders = await orderRepository.findAll();\n\n    io.to('admin').emit('new-order', orders);\n\n    res.json({ success: true, order: updatedOrder });\n  } catch (error) {\n    console.log(error);\n    logger.error('Error updating order status', { context: { error } });\n    res.status(500).json({ success: false, error: 'Failed to update order status' });\n  }\n};\n","size_bytes":6993},"server/src/routes/orderDetailsRoutes.ts":{"content":"import express from 'express';\nimport {\n  createOrderDetails,\n  getOrderDetailsByOrderId,\n  updateOrderDetailsByOrderId,\n} from '../controllers/orderDetailsController';\nimport {authenticateUser} from \"../middleware/auth\";\n\nconst router = express.Router();\n\n// Route to create order details\nrouter.post('/', authenticateUser, createOrderDetails);\n\n// Route to get order details by order ID\nrouter.get('/:orderId', authenticateUser, getOrderDetailsByOrderId);\n\n// Route to update order details by order ID\nrouter.put('/:orderId', authenticateUser, updateOrderDetailsByOrderId);\n\nexport default router;","size_bytes":599},"admin/src/pages/AdminPanel.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport io, { Socket } from \"socket.io-client\";\nimport {useDispatch} from \"react-redux\";\nimport type {AppDispatch} from \"../store/store.ts\";\nimport ChatsPanel from \"../components/ChatsPanel.tsx\";\nimport OrdersPanel from \"../components/OrdersPanel.tsx\";\nimport {updateOrderStatus} from \"../store/features/ordersSlice.ts\";\nimport NewGameForm from \"../components/NewGameForm.tsx\";\nimport NewOfferForm from \"../components/NewOfferForm.tsx\";\n\ninterface Message {\n    sender: number;\n    content: string;\n    timestamp: string;\n}\n\ninterface IOrder {\n    _id: number;\n    paymentId: number;\n    userId: number;\n    offerId: number;\n    orderDetailsId: number | null;\n    status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid';\n    currency: 'USDT' | 'RUB';\n    createdAt?: Date;\n    updatedAt?: Date;\n}\n\nlet socket: Socket;\n\nexport default function AdminPanel() {\n    const dispatch = useDispatch<AppDispatch>();\n    const [chatMap, setChatMap] = useState<Record<number, Message[]>>({});\n    const [selectedUserId, setSelectedUserId] = useState<number | null>(null);\n    const [chatVisible, setChatVisible] = useState(false);\n    const [input, setInput] = useState(\"\");\n    const [activeTab, setActiveTab] = useState<\"chats\" | \"users\" | \"orders\" | \"game\" | \"offer\">(\"chats\");\n    const [unreadCounts, setUnreadCounts] = useState<Record<number, number>>({});\n    const [orders, setOrders] = useState<IOrder[]>([]);\n\n    useEffect(() => {\n        socket = io(import.meta.env.VITE_API_URL);\n        socket.emit(\"register_admin\");\n\n        socket.on(\"chat_history\", (allChats: Record<number, Message[]>) => {\n            setChatMap(allChats);\n            setUnreadCounts({});\n        });\n\n        socket.on(\"orders_history\", (orders: IOrder[]) => {\n            setOrders(orders);\n        });\n\n        socket.on(\"new_message\", ({ sender, content, timestamp, userId }) => {\n            setChatMap(prev => ({\n                ...prev,\n                [userId]: [...(prev[userId] || []), { sender, content, timestamp }],\n            }));\n            setUnreadCounts(prev => {\n                if (selectedUserId === userId) return { ...prev, [userId]: 0 };\n                return { ...prev, [userId]: (prev[userId] || 0) + 1 };\n            });\n        });\n\n        socket.on(\"unread_counts\", (counts: Record<number, number>) => {\n            setUnreadCounts(counts);\n        });\n\n        socket.on(\"new-order\", (orders: IOrder[]) => {\n            setOrders([]);\n            setOrders(orders);\n        });\n\n        return () => {\n            socket.disconnect();\n        };\n    }, []); // ‚úÖ Only runs once when admin logs in\n\n    useEffect(() => {\n        if (selectedUserId === null) return;\n        setUnreadCounts((prev) => ({ ...prev, [selectedUserId]: 0 }));\n    }, [selectedUserId]);\n\n    function handleReply() {\n        if (!input.trim() || selectedUserId === null) return;\n        socket.emit(\"admin_reply\", { userId: selectedUserId, content: input });\n\n        setChatMap((prev) => ({\n            ...prev,\n            [selectedUserId]: [\n                ...(prev[selectedUserId] || []),\n                { sender: 0, content: input, timestamp: new Date().toISOString() },\n            ],\n        }));\n\n        setInput(\"\");\n    }\n\n    const handleSelectedUserId = (id: number | null) => {\n        if (id === selectedUserId) return;\n        setSelectedUserId(id);\n        if (id !== null) {\n            socket.emit('admin_select_chat', selectedUserId);\n            setChatVisible(true);\n        }\n    }\n\n    const handleOrderStatusChange = async (orderId: number, status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid') => {\n        const data: { orderId: string, status: string } = {\n            orderId: orderId.toString(),\n            status,\n        }\n\n        await dispatch(updateOrderStatus(data));\n        socket.emit('admin_order_status_changed', { orderId: orderId.toString() });\n    }\n\n    return (\n        <div className=\"flex flex-col h-screen bg-gray-900 text-white\">\n            <div className=\"flex border-b border-gray-700 overflow-x-auto\">\n                {[\"Chats\", \"Users\", \"Orders\", \"Game\", \"Offer\"].map((tab) => (\n                    <button\n                        key={tab}\n                        className={`px-6 py-3 cursor-pointer ${\n                            activeTab === tab.toLowerCase()\n                                ? \"border-b-2 border-blue-500 text-blue-400\"\n                                : \"text-gray-400\"\n                        } hover:text-blue-300`}\n                        onClick={() => setActiveTab(tab.toLowerCase() as any)}\n                    >\n                        {tab}\n                    </button>\n                ))}\n            </div>\n\n            <div className=\"flex flex-1 overflow-hidden\">\n                {activeTab === \"chats\" && (\n                    <ChatsPanel\n                        chatMap={chatMap}\n                        selectedUserId={selectedUserId}\n                        chatVisible={chatVisible}\n                        setChatVisible={setChatVisible}\n                        setSelectedUserId={setSelectedUserId}\n                        handleSelectedUserId={handleSelectedUserId}\n                        input={input}\n                        setInput={setInput}\n                        handleReply={handleReply}\n                        unreadCounts={unreadCounts}\n                    />\n                )}\n                {activeTab === \"users\" && (\n                    <div className=\"flex-1 p-6 overflow-auto\">\n                        <h2 className=\"text-xl font-bold mb-4\">User Management (coming soon)</h2>\n                    </div>\n                )}\n                {activeTab === \"orders\" && (\n                    <OrdersPanel orders={orders} handleOrderStatusChange={handleOrderStatusChange} />\n                )}\n                {activeTab === \"game\" && (\n                    <NewGameForm />\n                )}\n                {activeTab === \"offer\" && (\n                    <NewOfferForm />\n                )}\n            </div>\n        </div>\n    );\n}\n","size_bytes":6113},"admin/src/store/features/offersSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\ninterface IOffer {\n    _id: number;\n    gameId: number;\n    title: string;\n    imageUrl: string;\n    priceRUB: number;\n    priceUSDT: number;\n    isEnabled: boolean;\n}\n\ninterface IOffersState {\n    offers: Array<IOffer>;\n    offer: IOffer | null;\n    loading: boolean;\n    error: string | null | undefined;\n}\n\nconst initialState: IOffersState = {\n    offers: [],\n    offer: null,\n    loading: false,\n    error: null,\n};\n\nexport const addOffer = createAsyncThunk(\n    'offers/addOffer',\n    async (data: any, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.post(`/offers`, data);\n            return response.data;\n        } catch (error: any) {\n            if (error.response && error.response.data) {\n                return rejectWithValue(error.response.data);\n            }\n            return rejectWithValue(error.message);\n        }\n    }\n);\n\n// Thunk to fetch offers with query params\nexport const fetchOffers = createAsyncThunk(\n    'offers/fetchOffers',\n    async ({ gameId, isEnabled }: { gameId: number; isEnabled?: boolean }, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.get(`/offers/game/${gameId}`, {\n                params: { isEnabled },\n            });\n            return response.data;\n        } catch (error: any) {\n            if (error.response && error.response.data) {\n                return rejectWithValue(error.response.data);\n            }\n            return rejectWithValue(error.message);\n        }\n    }\n);\n\nexport const fetchOffer = createAsyncThunk(\n    'offers/fetchOffer',\n    async (gameId: number, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.get(`/offers/${gameId}`);\n            return response.data;\n        } catch (error: any) {\n            if (error.response && error.response.data) {\n                return rejectWithValue(error.response.data);\n            }\n            return rejectWithValue(error.message);\n        }\n    }\n);\n\nconst offersSlice = createSlice({\n    name: 'offers',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchOffers.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchOffers.fulfilled, (state, action) => {\n                state.loading = false;\n                state.offers = action.payload;\n            })\n            .addCase(fetchOffers.rejected, (state, action) => {\n                state.loading = false;\n                state.offers = [];\n                state.error = action.error.message;\n            });\n        builder\n            .addCase(fetchOffer.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchOffer.fulfilled, (state, action) => {\n                state.loading = false;\n                state.offer = action.payload;\n            })\n            .addCase(fetchOffer.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n    }\n});\n\nexport default offersSlice.reducer;","size_bytes":3381},"client/src/components/GridWidget.tsx":{"content":"import React from 'react';\nimport type {RefObject} from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { forwardRef } from 'react';\n\ninterface GridWidgetProps {\n  onSelect: (count: number) => void;\n  ref: RefObject<HTMLDivElement | null>;\n}\n\nconst GridWidget: React.FC<GridWidgetProps> = forwardRef<HTMLDivElement, GridWidgetProps>(({ onSelect }, ref) => {\n  const {t} = useTranslation();\n\n  return (\n    <div ref={ref} className=\"absolute top-[60px] right-[10px] bg-[#1A1B1E] text-white p-4 rounded-lg border  border-[#27282C]\">\n      <h3 className=\"mb-2 text-sm font-medium text-[#8F96A3]\">{t('gridWidget.title')}</h3>\n      <div className=\"flex gap-2\">\n        <button\n          className=\"px-4 py-2 text-sm text-[#8F96A3] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => onSelect(2)}\n        >\n          2\n        </button>\n        <button\n          className=\"px-4 py-2 text-sm text-[#8F96A3] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => onSelect(3)}\n        >\n          3\n        </button>\n        {/*<button*/}\n        {/*  className=\"px-4 py-2 text-sm text-[#8F96A3] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"*/}\n        {/*  onClick={() => onSelect(4)}*/}\n        {/*>*/}\n        {/*  4*/}\n        {/*</button>*/}\n      </div>\n    </div>\n  );\n});\n\nexport default GridWidget;","size_bytes":1486},"server/src/config/logger.ts":{"content":"import winston from 'winston';\nimport path from 'path';\nimport fs from 'fs';\n\n// Create logs directory if it doesn't exist\nconst logsDir = path.join(process.cwd(), 'logs');\nif (!fs.existsSync(logsDir)) {\n  fs.mkdirSync(logsDir);\n}\n\n// Define log format\nconst logFormat = winston.format.combine(\n  winston.format.timestamp({ format: 'YYYY-MM-DDTHH:mm:ss.SSSZ' }), // ISO-8601 UTC format\n  winston.format.printf(({ timestamp, level, message, stack, ...meta }) => {\n    const log = {\n      timestamp,\n      level,\n      service: 'tip-top-api',\n      message,\n      context: meta.context || {},\n      ...(stack ? { stack } : {})\n    };\n    return JSON.stringify(log);\n  })\n);\n\n// Create the logger\nexport const logger = winston.createLogger({\n  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',\n  format: logFormat,\n  defaultMeta: { service: 'tip-top-api' },\n  transports: [\n    // Write all logs with level 'error' and below to error.log\n    new winston.transports.File({ \n      filename: path.join(logsDir, 'error.log'), \n      level: 'error',\n      maxsize: 5242880, // 5MB\n      maxFiles: 5\n    }),\n    // Write all logs with level 'info' and below to combined.log\n    new winston.transports.File({ \n      filename: path.join(logsDir, 'combined.log'),\n      maxsize: 5242880, // 5MB\n      maxFiles: 5\n    })\n  ]\n});\n\n// If we're not in production, log to the console as well\n// if (process.env.NODE_ENV !== 'production') {\n//   logger.add(new winston.transports.Console({\n//     format: winston.format.combine(\n//       winston.format.colorize(),\n//       winston.format.printf(({ timestamp, level, message, stack, ...meta }) => {\n//         const log = {\n//           timestamp,\n//           level,\n//           service: 'games-store-api',\n//           message,\n//           context: meta.context || {},\n//           ...(stack ? { stack } : {})\n//         };\n//         return JSON.stringify(log, null, 2);\n//       })\n//     )\n//   }));\n// }\n\n// Create a stream object for Morgan middleware\nexport const stream = {\n  write: (message: string) => {\n    logger.info(message.trim());\n  }\n};","size_bytes":2103},"client/src/components/CategoriesWidget.tsx":{"content":"import {useDispatch} from \"react-redux\";\nimport type {AppDispatch} from \"../store/store.ts\";\nimport {fetchActiveGames, fetchDiscountedGames, fetchGames} from \"../store/features/gamesSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\nimport { forwardRef } from 'react';\n\nconst CategoriesWidget = forwardRef<HTMLDivElement, any>(({setCategoriesVisible}, ref) => {\n    const dispatch = useDispatch<AppDispatch>();\n\n    const {t} = useTranslation();\n\n    const fetchAllGames = () => {\n        setCategoriesVisible(false);\n        dispatch(fetchGames());\n    }\n\n    const fetchAllActiveGames = () => {\n        setCategoriesVisible(false);\n        dispatch(fetchActiveGames());\n    }\n\n    const fetchAllGamesWithDiscount = () => {\n        setCategoriesVisible(false);\n        dispatch(fetchDiscountedGames());\n    }\n\n    return (\n        <div ref={ref} className=\"flex z-10 flex-col justify-start absolute top-[60px] left-[10px] h-fill w-fill bg-[#1A1B1E] text-white items-center rounded-lg border  border-[#27282C]\">\n            <div className=\"flex flex-col gap-2 w-full px-2 py-2 box-border\">\n                <div onClick={fetchAllGames} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/Catalog.gif\" alt=\"reviews\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('categoriesWidget.allGames')}</span>\n                    </div>\n                </div>\n                <div onClick={fetchAllActiveGames} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/News.gif\" alt=\"support\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('categoriesWidget.actualGames')}</span>\n                    </div>\n                </div>\n                <div onClick={fetchAllGamesWithDiscount} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/Bot.gif\" alt=\"about us\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('categoriesWidget.discounts')}</span>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n});\n\nexport default CategoriesWidget;\n","size_bytes":2649},"client/src/components/LinksWidget.tsx":{"content":"import {useTranslation} from \"react-i18next\";\nimport {forwardRef} from \"react\";\n\nconst LinksWidget = forwardRef<HTMLDivElement>((_, ref) => {\n    const {t} = useTranslation();\n\n    return (\n        <div ref={ref} className=\"flex flex-col justify-start absolute right-[8px] bottom-[58px] h-fill w-fill bg-[#1A1B1E] text-white items-center rounded-lg border  border-[#27282C]\">\n            <div className=\"flex flex-col gap-2 w-full px-2 py-2 box-border\">\n                <a href=\"https://t.me/TipTop999_catalog\" target=\"_blank\" className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/Catalog.gif\" alt=\"reviews\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('linksWidget.catalog')}</span>\n                    </div>\n                </a>\n                <a href=\"https://t.me/TipTop999_news\" target=\"_blank\" className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/News.gif\" alt=\"support\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('linksWidget.news')}</span>\n                    </div>\n                </a>\n                <a href=\"https://t.me/TipTop999_bot\" target=\"_blank\" className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border  border-[#27282C] cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                        <img className=\"w-[18px] h-[18px]\" src=\"/Bot.gif\" alt=\"about us\" />\n                        <span className=\"text-[14px] text-[#8F96A3]\">{t('linksWidget.bot')}</span>\n                    </div>\n                </a>\n            </div>\n        </div>\n    );\n});\n\nexport default LinksWidget;\n","size_bytes":2026},"admin/src/pages/AdminLogin.tsx":{"content":"import React, { useState } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { loginAdmin } from '../store/features/authSlice';\nimport type { RootState, AppDispatch } from '../store/store';\nimport { useNavigate } from 'react-router-dom';\n\nconst AdminLogin = () => {\n    const dispatch = useDispatch<AppDispatch>();\n    const navigate = useNavigate();\n\n    const { loading, error } = useSelector((state: RootState) => state.auth);\n\n    const [username, setUsername] = useState('');\n    const [password, setPassword] = useState('');\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        const resultAction = await dispatch(loginAdmin({ username, password }));\n        if (loginAdmin.fulfilled.match(resultAction)) {\n            navigate('/admin');\n        }\n    };\n\n    return (\n        <form className=\"flex flex-col items-center justify-center pb-35 gap-1 w-screen h-screen\" onSubmit={handleSubmit}>\n            <input\n                className=\"bg-gray-200 rounded-md p-2 w-[200px] outline-none\"\n                type=\"text\"\n                placeholder=\"Username\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                required\n            />\n            <input\n                className=\"bg-gray-200 rounded-md p-2 w-[200px] outline-none\"\n                type=\"password\"\n                placeholder=\"Password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n            />\n            <button className=\"bg-gray-200 rounded-md p-2 w-[200px] cursor-pointer\" type=\"submit\" disabled={loading}>\n                {loading ? 'Logging in...' : 'Login'}\n            </button>\n            {error && <p style={{ color: 'red' }}>{error}</p>}\n        </form>\n    );\n};\n\nexport default AdminLogin;\n","size_bytes":1880},"client/src/pages/Home.tsx":{"content":"import { useSelector, useDispatch } from 'react-redux'\nimport type { AppDispatch, RootState } from '../store/store'\nimport { fetchGames } from '../store/features/gamesSlice.ts';\nimport { useEffect } from 'react';\nimport { useNavigate, useOutletContext } from 'react-router-dom';\nimport { useTranslation } from 'react-i18next';\nimport MarqueeTitle from \"../components/MarqueeTitle.tsx\";\n\nconst Home = () => {\n  const { loading, games, error } = useSelector((state: RootState) => state.games);\n  const dispatch = useDispatch<AppDispatch>();\n  const { t } = useTranslation();\n  const { cardsPerRow } = useOutletContext<{ cardsPerRow: number }>();\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    // Fetch products from API or perform any other side effects here\n    dispatch(fetchGames());\n  }, [dispatch]);\n\n  if (loading) return <p>{t('home.loading')}</p>;\n  if (error) return <p>{t('home.error', { error: error })}</p>;\n  if (!games || games.length === 0) return <p className='text-white pt-1'>{t('home.noProducts')}</p>;\n\n  const gap: number = 8; // Gap between cards\n  const cardWidth: string = `calc(${100 / cardsPerRow}% - ${(gap * (cardsPerRow - 1)) / cardsPerRow}px)`; // Adjust the card width based on cardsPerRow\n\n  return (\n    <div className='flex max-w-[28rem] gap-[8px] flex-wrap content-start justify-start px-2 py-3'>\n      {games.length === 0 && <p>No products available</p>}\n      {games.map((game, index) => (\n        <div\n          onClick={() => navigate(`/offers/${game._id}`)}\n          key={index}\n          className=\"flex flex-col content-stretch justify-stretch h-fit rounded-[10px] cursor-pointer border-2  border-[#27282C]\"\n          style={{ width: cardWidth }}\n        >\n          <img src={game.imageUrl} alt={game.title} className=\"h-fit aspect-square object-center object-cover rounded-tl-[8px] rounded-tr-[8px]\" />\n          <div className=\"overflow-hidden w-full bg-[#1A1B1E] py-0.5 px-0.5 rounded-bl-lg rounded-br-lg\">\n            <h2 className=\"text-sm pb-0.5 max-[350px]:pb-0 pl-1 pr-0.5 font-normal max-[350px]:text-[13px] text-[#fff] whitespace-nowrap overflow-hidden\">\n              <MarqueeTitle text={game.title} />\n            </h2>\n          </div>\n        </div>\n      ))}\n    </div>\n  )\n}\n\nexport default Home\n","size_bytes":2266},"server/src/controllers/transactionController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Transaction from \"../models/Transaction\";\n// MONGO BACKUP: import User from '../models/User';\nimport { prisma } from '../db/client';\nimport { transactionRepository } from '../db';\n\nexport const getTransactionsByRefer = async (req: Request, res: Response) => {\n    try {\n        const userId = req.telegramUser?.id;\n\n        // MONGO BACKUP: const transactions = await Transaction.find({ referId: Number(userId) });\n        const transactions = await transactionRepository.findByReferrerId(Number(userId));\n\n        // MONGO BACKUP: const userIds = transactions.map(tx => tx.userId);\n        // MONGO BACKUP: const users = await User.find({ _id: { $in: userIds } }).lean();\n        // MONGO BACKUP: const userMap = new Map(users.map(u => [u._id.toString(), u.username]));\n        // MONGO BACKUP: const transactionsWithUsername = transactions.map(tx => ({\n        // MONGO BACKUP:     ...tx.toObject(),\n        // MONGO BACKUP:     username: userMap.get(tx.userId.toString()) || null,\n        // MONGO BACKUP: }));\n\n        const transactionsWithUsername = transactions.map(tx => ({\n            ...tx,\n            username: tx.user?.username || null,\n        }));\n\n        res.json(transactionsWithUsername);\n    } catch (error) {\n        console.error(error);\n        res.status(500).json({ error: 'Failed to fetch transactions for refer' });\n    }\n};\n","size_bytes":1421},"admin/src/components/OrdersPanel.tsx":{"content":"import React from \"react\";\n\ninterface IOrder {\n    _id: number;\n    paymentId: number;\n    userId: number;\n    offerId: number;\n    orderDetailsId: number | null;\n    status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid';\n    currency: 'USDT' | 'RUB';\n    createdAt?: Date;\n    updatedAt?: Date;\n}\n\ninterface OrdersPanelProps {\n    orders: IOrder[];\n    handleOrderStatusChange: (orderId: number, status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid') => void;\n}\n\nconst statusColorMap: Record<IOrder[\"status\"], string> = {\n    pending: \"text-yellow-400\",\n    process: \"text-blue-400\",\n    completed: \"text-green-400\",\n    canceled: \"text-red-400\",\n    invalid: \"text-gray-400\",\n};\n\nconst OrdersPanel: React.FC<OrdersPanelProps> = ({ orders, handleOrderStatusChange }) => {\n    return (\n        <div className=\"flex flex-col w-full p-6\">\n            <h2 className=\"text-xl font-bold mb-4\">Orders</h2>\n            <div className=\"flex flex-wrap gap-3 justify-start items-start flex-1 space-y-4 overflow-y-auto overflow-x-hidden\">\n                {orders.map(order => (\n                    <div\n                        key={order._id}\n                        className=\"w-[250px] bg-gray-800 p-4 rounded-lg shadow-md flex flex-col gap-2\"\n                    >\n                        <div className=\"w-full\">\n                            <div>\n                                <div className=\"text-sm text-gray-400\">Order ID:</div>\n                                <div className=\"font-semibold\">#{order._id}</div>\n                            </div>\n                            <div>\n                                <div className=\"text-sm text-gray-400\">User:</div>\n                                <div>User {order.userId}</div>\n                            </div>\n                            <div>\n                                <div className=\"text-sm text-gray-400\">Offer:</div>\n                                <div>Offer {order.offerId}</div>\n                            </div>\n                            <div>\n                                <div className=\"text-sm text-gray-400\">Status:</div>\n                                <div className={`${statusColorMap[order.status]} font-semibold`}>{order.status}</div>\n                            </div>\n                            <div>\n                                <div className=\"text-sm text-gray-400\">Currency:</div>\n                                <div>{order.currency}</div>\n                            </div>\n                            <div>\n                                <div className=\"text-sm text-gray-400\">Created:</div>\n                                <div className=\"text-sm\">{order.createdAt ? new Date(order.createdAt).toLocaleString() : \"-\"}</div>\n                            </div>\n                        </div>\n                        {\n                            order.status === 'process' ? (\n                                <div className=\"flex flex-col items-center gap-2\">\n                                    <div className=\"w-full flex gap-2\">\n                                        <button onClick={() => handleOrderStatusChange(order._id, \"completed\")} className=\"flex-1 px-4 py-2 bg-blue-500 rounded-md hover:bg-blue-600 cursor-pointer\">\n                                            Complete\n                                        </button>\n                                        <button onClick={() => handleOrderStatusChange(order._id, \"canceled\")} className=\"px-4 py-2 bg-red-500 rounded-md hover:bg-red-600 cursor-pointer\">\n                                            Cancel\n                                        </button>\n                                    </div>\n                                    <button onClick={() => handleOrderStatusChange(order._id, \"invalid\")} className=\"w-full px-4 py-2 bg-gray-500 rounded-md hover:bg-gray-600 cursor-pointer\">\n                                        Invalid\n                                    </button>\n                                </div>\n                            ) : null\n                        }\n                        {\n                            order.status === 'pending' || order.status === 'invalid' ? (\n                                <div className=\"flex flex-col items-center gap-2\">\n                                    <div className=\"w-full flex gap-2\">\n                                        <button onClick={() => handleOrderStatusChange(order._id, \"canceled\")} className=\"w-full px-4 py-2 bg-red-500 rounded-md hover:bg-red-600 cursor-pointer\">\n                                            Cancel\n                                        </button>\n                                    </div>\n                                </div>\n                            ) : null\n                        }\n                    </div>\n                ))}\n            </div>\n        </div>\n    );\n};\n\nexport default OrdersPanel;\n","size_bytes":4905},"client/src/utils/telegram.ts":{"content":"import \"../types/telegram.d\"\nimport { mockInitData } from '../mock/initData';\n\nexport const getInitData = () => {  \n  if (import.meta.env.VITE_USE_MOCK === 'true') {\n    return `user=${encodeURIComponent(JSON.stringify(mockInitData))}&hash=MOCK_HASH`;\n  }\n  return window.Telegram?.WebApp?.initData || '';\n};","size_bytes":308},"server/src/routes/gameRoutes.ts":{"content":"import express from 'express';\nimport {\n  createGame,\n  getActiveGames, getDiscountedGames,\n  getGameById,\n  getGames,\n  searchGames\n} from '../controllers/gameController';\nimport {authenticateUser} from \"../middleware/auth\";\nimport {isAdmin} from \"../middleware/admin\";\n\nconst router = express.Router();\n\n// Public routes\nrouter.get('/', getGames);\nrouter.get('/active', getActiveGames);\nrouter.get('/discounts', getDiscountedGames);\nrouter.get('/search', searchGames);\nrouter.get('/:id', getGameById);\n\n// Admin-only routes\nrouter.post('/', authenticateUser, isAdmin, createGame);\n// router.put('/:id', authenticateUser, isAdmin, updateGame);\n// router.delete('/:id', authenticateUser, isAdmin, deleteGame);\n\nexport default router;","size_bytes":733},"client/src/store/features/paymentsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const createCryptoPayment = createAsyncThunk('payments/createCryptoPayment', async (paymentData: { gameName: string; offerName: string; price: number }, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.post('/payments/crypto', paymentData);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\nexport const createRubPayment = createAsyncThunk('payments/createRubPayment', async (paymentData: { gameName: string; offerName: string; price: number }, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.post('/payments/rub', paymentData);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\ninterface IOrdersState {\n  paymentLink: string | null;\n  loading: boolean;\n  error: string | null;\n}\n\nconst initialState: IOrdersState = {\n  paymentLink: null,\n  loading: false,\n  error: null,\n};\n\nconst paymentsSlice = createSlice({\n  name: 'payments',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(createCryptoPayment.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(createCryptoPayment.fulfilled, (state, action) => {\n        state.loading = false;\n        state.paymentLink = action.payload.invoice.miniAppInvoiceUrl;\n      })\n      .addCase(createCryptoPayment.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload as string;\n      });\n    builder\n        .addCase(createRubPayment.pending, (state) => {\n          state.loading = true;\n          state.error = null;\n        })\n        .addCase(createRubPayment.fulfilled, (state, action) => {\n          state.loading = false;\n          state.paymentLink = action.payload.invoice.payUrl;\n        })\n        .addCase(createRubPayment.rejected, (state, action) => {\n          state.loading = false;\n          state.error = action.payload as string;\n        });\n  },\n});\n\nexport default paymentsSlice.reducer;","size_bytes":2441},"client/src/components/Menu.tsx":{"content":"import { ChevronRight, Gem } from \"lucide-react\";\nimport { useSelector } from \"react-redux\";\nimport type { RootState } from \"../store/store\";\nimport { useNavigate } from \"react-router-dom\";\nimport { useTranslation } from \"react-i18next\";\nimport { forwardRef } from \"react\";\n\nconst Menu = forwardRef<HTMLDivElement, any>(({ visible }, ref) => {\n  const user = useSelector((state: RootState) => state.user.user);\n  const navigate = useNavigate();\n  const { t } = useTranslation();\n\n  if (!user || !visible) return null;\n\n  return (\n      <div\n          ref={ref}\n          className=\"flex flex-col justify-start absolute left-[8px] bottom-[58px] h-fit w-fit bg-[#1A1B1E] text-white items-center rounded-lg border border-[#27282C] z-50\"\n      >\n        <div onClick={() => navigate(\"/profile\")} className=\"flex gap-4 max-[350px]:gap-2 justify-between w-full text-[14px] py-2 px-2 box-border\">\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-[50px] h-[50px]\">\n              <img className=\"rounded\" src={user.avatarUrl || \"\"} alt=\"profile photo\" />\n            </div>\n            <div className=\"flex flex-col items-start gap-0\">\n              <span>{user.username}</span>\n              <span className=\"text-[#979EAA]\">ID: {user._id}</span>\n              <span className=\"flex items-center gap-1\">\n              <span className=\"text-[#b9f2ff]\">{user.referralPercent}% - </span>\n                {Array.from({ length: user.referralPercent || 0 }, (_, i) => (\n                    <Gem key={i} className=\"text-[#b9f2ff]\" size={18} />\n                ))}\n            </span>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-1 cursor-pointer\">\n            <div className=\"flex flex-col items-center gap-0 bg-[#1E1F23] rounded-[10px] px-2 py-2 border border-[#27282C]\">\n              <span className=\"text-[16px]\">{user.balanceUSDT}$</span>\n              <span className=\"text-[#979EAA] text-[12px]\">{t('menu.balance')}</span>\n            </div>\n            <div>\n              <ChevronRight className=\"w-[18px] h-[18px] text-[#fff]\" />\n            </div>\n          </div>\n        </div>\n        <div className=\"flex flex-col gap-2 w-full px-2 py-2 box-border\">\n          <div onClick={() => navigate(\"/orders\")} className=\"flex items-center justify-between gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border border-[#27282C] cursor-pointer\">\n            <div className=\"flex items-center gap-2\">\n              <img className=\"w-[18px] h-[18px]\" src=\"/Purchases.gif\" alt=\"orders\" />\n              <span className=\"text-[14px]\">{t('menu.orders')}</span>\n            </div>\n            <span className=\"text-[14px]\">{user.ordersCount}</span>\n          </div>\n          <div onClick={() => navigate(\"/reviews\")} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border border-[#27282C] cursor-pointer\">\n            <div className=\"flex items-center gap-2\">\n              <img className=\"w-[18px] h-[18px]\" src=\"/Completed.gif\" alt=\"reviews\" />\n              <span className=\"text-[14px]\">{t('menu.reviews')}</span>\n            </div>\n          </div>\n          <div onClick={() => navigate(\"/chat\")} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border border-[#27282C] cursor-pointer\">\n            <div className=\"flex items-center gap-2\">\n              <img className=\"w-[18px] h-[18px]\" src=\"/Chat.gif\" alt=\"support\" />\n              <span className=\"text-[14px]\">{t('menu.support')}</span>\n            </div>\n          </div>\n          <div onClick={() => navigate(\"/about\")} className=\"flex items-center justify-start gap-2 bg-[#1E1F23] rounded-lg px-2 py-2 border border-[#27282C] cursor-pointer\">\n            <div className=\"flex items-center gap-2\">\n              <img className=\"w-[18px] h-[18px]\" src=\"/Info.gif\" alt=\"about us\" />\n              <span className=\"text-[14px]\">{t('menu.aboutUs')}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n  );\n});\n\nexport default Menu;\n","size_bytes":4030},"client/src/store/features/userSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\n// create new user\nexport const createUser = createAsyncThunk('user/createUser', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.post('/users');\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\n// Update user language\nexport const updateLanguage = createAsyncThunk('user/updateLanguage', async (lang: 'ru' | 'en', { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.put('/users/language', {language: lang});\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\n// Async thunk to fetch game by id from an API\nexport const fetchUser = createAsyncThunk('user/fetchUser', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/users/me`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\ninterface IUser {\n  _id: number;\n  username: string;\n  language: string;\n  isBanned: boolean;\n  isSubscribed: boolean;\n  avatarUrl?: string;\n  balanceRUB: number;\n  balanceUSDT: number;\n  ordersCount: number;\n  referralCode?: string;\n  referralPercent: number;\n  acceptedPrivacyConsent: boolean;\n  createdAt?: Date;\n  updatedAt?: Date;\n}\n\ninterface IUserState {\n  user: IUser | null;\n  isAuth: boolean;\n  loading: boolean;\n  error: string | null;\n}\n\nconst initialState: IUserState = {\n  user: null,\n  isAuth: false,\n  loading: false,\n  error: null,\n};\n\nconst userSlice = createSlice({\n  name: 'user',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchUser.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchUser.fulfilled, (state, action) => {\n        state.loading = false;\n        state.user = action.payload;\n        state.isAuth = true;\n      })\n      .addCase(fetchUser.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload as string;\n      });\n    builder\n        .addCase(updateLanguage.pending, (state) => {\n          state.loading = true;\n          state.error = null;\n        })\n        .addCase(updateLanguage.fulfilled, (state, action) => {\n          state.loading = false;\n          state.user = action.payload;\n          state.isAuth = true;\n        })\n        .addCase(updateLanguage.rejected, (state, action) => {\n          state.loading = false;\n          state.error = action.payload as string;\n        });\n  }\n});\n\nexport default userSlice.reducer;","size_bytes":3052},"admin/src/styles.css":{"content":"@import \"tailwindcss\";\n\nhtml {\n  background-color: #141414;\n}\n","size_bytes":62},"client/src/pages/Withdrawals.tsx":{"content":"import { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store.ts\";\nimport { useEffect, useMemo } from \"react\";\nimport { createWithdrawal, fetchWithdrawalsByMe } from \"../store/features/withdrawalsSlice.ts\";\nimport { Gem } from \"lucide-react\";\nimport {fetchUser} from \"../store/features/userSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\n\nconst Withdrawals = () => {\n  const dispatch = useDispatch<AppDispatch>();\n  const withdrawals = useSelector((state: RootState) => state.withdrawals.withdrawals);\n  const user = useSelector((state: RootState) => state.user.user);\n\n  const {t} = useTranslation();\n\n  useEffect(() => {\n    dispatch(fetchWithdrawalsByMe());\n  }, [dispatch]);\n\n  const hasActiveRequest = useMemo(() => {\n    return withdrawals.some(w => w.status === 'pending');\n  }, [withdrawals]);\n\n  if (!user) return null;\n\n  const currentBalance = user.balanceUSDT;\n\n  const handleNewWithdrawal = async () => {\n    if (currentBalance) {\n      const newWithdrawal = {\n        amount: currentBalance\n      };\n\n      await dispatch(createWithdrawal(newWithdrawal));\n      await dispatch(fetchWithdrawalsByMe());\n      await dispatch(fetchUser());\n    }\n  };\n\n  return (\n      <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-y-auto py-3 px-2\">\n        {/* User Info */}\n        <div className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] mb-2\">\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-[75px] h-[75px] bg-[#252629] rounded-lg flex items-center justify-center border border-[#27282C] overflow-hidden\">\n              <img\n                  src={user.avatarUrl || \"\"}\n                  alt=\"Profile\"\n                  className=\"w-full h-full object-cover\"\n              />\n            </div>\n            <div className=\"flex-grow\">\n              <h2 className=\"text-base font-normal mb-0.5 text-white\">{user.username}</h2>\n              <div className=\"text-sm font-normal text-white\">ID: {user._id}</div>\n              <div className=\"flex items-center gap-1 mt-0.5\">\n                <span className=\"text-sm font-normal text-white\">{user.referralPercent}%</span>\n                <div className=\"flex text-[#4a9eff]\">\n                  {Array.from({ length: user.referralPercent || 0 }, (_, i) => (\n                      <Gem key={i} className=\"text-[#b9f2ff]\" size={18} />\n                  ))}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Withdrawal Info */}\n        <div className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] p-2 mb-2\">\n          <div className=\"flex items-center gap-2 mb-3\">\n            <span className=\"text-xl\">ü§ñ</span>\n            <h2 className=\"text-base font-medium text-white\">{t('withdrawals.title')}</h2>\n          </div>\n          <div className=\"space-y-2 text-sm text-gray-400\">\n            <div className=\"flex items-center gap-2\">\n              <span>‚è∞</span>\n              <span>{t('withdrawals.text1')}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span>üìå</span>\n              <span>{t('withdrawals.text2')}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span>üöÄ</span>\n              <span>{t('withdrawals.text3')}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span>üí¨</span>\n              <span>{t('withdrawals.text4')}</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Balance and Withdraw Button */}\n        <div className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] p-2 mb-2\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-2xl\">üí∞</span>\n              <div>\n                <div className=\"text-sm text-gray-400\">{t('withdrawals.balance')}:</div>\n                <div className=\"text-xl max-[350px]:text-base font-bold text-white\">{currentBalance?.toFixed(2)}$</div>\n              </div>\n            </div>\n            <button\n                className=\"bg-[#252629] text-[#8F96A3] max-[350px]:text-sm px-6 py-2 rounded-md font-medium disabled:opacity-60 border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n                disabled={hasActiveRequest || (currentBalance ?? 0) < 1}\n                onClick={handleNewWithdrawal}\n            >\n              {t('withdrawals.btn')}\n            </button>\n          </div>\n        </div>\n\n        {/* Current Request */}\n        {/*{hasActiveRequest && (*/}\n        {/*    <div className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] p-2 mb-2\">*/}\n        {/*      <h3 className=\"text-base font-medium text-[#FFB800] mb-2\">–¢–µ–∫—É—â–∞—è –∑–∞—è–≤–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h3>*/}\n        {/*      <div className=\"space-y-1 text-sm\">*/}\n        {/*        <div className=\"flex items-center gap-2\">*/}\n        {/*          <span className=\"text-gray-400\">–°—É–º–º–∞:</span>*/}\n        {/*          <span className=\"text-white\">${currentBalance}</span>*/}\n        {/*        </div>*/}\n        {/*        <div className=\"flex items-center gap-2\">*/}\n        {/*          <span className=\"text-gray-400\">–î–∞—Ç–∞:</span>*/}\n        {/*          <span className=\"text-white\">27.12.2024, 15:59:18</span>*/}\n        {/*        </div>*/}\n        {/*      </div>*/}\n        {/*    </div>*/}\n        {/*)}*/}\n\n        {/* Withdrawal History */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center gap-2 p-2\">\n            <span className=\"text-xl\">üìÑ</span>\n            <h2 className=\"text-lg font-medium text-white\">{t('withdrawals.historyTitle')}</h2>\n          </div>\n          {withdrawals.map((withdrawal, index) => (\n              <div\n                  key={index}\n                  className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] p-2\"\n              >\n                <div className=\"flex justify-between items-start mb-2\">\n                  <span className=\"text-lg max-[350px]:text-base font-medium text-white\">${withdrawal.amount.toFixed(2)}</span>\n                  <span\n                      className={`text-sm ${\n                          withdrawal.status === 'completed' ? 'text-green-500' : 'text-[#FFB800]'\n                      }`}\n                  >\n                {withdrawal.status === 'completed' ? t('withdrawals.completed') : withdrawal.status === 'pending' ? t('withdrawals.pending') : t('withdrawals.failed')}\n              </span>\n                </div>\n                <div className=\"text-sm text-gray-400\">{t('withdrawals.date')}: {withdrawal.createdAt.toString()}</div>\n              </div>\n          ))}\n        </div>\n      </div>\n  );\n};\n\nexport default Withdrawals;\n","size_bytes":6838},"server/src/controllers/orderDetailsController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import OrderDetails from '../models/OrderDetails';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import Order, {IOrder} from \"../models/Order\";\nimport {clients, io} from \"../../index\";\n// MONGO BACKUP: import Offer from \"../models/Offer\";\n// MONGO BACKUP: import Game from \"../models/Game\";\n// MONGO BACKUP: import {Chat, IMessage} from \"../models/Chat\";\n// MONGO BACKUP: import Payment from \"../models/Payment\";\nimport { prisma } from '../db/client';\nimport { orderRepository, chatRepository } from '../db';\n\n// Create new order details\nexport const createOrderDetails = async (req: Request, res: Response) => {\n  try {\n    const { orderId } = req.body;\n    const userId = req.telegramUser?.id;\n    logger.info('Creating new order details', { context: { body: req.body } });\n\n    // MONGO BACKUP: const order = await Order.findById(orderId);\n    const order = await orderRepository.findById(parseInt(orderId));\n\n    if (!order) {\n      logger.warn('Order not found', { context: { orderId } });\n      return res.status(404).json({ message: 'Order not found' });\n    }\n\n    if (order.userId !== userId) {\n      logger.warn('Order does not belong to user', { context: { orderId } });\n      return res.status(400).json({ message: 'Order does not belong to user' });\n    }\n\n    if (order.status !== 'pending') {\n      logger.warn('Order status is not pending', { context: { orderId } });\n      return res.status(400).json({ message: 'Order status is not pending' });\n    }\n\n    // MONGO BACKUP: order.status = 'process';\n    // MONGO BACKUP: await order.save();\n    await orderRepository.updateStatus(parseInt(orderId), 'process');\n\n    // MONGO BACKUP: const orderDetails = new OrderDetails(req.body);\n    // MONGO BACKUP: await orderDetails.save();\n    const orderDetails = await prisma.orderDetails.create({\n      data: {\n        order: { connect: { id: parseInt(orderId) } },\n        ...req.body,\n        orderId: parseInt(orderId),\n      }\n    });\n\n    // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n    const orders = await orderRepository.findAll();\n\n    io.to('admin').emit('new-order', orders);\n\n    logger.info('Order details created successfully', { context: { orderDetailsId: orderDetails.id } });\n    res.status(201).json(orderDetails);\n  } catch (error) {\n    logger.error('Error creating order details', { context: { error } });\n    res.status(500).json({ message: 'Error creating order details', error });\n  }\n};\n\n// Get order details by order ID\nexport const getOrderDetailsByOrderId = async (req: Request, res: Response) => {\n  try {\n    const { orderId } = req.params;\n    logger.info('Fetching order details by order ID', { context: { orderId } });\n\n    // MONGO BACKUP: const orderDetails = await OrderDetails.findOne({ orderId });\n    const orderDetails = await prisma.orderDetails.findUnique({\n      where: { orderId: parseInt(orderId) }\n    });\n    \n    if (!orderDetails) {\n      logger.warn('Order details not found', { context: { orderId } });\n      return res.status(404).json({ message: 'Order details not found' });\n    }\n\n    logger.info('Order details fetched successfully', { context: { orderId, orderDetailsId: orderDetails.id } });\n    res.json(orderDetails);\n  } catch (error) {\n    logger.error('Error fetching order details', { context: { error } });\n    res.status(500).json({ message: 'Error fetching order details', error });\n  }\n};\n\n// Update order details by order ID\nexport const updateOrderDetailsByOrderId = async (req: Request, res: Response) => {\n  try {\n    const { orderId } = req.params;\n    const userId = req.telegramUser?.id;\n    logger.info('Updating order details by order ID', { context: { orderId, body: req.body } });\n\n    // MONGO BACKUP: const order = await Order.findById(orderId);\n    const order = await orderRepository.findById(parseInt(orderId));\n    \n    if (!order) {\n      logger.warn('Order not found', { context: { orderId } });\n      return res.status(404).json({ message: 'Order not found' });\n    }\n\n    if (userId !== order.userId) {\n      logger.warn('Order does not belong to user', { context: { orderId } });\n      return res.status(400).json({ message: 'Order does not belong to user' });\n    }\n\n    // MONGO BACKUP: const updatedOrderDetails = await OrderDetails.findOneAndUpdate(\n    // MONGO BACKUP:   { orderId },\n    // MONGO BACKUP:   req.body,\n    // MONGO BACKUP:   { new: true, runValidators: true }\n    // MONGO BACKUP: );\n    const updatedOrderDetails = await prisma.orderDetails.update({\n      where: { orderId: parseInt(orderId) },\n      data: req.body\n    });\n\n    if (!updatedOrderDetails) {\n      logger.warn('Order details not found for update', { context: { orderId } });\n      return res.status(404).json({ message: 'Order details not found' });\n    }\n\n    // MONGO BACKUP: order.status = \"process\";\n    // MONGO BACKUP: await order.save();\n    await orderRepository.updateStatus(parseInt(orderId), 'process');\n\n    // MONGO BACKUP: const payment = await Payment.findOne({ orderId });\n    const payment = await prisma.payment.findUnique({\n      where: { orderId: parseInt(orderId) }\n    });\n    \n    if (!payment) {\n      logger.warn('Payment not found for order', { context: { orderId } });\n      return res.status(404).json({ message: 'Payment not found' });\n    }\n\n    // MONGO BACKUP: const offer = await Offer.findOne({ _id: order.offerId });\n    // MONGO BACKUP: const game = await Game.findOne({ _id: offer?.gameId });\n    const offer = await prisma.offer.findUnique({\n      where: { id: order.offerId },\n      include: { game: true }\n    });\n    const game = offer?.game;\n\n    // Send notifications\n    const orderMsg = `üì¶ *Order status changed*\\n` +\n        `üÜî Order ID: ${order.id}\\n` +\n        `üéÆ Game: ${game?.title}\\n` +\n        `üéÆ Offer: ${offer?.title}\\n` +\n        `üí∞ Amount: ${payment?.amountToPay} ${order.currency}\\n` +\n        `üìå Status: ${order.status.toUpperCase()}\\n` +\n        `üïí Created: ${new Date(order.createdAt).toLocaleString()}\\n` +\n        `üïí Modified: ${new Date(order.updatedAt).toLocaleString()}\\n`;\n\n    const message = { sender: -1, content: orderMsg, timestamp: new Date(), isSystemMessage: false };\n\n    // MONGO BACKUP: let chat = await Chat.findOne({ userId: order.userId });\n    // MONGO BACKUP: if (!chat) {\n    // MONGO BACKUP:   chat = new Chat({\n    // MONGO BACKUP:     userId: order.userId,\n    // MONGO BACKUP:     messages: [message],\n    // MONGO BACKUP:     lastReadByUser: new Date(),\n    // MONGO BACKUP:     lastReadByAdmin: new Date(0),\n    // MONGO BACKUP:     unreadAdminCount: 0,\n    // MONGO BACKUP:   });\n    // MONGO BACKUP: } else {\n    // MONGO BACKUP:   chat.messages.push(message);\n    // MONGO BACKUP: }\n    // MONGO BACKUP: await chat.save();\n    \n    await chatRepository.addMessage(order.userId, message);\n\n    const clientSocketId = clients.get(order.userId);\n\n    if (clientSocketId) {\n      io.to(clientSocketId).emit('new_message', { sender: -1, content: orderMsg });\n    }\n\n    // MONGO BACKUP: const orders: IOrder[] = await Order.find();\n    const orders = await orderRepository.findAll();\n\n    io.to('admin').emit('new-order', orders);\n\n    logger.info('Order details updated successfully', { context: { orderId, orderDetailsId: updatedOrderDetails.id } });\n    res.json(updatedOrderDetails);\n  } catch (error) {\n    logger.error('Error updating order details', { context: { error } });\n    res.status(500).json({ message: 'Error updating order details', error });\n  }\n};\n","size_bytes":7559},"admin/src/vite-env.d.ts":{"content":"/// <reference types=\"vite/client\" />\n","size_bytes":38},"admin/src/App.tsx":{"content":"import {BrowserRouter, Route, Routes} from \"react-router-dom\"\nimport AdminPanel from \"./pages/AdminPanel.tsx\";\nimport AdminLogin from \"./pages/AdminLogin.tsx\";\nimport ProtectedRoute from \"./components/ProtectedRoute.tsx\";\n\nfunction App() {\n  return (\n    <>\n        <BrowserRouter>\n            <Routes>\n                <Route path=\"/admin/login\" element={<AdminLogin />} />\n                <Route\n                    path=\"/admin\"\n                    element={\n                        <ProtectedRoute>\n                            <AdminPanel />\n                        </ProtectedRoute>\n                    }\n                />\n            </Routes>\n        </BrowserRouter>\n    </>\n  )\n}\n\nexport default App\n","size_bytes":709},"admin/eslint.config.js":{"content":"import js from '@eslint/js'\nimport globals from 'globals'\nimport reactHooks from 'eslint-plugin-react-hooks'\nimport reactRefresh from 'eslint-plugin-react-refresh'\nimport tseslint from 'typescript-eslint'\n\nexport default tseslint.config(\n    { ignores: ['dist'] },\n    {\n      extends: [js.configs.recommended, ...tseslint.configs.recommended],\n      files: ['**/*.{ts,tsx}'],\n      languageOptions: {\n        ecmaVersion: 2020,\n        globals: globals.browser,\n      },\n      plugins: {\n        'react-hooks': reactHooks,\n        'react-refresh': reactRefresh,\n      },\n      rules: {\n        ...reactHooks.configs.recommended.rules,\n        \"@typescript-eslint/no-explicit-any\": \"off\",\n        'react-refresh/only-export-components': [\n          'warn',\n          { allowConstantExport: true },\n        ],\n      },\n    },\n)\n","size_bytes":827},"server/src/routes/webhookRoutes.ts":{"content":"import express from 'express';\nimport {handleCryptoWebhook, handleRubWebhook} from '../controllers/webhookController';\n\nconst router = express.Router();\n\n// Crypto payment webhook\nrouter.post('/crypto', handleCryptoWebhook);\nrouter.post('/rub', handleRubWebhook);\n\nexport default router; ","size_bytes":288},"client/src/store/features/referralsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const fetchReferralsCountByReferId = createAsyncThunk('referrals/fetchReferralsCountByReferId', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/referrals/refer/count`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\ninterface IReferralsState {\n  referralsCount: number;\n  loading: boolean;\n  error: string | null;\n}\n\nconst initialState: IReferralsState = {\n  referralsCount: 0,\n  loading: false,\n  error: null,\n};\n\nconst referralsSlice = createSlice({\n  name: 'referrals',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchReferralsCountByReferId.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchReferralsCountByReferId.fulfilled, (state, action) => {\n        state.loading = false;\n        state.referralsCount = action.payload;\n      })\n      .addCase(fetchReferralsCountByReferId.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload as string;\n      });\n  }\n});\n\nexport default referralsSlice.reducer;","size_bytes":1448},"bot/src/utils/subscription.ts":{"content":"import { Context } from 'telegraf';\nimport { CHANNEL_URL } from '../config/localization';\n\n/**\n * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–∞–Ω–∞–ª\n * @param ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç Telegraf\n * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n * @returns Promise<boolean> - true –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω, false –µ—Å–ª–∏ –Ω–µ—Ç\n */\nexport async function checkUserSubscription(ctx: Context, userId: string): Promise<boolean> {\n  try {\n    // –ò–∑–≤–ª–µ–∫–∞–µ–º username –∫–∞–Ω–∞–ª–∞ –∏–∑ URL\n    const channelUsername = extractChannelUsername(CHANNEL_URL);\n    \n    if (!channelUsername) {\n      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å username –∫–∞–Ω–∞–ª–∞ –∏–∑ URL:', CHANNEL_URL);\n      return false;\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª–µ\n    const chatMember = await ctx.telegram.getChatMember(channelUsername, parseInt(userId));\n    \n    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º, –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ–∫–∏–Ω—É–ª –∫–∞–Ω–∞–ª –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n    const isSubscribed = ['creator', 'administrator', 'member'].includes(chatMember.status);\n    \n    console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${isSubscribed ? '–ø–æ–¥–ø–∏—Å–∞–Ω' : '–Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω'}`);\n    \n    return isSubscribed;\n  } catch (error) {\n    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏:', error);\n    \n    // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞,\n    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω)\n    return false;\n  }\n}\n\n/**\n * –ò–∑–≤–ª–µ–∫–∞–µ—Ç username –∫–∞–Ω–∞–ª–∞ –∏–∑ Telegram URL\n * @param channelUrl - URL –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://t.me/channel_name)\n * @returns string | null - username –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å\n */\nfunction extractChannelUsername(channelUrl: string): string | null {\n  try {\n    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã URL:\n    // https://t.me/channel_name\n    // https://telegram.me/channel_name\n    // t.me/channel_name\n    // @channel_name\n    \n    if (channelUrl.startsWith('@')) {\n      return channelUrl;\n    }\n    \n    const match = channelUrl.match(/(?:https?:\\/\\/)?(?:t\\.me|telegram\\.me)\\/([a-zA-Z0-9_]+)/);\n    \n    if (match && match[1]) {\n      return `@${match[1]}`;\n    }\n    \n    return null;\n  } catch (error) {\n    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ username –∫–∞–Ω–∞–ª–∞:', error);\n    return null;\n  }\n}\n\n/**\n * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ\n * @param ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç Telegraf\n * @param channelUsername - Username –∫–∞–Ω–∞–ª–∞ (—Å @)\n * @returns Promise<any> - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ –∏–ª–∏ null\n */\nexport async function getChannelInfo(ctx: Context, channelUsername: string) {\n  try {\n    const chat = await ctx.telegram.getChat(channelUsername);\n    return chat;\n  } catch (error) {\n    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–Ω–∞–ª–µ:', error);\n    return null;\n  }\n}","size_bytes":3184},"client/src/store/features/reviewsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const createReview = createAsyncThunk('referrals/createReview', async (payload: any, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.post(`/reviews`, payload);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const fetchReviews = createAsyncThunk('referrals/fetchReviews', async (_, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/reviews`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport interface IReview {\n    _id: number;\n    userId: number;\n    orderId: number;\n    username: string;\n    rating: number;\n    comment: string;\n    createdAt: Date;\n    updatedAt: Date;\n}\n\ninterface IReviewsState {\n    reviews: IReview[];\n    loading: boolean;\n    error: string | null;\n}\n\nconst initialState: IReviewsState = {\n    reviews: [],\n    loading: false,\n    error: null,\n};\n\nconst reviewsSlice = createSlice({\n    name: 'reviews',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchReviews.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchReviews.fulfilled, (state, action) => {\n                state.loading = false;\n                state.reviews = action.payload;\n            })\n            .addCase(fetchReviews.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            })\n\n    }\n});\n\nexport default reviewsSlice.reducer;","size_bytes":2103},"client/src/pages/ReferralInfo.tsx":{"content":"import {useTranslation} from \"react-i18next\";\n\n\nconst ReferralInfo = () => {\n  const {t} = useTranslation();\n\n  return (\n    <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-y-auto py-2 px-2\">\n      {/* Main Title Section */}\n      <div className=\"flex items-center gap-3 mb-2\">\n        <span className=\"text-3xl\">ü§ù</span>\n        <h2 className=\"text-xl font-medium text-white\">{t('referralsDetails.title')}</h2>\n      </div>\n\n      {/* Description */}\n      <div className=\"bg-[#1a1b1e] p-2 mb-2 rounded-lg border  border-[#27282C]\">\n        <p className=\"text-[#8F96A3] text-sm leading-relaxed\">\n          {t('referralsDetails.desc')}\n        </p>\n      </div>\n\n      {/* Benefits Section */}\n      <div className=\"bg-[#1a1b1e] p-2 mb-2 rounded-lg border  border-[#27282C]\">\n        <h3 className=\"text-white text-base font-medium mb-3\">{t('referralsDetails.advantagesTitle')}</h3>\n        <ul className=\"space-y-2\">\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.advantagesText1')}</span>\n          </li>\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.advantagesText2')}</span>\n          </li>\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.advantagesText3')}</span>\n          </li>\n        </ul>\n      </div>\n\n      {/* Reward Levels */}\n      <div className=\"bg-[#1a1b1e] p-2 mb-2 rounded-lg border  border-[#27282C]\">\n        <h3 className=\"text-white text-base font-medium mb-3\">{t('referralsDetails.levelsTitle')}</h3>\n        <p className=\"text-[#8F96A3] text-sm mb-3\">\n          {t('referralsDetails.levelsDesc')}\n        </p>\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-[#8F96A3] text-sm\">1lvl</span>\n              <span>üíé</span>\n            </div>\n            <span className=\"text-[#8F96A3] text-sm\">1% - 1 üë•</span>\n          </div>\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-[#8F96A3] text-sm\">2lvl</span>\n              <span>üíéüíé</span>\n            </div>\n            <span className=\"text-[#8F96A3] text-sm\">2% - 3 üë•</span>\n          </div>\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-[#8F96A3] text-sm\">3lvl</span>\n              <span>üíéüíéüíé</span>\n            </div>\n            <span className=\"text-[#8F96A3] text-sm\">3% - 6 üë•</span>\n          </div>\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-[#8F96A3] text-sm\">4lvl</span>\n              <span>üíéüíéüíéüíé</span>\n            </div>\n            <span className=\"text-[#8F96A3] text-sm\">4% - 10 üë•</span>\n          </div>\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-[#8F96A3] text-sm\">5lvl</span>\n              <span>üíéüíéüíéüíéüíé</span>\n            </div>\n            <span className=\"text-[#8F96A3] text-sm\">5% - 15 üë•</span>\n          </div>\n        </div>\n      </div>\n\n      {/* Terms and Conditions */}\n      <div className=\"bg-[#1a1b1e] p-2 rounded-lg border  border-[#27282C]\">\n        <h3 className=\"text-white text-base font-medium mb-3\">{t('referralsDetails.conditionsTitle')}</h3>\n        <ul className=\"space-y-2\">\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.conditionsText1')}</span>\n          </li>\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.conditionsText2')}</span>\n          </li>\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.conditionsText3')}</span>\n          </li>\n          <li className=\"flex items-center gap-2 text-[#8F96A3] text-sm\">\n            <span className=\"text-white\">‚Ä¢</span>\n            <span>{t('referralsDetails.conditionsText4')}</span>\n          </li>\n        </ul>\n      </div>\n    </div>\n  );\n};\n\nexport default ReferralInfo;\n","size_bytes":4792},"bot/src/handlers/callback.handler.ts":{"content":"import { Context } from 'telegraf';\nimport { localization, CABINET_GIF_URL } from '../config/localization';\nimport { userService } from '../services/user.service';\nimport { gameService } from '../services/game.service';\nimport { handleLanguageChange, handleCheckSubscription, showMainMenu, bannerIndex, isPlaying, slideshowIntervals } from './start.handler';\nimport { messageService } from '../services/message.service';\nimport { messageUpdateManager } from '../utils/messageUpdateManager';\nimport { configService } from '../config/config.service';\nimport { errorHandler } from '../utils/errorHandler';\nimport { loggerMiddleware } from '../middleware/logger';\n\n// –°–µ—Ä–≤–∏—Å—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ —Å–∏–Ω–≥–ª—Ç–æ–Ω—ã\n\n// –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback query\nexport async function safeAnswerCbQuery(ctx: Context, text?: string, options?: any): Promise<void> {\n  try {\n    await ctx.answerCbQuery(text, options);\n  } catch (error: any) {\n    if (error.description?.includes('query is too old') || error.description?.includes('query ID is invalid')) {\n      errorHandler.logWarning('Callback query too old or invalid, ignoring:', error.description);\n    } else {\n      errorHandler.logError('Error answering callback query:', error);\n    }\n  }\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–∞–π–¥—à–æ—É —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ç–∞—Ç—É—Å–∞\nexport function stopSlideshowForUser(userId: string): boolean {\n  if (slideshowIntervals.has(userId)) {\n    const slideshow = slideshowIntervals.get(userId)!;\n    clearInterval(slideshow.interval);\n    clearTimeout(slideshow.timeout);\n    slideshowIntervals.delete(userId);\n    isPlaying[userId] = false;\n    errorHandler.logInfo(`Slideshow stopped for user ${userId}`);\n    return true;\n  }\n  return false;\n}\n\nexport async function handleCallbackQuery(ctx: Context) {\n  if (!ctx.callbackQuery || !('data' in ctx.callbackQuery)) return;\n  \n  const data = (ctx.callbackQuery as any).data;\n  const userId = ctx.from?.id;\n  \n  if (!userId) return;\n  \n  errorHandler.logInfo(`Callback query received: ${data} from user ${userId}`);\n  await loggerMiddleware.logUserAction(ctx, 'callback_query', { data });\n  \n  const user = await userService.getUserById(userId);\n  const language = user?.language || 'ru';\n  const l = localization(language);\n\n  try {\n    switch (data) {\n      case 'cabinet':\n        await handleCabinet(ctx);\n        break;\n      case 'language':\n        const newLang = language === 'ru' ? 'en' : 'ru';\n        await handleLanguageChange(ctx, newLang);\n        break;\n      case 'lang_ru':\n        await handleLanguageChange(ctx, 'ru');\n        break;\n      case 'lang_en':\n        await handleLanguageChange(ctx, 'en');\n        break;\n      case 'check_subscription':\n        await handleCheckSubscription(ctx);\n        break;\n      case 'banner_play':\n        await handleBannerPlay(ctx);\n        break;\n      case 'banner_stop':\n        await handleBannerStop(ctx);\n        break;\n      case 'banner_next':\n        await handleBannerNext(ctx);\n        break;\n      case 'banner_prev':\n        await handleBannerPrev(ctx);\n        break;\n      case 'back_to_menu':\n        await handleBackToMenu(ctx);\n        break;\n      case 'referral_program':\n        await handleReferralProgram(ctx);\n        break;\n      case 'orders':\n        await handleOrders(ctx);\n        break;\n      case 'withdraw':\n        await handleWithdraw(ctx);\n        break;\n      case 'refresh':\n        await handleRefresh(ctx);\n        break;\n      default:\n        errorHandler.logWarning(`Unknown callback data: ${data}`);\n        await safeAnswerCbQuery(ctx, l.errors.general);\n    }\n  } catch (error) {\n    errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'handleCallbackQuery');\n    await loggerMiddleware.logUserAction(ctx, 'callback_error', { data, error: error instanceof Error ? error.message : String(error) });\n    await safeAnswerCbQuery(ctx, l.errors.general);\n  }\n}\n\nasync function handleCabinet(ctx: Context) {\n  if (!ctx.from || !ctx.chat?.id) return;\n  \n  const userId = ctx.from.id;\n  \n  try {\n    const user = await userService.getUserById(userId);\n    if (!user) {\n        errorHandler.logError(`User not found for cabinet request: ${userId}`);\n        await loggerMiddleware.logUserAction(ctx, 'cabinet_error', { error: 'user_not_found' });\n        await safeAnswerCbQuery(ctx, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');\n        return;\n    }\n\n  const l = localization(user.language);\n  const webAppUrl = configService.getString('WEB_APP_URL', 'https://mobile-games.online/');\n  \n  stopSlideshowForUser(userId.toString());\n  \n  const referralsCount = 0; \n  const botUsername = configService.getString('BOT_USERNAME', 'TipTop999_bot');\n  const referralLink = `https://t.me/${botUsername.replace('@', '')}?start=${user.referralCode || 'UNKNOWN'}`;\n  \n  const keyboard = messageService.createCabinetKeyboard(l, webAppUrl);\n  \n  const cabinetText = `üßô‚Äç‚ôÄÔ∏è ${l.cabinet.user} @${ctx.from.username || l.cabinet.defaultUsername}\n` +\n    `üÜî ${l.cabinet.id} ${userId}\n` +\n    `üì¶ ${l.cabinet.ordersCount} ${user.ordersCount}\n` +\n    `ü§ù ${l.cabinet.referralProgram}\n` +\n    `üõçÔ∏è ${l.cabinet.referralPurchases} 0\n` +\n    `üíé ${l.cabinet.referralPercent} ${user.referralPercent}%\n` +\n    `üë• ${l.cabinet.referrals} ${referralsCount}\n` +\n    `üí∞ ${l.cabinet.balance} ${user.balanceRUB} $\n` +\n    `üîó ${l.cabinet.yourReferralLink}\n` +\n    `${referralLink}`;\n  \n  try {\n    let mediaUrl = CABINET_GIF_URL;\n    let mediaType: 'photo' | 'animation' = 'animation';\n    \n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è\n    try {\n      const userProfilePhotos = await ctx.telegram.getUserProfilePhotos(ctx.from.id, 0, 1);\n      if (userProfilePhotos.photos.length > 0) {\n        const photo = userProfilePhotos.photos[0];\n        const largestPhoto = photo[photo.length - 1];\n        mediaUrl = largestPhoto.file_id;\n        mediaType = 'photo';\n      }\n    } catch (photoError) {\n      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é\n      errorHandler.logInfo(`Could not get profile photo for user ${userId}, using default animation:`, photoError);\n    }\n    \n    const messageId = ctx.callbackQuery && 'message' in ctx.callbackQuery && (ctx.callbackQuery as any).message \n      ? (ctx.callbackQuery as any).message.message_id \n      : undefined;\n    \n    if (messageId && ctx.chat?.id) {\n        try {\n            await ctx.telegram.editMessageMedia(\n                ctx.chat.id,\n                messageId,\n                undefined,\n                {\n                  type: mediaType,\n                  media: mediaUrl,\n                  caption: cabinetText,\n                  parse_mode: 'HTML'\n                },\n                { reply_markup: keyboard }\n              );\n        } catch(error) {\n            const errorMsg = error instanceof Error ? error.message : String(error);\n            if (!errorMsg.includes('message is not modified') && !errorMsg.includes('message to edit not found')) {\n                errorHandler.logError('Error in handleCabinet editing message:', error);\n                // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n                if (mediaType === 'photo') {\n                    await ctx.replyWithPhoto(mediaUrl, { caption: cabinetText, parse_mode: 'HTML', reply_markup: keyboard });\n                } else {\n                    await ctx.replyWithAnimation(mediaUrl, { caption: cabinetText, parse_mode: 'HTML', reply_markup: keyboard });\n                }\n            }\n        }\n    } else {\n        if (mediaType === 'photo') {\n            await ctx.replyWithPhoto(mediaUrl, { caption: cabinetText, parse_mode: 'HTML', reply_markup: keyboard });\n        } else {\n            await ctx.replyWithAnimation(mediaUrl, { caption: cabinetText, parse_mode: 'HTML', reply_markup: keyboard });\n        }\n    }\n  } catch (error) {\n    errorHandler.logError('Error in handleCabinet:', error);\n  }\n  } catch (globalError) {\n    errorHandler.handleBotError(globalError instanceof Error ? globalError : new Error(String(globalError)), ctx, 'handleCabinet');\n    await loggerMiddleware.logUserAction(ctx, 'cabinet_critical_error', { error: globalError instanceof Error ? globalError.message : String(globalError) });\n    try {\n      await safeAnswerCbQuery(ctx, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞–±–∏–Ω–µ—Ç–∞');\n    } catch (cbError) {\n      errorHandler.logError('Failed to answer callback query:', cbError);\n    }\n    return;\n  }\n  \n  await loggerMiddleware.logUserAction(userId, 'cabinet_shown');\n  \n  await safeAnswerCbQuery(ctx);\n}\n\nasync function handleBannerPlay(ctx: Context) {\n    if (!ctx.from || !ctx.chat?.id) return;\n\n    const userId = ctx.from.id.toString();\n    const user = await userService.getUserById(ctx.from.id);\n    const l = localization(user?.language || 'ru');\n\n    if (slideshowIntervals.has(userId)) {\n        const slideshow = slideshowIntervals.get(userId)!;\n        clearInterval(slideshow.interval);\n        clearTimeout(slideshow.timeout);\n        slideshowIntervals.delete(userId);\n    }\n\n    isPlaying[userId] = true;\n\n    const games = await gameService.getEnabledGames();\n    if (games && games.length > 1) {\n        const chatId = ctx.chat.id;\n        const currentMessageId = (ctx.callbackQuery as any)?.message?.message_id || 0;\n\n        const intervalId = setInterval(async () => {\n            if (!slideshowIntervals.has(userId)) {\n                clearInterval(intervalId);\n                return;\n            }\n            bannerIndex[userId] = (bannerIndex[userId] + 1) % games.length;\n            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n            const updateKey = `${userId}_${ctx.chat?.id}_slideshow`;\n            messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n        }, 6000);\n\n        const timeoutId = setTimeout(() => {\n            if (slideshowIntervals.has(userId)) {\n                clearInterval(intervalId);\n                isPlaying[userId] = false;\n                slideshowIntervals.delete(userId);\n                errorHandler.logInfo(`Slideshow auto-stopped for user ${userId}`);\n            }\n        }, 30000);\n\n        slideshowIntervals.set(userId, {\n            interval: intervalId,\n            timeout: timeoutId,\n            chatId: chatId,\n            messageId: currentMessageId\n        });\n    }\n\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n    const updateKey = `${userId}_${ctx.chat?.id}_play`;\n    messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n    await loggerMiddleware.logUserAction(parseInt(userId), 'slideshow_started');\n    await safeAnswerCbQuery(ctx, l.slideshow.started);\n}\n\nasync function handleBannerStop(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id.toString();\n    const user = await userService.getUserById(ctx.from.id);\n    const l = localization(user?.language || 'ru');\n\n    stopSlideshowForUser(userId);\n\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n    const updateKey = `${userId}_${ctx.chat?.id}_stop`;\n    messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n    await loggerMiddleware.logUserAction(parseInt(userId), 'slideshow_stopped');\n    await safeAnswerCbQuery(ctx, l.slideshow.stopped);\n}\n\nasync function handleBannerNext(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id.toString();\n    const user = await userService.getUserById(ctx.from.id);\n    const l = localization(user?.language || 'ru');\n\n    const slideshowStopped = stopSlideshowForUser(userId);\n    const games = await gameService.getEnabledGames();\n\n    if (games && games.length > 0) {\n        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º bannerIndex –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n        if (!(userId in bannerIndex)) {\n            bannerIndex[userId] = 0;\n        }\n        bannerIndex[userId] = (bannerIndex[userId] + 1) % games.length;\n        errorHandler.logInfo(`Banner next for user ${userId}: index ${bannerIndex[userId]} of ${games.length} games`);\n        await loggerMiddleware.logUserAction(parseInt(userId), 'banner_next', { index: bannerIndex[userId], totalGames: games.length });\n        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n        const updateKey = `${userId}_${ctx.chat?.id}_next`;\n        messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n    }\n\n    if (slideshowStopped) {\n        await safeAnswerCbQuery(ctx, l.slideshow.stopped);\n    } else {\n        await safeAnswerCbQuery(ctx);\n    }\n}\n\nasync function handleBannerPrev(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id.toString();\n    const user = await userService.getUserById(ctx.from.id);\n    const l = localization(user?.language || 'ru');\n\n    const slideshowStopped = stopSlideshowForUser(userId);\n    const games = await gameService.getEnabledGames();\n\n    if (games && games.length > 0) {\n        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º bannerIndex –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n        if (!(userId in bannerIndex)) {\n            bannerIndex[userId] = 0;\n        }\n        bannerIndex[userId] = bannerIndex[userId] > 0 ? bannerIndex[userId] - 1 : games.length - 1;\n        errorHandler.logInfo(`Banner prev for user ${userId}: index ${bannerIndex[userId]} of ${games.length} games`);\n        await loggerMiddleware.logUserAction(parseInt(userId), 'banner_prev', { index: bannerIndex[userId], totalGames: games.length });\n        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n        const updateKey = `${userId}_${ctx.chat?.id}_prev`;\n        messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n    }\n\n    if (slideshowStopped) {\n        await safeAnswerCbQuery(ctx, l.slideshow.stopped);\n    } else {\n        await safeAnswerCbQuery(ctx);\n    }\n}\n\nasync function handleBackToMenu(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id.toString();\n    stopSlideshowForUser(userId);\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n    const updateKey = `${userId}_${ctx.chat?.id}_back`;\n    messageUpdateManager.scheduleUpdate(updateKey, () => showMainMenu(ctx, true));\n    await loggerMiddleware.logUserAction(parseInt(userId), 'back_to_menu');\n    await safeAnswerCbQuery(ctx);\n}\n\nasync function handleReferralProgram(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id;\n    const user = await userService.getUserById(userId);\n    if (!user) return;\n\n    const l = localization(user.language);\n    const slideshowStopped = stopSlideshowForUser(userId.toString());\n    const botUsername = configService.getString('BOT_USERNAME', 'TipTop999_bot');\n    const referralLink = `https://t.me/${botUsername.replace('@', '')}?start=${user.referralCode || 'UNKNOWN'}`;\n    const referralsCount = 0; // Placeholder\n\n    const keyboard = {\n        inline_keyboard: [\n            [{ text: l.buttons.back, callback_data: 'cabinet' }]\n        ]\n    };\n\n    const referralText = `ü§ù ${l.cabinet.referralProgram}\n\n` +\n        `üíé ${l.cabinet.referralPercent} ${user.referralPercent}%\n` +\n        `üë• ${l.cabinet.referrals} ${referralsCount}\n` +\n        `üõçÔ∏è ${l.cabinet.ordersCount} 0\n\n` +\n        `üîó ${l.cabinet.yourReferralLink}\n` +\n        `\\`${referralLink}\\`\n\n` +\n        l.cabinet.copyLinkText;\n\n    await ctx.editMessageCaption(referralText, {\n        reply_markup: keyboard,\n        parse_mode: 'Markdown'\n    });\n\n    await loggerMiddleware.logUserAction(userId, 'referral_program_viewed');\n    if (slideshowStopped) {\n        await safeAnswerCbQuery(ctx, l.slideshow.stopped);\n    } else {\n        await safeAnswerCbQuery(ctx);\n    }\n}\n\nasync function handleOrders(ctx: Context) {\n    if (!ctx.from) return;\n    \n    const userId = ctx.from.id;\n    const user = await userService.getUserById(userId);\n    if (!user) return;\n    \n    const l = localization(user.language);\n    const slideshowStopped = stopSlideshowForUser(userId.toString());\n    const keyboard = {\n        inline_keyboard: [\n            [{ text: l.buttons.back, callback_data: 'cabinet' }]\n        ]\n    };\n    \n    const ordersText = `${l.orders.title}${l.orders.empty}`;\n    \n    await ctx.editMessageCaption(ordersText, {\n        reply_markup: keyboard,\n        parse_mode: 'HTML'\n    });\n    \n    await loggerMiddleware.logUserAction(userId, 'orders_viewed');\n    if (slideshowStopped) {\n        await safeAnswerCbQuery(ctx, l.slideshow.stopped);\n    } else {\n        await safeAnswerCbQuery(ctx);\n    }\n}\n\nasync function handleWithdraw(ctx: Context) {\n    if (!ctx.from) return;\n\n    const userId = ctx.from.id;\n    const user = await userService.getUserById(userId);\n    if (!user) return;\n    \n    const l = localization(user.language);\n    const slideshowStopped = stopSlideshowForUser(userId.toString());\n    \n    const keyboard = {\n        inline_keyboard: [\n            [{ text: l.buttons.back, callback_data: 'cabinet' }]\n        ]\n    };\n    \n    const withdrawText = `üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤\n\n–í–∞—à –±–∞–ª–∞–Ω—Å: ${user.balanceUSDT}$\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞:`;\n    \n    await ctx.editMessageCaption(withdrawText, {\n        reply_markup: keyboard,\n        parse_mode: 'HTML'\n    });\n    \n    await loggerMiddleware.logUserAction(userId, 'withdraw_viewed');\n    if (slideshowStopped) {\n        await ctx.answerCbQuery(l.slideshow.stopped);\n    } else {\n        await ctx.answerCbQuery();\n    }\n}\n\nasync function handleRefresh(ctx: Context) {\n    try {\n        if (!ctx.from) {\n            errorHandler.logError('handleRefresh: ctx.from is missing');\n            return;\n        }\n        const userId = ctx.from.id;\n\n        // await userService.toggleReferralPercent(userId);\n\n        const user = await userService.getUserById(userId);\n        if (!user) {\n            errorHandler.logError(`handleRefresh: User ${userId} not found`);\n            await loggerMiddleware.logUserAction(userId, 'refresh_error', { error: 'user_not_found' });\n            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω\n            await ctx.answerCbQuery('User not found.', { show_alert: true });\n            return;\n        }\n\n        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π\n        const notificationText = user.language === 'ru' ? '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω! ‚úÖ' : 'Profile updated! ‚úÖ';\n        \n        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ë–ï–ó —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è\n        await ctx.answerCbQuery(notificationText, { show_alert: false });\n\n        // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\n        await handleCabinet(ctx);\n        \n        await loggerMiddleware.logUserAction(userId, 'profile_refreshed');\n\n    } catch (error) {\n        // –õ–æ–≥–∏—Ä—É–µ–º –ª—é–±—É—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏\n        errorHandler.handleBotError(error instanceof Error ? error : new Error(String(error)), ctx, 'handleRefresh');\n        if (ctx.from?.id) {\n            await loggerMiddleware.logUserAction(ctx.from.id, 'refresh_critical_error', { error: error instanceof Error ? error.message : String(error) });\n        }\n    }\n}\n","size_bytes":20021},"client/src/pages/Statistics.tsx":{"content":"import { useEffect } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport { fetchTransactionsByReferId } from \"../store/features/transactionsSlice.ts\";\nimport type { ITransaction } from \"../store/features/transactionsSlice.ts\";\nimport { fetchReferralsCountByReferId } from \"../store/features/referralsSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\n\n\n\nconst Statistics = () => {\n  const dispatch = useDispatch<AppDispatch>();\n\n  const {t} = useTranslation();\n\n  const user = useSelector((state: RootState) => state.user.user);\n  const transactions = useSelector((state: RootState) => state.transactions.transactions);\n  const referralsCount = useSelector((state: RootState) => state.referrals.referralsCount);\n\n  useEffect(() => {\n    dispatch(fetchTransactionsByReferId());\n    dispatch(fetchReferralsCountByReferId());\n  }, [dispatch]);\n\n  return (\n    <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-y-auto py-3 px-2\">\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-3 gap-2\">\n        <div\n          className={`rounded-lg bg-[#1a1b1e] p-4 border  border-[#27282C]`}\n        >\n          <div className=\"text-[22px] max-[350px]:text-lg font-bold text-white flex items-center justify-center gap-2\">\n            <img\n              src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–õ—é–¥–∏-r51OhufSUCgXxG5rZX5E7K5d5TpfAB.gif\"\n              alt=\"Referrals\"\n              className=\"w-7 h-7 max-[350px]:w-5 max-[350px]:h-5\"\n            />\n            <span className=\"text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)] text-white\">{referralsCount}</span>\n          </div>\n          <div className=\"text-[#8F96A3] text-sm text-center text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">{t('statistics.referrals')}</div>\n        </div>\n        <div\n          className={`rounded-lg bg-[#1a1b1e] p-4 border  border-[#27282C]`}\n        >\n          <div className=\"text-[22px] max-[350px]:text-lg font-bold text-white flex items-center justify-center gap-2\">\n            <img\n              src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–ü–æ–∫—É–ø–æ–∫-WRzItxdECelB09wDBDbapS7JN4nqAR.gif\"\n              alt=\"Purchases\"\n              className=\"w-7 h-7 max-[350px]:w-5 max-[350px]:h-5\"\n            />\n            <span className=\"text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)] text-white\">{transactions.length}</span>\n          </div>\n          <div className=\"text-[#8F96A3] text-sm text-center text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">{t('statistics.purchases')}</div>\n        </div>\n        <div className=\"rounded-lg bg-[#1a1b1e] p-4 border  border-[#27282C]\">\n          <div className=\"text-[22px] max-[350px]:text-lg font-bold text-white flex items-center justify-center gap-2\">\n            <img\n              src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–î–æ—Ö–æ–¥-Wj6IqY7LjQWdgWAiYijUlRNkY32Sxp.gif\"\n              alt=\"Income\"\n              className=\"w-7 h-7 max-[350px]:w-5 max-[350px]:h-5\"\n            />\n            <span className=\"text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)] text-white\">{(user?.balanceUSDT ?? 0) > 0 ? (user?.balanceUSDT ?? 0).toFixed(1) : '0'}</span>\n          </div>\n          <div className=\"text-[#8F96A3] text-sm text-center text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">{t('statistics.income')}</div>\n        </div>\n      </div>\n\n      {/* Purchases List */}\n      <div className=\"space-y-2 mt-2\">\n        {transactions.map((transaction: ITransaction) => (\n          <div key={transaction._id} className=\"rounded-lg border bg-[#1a1b1e] border-[#27282C] p-2\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[#8F96A3] text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>\n                <a\n                  href={`https://t.me/${transaction.username}`}\n                  className=\"text-[#8F96A3] hover:underline text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\"\n                  target=\"_blank\" rel=\"noopener noreferrer\"\n                >\n                  {transaction.username}\n                </a>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[#8F96A3] text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">üí∞ {t('statistics.sum')}:</span>\n                <span className=\"text-white text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">${transaction.amount.toFixed(2)}</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[#8F96A3] text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">üïí {t('statistics.date')}:</span>\n                <span className=\"text-white text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">{transaction.createdAt.toLocaleString()}</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[#8F96A3] text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">üéÅ {t('statistics.accrual')}:</span>\n                <span className=\"text-green-500 text-shadow-[0_0_10px_rgba(0,163,255,0.3)] transition-all duration-300 hover:text-shadow-[0_0_15px_rgba(0,163,255,0.5)]\">\n                  ${(transaction.earned ?? 0).toFixed(2)}\n                </span>\n              </div>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default Statistics;\n","size_bytes":6452},"admin/src/store/features/gamesSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\n// Add a new game\nexport const addGame = createAsyncThunk('games/addGame', async (data: any, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.post('/games', data);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\n// Async thunk to fetch games from an API\nexport const fetchGames = createAsyncThunk('games/fetchGames', async (_, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get('/games');\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const fetchActiveGames = createAsyncThunk(\n    'games/fetchActiveGames',\n    async (_, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.get('/games/active');\n            return response.data;\n        } catch (error: any) {\n            return rejectWithValue(error.response?.data || error.message);\n        }\n    }\n);\n\nexport const fetchDiscountedGames = createAsyncThunk(\n    'games/fetchDiscountedGames',\n    async (_, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.get('/games/discounts');\n            return response.data;\n        } catch (error: any) {\n            return rejectWithValue(error.response?.data || error.message);\n        }\n    }\n);\n\n\n// Thunk to search games\nexport const searchGames = createAsyncThunk(\n    'games/searchGames',\n    async (query: string, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.get(`/games/search`, {\n                params: { query },\n            });\n            return response.data;\n        } catch (error : any) {\n            if (error.response && error.response.data) {\n                return rejectWithValue(error.response.data);\n            }\n            return rejectWithValue(error.message);\n        }\n    }\n);\n\n// Async thunk to fetch game by id from an API\nexport const fetchGame = createAsyncThunk('games/fetchGame', async (gameId: number, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/games/${gameId}`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\ninterface IGame {\n    _id: number;\n    title: string;\n    imageUrl: string;\n    gifUrl: string;\n    hasDiscount: boolean;\n    isActual: boolean;\n    isEnabled: boolean;\n    appleStoreUrl: string;\n    googlePlayUrl: string;\n    trailerUrl: string;\n}\n\ninterface IGamesState {\n    games: Array<IGame>,\n    gamesCount: number,\n    game: IGame | null,\n    loading: boolean,\n    error: string | null | undefined,\n}\n\nconst initialState: IGamesState = {\n    games: [],\n    gamesCount: 0,\n    game: null,\n    loading: false,\n    error: null,\n};\n\nconst gamesSlice = createSlice({\n    name: 'games',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchGames.pending, (state) => {\n                state.loading = true;\n            })\n            .addCase(fetchGames.fulfilled, (state, action) => {\n                state.loading = false;\n                state.games = action.payload;\n                state.gamesCount = action.payload.length; // Assuming the payload contains the games array\n            })\n            .addCase(fetchGames.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n        builder\n            .addCase(searchGames.pending, (state) => {\n                state.loading = true;\n            })\n            .addCase(searchGames.fulfilled, (state, action) => {\n                state.loading = false;\n                state.games = action.payload;\n            })\n            .addCase(searchGames.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n        builder\n            .addCase(fetchGame.pending, (state) => {\n                state.loading = true;\n            })\n            .addCase(fetchGame.fulfilled, (state, action) => {\n                state.loading = false;\n                state.game = action.payload;\n            })\n            .addCase(fetchGame.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n        builder\n            .addCase(fetchActiveGames.pending, (state) => {\n                state.loading = true;\n            })\n            .addCase(fetchActiveGames.fulfilled, (state, action) => {\n                state.loading = false;\n                state.games = action.payload;\n            })\n            .addCase(fetchActiveGames.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n        builder\n            .addCase(fetchDiscountedGames.pending, (state) => {\n                state.loading = true;\n            })\n            .addCase(fetchDiscountedGames.fulfilled, (state, action) => {\n                state.loading = false;\n                state.games = action.payload;\n            })\n            .addCase(fetchDiscountedGames.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.error.message;\n            });\n    }\n});\n\nexport default gamesSlice.reducer;","size_bytes":5973},"server/src/controllers/referralController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Referral from '../models/Referral';\nimport { logger } from '../config/logger';\n// MONGO BACKUP: import User from '../models/User';\nimport { prisma } from '../db/client';\nimport { referralRepository } from '../db';\n\n// create new referral by refer via bot\nexport const createReferralByRefer = async (req: Request, res: Response) => {\n  try {\n    logger.info('Creating a new referral', { context: { body: req.body } });\n\n    const token = req.get('Token');\n    if (token !== process.env.AUTH_BOT_TOKEN) {\n      logger.warn('Invalid request token', { context: { token: token } });\n      return res.status(400).json({ error: 'Invalid request token' });\n    }\n\n    // Validate telegram data\n    if (!req.body.userId || !req.body.referId) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      return res.status(400).json({ error: 'Invalid request body' });\n    }\n\n    // MONGO BACKUP: const user = await User.findOne({ _id: req.body.userId });\n    const user = await prisma.user.findUnique({ where: { id: req.body.userId } });\n    if (user) {\n      if (user.id === req.body.userId) {\n        logger.warn(`User with id ${req.body.userId} is already exists`);\n        return res.status(409).json({})\n      }\n    }\n\n    // MONGO BACKUP: const newReferral = {\n    // MONGO BACKUP:   userId: req.body.userId,\n    // MONGO BACKUP:   referId: req.body.referId\n    // MONGO BACKUP: };\n    // MONGO BACKUP: const referral = new Referral(newReferral);\n    // MONGO BACKUP: await referral.save();\n\n    const referral = await referralRepository.createReferral(req.body.userId, req.body.referId);\n\n    logger.info('Referral created successfully', { context: { userId: referral.userId } });\n    res.status(201).json(referral);\n  } catch (error) {\n    logger.error('Error creating referral', { context: { error } });\n    res.status(500).json({ error: 'Error creating referral', details: error });\n  }\n}\n\n// Get referral count by refer\nexport const getReferralCountByReferId = async (req: Request, res: Response) => {\n  try {\n    const referId = req.telegramUser?.id;\n    // MONGO BACKUP: const count = await Referral.countDocuments({ referId });\n    const count = await referralRepository.countByReferrerId(referId!);\n    logger.info('Referral count fetched successfully', { context: { referId, count } });\n    res.json(count); // Return as a plain number\n  } catch (error) {\n    logger.error('Error fetching referral count', { context: { error } });\n    res.status(500).json({ message: 'Error fetching referral count', error });\n  }\n};\n","size_bytes":2615},"server/src/config/database.ts":{"content":"// MONGO BACKUP: import mongoose from 'mongoose';\n// MONGO BACKUP: import { logger } from './logger';\n// MONGO BACKUP: \n// MONGO BACKUP: // MongoDB connection options\n// MONGO BACKUP: const options: mongoose.ConnectOptions = {\n// MONGO BACKUP:   // These options are no longer needed in Mongoose 6+\n// MONGO BACKUP:   // useNewUrlParser: true,\n// MONGO BACKUP:   // useUnifiedTopology: true,\n// MONGO BACKUP:   // useCreateIndex: true,\n// MONGO BACKUP:   // useFindAndModify: false,\n// MONGO BACKUP: };\n// MONGO BACKUP: \n// MONGO BACKUP: // Connect to MongoDB\n// MONGO BACKUP: export const connectDB = async (): Promise<void> => {\n// MONGO BACKUP:   try {\n// MONGO BACKUP:     const mongoURI = process.env.MONGODB_URI || 'mongodb://localhost:27017/games-store';\n// MONGO BACKUP:     \n// MONGO BACKUP:     await mongoose.connect(mongoURI, options);\n// MONGO BACKUP:     \n// MONGO BACKUP:     logger.info('MongoDB connected successfully');\n// MONGO BACKUP:     \n// MONGO BACKUP:     // Handle connection events\n// MONGO BACKUP:     mongoose.connection.on('error', (err) => {\n// MONGO BACKUP:       logger.error('MongoDB connection error:', err);\n// MONGO BACKUP:     });\n// MONGO BACKUP:     \n// MONGO BACKUP:     mongoose.connection.on('disconnected', () => {\n// MONGO BACKUP:       logger.warn('MongoDB disconnected');\n// MONGO BACKUP:     });\n// MONGO BACKUP:     \n// MONGO BACKUP:     // Handle process termination\n// MONGO BACKUP:     process.on('SIGINT', async () => {\n// MONGO BACKUP:       await mongoose.connection.close();\n// MONGO BACKUP:       logger.info('MongoDB connection closed through app termination');\n// MONGO BACKUP:       process.exit(0);\n// MONGO BACKUP:     });\n// MONGO BACKUP:     \n// MONGO BACKUP:   } catch (error) {\n// MONGO BACKUP:     logger.error('MongoDB connection error:', error);\n// MONGO BACKUP:     process.exit(1);\n// MONGO BACKUP:   }\n// MONGO BACKUP: };\n","size_bytes":1894},"client/src/i18n.ts":{"content":"import i18n from 'i18next';\nimport { initReactI18next } from 'react-i18next';\nimport ru from './locales/ru.json';\nimport en from './locales/en.json';\n\ni18n.use(initReactI18next).init({\n  resources: {\n    ru: { translation: ru },\n    en: { translation: en },\n  },\n  lng: 'ru', // Default language\n  fallbackLng: 'en', // Fallback language\n  interpolation: {\n    escapeValue: false, // React already escapes values\n  },\n});\n\nexport default i18n;","size_bytes":443},"client/src/components/MarqueeTitle.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\n\nconst MarqueeTitle = ({ text }: { text: string }) => {\n    const containerRef = useRef<HTMLDivElement>(null);\n    const [isOverflowing, setIsOverflowing] = useState(false);\n\n    useEffect(() => {\n        if (containerRef.current) {\n            setIsOverflowing(containerRef.current.scrollWidth > containerRef.current.clientWidth);\n        }\n    }, [text]);\n\n    if (!isOverflowing) {\n        return (\n            <div\n                ref={containerRef}\n                style={{ whiteSpace: \"nowrap\", overflow: \"hidden\", textOverflow: \"ellipsis\" }}\n            >\n                {text}\n            </div>\n        );\n    }\n\n    return (\n        <div\n            ref={containerRef}\n            style={{\n                overflow: \"hidden\",\n                whiteSpace: \"nowrap\",\n                boxSizing: \"border-box\",\n            }}\n        >\n            <div\n                className=\"flex items-center justify-center\"\n                style={{\n                    display: \"inline-block\",\n                    paddingLeft: \"100%\",\n                    animation: \"marquee 10s linear infinite\",\n                }}\n            >\n                {text}\n            </div>\n            <style>{`\n        @keyframes marquee {\n          0%   { transform: translateX(0%); }\n          100% { transform: translateX(-100%); }\n        }\n      `}</style>\n        </div>\n    );\n};\n\nexport default MarqueeTitle;\n","size_bytes":1448},"admin/src/main.tsx":{"content":"import { StrictMode } from 'react'\nimport { createRoot } from 'react-dom/client'\nimport './styles.css'\nimport App from './App.tsx'\nimport {Provider} from \"react-redux\";\nimport store from \"./store/store.ts\";\n\n\ncreateRoot(document.getElementById('root')!).render(\n  <StrictMode>\n    <Provider store={store}>\n        <App />\n    </Provider>\n  </StrictMode>,\n)\n","size_bytes":357},"server/src/controllers/adminController.ts":{"content":"import { Request, Response } from 'express';\nimport jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\n\nconst ADMIN = {\n    username: 'legendy',\n    passwordHash: bcrypt.hashSync('root241', 10),\n};\n\nconst JWT_SECRET = 'ewfewf2342132fwef423rr2f43f4g52sa3r242';\n\nexport const login = (req: Request, res: Response) => {\n    const { username, password } = req.body;\n    if (username !== ADMIN.username || !bcrypt.compareSync(password, ADMIN.passwordHash)) {\n        return res.status(401).json({ message: 'Invalid credentials' });\n    }\n\n    const token = jwt.sign({ username }, JWT_SECRET, { expiresIn: '4h' });\n    res.json({ token });\n};\n\nexport const protectedRoute = (req: Request, res: Response) => {\n    const authHeader = req.headers.authorization;\n    if (!authHeader) return res.sendStatus(401);\n\n    const token = authHeader.split(' ')[1];\n    try {\n        jwt.verify(token, JWT_SECRET);\n        res.json({ message: 'Access granted' });\n    } catch {\n        res.sendStatus(403);\n    }\n};\n","size_bytes":1002},"check-env.sh":{"content":"#!/bin/bash\n\necho \"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...\"\necho \"\"\n\nMISSING=0\n\ncheck_var() {\n    if [ -z \"${!1}\" ]; then\n        echo \"‚ùå $1 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞\"\n        MISSING=1\n    else\n        echo \"‚úÖ $1 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞\"\n    fi\n}\n\ncheck_var \"BOT_TOKEN\"\ncheck_var \"BOT_USERNAME\"\ncheck_var \"ADMIN_ID\"\ncheck_var \"MONGODB_URI\"\n\nif [ $MISSING -eq 1 ]; then\n    echo \"\"\n    echo \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\"\n    echo \"‚ö†Ô∏è  –ü–û–ñ–ê–õ–£–ô–°–¢–ê, –î–û–ë–ê–í–¨–¢–ï –ù–ï–î–û–°–¢–ê–Æ–©–ò–ï –°–ï–ö–†–ï–¢–´:\"\n    echo \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\"\n    echo \"\"\n    echo \"1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å Tools (üîß) ‚Üí Secrets (üîí)\"\n    echo \"2. –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã:\"\n    echo \"\"\n    echo \"   BOT_TOKEN = –≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_@BotFather\"\n    echo \"   BOT_USERNAME = @–≤–∞—à_–±–æ—Ç\"\n    echo \"   ADMIN_ID = –≤–∞—à_telegram_id\"\n    echo \"   MONGODB_URI = mongodb+srv://...\"\n    echo \"\"\n    echo \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\"\n    echo \"\"\n    echo \"üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ MongoDB Atlas (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):\"\n    echo \"\"\n    echo \"   1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://www.mongodb.com/atlas\"\n    echo \"   2. –ù–∞–∂–º–∏—Ç–µ 'Try Free' –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å\"\n    echo \"   3. –°–æ–∑–¥–∞–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä M0 (512 –ú–ë)\"\n    echo \"   4. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î\"\n    echo \"   5. –î–æ–±–∞–≤—å—Ç–µ IP 0.0.0.0/0 –≤ Network Access\"\n    echo \"   6. –ù–∞–∂–º–∏—Ç–µ Connect ‚Üí Drivers\"\n    echo \"   7. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\"\n    echo \"\"\n    echo \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\"\n    echo \"\"\n    exit 1\nfi\n\necho \"\"\necho \"‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!\"\necho \"\"\n","size_bytes":2183},"build-all.sh":{"content":"#!/bin/bash\n\necho \"üì¶ –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è production...\"\necho \"\"\n\n# –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–µ—Ä\necho \"üîß –°–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...\"\ncd /home/runner/workspace/server && npm run build\n\n# –°–æ–±–∏—Ä–∞–µ–º –±–æ—Ç–∞\necho \"üîß –°–±–æ—Ä–∫–∞ –±–æ—Ç–∞...\"\ncd /home/runner/workspace/bot && npm run build\n\n# –°–æ–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç\necho \"üîß –°–±–æ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞...\"\ncd /home/runner/workspace/client && npm run build\n\n# –°–æ–±–∏—Ä–∞–µ–º –∞–¥–º–∏–Ω–∫—É\necho \"üîß –°–±–æ—Ä–∫–∞ –∞–¥–º–∏–Ω–∫–∏...\"\ncd /home/runner/workspace/admin && npm run build\n\necho \"\"\necho \"‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!\"\n","size_bytes":670},"index.js":{"content":"#!/usr/bin/env node\n\n/**\n * Launcher –¥–ª—è Tip-Top –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞ Replit\n * –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: server, bot, client, admin\n */\n\nconst { spawn } = require('child_process');\nconst path = require('path');\nconst fs = require('fs');\n\nconsole.log('üöÄ Tip-Top Platform Launcher');\nconsole.log('');\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\nconst requiredEnvVars = ['BOT_TOKEN', 'BOT_USERNAME', 'ADMIN_ID'];\nconst missingVars = requiredEnvVars.filter(v => !process.env[v]);\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º DATABASE_URL (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è PostgreSQL –≤ Replit)\nif (!process.env.DATABASE_URL) {\n  console.error('‚ùå DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω. PostgreSQL –±–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –≤ Replit.');\n  console.error('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: —Å–º. DEPLOYMENT_GUIDE.md');\n  process.exit(1);\n}\n\n// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º PostgreSQL\nif (!process.env.USE_POSTGRES) {\n  process.env.USE_POSTGRES = 'true';\n  console.log('‚ÑπÔ∏è  USE_POSTGRES –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true');\n}\n\nif (missingVars.length > 0) {\n  console.error('‚ùå –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:', missingVars.join(', '));\n  console.error('');\n  console.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ Replit Secrets (üîí)');\n  console.error('');\n  console.error('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: —Å–º. DEPLOYMENT_GUIDE.md');\n  process.exit(1);\n}\n\n// –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º PORT - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ .replit environment\n// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Replit —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PORT=5000\nconst PORT = process.env.PORT || '3000';\nconsole.log(`‚ÑπÔ∏è  –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É: ${PORT}`);\n\n// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CLIENT_URL –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω\nif (!process.env.CLIENT_URL) {\n  const replSlug = process.env.REPL_SLUG || 'tip-top';\n  const replOwner = process.env.REPL_OWNER || 'user';\n  process.env.CLIENT_URL = `https://${replSlug}.${replOwner}.repl.co`;\n  console.log(`‚ÑπÔ∏è  CLIENT_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: ${process.env.CLIENT_URL}`);\n  console.log('');\n}\n\nconsole.log('‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');\nconsole.log('');\nconsole.log('üì¶ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...');\nconsole.log('');\n\nconst processes = [];\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞\nfunction startProcess(name, cwd, command, args = []) {\n  console.log(`üîß –ó–∞–ø—É—Å–∫ ${name}...`);\n  \n  const proc = spawn(command, args, {\n    cwd,\n    stdio: 'inherit',\n    shell: true,\n    env: { ...process.env }\n  });\n  \n  proc.on('error', (err) => {\n    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ ${name}:`, err);\n  });\n  \n  proc.on('exit', (code) => {\n    console.log(`‚ö†Ô∏è  ${name} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º ${code}`);\n  });\n  \n  processes.push({ name, proc });\n  return proc;\n}\n\n// –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã\nconst serverCwd = path.join(__dirname, 'server');\nconst botCwd = path.join(__dirname, 'bot');\n\nstartProcess('Server (API + Socket.IO)', serverCwd, 'npm', ['run', 'dev']);\nstartProcess('Bot (Telegram)', botCwd, 'npm', ['run', 'dev']);\n\nconsole.log('');\nconsole.log('‚úÖ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ Tip-Top –∑–∞–ø—É—â–µ–Ω–∞!');\nconsole.log('');\nconsole.log('üìç –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:');\nconsole.log(`   - API —Å–µ—Ä–≤–µ—Ä: http://localhost:${PORT}`);\nconsole.log('   - Telegram –±–æ—Ç: –∞–∫—Ç–∏–≤–µ–Ω');\nconsole.log('');\nconsole.log('üí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:');\nconsole.log('   - –ö–ª–∏–µ–Ω—Ç: cd client && npm run dev (–ø–æ—Ä—Ç 5173)');\nconsole.log('   - –ê–¥–º–∏–Ω: cd admin && npm run dev (–ø–æ—Ä—Ç 5174)');\nconsole.log('');\nconsole.log('üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: —Å–º. DEPLOYMENT_GUIDE.md');\nconsole.log('');\n\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\nprocess.on('SIGINT', () => {\n  console.log('');\n  console.log('‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...');\n  processes.forEach(({ name, proc }) => {\n    console.log(`   –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é ${name}...`);\n    proc.kill('SIGINT');\n  });\n  process.exit(0);\n});\n\nprocess.on('SIGTERM', () => {\n  processes.forEach(({ proc }) => proc.kill('SIGTERM'));\n  process.exit(0);\n});\n","size_bytes":4316},"admin/src/store/store.ts":{"content":"import { configureStore } from \"@reduxjs/toolkit\";\nimport gamesReducer from \"./features/gamesSlice.ts\";\nimport offersReducer from \"./features/offersSlice.ts\";\nimport ordersReducer from \"./features/ordersSlice.ts\";\nimport authReducer from \"./features/authSlice.ts\";\n\nconst store = configureStore({\n    reducer: {\n        // Add your reducers here\n        games: gamesReducer,\n        offers: offersReducer,\n        orders: ordersReducer,\n        auth: authReducer,\n    },\n});\n\nexport type RootState = ReturnType<typeof store.getState>;\nexport type AppDispatch = typeof store.dispatch;\nexport default store;","size_bytes":605},"server/src/models/Payment.ts":{"content":"// MONGO BACKUP: import { getMaxPaymentId } from '../helpers/index';\n// MONGO BACKUP: import mongoose, { Schema } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IPayment {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   externalId: string;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   orderId: number | null;\n// MONGO BACKUP:   offerId: number;\n// MONGO BACKUP:   amountToPay: number;\n// MONGO BACKUP:   currency: 'USDT' | 'RUB';\n// MONGO BACKUP:   status: 'pending' | 'completed' | 'failed' | 'canceled';\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const PaymentSchema = new Schema<IPayment>(\n// MONGO BACKUP:   {\n// MONGO BACKUP:     _id: {\n// MONGO BACKUP:       type: Number,\n// MONGO BACKUP:       required: false,\n// MONGO BACKUP:     },\n// MONGO BACKUP:     externalId: { type: String, required: true },\n// MONGO BACKUP:     userId: { type: Number, required: true },\n// MONGO BACKUP:     orderId: { type: Number, required: false },\n// MONGO BACKUP:     offerId: { type: Number, required: true },\n// MONGO BACKUP:     amountToPay: { type: Number, required: true },\n// MONGO BACKUP:     currency: { type: String, enum: ['USDT', 'RUB'], required: true },\n// MONGO BACKUP:     status: { type: String, enum: ['pending', 'completed', 'failed', 'canceled'], required: true },\n// MONGO BACKUP:   },\n// MONGO BACKUP:   {\n// MONGO BACKUP:     timestamps: true,\n// MONGO BACKUP:   }\n// MONGO BACKUP: );\n// MONGO BACKUP: \n// MONGO BACKUP: // Pre-save hook to set _id automatically\n// MONGO BACKUP: PaymentSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxPaymentId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: PaymentSchema.index({ _id: 1, externalId: 1 }, { unique: true });\n// MONGO BACKUP: // PaymentSchema.index({ orderId: 1 }, { unique: true, sparse: true });\n// MONGO BACKUP: PaymentSchema.index({ status: 1 });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IPayment>('Payment', PaymentSchema);\n","size_bytes":2160},"client/src/components/Header.tsx":{"content":"import { Globe, Grid, List } from 'lucide-react';\nimport SearchBar from './SearchBar';\nimport { useState, useRef, useEffect } from 'react';\nimport GridWidget from './GridWidget';\nimport LangWidget from './LangWidget';\nimport CategoriesWidget from \"./CategoriesWidget.tsx\";\nimport { searchGames } from '../store/features/gamesSlice.ts';\nimport { useDispatch } from 'react-redux';\nimport type { AppDispatch } from '../store/store';\nimport { useLocation } from 'react-router-dom';\n\ninterface HeaderProps {\n  onChangeCardsPerRow: (count: number) => void;\n  onChangeLanguage: (lang: 'ru' | 'en') => void;\n}\n\nconst Header: React.FC<HeaderProps> = ({ onChangeCardsPerRow, onChangeLanguage }) => {\n  const [showGridWidget, setShowGridWidget] = useState(false);\n  const [showLangWidget, setShowLangWidget] = useState(false);\n  const [categoriesVisible, setCategoriesVisible] = useState(false);\n\n  const dispatch = useDispatch<AppDispatch>();\n  const location = useLocation();\n\n  const categoriesRef = useRef<HTMLDivElement | null>(null);\n  const gridRef = useRef<HTMLDivElement | null>(null);\n  const langRef = useRef<HTMLDivElement | null>(null);\n\n  const handleSearch = (query: string) => {\n    dispatch(searchGames(query));\n  };\n\n  const handleCategoriesClick = () => {\n    setCategoriesVisible((prev) => !prev);\n    setShowGridWidget(false);\n    setShowLangWidget(false);\n  };\n\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      const target = e.target as Node;\n      if (\n          !categoriesRef.current?.contains(target) &&\n          !gridRef.current?.contains(target) &&\n          !langRef.current?.contains(target)\n      ) {\n        setCategoriesVisible(false);\n        setShowGridWidget(false);\n        setShowLangWidget(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  useEffect(() => {\n    setCategoriesVisible(false);\n    setShowGridWidget(false);\n    setShowLangWidget(false);\n  }, [location]);\n\n  return (\n      <header className={`flex justify-center bg-[#1A1B1E] text-white items-center py-[10px] border-b border-[#00CCCC33]`}>\n        <div className='flex relative max-w-[28rem] w-full items-center gap-2 px-2'>\n          {categoriesVisible && (\n              <CategoriesWidget ref={categoriesRef} setCategoriesVisible={setCategoriesVisible} />\n          )}\n          <button onClick={handleCategoriesClick} className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'>\n            <List className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          <div className=\"flex-1\">\n            <SearchBar onSearch={handleSearch} />\n          </div>\n          <button\n              className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'\n              onClick={() => {\n                setShowGridWidget((prev) => !prev);\n                setCategoriesVisible(false);\n                setShowLangWidget(false);\n              }}\n          >\n            <Grid className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          <button\n              className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'\n              onClick={() => {\n                setShowLangWidget((prev) => !prev);\n                setCategoriesVisible(false);\n                setShowGridWidget(false);\n              }}\n          >\n            <Globe className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          {showGridWidget && (\n              <GridWidget\n                  ref={gridRef}\n                  onSelect={(count) => {\n                    onChangeCardsPerRow(count);\n                    setShowGridWidget(false);\n                  }}\n              />\n          )}\n          {showLangWidget && (\n              <LangWidget\n                  ref={langRef}\n                  onSelect={(lang) => {\n                    onChangeLanguage(lang);\n                    setShowLangWidget(false);\n                  }}\n              />\n          )}\n        </div>\n      </header>\n  );\n};\n\nexport default Header;\n","size_bytes":4595},"admin/src/components/NewOfferForm.tsx":{"content":"import React, {useEffect, useState} from 'react';\nimport {useDispatch, useSelector} from \"react-redux\";\nimport type {AppDispatch, RootState} from \"../store/store.ts\";\nimport {fetchGames} from \"../store/features/gamesSlice.ts\";\nimport {addOffer} from \"../store/features/offersSlice.ts\";\n\nconst NewOfferForm: React.FC = () => {\n    const games = useSelector((state: RootState) => state.games.games);\n    const dispatch = useDispatch<AppDispatch>();\n\n    const [gameId, setGameId] = useState<number>(games[0]?._id || 0);\n    const [title, setTitle] = useState('');\n    const [imageUrl, setImageUrl] = useState('');\n    const [priceRUB, setPriceRUB] = useState<number | undefined>(undefined);\n    const [priceUSDT, setPriceUSDT] = useState<number | undefined>(undefined);\n    const [isEnabled, setIsEnabled] = useState(true);\n\n    useEffect(() => {\n        dispatch(fetchGames());\n    }, [dispatch]);\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!gameId) return;\n\n        const offer = {\n            gameId,\n            title,\n            imageUrl,\n            priceRUB,\n            priceUSDT,\n            isEnabled,\n        }\n\n        await dispatch(addOffer(offer));\n\n        setTitle('');\n        setImageUrl('');\n        setPriceRUB(0);\n        setPriceUSDT(0);\n        setIsEnabled(true);\n    };\n\n    return (\n        <form onSubmit={handleSubmit} className=\"space-y-2 max-w-md p-4 rounded\">\n            <select\n                value={gameId}\n                onChange={(e) => setGameId(Number(e.target.value))}\n                required\n                className=\"w-full p-2 border\"\n            >\n                {games.map((game) => (\n                    <option key={game._id} value={game._id} className=\"text-black\">\n                        {game.title}\n                    </option>\n                ))}\n            </select>\n            <input\n                type=\"text\"\n                placeholder=\"Title\"\n                value={title}\n                required\n                onChange={(e) => setTitle(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"url\"\n                placeholder=\"Image URL\"\n                value={imageUrl}\n                required\n                onChange={(e) => setImageUrl(e.target.value)}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"number\"\n                placeholder=\"Price RUB\"\n                value={priceRUB}\n                min={0}\n                required\n                onChange={(e) => setPriceRUB(Number(e.target.value))}\n                className=\"w-full p-2 border\"\n            />\n            <input\n                type=\"number\"\n                placeholder=\"Price USDT\"\n                value={priceUSDT}\n                min={0}\n                required\n                onChange={(e) => setPriceUSDT(Number(e.target.value))}\n                className=\"w-full p-2 border\"\n            />\n            <label className=\"inline-flex items-center space-x-2\">\n                <input\n                    type=\"checkbox\"\n                    checked={isEnabled}\n                    onChange={() => setIsEnabled(!isEnabled)}\n                />\n                <span>Is Enabled</span>\n            </label>\n            <br/>\n            <button type=\"submit\" className=\"bg-blue-600 text-white px-4 py-2 rounded\">\n                Add Offer\n            </button>\n        </form>\n    );\n};\n\nexport default NewOfferForm;\n","size_bytes":3532},"client/src/store/features/offersSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\ninterface IOffer {\n  _id: number;\n  gameId: number;\n  title: string;\n  imageUrl: string;\n  priceRUB: number;\n  priceUSDT: number;\n  isEnabled: boolean;\n}\n\ninterface IOffersState {\n  offers: Array<IOffer>;\n  offer: IOffer | null;\n  loading: boolean;\n  error: string | null | undefined;\n}\n\nconst initialState: IOffersState = {\n  offers: [],\n  offer: null,\n  loading: false,\n  error: null,\n};\n\nexport const addOffer = createAsyncThunk(\n    'offers/addOffer',\n    async (data: any, { rejectWithValue }) => {\n      try {\n        const response = await axiosInstance.post(`/offers`, data);\n        return response.data;\n      } catch (error: any) {\n        if (error.response && error.response.data) {\n          return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n      }\n    }\n);\n\n// Thunk to fetch offers with query params\nexport const fetchOffers = createAsyncThunk(\n  'offers/fetchOffers',\n  async ({ gameId, isEnabled }: { gameId: number; isEnabled?: boolean }, { rejectWithValue }) => {\n    try {\n      const response = await axiosInstance.get(`/offers/game/${gameId}`, {\n        params: { isEnabled },\n      });\n      return response.data;\n    } catch (error: any) {\n      if (error.response && error.response.data) {\n        return rejectWithValue(error.response.data);\n      }\n      return rejectWithValue(error.message);\n    }\n  }\n);\n\nexport const fetchOffer = createAsyncThunk(\n  'offers/fetchOffer',\n  async (gameId: number, { rejectWithValue }) => {\n    try {\n      const response = await axiosInstance.get(`/offers/${gameId}`);\n      return response.data;\n    } catch (error: any) {\n      if (error.response && error.response.data) {\n        return rejectWithValue(error.response.data);\n      }\n      return rejectWithValue(error.message);\n    }\n  }\n);\n\nconst offersSlice = createSlice({\n  name: 'offers',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchOffers.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchOffers.fulfilled, (state, action) => {\n        state.loading = false;\n        state.offers = action.payload;\n      })\n      .addCase(fetchOffers.rejected, (state, action) => {\n        state.loading = false;\n        state.offers = [];\n        state.error = action.error.message;\n      });\n    builder\n      .addCase(fetchOffer.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchOffer.fulfilled, (state, action) => {\n        state.loading = false;\n        state.offer = action.payload;\n      })\n      .addCase(fetchOffer.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.error.message;\n      });\n  }\n});\n\nexport default offersSlice.reducer;","size_bytes":2993},"server/src/controllers/withdrawalController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Withdrawal from '../models/Withdrawal';\n// MONGO BACKUP: import User from '../models/User';\nimport { logger } from '../config/logger';\nimport * as process from \"node:process\";\nimport {CryptoPay} from \"@foile/crypto-pay-api\";\nimport axios from \"axios\";\nimport { prisma } from '../db/client';\nimport { withdrawalRepository, userRepository } from '../db';\n\nexport const cryptoPay = new CryptoPay(process.env.CRYPTOPAY_API_KEY!);\n\nexport const createWithdrawal = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    const { amount } = req.body;\n\n    const currency = 'USDT';\n\n    // MONGO BACKUP: const user = await User.findById(userId);\n    const user = await userRepository.findById(userId!);\n    if (!user) return res.status(404).json({ message: 'User not found' });\n\n    if (currency !== 'USDT') return res.status(400).json({ message: 'Incorrect currency' });\n    if (amount < 1) return res.status(400).json({ message: 'Minimum withdrawal amount is 1 USDT' });\n    if (user.balanceUSDT < amount) return res.status(400).json({ message: 'Insufficient USDT balance' });\n\n    // MONGO BACKUP: const withdrawal = new Withdrawal({\n    // MONGO BACKUP:   userId,\n    // MONGO BACKUP:   amount,\n    // MONGO BACKUP:   status: 'pending',\n    // MONGO BACKUP:   currency\n    // MONGO BACKUP: });\n    // MONGO BACKUP: await withdrawal.save();\n\n    const withdrawal = await withdrawalRepository.createWithdrawal(userId!, amount, currency as 'USDT');\n    logger.info('Withdrawal request created', { context: { withdrawalId: withdrawal.id } });\n\n    const spend_id = `withdraw_${Date.now()}`;\n\n    try {\n      await cryptoPay.transfer(userId!, currency, amount.toString(), spend_id);\n\n      // MONGO BACKUP: user.balanceUSDT -= amount;\n      // MONGO BACKUP: await user.save();\n      await userRepository.updateBalance(userId!, 'USDT', -amount);\n\n      // MONGO BACKUP: withdrawal.status = 'completed';\n      // MONGO BACKUP: await withdrawal.save();\n      await withdrawalRepository.updateStatus(withdrawal.id, 'completed');\n\n      const botToken = process.env.BOT_TOKEN;\n      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;\n\n      await axios.post(url, {\n        chat_id: userId,\n        text: `–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.`,\n      });\n\n      logger.info('Withdrawal completed', { context: { withdrawalId: withdrawal.id } });\n      return res.status(201).json(withdrawal);\n    } catch (error: any) {\n      // MONGO BACKUP: withdrawal.status = 'rejected';\n      // MONGO BACKUP: await withdrawal.save();\n      await withdrawalRepository.updateStatus(withdrawal.id, 'rejected');\n\n      logger.error(`Withdrawal failed: ${error.message}`, { context: { withdrawalId: withdrawal.id } });\n      return res.status(500).json({ message: 'Error during withdrawal', error: error.message });\n    }\n  } catch (error) {\n    logger.error(`Error creating withdrawal: ${error}`);\n    return res.status(500).json({ message: 'Error creating withdrawal', error });\n  }\n};\n\nexport const getWithdrawalsByMe = async (req: Request, res: Response) => {\n  try {\n    const userId = req.telegramUser?.id;\n    logger.info(\"Fetching all withdrawals by userId\", { context: { userId } });\n    // MONGO BACKUP: const withdrawals = await Withdrawal.find({ userId }).sort({ createdAt: -1 });\n    const withdrawals = await withdrawalRepository.findByUserId(userId!);\n    logger.info(\"Withdrawals fetched succussfully\", { context: { userId, count: withdrawals.length } });\n    res.json(withdrawals);\n  } catch (error) {\n    logger.error(`Error getting withdrawals: ${error}`);\n    res.status(500).json({ message: 'Error getting withdrawals', error });\n  }\n}\n","size_bytes":3770},"client/src/layouts/MainLayout.tsx":{"content":"import Header from '../components/Header'\nimport Footer from '../components/Footer'\nimport { Outlet } from 'react-router-dom'\nimport { useState } from 'react';\nimport {useDispatch} from \"react-redux\";\nimport type {AppDispatch} from \"../store/store.ts\";\nimport {updateLanguage} from \"../store/features/userSlice.ts\";\n\nconst MainLayout = () => {\n  const dispatch = useDispatch<AppDispatch>();\n\n  const [cardsPerRow, setCardsPerRow] = useState(3);\n\n  const changeLanguage = async (lang: 'ru' | 'en') => {\n    await dispatch(updateLanguage(lang));\n  };\n  \n  return (\n    <div className='flex flex-col h-screen'>\n      <Header onChangeCardsPerRow={setCardsPerRow} onChangeLanguage={changeLanguage} />\n      <main className='flex justify-center w-full flex-grow overflow-y-auto'>\n        <Outlet context={{cardsPerRow}} />\n      </main>\n      <Footer />\n    </div>\n  )\n}\n\nexport default MainLayout\n","size_bytes":892},"bot/src/utils/notifications.ts":{"content":"import { Telegraf } from 'telegraf';\nimport { localization } from '../config/localization';\nimport { errorHandler } from '../utils/errorHandler';\n\n// ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ .env)\nconst ADMIN_ID = process.env.ADMIN_ID;\n\nexport class NotificationService {\n  private bot: Telegraf;\n\n  constructor(bot: Telegraf) {\n    this.bot = bot;\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ\n   */\n  async notifyNewUser(userId: string, username?: string, referrerId?: string) {\n    if (!ADMIN_ID) {\n      errorHandler.logWarning('ADMIN_ID not set in environment variables');\n      return;\n    }\n\n    try {\n      const l = localization('ru'); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º\n      let message = `üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!\\n\\n`;\n      message += `üë§ ID: ${userId}\\n`;\n      \n      if (username) {\n        message += `üìù Username: @${username}\\n`;\n      }\n      \n      if (referrerId) {\n        message += `üîó –ü—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –æ—Ç: ${referrerId}\\n`;\n      }\n      \n      message += `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;\n      \n      await this.bot.telegram.sendMessage(ADMIN_ID, message);\n    } catch (error) {\n      errorHandler.logError(`Could not send new user notification (check ADMIN_ID: ${ADMIN_ID}):`, error instanceof Error ? error.message : String(error));\n    }\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ–± –æ—à–∏–±–∫–µ\n   */\n  async notifyError(error: Error, context?: string) {\n    if (!ADMIN_ID) {\n      errorHandler.logWarning('ADMIN_ID not set in environment variables');\n      return;\n    }\n\n    try {\n      let message = `üö® –û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ!\\n\\n`;\n      \n      if (context) {\n        message += `üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${context}\\n`;\n      }\n      \n      message += `‚ùå –û—à–∏–±–∫–∞: ${error.message}\\n`;\n      message += `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;\n\n      await this.bot.telegram.sendMessage(ADMIN_ID, message);\n    } catch (notificationError) {\n      errorHandler.logError(`Could not send new user notification (check ADMIN_ID: ${ADMIN_ID}):`, notificationError instanceof Error ? notificationError.message : String(notificationError));\n    }\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ\n   */\n  async notifyCriticalError(error: Error, context?: string) {\n    if (!ADMIN_ID) {\n      errorHandler.logWarning('ADMIN_ID not set in environment variables');\n      return;\n    }\n\n    try {\n      let message = `üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!\\n\\n`;\n      \n      if (context) {\n        message += `üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${context}\\n`;\n      }\n      \n      message += `‚ùå –û—à–∏–±–∫–∞: ${error.message}\\n`;\n      message += `üìã Stack: ${error.stack?.substring(0, 500)}...\\n`;\n      message += `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;\n\n      await this.bot.telegram.sendMessage(ADMIN_ID, message, {\n        parse_mode: 'HTML'\n      });\n    } catch (notificationError) {\n      errorHandler.logError('Error sending critical error notification:', notificationError);\n    }\n  }\n}","size_bytes":3340},"client/src/pages/Offers.tsx":{"content":"import { useEffect } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useNavigate, useParams } from \"react-router-dom\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport { fetchOffers } from \"../store/features/offersSlice.ts\";\nimport { useTranslation } from \"react-i18next\";\nimport { fetchGame } from \"../store/features/gamesSlice.ts\";\nimport MarqueeTitle from \"../components/MarqueeTitle.tsx\";\n\nconst Offer = () => {\n  const { gameId } = useParams<{ gameId: string }>();\n  const dispatch = useDispatch<AppDispatch>();\n  const navigate = useNavigate(); // Use useNavigate instead of redirect\n  const { offers, loading, error } = useSelector((state: RootState) => state.offers);\n  const gameData = useSelector((state: RootState) => state.games);\n  const { t } = useTranslation();\n\n  useEffect(() => {\n    dispatch(fetchOffers({ gameId: Number(gameId), isEnabled: true }));\n\n    if ((!gameData && gameId) || gameData?.game?._id !== Number(gameId)) {\n      // Fetch game data if not already available\n      dispatch(fetchGame(Number(gameId)));\n    }\n  }, [gameId, dispatch]);\n\n  if (loading) return <p>{t('offers.loading')}</p>;\n  if (error) return <p>{t('offers.error', { error: error })}</p>;\n  // if (!offers || offers.length === 0) return <p className='text-white pt-1'>{t('offers.noProducts')}</p>;\n\n  if (gameData?.loading) return <p>{t('home.loading')}</p>;\n  if (gameData?.error) return <p>{t('home.error', { error: error })}</p>;\n  if (!gameData?.game) return <p className='text-white pt-1'>{t('home.noGame')}</p>;\n\n  const redirectToAppStore = () => {\n    window.open(gameData?.game?.appleStoreUrl, \"_blank\");\n  }\n\n  const redirectToGooglePlay = () => {\n    window.open(gameData?.game?.googlePlayUrl, \"_blank\");\n  }\n\n  return (\n    <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-hidden pt-2\">\n      <div className=\"flex flex-col justify-between px-2 h-[210px] max-[350px]:h-[200px]\">\n        {/* Trailer block */}\n        <div className=\"w-full flex items-start justify-center\">\n          <iframe\n            className=\"w-full flex-1 h-fit rounded-[10px]\"\n            src={gameData?.game?.trailerUrl}\n            title=\"YouTube video player\"\n            frameBorder=\"0\"\n            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\n            referrerPolicy=\"strict-origin-when-cross-origin\"\n            allowFullScreen\n          ></iframe>\n        </div>\n\n        {/* Buttons block */}\n        <div className=\"w-full grid grid-cols-2 gap-2.5 pb-1.5 pt-1.5\">\n          <button onClick={redirectToAppStore} className=\"flex justify-center items-center gap-1 px-4 max-[350px]:px-1 py-2 max-[350px]:py-1 bg-[#1A1B1E] text-white rounded-lg cursor-pointer border  border-[#27282C]\">\n            <img src=\"/AppStore.png\" alt=\"appstore\" className=\"w-[26px] max-[350px]:w-[24px] object-contain rounded-[10px]\" />\n            <span className=\"max-[350px]:text-sm\">App Store</span>\n          </button>\n          <button onClick={redirectToGooglePlay} className=\"flex justify-center items-center gap-1 px-4 max-[350px]:px-1 py-2 max-[350px]:py-1 bg-[#1A1B1E] text-white rounded-lg cursor-pointer border  border-[#27282C]\">\n            <img src=\"/GooglePlay.png\" alt=\"googleplay\" className=\"w-[28px] max-[350px]:w-[26px] mt-0.5 object-contain rounded-[10px]\" />\n            <span className=\"max-[350px]:text-sm\">Google Play</span>\n          </button>\n        </div>\n      </div>\n\n      {/* Offers block */}\n      <div className=\"px-2 pb-2 flex-1 overflow-y-auto\">\n        <div className=\"\">\n          <div className=\"grid grid-cols-2 gap-2.5 w-full text-white\">\n            {offers.map((offer, index) => (\n                <div onClick={() => navigate(`/games/${gameId}/offers/${offer._id}/order`)} key={index} className=\"bg-gray-800 rounded-lg shadow-md box-border cursor-pointer border-2  border-[#27282C]\">\n                  <img src={offer.imageUrl} alt={offer.title} className=\"w-[100%] aspect-square object-center object-cover rounded-tl-[8px] rounded-tr-[8px]\" />\n                  <div className=\"flex flex-col items-center justify-between gap-2 gap-y-0 flex-wrap bg-[#1A1B1E] py-1 px-2 rounded-bl-lg rounded-br-lg\">\n                    <h2 className=\"text-sm pb-0.5 pl-1 max-w-full pr-0.5 font-normal text-[#fff] whitespace-nowrap overflow-hidden\">\n                      <MarqueeTitle text={offer.title} />\n                    </h2>\n                    <div className=\"flex flex-row items-center justify-between gap-2 w-full\">\n                      <p className=\"text-sm text-green-400\">{offer.priceUSDT + \"$\"}</p>\n                      <p className=\"text-sm text-green-400\">{offer.priceRUB + \"‚ÇΩ\"}</p>\n                    </div>\n                  </div>\n                </div>\n            ))}\n          </div>\n          <div className=\"w-full flex flex-col items-center justify-center gap-2 mt-2\">\n            <div className=\"flex gap-2\">\n              <p className=\"text-white text-base\">{t('offers.footerText')}</p>\n              <img src=\"/question.png\" alt=\"question\" className=\"w-[16px] object-contain rounded-[10px]\" />\n            </div>\n            <button onClick={() => navigate(\"/chat\")} className=\"bg-[#1A1B1E] text-[#fff] border border-[#27282C] rounded-lg px-4 py-2 cursor-pointer\">{t('offers.footerBtn')}</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Offer;\n","size_bytes":5448},"client/src/store/features/gamesSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\n// Add a new game\nexport const addGame = createAsyncThunk('games/addGame', async (data: any, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.post('/games', data);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\n// Async thunk to fetch games from an API\nexport const fetchGames = createAsyncThunk('games/fetchGames', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get('/games');\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\nexport const fetchActiveGames = createAsyncThunk(\n    'games/fetchActiveGames',\n    async (_, { rejectWithValue }) => {\n      try {\n        const response = await axiosInstance.get('/games/active');\n        return response.data;\n      } catch (error: any) {\n        return rejectWithValue(error.response?.data || error.message);\n      }\n    }\n);\n\nexport const fetchDiscountedGames = createAsyncThunk(\n    'games/fetchDiscountedGames',\n    async (_, { rejectWithValue }) => {\n      try {\n        const response = await axiosInstance.get('/games/discounts');\n        return response.data;\n      } catch (error: any) {\n        return rejectWithValue(error.response?.data || error.message);\n      }\n    }\n);\n\n\n// Thunk to search games\nexport const searchGames = createAsyncThunk(\n  'games/searchGames',\n  async (query: string, { rejectWithValue }) => {\n    try {\n      const response = await axiosInstance.get(`/games/search`, {\n        params: { query },\n      });\n      return response.data;\n    } catch (error : any) {\n      if (error.response && error.response.data) {\n        return rejectWithValue(error.response.data);\n      }\n      return rejectWithValue(error.message);\n    }\n  }\n);\n\n// Async thunk to fetch game by id from an API\nexport const fetchGame = createAsyncThunk('games/fetchGame', async (gameId: number, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/games/${gameId}`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\ninterface IGame {\n  _id: number;\n  title: string;\n  imageUrl: string;\n  gifUrl: string;\n  hasDiscount: boolean;\n  isActual: boolean;\n  isEnabled: boolean;\n  appleStoreUrl: string;\n  googlePlayUrl: string;\n  trailerUrl: string;\n}\n\ninterface IGamesState {\n  games: Array<IGame>,\n  gamesCount: number,\n  game: IGame | null,\n  loading: boolean,\n  error: string | null | undefined,\n}\n\nconst initialState: IGamesState = {\n  games: [],\n  gamesCount: 0,\n  game: null,\n  loading: false,\n  error: null,\n};\n\nconst gamesSlice = createSlice({\n  name: 'games',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchGames.pending, (state) => {\n        state.loading = true;\n      })\n      .addCase(fetchGames.fulfilled, (state, action) => {\n        state.loading = false;\n        state.games = action.payload;\n        state.gamesCount = action.payload.length; // Assuming the payload contains the games array\n      })\n      .addCase(fetchGames.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.error.message;\n      });\n    builder\n      .addCase(searchGames.pending, (state) => {\n        state.loading = true;\n      })\n      .addCase(searchGames.fulfilled, (state, action) => {\n        state.loading = false;\n        state.games = action.payload;\n      })\n      .addCase(searchGames.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.error.message;\n      });\n    builder\n      .addCase(fetchGame.pending, (state) => {\n        state.loading = true;\n      })\n      .addCase(fetchGame.fulfilled, (state, action) => {\n        state.loading = false;\n        state.game = action.payload;\n      })\n      .addCase(fetchGame.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.error.message;\n      });\n    builder\n        .addCase(fetchActiveGames.pending, (state) => {\n          state.loading = true;\n        })\n        .addCase(fetchActiveGames.fulfilled, (state, action) => {\n          state.loading = false;\n          state.games = action.payload;\n        })\n        .addCase(fetchActiveGames.rejected, (state, action) => {\n          state.loading = false;\n          state.error = action.error.message;\n        });\n    builder\n        .addCase(fetchDiscountedGames.pending, (state) => {\n          state.loading = true;\n        })\n        .addCase(fetchDiscountedGames.fulfilled, (state, action) => {\n          state.loading = false;\n          state.games = action.payload;\n        })\n        .addCase(fetchDiscountedGames.rejected, (state, action) => {\n          state.loading = false;\n          state.error = action.error.message;\n        });\n  }\n});\n\nexport default gamesSlice.reducer;","size_bytes":5351},"server/src/routes/paymentRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\nimport {\n  createCryptoInvoice, createRubInvoice,\n  getAllByMe\n} from '../controllers/paymentController';\n\nconst router = express.Router();\n\n// User routes\nrouter.post('/crypto', authenticateUser, createCryptoInvoice);\nrouter.post('/rub', authenticateUser, createRubInvoice)\nrouter.get('/me', authenticateUser, getAllByMe);\n\nexport default router;\n","size_bytes":434},"bot/src/types/inline.d.ts":{"content":"export interface InlineQueryResult {\n  type: 'article';\n  id: string;\n  title: string;\n  description?: string;\n  thumb_url?: string;\n  thumb_width?: number;\n  thumb_height?: number;\n  input_message_content: {\n    message_text: string;\n    parse_mode?: 'HTML' | 'Markdown';\n  };\n  reply_markup?: {\n    inline_keyboard: Array<Array<{\n      text: string;\n      url?: string;\n      callback_data?: string;\n      start_parameter?: string;\n    }>>;\n  };\n}\n\nexport interface InlineQueryButton {\n  text: string;\n  start_parameter?: string;\n}","size_bytes":533},"server/src/routes/orderRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\nimport {\n  getOrderById,\n  getOrdersByMe,\n  getOrdersCountByStatus, updateOrderStatus\n} from '../controllers/orderController';\nimport {isAdmin} from \"../middleware/admin\";\n\nconst router = express.Router();\n\n// User routes\nrouter.get('/me', authenticateUser, getOrdersByMe);\nrouter.get('/:orderId', authenticateUser, getOrderById);\nrouter.get('/me/status/:status/count', authenticateUser, getOrdersCountByStatus);\n\n// Admin-only routes\nrouter.put('/:orderId/status/:status', authenticateUser, isAdmin, updateOrderStatus);\n\nexport default router;","size_bytes":630},"admin/src/components/ProtectedRoute.tsx":{"content":"import React, { useEffect } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { checkToken } from '../store/features/authSlice';\nimport type { RootState, AppDispatch } from '../store/store';\nimport { Navigate } from 'react-router-dom';\n\ninterface ProtectedRouteProps {\n    children: React.ReactNode;\n}\n\nconst ProtectedRoute: React.FC<ProtectedRouteProps> = ({ children }) => {\n    const dispatch = useDispatch<AppDispatch>();\n    const { token, loading } = useSelector((state: RootState) => state.auth);\n\n    useEffect(() => {\n        if (token) {\n            dispatch(checkToken());\n        }\n    }, [dispatch, token]);\n\n    if (loading) return <div>Loading...</div>;\n\n    if (!token) {\n        return <Navigate to=\"/admin/login\" replace />;\n    }\n\n    return <>{children}</>;\n};\n\nexport default ProtectedRoute;\n","size_bytes":840},"bot/src/services/game.service.ts":{"content":"import axios from \"axios\";\nimport {User} from \"./user.service\";\n\nexport interface Game {\n  _id: number;\n  title: string;\n  imageUrl: string;\n  gifUrl: string;\n  hasDiscount: boolean;\n  isEnabled: boolean;\n  appStoreUrl: string;\n  googlePlayUrl: string;\n  trailerUrl: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport class GameService {\n  /**\n   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã\n   */\n  async getEnabledGames(): Promise<Game[]> {\n    const response = await axios.get(process.env.API_URL + '/games');\n\n    const isEnabledGames = response.data.filter((game: Game) => game.isEnabled);\n\n    return isEnabledGames || null;\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞\nexport const gameService = new GameService();\n","size_bytes":762},"client/src/pages/PurchaseForm.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport {useNavigate, useParams} from \"react-router-dom\";\nimport {useDispatch, useSelector} from \"react-redux\";\nimport type {AppDispatch} from \"../store/store.ts\";\nimport {fetchOrder} from \"../store/features/ordersSlice.ts\";\nimport {createOrderDetails, fetchOrderDetails, updateOrderDetails} from \"../store/features/orderDetailsSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\n\ntype BindingType = \"id\" | \"gameAccount\" | \"google\" | \"facebook\" | \"other\" | \"choice\";\n\ninterface FormData {\n    orderId: string | null;\n    userInGameId: string | null;\n    nickname: string | null;\n    login: string | null;\n    password: string | null;\n    entry: string | null;\n    code: string | null;\n    server: string | null;\n}\n\nconst isEntryType = (v: BindingType): v is Exclude<BindingType, \"other\" | \"choice\"> =>\n    v !== \"other\" && v !== \"choice\";\n\nconst PurchaseForm: React.FC = () => {\n    const { orderId } = useParams<{ orderId: string }>();\n\n    const dispatch = useDispatch<AppDispatch>();\n    const navigate = useNavigate();\n\n    const {t} = useTranslation();\n\n    const order = useSelector((state: any) => state.orders.orderForm);\n    const orderDetails = useSelector((state: any) => state.ordersDetails.orderDetails);\n\n    const [bindingType, setBindingType] = useState<BindingType>(\"choice\");\n    const [formData, setFormData] = useState<FormData>({\n        orderId: orderId || null,\n        userInGameId: null,\n        nickname: null,\n        login: null,\n        password: null,\n        entry: null,\n        code: null,\n        server: null,\n    });\n    const [errors, setErrors] = useState<Record<string, boolean>>({});\n\n    useEffect(() => {\n        if (orderId) {\n            dispatch(fetchOrder(orderId));\n            dispatch(fetchOrderDetails(orderId));\n        }\n\n        if (order && orderDetails) {\n            if (order.status === \"pending\") {\n                setFormData((prev) => ({\n                    ...prev,\n                    orderId: orderId || null,\n                }));\n            }\n\n            if (order.status === \"invalid\") {\n                const oldFormData: FormData = {\n                    orderId: order._id || null,\n                    userInGameId: orderDetails.userInGameId || null,\n                    nickname: orderDetails.nickname || null,\n                    login: orderDetails.login || null,\n                    password: orderDetails.password || null,\n                    entry: orderDetails.entry || null,\n                    code: orderDetails.code || null,\n                    server: orderDetails.server || null,\n                }\n\n                setFormData(oldFormData);\n            }\n        }\n    }, [orderId]);\n\n    if (!orderId) {\n        return <div className=\"p-4 text-red-500 font-bold\">Order ID not found</div>;\n    }\n\n    if (!order) {\n        return <div className=\"p-4 text-red-500 font-bold\">Order not found</div>;\n    }\n\n    if (order.status == \"pending\" || order.status == \"invalid\") { /* empty */ } else {\n        return <div className=\"p-4 text-red-500 font-bold\">Order status is {order.status}</div>;\n    }\n\n    const handleBindingTypeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n        const value = e.target.value as BindingType;\n        setBindingType(value);\n\n        setFormData((prev) => ({\n            ...prev,\n            entry: isEntryType(value) ? value : formData.entry,\n            // Clear other fields that might not be relevant after binding change\n            userInGameId: value === \"id\" ? prev.userInGameId : null,\n            login: [\"gameAccount\", \"google\", \"facebook\", \"other\"].includes(value)\n                ? prev.login\n                : null,\n            password: [\"gameAccount\", \"google\", \"facebook\", \"other\"].includes(value)\n                ? prev.password\n                : null,\n            nickname: prev.nickname, // keep nickname, it's always needed except for choice\n        }));\n\n        setErrors({});\n    };\n\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const { name, value } = e.target;\n        setFormData((prev) => ({\n            ...prev,\n            [name]: value.trim() === \"\" ? null : value,\n        }));\n    };\n\n    const validate = () => {\n        const newErrors: Record<string, boolean> = {};\n        if (bindingType === \"choice\") return newErrors;\n\n        const requiredFieldsMap: Record<BindingType, (keyof FormData)[]> = {\n            id: [\"userInGameId\", \"nickname\"],\n            gameAccount: [\"login\", \"password\", \"nickname\"],\n            google: [\"login\", \"password\", \"nickname\"],\n            facebook: [\"login\", \"password\", \"nickname\"],\n            other: [\"entry\", \"login\", \"password\", \"nickname\"],\n            choice: [],\n        };\n\n        const requiredFields = requiredFieldsMap[bindingType] || [];\n\n        requiredFields.forEach((field) => {\n            if (!formData[field]) {\n                newErrors[field] = true;\n            }\n        });\n\n        return newErrors;\n    };\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n\n        if (bindingType === \"choice\") {\n            // Do not submit if choice is selected\n            return;\n        }\n\n        const validationErrors = validate();\n        setErrors(validationErrors);\n\n        if (Object.keys(validationErrors).length === 0) {\n            if (order.status === \"pending\") {\n                dispatch(createOrderDetails(formData));\n            }\n\n            if (order.status === \"invalid\") {\n                dispatch(updateOrderDetails(formData));\n            }\n\n            navigate(\"/chat\")\n        }\n    };\n\n    const inputClass =\n        \"w-full p-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500 text-gray-200 border-gray-400 bg-[#1A1B1E]\";\n    const errorClass = \"text-red-500 text-sm mb-2\";\n\n    return (\n        <form\n            onSubmit={handleSubmit}\n            className=\"max-w-[28rem] w-full mx-2 my-3 p-4 space-y-4 bg-[#1A1B1E] rounded-xl shadow-md\"\n        >\n            <select\n                value={bindingType}\n                onChange={handleBindingTypeChange}\n                className={inputClass}\n            >\n                <option value=\"choice\">{t('purchaseForm.typeTitle')}</option>\n                <option value=\"id\">ID</option>\n                <option value=\"gameAccount\">{t('purchaseForm.gameAccount')}</option>\n                <option value=\"google\">Google</option>\n                <option value=\"facebook\">Facebook</option>\n                <option value=\"other\">{t('purchaseForm.other')}</option>\n            </select>\n\n            {bindingType === \"id\" && (\n                <>\n                    <div>\n                        <input\n                            name=\"userInGameId\"\n                            placeholder=\"User In-Game ID\"\n                            value={formData.userInGameId ?? \"\"}\n                            onChange={handleInputChange}\n                            className={inputClass}\n                        />\n                        {errors.userInGameId && (\n                            <div className={errorClass}>User In-Game ID is required</div>\n                        )}\n                    </div>\n                    <div>\n                        <input\n                            name=\"nickname\"\n                            placeholder=\"Nickname\"\n                            value={formData.nickname ?? \"\"}\n                            onChange={handleInputChange}\n                            className={inputClass}\n                        />\n                        {errors.nickname && (\n                            <div className={errorClass}>Nickname is required</div>\n                        )}\n                    </div>\n                </>\n            )}\n\n            {[\"gameAccount\", \"google\", \"facebook\", \"other\"].includes(bindingType) && (\n                <>\n                    {bindingType === \"other\" && (\n                        <div>\n                            <input\n                                name=\"entry\"\n                                placeholder={t('purchaseForm.entry')}\n                                value={formData.entry ?? \"\"}\n                                onChange={handleInputChange}\n                                className={inputClass}\n                            />\n                            {errors.entry && <div className={errorClass}>Entry is required</div>}\n                        </div>\n                    )}\n                    <div>\n                        <input\n                            name=\"login\"\n                            placeholder={t('purchaseForm.login')}\n                            value={formData.login ?? \"\"}\n                            onChange={handleInputChange}\n                            className={inputClass}\n                        />\n                        {errors.login && <div className={errorClass}>Login is required</div>}\n                    </div>\n                    <div>\n                        <input\n                            name=\"password\"\n                            placeholder={t('purchaseForm.password')}\n                            value={formData.password ?? \"\"}\n                            onChange={handleInputChange}\n                            className={inputClass}\n                        />\n                        {errors.password && (\n                            <div className={errorClass}>Password is required</div>\n                        )}\n                    </div>\n                    <div>\n                        <input\n                            name=\"nickname\"\n                            placeholder={t('purchaseForm.nickname')}\n                            value={formData.nickname ?? \"\"}\n                            onChange={handleInputChange}\n                            className={inputClass}\n                        />\n                        {errors.nickname && (\n                            <div className={errorClass}>Nickname is required</div>\n                        )}\n                    </div>\n                </>\n            )}\n\n            <div>\n                <input\n                    name=\"code\"\n                    placeholder={t('purchaseForm.code')}\n                    value={formData.code ?? \"\"}\n                    onChange={handleInputChange}\n                    className={inputClass}\n                />\n            </div>\n            <div>\n                <input\n                    name=\"server\"\n                    placeholder={t('purchaseForm.server')}\n                    value={formData.server ?? \"\"}\n                    onChange={handleInputChange}\n                    className={inputClass}\n                />\n            </div>\n\n            <button\n                type=\"submit\"\n                className=\"w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition cursor-pointer\"\n            >\n                {order.status === \"pending\" ? t('purchaseForm.btn') : null}\n                {order.status === \"invalid\" ? t('purchaseForm.btnUpdate') : null}\n            </button>\n        </form>\n    );\n};\n\nexport default PurchaseForm;\n","size_bytes":11142},"server/src/routes/withdrawalRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\nimport {\n  createWithdrawal,\n  getWithdrawalsByMe,\n} from '../controllers/withdrawalController';\n\nconst router = express.Router();\n\n// Create withdrawal\nrouter.post('/', authenticateUser, createWithdrawal);\n\n// Get withdrawals by me\nrouter.get('/me', authenticateUser, getWithdrawalsByMe);\n\nexport default router;","size_bytes":399},"admin/src/store/features/ordersSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const fetchOrders = createAsyncThunk('orders/fetchOrders', async (_, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/orders/me`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const fetchOrder = createAsyncThunk('orders/fetchOrder', async (orderId: string, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/orders/${orderId}`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const updateOrderStatus = createAsyncThunk('orders/updateOrderStatus', async (data: { orderId: string, status: string }, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.put(`/orders/${data.orderId}/status/${data.status}`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n    }\n})\n\nexport interface IOrder {\n    _id: number;\n    paymentId: number;\n    userId: number;\n    offerId: number;\n    orderDetailsId: number | null;\n    status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid';\n    currency: 'USDT' | 'RUB';\n    gameTitle: string;\n    createdAt: string;\n    updatedAt: Date;\n}\n\ninterface IOrdersState {\n    orders: IOrder[];\n    orderForm: IOrder | null;\n    loading: boolean;\n    error: string | null;\n}\n\nconst initialState: IOrdersState = {\n    orders: [],\n    orderForm: null,\n    loading: false,\n    error: null,\n};\n\nconst ordersSlice = createSlice({\n    name: 'orders',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchOrders.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchOrders.fulfilled, (state, action) => {\n                state.loading = false;\n                state.orders = action.payload.orders;\n            })\n            .addCase(fetchOrders.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            })\n        builder\n            .addCase(fetchOrder.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchOrder.fulfilled, (state, action) => {\n                state.loading = false;\n                state.orderForm = action.payload;\n            })\n            .addCase(fetchOrder.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            });\n    }\n});\n\nexport default ordersSlice.reducer;","size_bytes":3215},"client/src/types/telegram.d.ts":{"content":"export {};\n\ndeclare global {\n    interface TelegramWebAppUser {\n        id: number;\n        first_name: string;\n        last_name?: string;\n        username?: string;\n        language_code?: string;\n    }\n\n    interface TelegramWebApp {\n        initData: string;\n        initDataUnsafe?: {\n            user?: TelegramWebAppUser;\n        };\n        expand?: () => void;\n        ready?: () => void;\n        // add other properties if needed\n    }\n\n    interface Window {\n        Telegram?: {\n            WebApp?: TelegramWebApp;\n        };\n    }\n}\n","size_bytes":546},"client/src/store/features/orderDetailsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const createOrderDetails = createAsyncThunk('orderDetails/createOrderDetails', async (formData: any, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.post('/order-details', formData);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const updateOrderDetails = createAsyncThunk('orderDetails/updateOrderDetails', async (formData: any, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.put(`/order-details/${formData.orderId}`, formData);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport const fetchOrderDetails = createAsyncThunk('orderDetails/fetchOrderDetails', async (orderId: string, { rejectWithValue }) => {\n    try {\n        const response = await axiosInstance.get(`/order-details/${orderId}`);\n        return response.data;\n    } catch (error: any) {\n        if (error.response && error.response.data) {\n            return rejectWithValue(error.response.data);\n        }\n        return rejectWithValue(error.message);\n    }\n});\n\nexport interface IOrderDetails {\n    _id: number;\n    orderId: number;\n    entry: string | null;\n    login: string | null;\n    password: string | null;\n    code: string | null;\n    server: string;\n    nickname: string;\n    userInGameId: number | null;\n}\n\ninterface IOrderDetailsState {\n    orderDetails: IOrderDetails | null;\n    loading: boolean;\n    error: string | null;\n}\n\nconst initialState: IOrderDetailsState = {\n    orderDetails: null,\n    loading: false,\n    error: null,\n};\n\nconst orderDetailsSlice = createSlice({\n    name: 'orderDetails',\n    initialState,\n    reducers: {\n        // Define your synchronous actions here if needed\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(fetchOrderDetails.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(fetchOrderDetails.fulfilled, (state, action) => {\n                state.loading = false;\n                state.orderDetails = action.payload;\n            })\n            .addCase(fetchOrderDetails.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            });\n    }\n});\n\nexport default orderDetailsSlice.reducer;","size_bytes":2777},"bot/src/middleware/userMiddleware.ts":{"content":"import { MiddlewareFn } from 'telegraf';\nimport { userService } from '../services/user.service';\nimport {loggerMiddleware} from \"./logger\";\n\nexport const userMiddleware: MiddlewareFn<any> = async (ctx, next) => {\n  try {\n    const { id, username, languageCode } = ctx.from;\n\n    const referId = ctx.message?.text?.startsWith('/start ')\n        ? Number(ctx.message.text.split(' ')[1])\n        : null;\n\n    const { user, isNew } = await userService.getOrCreateUser({\n      _id: id,\n      username,\n      language: languageCode !== 'ru' ? 'en' : 'ru',\n      referredBy: referId\n    });\n\n    if (user && isNew && referId) {\n      try {\n        await ctx.telegram.sendMessage(\n            referId,\n            `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£ –≤–∞—Å –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª: @${username || '–±–µ–∑ username'}`\n        );\n      } catch (err) {\n        await loggerMiddleware.logSystemEvent(\"error\", '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É: ' + err);\n      }\n    }\n\n    ctx.state.user = user;\n    ctx.state.isNewUser = isNew;\n\n    if (user.isBanned) {\n      await ctx.reply('‚ùå –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –∑–∞–ø—Ä–µ—â—ë–Ω.');\n      return;\n    }\n\n    await next();\n  } catch (error) {\n    await loggerMiddleware.logSystemEvent('error', 'User middleware error: ' + error);\n  }\n};\n","size_bytes":1308},"server/src/routes/reviewRoutes.ts":{"content":"import express from 'express';\nimport {\n  createReview,\n  getReviews\n} from '../controllers/reviewController';\nimport {authenticateUser} from \"../middleware/auth\";\n\nconst router = express.Router();\n\n// Create a new review\nrouter.post('/', authenticateUser, createReview);\n\n// Get all reviews\nrouter.get('/', authenticateUser, getReviews);\n\nexport default router; ","size_bytes":363},"client/src/pages/About.tsx":{"content":"import { useState } from 'react';\nimport { useTranslation } from 'react-i18next';\n\nexport function About() {\n    const { t } = useTranslation();\n    const [activeMainTab, setActiveMainTab] = useState<'about' | 'info'>('about');\n    const [activeInfoTab, setActiveInfoTab] = useState<'agreement' | 'privacy'>('agreement');\n\n    return (\n        <div className=\"flex flex-col max-w-[28rem] mb-2 px-2 w-full text-white\">\n            {/* Main Navigation */}\n            <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 rounded-lg border  border-[#27282C]\">\n                <div className=\"grid grid-cols-2 gap-2\">\n                    <button\n                        className={`py-2 px-3 max-[350px]:text-sm max-[350px]:px-0 rounded-lg flex items-center justify-center cursor-pointer gap-2 ${\n                            activeMainTab === 'about' ? 'bg-[#252629] text-white' : 'text-[#8F96A3] hover:bg-[#252629]'\n                        }`}\n                        onClick={() => setActiveMainTab('about')}\n                    >\n                        <img\n                            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–û –Ω–∞—Å-qEHO7DLhT0EnUUme9mFMSVcUXfg5JS.gif\"\n                            alt={t('about.tabs.about')}\n                            className=\"w-5 h-5\"\n                        />\n                        <span>{t('about.tabs.about')}</span>\n                    </button>\n                    <button\n                        className={`py-2 px-3 max-[350px]:text-sm max-[350px]:px-0 rounded-lg flex items-center cursor-pointer justify-center gap-2 ${\n                            activeMainTab === 'info' ? 'bg-[#252629] text-white' : 'text-[#8F96A3] hover:bg-[#252629]'\n                        }`}\n                        onClick={() => setActiveMainTab('info')}\n                    >\n                        <img\n                            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–ò–Ω—Ñ–æ-rdnciHLjX0w1qpNN5CAH9oMFKxwH5z.gif\"\n                            alt={t('about.tabs.info')}\n                            className=\"w-5 h-5\"\n                        />\n                        <span>{t('about.tabs.info')}</span>\n                    </button>\n                </div>\n            </div>\n\n            {/* Info Sub-Navigation */}\n            {activeMainTab === 'info' && (\n                <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 rounded-lg border  border-[#27282C]\">\n                    <div className=\"flex flex-row max-[350px]:flex-col gap-2\">\n                        <button\n                            className={`py-2 px-3 max-[350px]:text-sm max-[350px]:whitespace-break-spaces rounded-lg flex items-center cursor-pointer justify-center gap-2 ${\n                                activeInfoTab === 'agreement' ? 'bg-[#252629] text-white' : 'text-[#8F96A3] hover:bg-[#252629]'\n                            }`}\n                            onClick={() => setActiveInfoTab('agreement')}\n                        >\n                            <img\n                                src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑-8B47YSRXaMqxptvSDC0qIn20wONJg3.gif\"\n                                alt={t('about.tabs.agreement')}\n                                className=\"w-5 h-5\"\n                            />\n                            {t('about.tabs.agreement')}\n                        </button>\n                        <button\n                            className={`py-2 px-3 max-[350px]:text-sm max-[350px]:whitespace-break-spaces rounded-lg flex cursor-pointer items-center justify-center gap-2 ${\n                                activeInfoTab === 'privacy' ? 'bg-[#252629] text-white' : 'text-[#8F96A3] hover:bg-[#252629]'\n                            }`}\n                            onClick={() => setActiveInfoTab('privacy')}\n                        >\n                            <img\n                                src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑-8B47YSRXaMqxptvSDC0qIn20wONJg3.gif\"\n                                alt={t('about.tabs.privacy')}\n                                className=\"w-5 h-5\"\n                            />\n                            {t('about.tabs.privacy')}\n                        </button>\n                    </div>\n                </div>\n            )}\n\n            {/* Content */}\n            <div className=\"w-full flex-1 mt-2 overflow-y-auto\">\n                {activeMainTab === 'about' && (\n                    <div>\n                        <div className=\"w-full bg-[#1a1b1e] p-2 text-[#8F96A3] rounded-lg border  border-[#27282C]\">\n                            <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.content.greetingTitle')}</h2>\n                            <p className=\"max-[350px]:text-sm\">{t('about.content.greetingText')}</p>\n                        </div>\n                        <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 text-[#8F96A3] rounded-lg border  border-[#27282C]\">\n                            <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.content.shopTitle')}</h2>\n                            <p className=\"max-[350px]:text-sm\">{t('about.content.shopText')}</p>\n                        </div>\n                        <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 text-[#8F96A3] rounded-lg border  border-[#27282C]\">\n                            <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.content.advantagesTitle')}</h2>\n                            <p className=\"max-[350px]:text-sm\">‚Ä¢ {t('about.content.advantage1')}</p>\n                            <p className=\"max-[350px]:text-sm\">‚Ä¢ {t('about.content.advantage2')}</p>\n                            <p className=\"max-[350px]:text-sm\">‚Ä¢ {t('about.content.advantage3')}</p>\n                            <p className=\"max-[350px]:text-sm\">‚Ä¢ {t('about.content.advantage4')}</p>\n                        </div>\n                        <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 text-[#8F96A3] rounded-lg border  border-[#27282C]\">\n                            <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.content.securityTitle')}</h2>\n                            <p className=\"max-[350px]:text-sm\">{t('about.content.securityText')}</p>\n                        </div>\n                        <div className=\"w-full bg-[#1a1b1e] p-2 mt-2 text-[#8F96A3] rounded-lg border  border-[#27282C]\">\n                            <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.content.supportTitle')}</h2>\n                            <p className=\"max-[350px]:text-sm\">{t('about.content.supportText')}</p>\n                        </div>\n                    </div>\n                )}\n\n                {activeMainTab === 'info' && activeInfoTab === 'agreement' && (\n                    <div className=\"bg-[#1a1b1e] rounded-lg p-2 text-[#8F96A3] border  border-[#27282C]\">\n                        <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.agreement.title')}</h2>\n                        <p className=\"max-[350px]:text-sm\">{t('about.agreement.date')}</p>\n                        <p className=\"max-[350px]:text-sm\">{t('about.agreement.intro')}</p>\n                        <h3>{t('about.agreement.acceptanceTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.agreement.acceptanceText')}</p>\n                        <h3>{t('about.agreement.servicesTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.agreement.servicesText')}</p>\n                        <h3>{t('about.agreement.liabilityTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.agreement.liabilityText')}</p>\n                    </div>\n                )}\n\n                {activeMainTab === 'info' && activeInfoTab === 'privacy' && (\n                    <div className=\"bg-[#1a1b1e] rounded-lg p-2 text-[#8F96A3] border  border-[#27282C]\">\n                        <h2 className=\"text-xl max-[350px]:text-base font-medium text-white mb-2\">{t('about.privacy.title')}</h2>\n                        <p className=\"max-[350px]:text-sm\">{t('about.privacy.date')}</p>\n                        <p className=\"max-[350px]:text-sm\">{t('about.privacy.intro')}</p>\n                        <h3>{t('about.privacy.collectTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.privacy.collectText')}</p>\n                        <h3>{t('about.privacy.useTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.privacy.useText')}</p>\n                        <h3>{t('about.privacy.securityTitle')}</h3>\n                        <p className=\"max-[350px]:text-sm\">{t('about.privacy.securityText')}</p>\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n}\n","size_bytes":8961},"client/src/pages/Reviews.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Star } from \"lucide-react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store.ts\";\nimport { fetchReviews } from \"../store/features/reviewsSlice.ts\";\nimport type{ IReview } from \"../store/features/reviewsSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\n\nexport function Reviews() {\n    const [sortBy, setSortBy] = useState<\"date\" | \"rating\">(\"date\");\n    const [reviewsData, setReviewsData] = useState<IReview[]>([]);\n    const dispatch = useDispatch<AppDispatch>();\n    const { reviews, loading } = useSelector((state: RootState) => state.reviews);\n\n    const {t} = useTranslation();\n\n    useEffect(() => {\n        dispatch(fetchReviews());\n    }, [dispatch]);\n\n    useEffect(() => {\n        if (reviews.length > 0) {\n            const sorted = [...reviews].sort((a, b) =>\n                sortBy === \"date\"\n                    ? new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                    : b.rating - a.rating\n            );\n            setReviewsData(sorted);\n        } else {\n            setReviewsData([]);\n        }\n    }, [reviews, sortBy]);\n\n    const averageRating =\n        reviews.length > 0\n            ? (reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length).toFixed(1)\n            : \"0\";\n\n    return (\n        <div className=\"max-w-[28rem] w-full h-full text-white font-sans flex flex-col\">\n            {/* External Links */}\n            <section className=\"p-3\">\n                <p className=\"text-xs text-[#8F96A3] mb-2\">\n                    {t('reviews.desc')}\n                </p>\n                <div className=\"grid grid-cols-2 gap-2\">\n                    <a\n                        href=\"https://www.z2u.com/shop/TipTop\"\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"bg-[#1a1b1e] rounded border border-[#27282C] flex justify-center items-center h-[50px]\"\n                    >\n                        <img\n                            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/Z2U-c5h7q5XnVVv9ID7Tj8uiJA00ul15qa.png\"\n                            alt=\"Z2U\"\n                            className=\"h-12 object-contain\"\n                        />\n                    </a>\n                    <a\n                        href=\"https://playerok.com/profile/TipTop999/reviews\"\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"bg-[#1a1b1e] rounded border border-[#27282C] flex justify-center items-center h-[50px]\"\n                    >\n                        <img\n                            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–ø–õ–ï–ô–ï–†–û–ö-anUyadlymqmnQiKwGyLNfhyTrApQ0u.png\"\n                            alt=\"PlayerOK\"\n                            className=\"h-15 object-contain\"\n                        />\n                    </a>\n                </div>\n            </section>\n\n            {/* Summary */}\n            <section className=\"bg-[#1a1b1e] m-3 max-[350px]:mt-0 max-[350px]:mb-1 rounded p-3 shrink-0 border border-[#27282C]\">\n                <div>\n                    <h2 className=\"mb-2 text-lg max-[350px]:text-base\">{t('reviews.count')}: {reviews.length}</h2>\n                    <div className=\"flex items-center gap-1\">\n                        {[1, 2, 3, 4, 5].map((star) => (\n                            <Star\n                                key={star}\n                                size={20}\n                                className=\"max-[350px]:h-[16px] max-[350px]:w-[16px]\"\n                                color={star <= Math.round(Number(averageRating)) ? \"#fbbf24\" : \"#27282C\"}\n                            />\n                        ))}\n                        <span className=\"ml-2 text-lg max-[350px]:text-base\">{averageRating}</span>\n                    </div>\n                </div>\n                <div className=\"mt-3 max-[350px]:mt-1 text-right\">\n                    <select\n                        value={sortBy}\n                        onChange={(e) => setSortBy(e.target.value as \"date\" | \"rating\")}\n                        className=\"bg-[#252629] text-[#8F96A3] rounded border border-[#27282C] px-3 py-1 text-sm cursor-pointer\"\n                    >\n                        <option value=\"date\">{t('reviews.byDate')}</option>\n                        <option value=\"rating\">{t('reviews.byRating')}</option>\n                    </select>\n                </div>\n            </section>\n\n            {/* Reviews */}\n            <main className=\"flex-grow overflow-y-auto p-3\">\n                {loading ? (\n                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>\n                ) : (\n                    reviewsData.map((review) => (\n                        <article\n                            key={review._id}\n                            className=\"bg-[#1a1b1e] rounded p-3 mb-3 border border-[#27282C]\"\n                        >\n                            <header className=\"flex justify-between mb-2\">\n                                <strong className=\"max-[350px]:text-sm\">{review.username}</strong>\n                                <div className=\"flex items-center gap-1\">\n                                    {[1, 2, 3, 4, 5].map((star) => (\n                                        <Star\n                                            key={star}\n                                            size={16}\n                                            color={star <= review.rating ? \"#fbbf24\" : \"#27282C\"}\n                                        />\n                                    ))}\n                                </div>\n                            </header>\n                            <p className=\"mb-2 max-[350px]:text-sm\">{review.comment}</p>\n                            <footer className=\"text-xs text-[#8F96A3]\">\n                                {new Date(review.createdAt).toLocaleString(\"ru-RU\", {\n                                    day: \"2-digit\",\n                                    month: \"2-digit\",\n                                    year: \"numeric\",\n                                    hour: \"2-digit\",\n                                    minute: \"2-digit\",\n                                })}\n                            </footer>\n                        </article>\n                    ))\n                )}\n            </main>\n        </div>\n    );\n}\n","size_bytes":6487},"client/src/styles.css":{"content":"@import \"tailwindcss\";\n\nhtml {\n  background-color: #141414;\n}","size_bytes":61},"bot/src/services/user.service.ts":{"content":"import axios from \"axios\";\nimport { bot } from \"../main\";\n\nexport interface User {\n  _id: number;\n  username: string;\n  language: string;\n  isBanned: boolean;\n  isSubscribed: boolean;\n  isAdmin: boolean;\n  avatarUrl: string | null;\n  balanceRUB: number;\n  balanceUSDT: number;\n  ordersCount: number;\n  referralPercent: number;\n  acceptedPrivacyConsent: boolean;\n  createdAt: Date;\n  updatedAt: Date;\n  referralCode: string;\n}\n\nexport class UserService {\n  /**\n   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID\n   */\n  async getUserById(userId: number): Promise<User | null> {\n    try {\n      const response = await axios.get(`${process.env.API_URL}/users/bot/${userId}`, {\n        headers: { 'Token': process.env.AUTH_BOT_TOKEN }\n      });\n      return response.data || null;\n    } catch (error: any) {\n      if (axios.isAxiosError(error) && error.response?.status === 404) {\n        return null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è\n      }\n      throw error; // –ü—Ä–æ—á–∏–µ –æ—à–∏–±–∫–∏ ‚Äî –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ\n    }\n  }\n\n  /**\n   * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  async createUser(userData: {\n    _id: number;\n    username?: string;\n    language?: string;\n    referredBy?: number | null;\n  }): Promise<User> {\n    const photos = await bot.telegram.getUserProfilePhotos(userData._id, 0, 1);\n    let avatarUrl;\n\n    if (photos.total_count > 0) {\n      const fileId = photos.photos[0][0].file_id;\n      const file = await bot.telegram.getFile(fileId);\n      avatarUrl = `https://api.telegram.org/file/bot${process.env.BOT_TOKEN}/${file.file_path}`;\n    } else {\n      avatarUrl = 'https://gravatar.com/avatar/9c88e3f5265071b9c524f12e3d584236?s=400&d=robohash&r=x';\n    }\n\n    const newUser = {\n      userId: userData._id,\n      username: userData.username || 'user',\n      avatarUrl: avatarUrl\n    };\n\n    const response = await axios.post(process.env.API_URL + '/users/bot', newUser, {\n      headers: {\n        'Token': process.env.AUTH_BOT_TOKEN\n      }\n    })\n\n    if (response.status === 201 && userData.referredBy) {\n      const newReferral = {\n        userId: userData._id,\n        referId: userData.referredBy || null,\n      }\n\n      const response2 = await axios.post(process.env.API_URL + '/referrals/bot', newReferral, {\n        headers: {\n          'Token': process.env.AUTH_BOT_TOKEN\n        }\n      })\n    }\n\n    return response.data || null;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  async getOrCreateUser(userData: {\n    _id: number;\n    username?: string;\n    language?: string;\n    referredBy?: number | null;\n  }): Promise<{ user: User; isNew: boolean }> {\n    let user = await this.getUserById(userData._id);\n    let isNew = false;\n\n    if (!user) {\n      user = await this.createUser(userData);\n      isNew = true;\n    }\n\n    return { user, isNew };\n  }\n\n  async updateLanguage(userId: number, updateData: {\n    language?: string;\n  }): Promise<User> {\n    const response = await axios.put(process.env.API_URL + `/users/bot/${userId}/language`, updateData, {\n      headers: {\n        'Token': process.env.AUTH_BOT_TOKEN\n      }\n    })\n\n    return response.data || null;\n  }\n\n  async updateSubscription(userId: number, updateData: {\n    isSubscribed?: boolean;\n  }): Promise<User | null> {\n    const response = await axios.put(process.env.API_URL + `/users/bot/${userId}/isSubscribed`, updateData, {\n      headers: {\n        'Token': process.env.AUTH_BOT_TOKEN\n      }\n    })\n\n    return response.data || null;\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º singleton instance\nexport const userService = new UserService();\n","size_bytes":3680},"client/src/components/SwitchGamesPanel.tsx":{"content":"import { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport {ChevronLeft, StepBack, StepForward} from \"lucide-react\";\nimport { useNavigate, useLocation } from \"react-router-dom\";\nimport { fetchGame, fetchGames } from \"../store/features/gamesSlice.ts\";\nimport { useEffect } from \"react\";\nimport {useTranslation} from \"react-i18next\";\nimport {fetchOffer, fetchOffers} from \"../store/features/offersSlice.ts\";\n\n// @ts-ignore\n// @ts-ignore\nconst SwitchGamesPanel = () => {\n  const dispatch = useDispatch<AppDispatch>();\n  const location = useLocation();\n  const navigate = useNavigate(); // Use useNavigate instead of redirect\n  const path = location.pathname.split(\"/\").filter(Boolean);\n  const {t} = useTranslation();\n\n  const gameId = useSelector((state: RootState) => state.offers.offer?.gameId);\n  const gamesCount = useSelector((state: RootState) => state.games.gamesCount);\n  // const offersCount = useSelector((state: RootState) => state.offers.offers).length;\n  const offers = useSelector((state: RootState) => state.offers.offers)\n\n  useEffect(() => {\n    if (path[0] === \"offers\") {\n      dispatch(fetchGames());\n    }\n\n    if (path[0] === \"order\" && gameId) {\n      dispatch(fetchGame(Number(gameId)));\n\n      const data = {\n        gameId: Number(gameId),\n        isEnabled: true\n      };\n\n      dispatch(fetchOffers(data));\n    }\n  }, [path[0], path[1], gameId]);\n\n  const game = useSelector((state: RootState) => state.games.game);\n\n  if (path[0] === \"offers\" || path[0] === \"order\") {\n      if (!game) return null;\n  }\n\n  const getNextOfferId = () => {\n    const currentOfferId = Number(path[3]);\n    const sortedOffers = [...offers]\n        .map(o => o._id)\n        .filter(id => id > currentOfferId)\n        .sort((a, b) => a - b);\n\n    return sortedOffers[0] ?? null;\n  };\n\n  const getPrevOfferId = () => {\n    const currentOfferId = Number(path[3]);\n    const sortedOffers = [...offers]\n        .map(o => o._id)\n        .filter(id => id < currentOfferId)\n        .sort((a, b) => b - a);\n\n    return sortedOffers[0] ?? null;\n  };\n\n  const getMinOfferId = () => {\n    return offers.length > 0 ? Math.min(...offers.map(o => o._id)) : null;\n  };\n\n  const getMaxOfferId = () => {\n    return offers.length > 0 ? Math.max(...offers.map(o => o._id)) : null;\n  };\n\n  const nextGame = async () => {\n    if (path[0] === \"offers\") {\n      const nextGameId = Number(path[1]) + 1;\n\n      if (nextGameId > gamesCount) {\n        const response = await dispatch(fetchGame(1));\n\n        if (response.meta.requestStatus === \"fulfilled\") {\n          navigate(`/offers/${1}`);\n        } else {\n          console.warn(\"Next game or its offers do not exist.\");\n        }\n\n        return;\n      }\n\n      const response = await dispatch(fetchGame(nextGameId));\n\n      if (response.meta.requestStatus === \"fulfilled\") {\n        navigate(`/offers/${nextGameId}`);\n      } else {\n        console.warn(\"Next game or its offers do not exist.\");\n      }\n    } else if (path[0] === \"games\" && path[2] === \"offers\" && path[4] === \"order\") {\n      const nextOfferId = getNextOfferId();\n\n      if (nextOfferId === null) {\n        const response = await dispatch(fetchOffer(getMinOfferId() || -1));\n\n        if (response.meta.requestStatus === \"fulfilled\") {\n          navigate(`/games/${gameId}/offers/${getMinOfferId()}/order`);\n        } else {\n          console.warn(\"Next game or its offers do not exist.\");\n        }\n\n        return;\n      }\n\n      const response = await dispatch(fetchOffer(nextOfferId));\n\n      if (response.meta.requestStatus === \"fulfilled\") {\n        navigate(`/games/${gameId}/offers/${nextOfferId}/order`);\n      } else {\n        console.warn(\"Next game or its offers do not exist.\");\n      }\n    }\n  };\n\n  const prevGame = async () => {\n    if (path[0] === \"offers\") {\n      const prevGameId = Number(path[1]) - 1;\n\n      if (prevGameId <= 0) {\n        const response = await dispatch(fetchGame(gamesCount));\n\n        if (response.meta.requestStatus === \"fulfilled\") {\n          navigate(`/offers/${gamesCount}`);\n        } else {\n          console.warn(\"Previous game or its offers do not exist.\");\n        }\n\n        return;\n      }\n\n      const response = await dispatch(fetchGame(prevGameId));\n\n      if (response.meta.requestStatus === \"fulfilled\") {\n        navigate(`/offers/${prevGameId}`);\n      } else {\n        console.warn(\"Previous game or its offers do not exist.\");\n      }\n    } else if (path[0] === \"games\" && path[2] === \"offers\" && path[4] === \"order\") {\n      const prevOfferId = getPrevOfferId();\n\n      if (prevOfferId === null) {\n        const response = await dispatch(fetchOffer(getMaxOfferId() || -1));\n\n        if (response.meta.requestStatus === \"fulfilled\") {\n          navigate(`/games/${gameId}/offers/${getMaxOfferId()}/order`);\n        } else {\n          console.warn(\"Previous game or its offers do not exist.\");\n        }\n\n        return;\n      }\n\n      const response = await dispatch(fetchOffer(prevOfferId));\n\n      if (response.meta.requestStatus === \"fulfilled\") {\n        navigate(`/games/${gameId}/offers/${prevOfferId}/order`);\n      } else {\n        console.warn(\"Previous game or its offers do not exist.\");\n      }\n    }\n  };\n\n  let title;\n\n  if (path[0] === \"offers\") {\n    title = game?.title;\n  } else if (path[0] === \"games\" && path[2] === \"offers\" && path[4] === \"order\") {\n    title = game?.title;\n  } else if (path[0] === \"orders\") {\n    title = t('switchGamesPanel.history');\n  } else if (path[0] === \"profile\") {\n    title = t('switchGamesPanel.referral');\n  } else if (path[0] === \"referral-info\") {\n    title = t('switchGamesPanel.rules');\n  } else if (path[0] == \"statistics\") {\n    title = t('switchGamesPanel.statistics');\n  } else if (path[0] === \"withdrawals\") {\n    title = t('switchGamesPanel.withdrawal');\n  } else if (path[0] === \"reviews\") {\n    title = t('switchGamesPanel.reviews');\n  } else if (path[0] === \"purchase-form\") {\n    title = t('switchGamesPanel.entry');\n  } else if (path[0] === \"about\") {\n    title = t('switchGamesPanel.about');\n  } else if (path[0] === \"chat\") {\n    title = t('switchGamesPanel.support');\n  } else if (path[0] === \"review\") {\n    title = t('switchGamesPanel.review');\n  }\n\n  const handleBack = () => {\n    window.history.back();\n  };\n\n  return (\n    <header className='flex justify-center bg-[#1A1B1E] text-white items-center py-[10px] border-b  border-[#27282C]'>\n      <div className='flex gap-1 max-w-[28rem] w-full items-center gap-1.5 px-2'>\n        <div style={path[0] !== \"offers\" && path[4] !== \"order\" ? {display: \"flex\"} : {display: \"none\"}} onClick={handleBack} className=\"flex items-center justify-center h-[40px] w-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\">\n          <ChevronLeft className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n        </div>\n        <div style={path[0] === \"orders\" || path[0] === \"profile\" || path[0] === \"referral-info\" || path[0] === \"statistics\" || path[0] === \"withdrawals\" || path[0] === \"reviews\" || path[0] === \"purchase-form\" || path[0] === \"about\" || path[0] === \"chat\" || path[0] === \"review\" ? {display: \"none\"} : {display: \"flex\"}} onClick={prevGame} className=\"flex items-center justify-center h-[40px] w-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\">\n          <StepBack className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n        </div>\n        <div className=\"flex flex-1 items-center justify-center overflow-hidden\">\n          <h1 onClick={() => navigate(\"/\")} className='text-lg max-[350px]:text-base text-[#fff] font-medium overflow-hidden text-ellipsis whitespace-nowrap'>{title}</h1>\n        </div>\n        <div style={path[0] === \"orders\" || path[0] === \"profile\" || path[0] === \"referral-info\" || path[0] === \"statistics\" || path[0] === \"withdrawals\" || path[0] === \"reviews\" || path[0] === \"purchase-form\" || path[0] === \"about\" || path[0] === \"chat\" || path[0] === \"review\" ? {display: \"none\"} : {display: \"flex\"}} onClick={nextGame} className=\"flex items-center justify-center h-[40px] w-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\">\n          <StepForward className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n        </div>\n        <div style={path[0] !== \"offers\" && path[4] !== \"order\" ? {display: \"flex\"} : {display: \"none\"}} className=\"flex items-center justify-center h-[40px] w-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer invisible\">\n          <ChevronLeft className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n        </div>\n      </div>\n    </header>\n  );\n};\n\nexport default SwitchGamesPanel;\n","size_bytes":9043},"client/src/components/SearchBar.tsx":{"content":"import React from 'react';\nimport { Search } from 'lucide-react';\nimport { useTranslation } from 'react-i18next';\n\ninterface SearchBarProps {\n  onSearch: (query: string) => void;\n}\n\nconst SearchBar: React.FC<SearchBarProps> = ({ onSearch }) => {\n  const {t} = useTranslation();\n  const inputRef = React.useRef<HTMLInputElement>(null);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    onSearch(e.target.value);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n      if (e.key === 'Enter') {\n          inputRef.current?.blur();\n      }\n  };\n\n  return (\n    <div className=\"flex flex-1 box-border px-2 items-center h-[40px] max-[350px]:h-[35px] gap-2 rounded-md border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]\">\n      <Search className=\"text-[#8F96A3] max-[350px]:w-[16px] max-[350px]:h-[16px]\" size={18} />\n      <input\n        type=\"text\"\n        onChange={handleInputChange}\n        onKeyDown={handleKeyDown}\n        placeholder={t('header.searchPlaceholder')}\n        className=\"flex-1 text-[14px] w-[110px] border-none focus:outline-none bg-transparent placeholder-[#8F96A3]\"\n      />\n    </div>\n  );\n};\n\nexport default SearchBar;","size_bytes":1207},"client/src/mock/initData.ts":{"content":"export const mockInitData = {\n    id: 1113418229,\n    first_name: 'M. S.',\n    last_name: '',\n    username: 'nikita_sy',\n};","size_bytes":123},"client/src/vite-env.d.ts":{"content":"/// <reference types=\"vite/client\" />\n","size_bytes":38},"client/src/store/features/ordersSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const fetchOrders = createAsyncThunk('orders/fetchOrders', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/orders/me`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\nexport const fetchOrder = createAsyncThunk('orders/fetchOrder', async (orderId: string, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/orders/${orderId}`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\nexport const updateOrderStatus = createAsyncThunk('orders/updateOrderStatus', async (data: { orderId: string, status: string }, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.put(`/orders/${data.orderId}/status/${data.status}`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n  }\n})\n\nexport interface IOrder {\n  _id: number;\n  paymentId: number;\n  userId: number;\n  offerId: number;\n  orderDetailsId: number | null;\n  status: 'pending' | 'process' | 'completed' | 'canceled' | 'invalid';\n  currency: 'USDT' | 'RUB';\n  gameTitle: string;\n  createdAt: string;\n  updatedAt: Date;\n}\n\ninterface IOrdersState {\n  orders: IOrder[];\n  orderForm: IOrder | null;\n  loading: boolean;\n  error: string | null;\n}\n\nconst initialState: IOrdersState = {\n  orders: [],\n  orderForm: null,\n  loading: false,\n  error: null,\n};\n\nconst ordersSlice = createSlice({\n  name: 'orders',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchOrders.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchOrders.fulfilled, (state, action) => {\n        state.loading = false;\n        state.orders = action.payload.orders;\n      })\n      .addCase(fetchOrders.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload as string;\n      })\n    builder\n        .addCase(fetchOrder.pending, (state) => {\n          state.loading = true;\n          state.error = null;\n        })\n        .addCase(fetchOrder.fulfilled, (state, action) => {\n          state.loading = false;\n          state.orderForm = action.payload;\n        })\n        .addCase(fetchOrder.rejected, (state, action) => {\n          state.loading = false;\n          state.error = action.payload as string;\n        });\n  }\n});\n\nexport default ordersSlice.reducer;","size_bytes":2919},"server/src/routes/referralRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\nimport {\n  getReferralCountByReferId,\n  createReferralByRefer,\n} from '../controllers/referralController';\n\nconst router = express.Router();\n\nrouter.post('/bot', createReferralByRefer);\nrouter.get('/refer/count', authenticateUser, getReferralCountByReferId);\n\nexport default router;","size_bytes":368},"admin/src/api/axiosInstance.ts":{"content":"import axios from 'axios';\n\nconst axiosInstance = axios.create({\n    baseURL: `${import.meta.env.VITE_API_URL}/api`,\n    headers: {\n        'Content-Type': 'application/json',\n    },\n});\n\nexport default axiosInstance;\n","size_bytes":218},"client/src/App.tsx":{"content":"import { useEffect, useState } from \"react\"\nimport { BrowserRouter, Route, Routes } from \"react-router-dom\"\nimport MainLayout from \"./layouts/MainLayout\"\nimport Home from \"./pages/Home\"\nimport Offer from \"./pages/Offers\"\nimport SecondaryLayout from \"./layouts/SecondaryLayout\"\nimport Order from \"./pages/Order\"\nimport { useDispatch, useSelector } from \"react-redux\"\nimport type { AppDispatch, RootState } from \"./store/store\"\nimport { createUser, fetchUser } from \"./store/features/userSlice\"\nimport Orders from \"./pages/Orders\"\nimport Profile from \"./pages/Profile\"\nimport ReferralInfo from \"./pages/ReferralInfo\"\nimport Statistics from \"./pages/Statistics\"\nimport Withdrawals from \"./pages/Withdrawals\"\nimport { Reviews } from \"./pages/Reviews\"\nimport Chat from \"./pages/Chat\"\nimport PurchaseForm from \"./pages/PurchaseForm\"\nimport { About } from \"./pages/About\"\nimport { useTranslation } from \"react-i18next\"\nimport OrientationWarning from \"./components/OrientationWarning\"\nimport ReviewForm from \"./pages/ReviewForm\"\n\nconst App = () => {\n  const dispatch = useDispatch<AppDispatch>()\n  const { i18n } = useTranslation()\n\n  const isAuth = useSelector((state: RootState) => state.user.isAuth)\n  const user = useSelector((state: RootState) => state.user.user)\n\n  const [isTelegram, setIsTelegram] = useState(false)\n  const [userCreated, setUserCreated] = useState(false)\n\n  useEffect(() => {\n    if (typeof window !== \"undefined\" && window.Telegram && window.Telegram.WebApp) {\n      const tg = window.Telegram.WebApp\n      if (tg) {\n        tg.ready?.()\n        tg.expand?.()\n        setIsTelegram(true)\n        dispatch(fetchUser())\n      }\n    }\n  }, [dispatch])\n\n  useEffect(() => {\n    if (isTelegram) {\n      if (user) {\n        i18n.changeLanguage(user.language)\n      } else if (!userCreated) {\n        dispatch(createUser())\n        setUserCreated(true)\n      }\n    }\n  }, [user, isTelegram, userCreated, dispatch, i18n])\n\n  if (!window.Telegram?.WebApp?.initData && import.meta.env.VITE_NODE_ENV === 'production') {\n    return <div className=\"text-white\">Please open this app via Telegram</div>\n  }\n\n  if (!isAuth && import.meta.env.VITE_NODE_ENV === 'production') {\n    return <div className=\"text-white\">Unauthorized</div>\n  }\n\n  if (user?.isBanned && import.meta.env.VITE_NODE_ENV === 'production') {\n    return <div className=\"text-white\">‚ùå –î–æ—Å—Ç—É–ø –∫ –º–∞–≥–∞–∑–∏–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω.</div>\n  }\n\n  return (\n    <>\n      <OrientationWarning />\n      <BrowserRouter>\n        <Routes>\n          <Route path=\"/\" element={<MainLayout />}>\n            <Route index element={<Home />} />\n            <Route path=\"/games\" element={<Home />} />\n          </Route>\n          <Route path=\"/games/:gameId/offers/:offerId/order\" element={<SecondaryLayout />}>\n            <Route index element={<Order />} />\n          </Route>\n          <Route path=\"/chat\" element={<SecondaryLayout />}>\n            <Route index element={<Chat />} />\n          </Route>\n          <Route path=\"/offers\" element={<SecondaryLayout />}>\n            <Route path=\":gameId\" element={<Offer />} />\n          </Route>\n          <Route path=\"/orders\" element={<SecondaryLayout />}>\n            <Route index element={<Orders />} />\n          </Route>\n          <Route path=\"/profile\" element={<SecondaryLayout />}>\n            <Route index element={<Profile />} />\n          </Route>\n          <Route path=\"/referral-info\" element={<SecondaryLayout />}>\n            <Route index element={<ReferralInfo />} />\n          </Route>\n          <Route path=\"/statistics\" element={<SecondaryLayout />}>\n            <Route index element={<Statistics />} />\n          </Route>\n          <Route path=\"/withdrawals\" element={<SecondaryLayout />}>\n            <Route index element={<Withdrawals />} />\n          </Route>\n          <Route path=\"/reviews\" element={<SecondaryLayout />}>\n            <Route index element={<Reviews />} />\n          </Route>\n          <Route path=\"/purchase-form/:orderId\" element={<SecondaryLayout />}>\n            <Route index element={<PurchaseForm />} />\n          </Route>\n          <Route path=\"/review/:orderId\" element={<SecondaryLayout />}>\n            <Route index element={<ReviewForm />} />\n          </Route>\n          <Route path=\"/about\" element={<SecondaryLayout />}>\n            <Route index element={<About />} />\n          </Route>\n        </Routes>\n      </BrowserRouter>\n    </>\n  )\n}\n\nexport default App\n","size_bytes":4426},"client/vite.config.ts":{"content":"import { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\nimport tailwindcss from '@tailwindcss/vite'\n\n// https://vite.dev/config/\nexport default defineConfig({\n  plugins: [react(), tailwindcss()],\n})\n","size_bytes":220},"client/src/pages/Orders.tsx":{"content":"import { useDispatch, useSelector } from \"react-redux\";\nimport type { AppDispatch, RootState } from \"../store/store\"\nimport {useEffect, useState} from \"react\";\nimport type {IOrder} from \"../store/features/ordersSlice.ts\";\nimport {fetchOrders} from \"../store/features/ordersSlice.ts\";\nimport { format } from 'date-fns';\nimport {useTranslation} from \"react-i18next\";\n\nconst Orders = () => {\n  const dispatch = useDispatch<AppDispatch>();\n  const orders = useSelector((state: RootState) => state.orders.orders);\n  const formattedOrders = orders.map(order => ({\n    ...order,\n    createdAt: format(new Date(order.createdAt), 'yyyy-MM-dd'),\n  }));\n  const [filteredOrders, setFilteredOrders] = useState<IOrder[]>(formattedOrders);\n  const [filteredOrdersStatus, setFilteredOrdersStatus] = useState<'all' | 'completed' | 'pending' | 'process' | 'canceled'>();\n\n  const {t} = useTranslation();\n\n  useEffect(() => {\n    dispatch(fetchOrders());\n  }, [dispatch]);\n\n  useEffect(() => {\n    const formatted = orders.map(order => ({\n      ...order,\n      createdAt: format(new Date(order.createdAt), 'yyyy-MM-dd'),\n    }));\n    setFilteredOrders(formatted);\n    setFilteredOrdersStatus('all');\n  }, [orders]);\n\n  if (!orders) return null;\n\n  const allOrders = formattedOrders;\n  const completedOrders = formattedOrders.filter(order => order.status === 'completed');\n  const pendingOrders = formattedOrders.filter(order => order.status === 'pending');\n  const processOrders = formattedOrders.filter(order => order.status === 'process');\n  const canceledOrders = formattedOrders.filter(order => order.status === 'canceled');\n\n  const ordersCount = allOrders.length;\n  const completedOrdersCount = completedOrders.length;\n  const pendingOrdersCount = pendingOrders.length;\n  const processOrdersCount = processOrders.length;\n  const canceledOrdersCount = canceledOrders.length;\n\n  const toggleToAllOrders = () => {\n    setFilteredOrders(allOrders);\n    setFilteredOrdersStatus('all');\n  }\n\n  const toggleToCompletedOrders = () => {\n    setFilteredOrders(completedOrders);\n    setFilteredOrdersStatus('completed');\n  }\n\n  const toggleToPendingOrders = () => {\n    setFilteredOrders(pendingOrders);\n    setFilteredOrdersStatus('pending');\n  }\n\n  const toggleToProcessOrders = () => {\n    setFilteredOrders(processOrders);\n    setFilteredOrdersStatus('process');\n  }\n\n  const toggleToCanceledOrders = () => {\n    setFilteredOrders(canceledOrders);\n    setFilteredOrdersStatus('canceled');\n  }\n\n  return (\n    <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-hidden py-3 px-2\">\n      <div className=\"flex flex-col gap-2 w-full h-fill\">\n        <div onClick={toggleToAllOrders} style={filteredOrdersStatus === 'all' ? {border: \"2px solid white\"} : {}} className=\"flex items-center justify-center gap-1 bg-[#1E1F23] rounded-[10px] py-2 border  border-[#27282C]\">\n          <div className=\"flex items-center gap-2\">\n            <img className=\"w-[20px]\" src=\"/Purchases.gif\" alt=\"orders\" />\n            <span className=\"text-[16px] text-[#979EAA]\">{t('orders.count')}:</span>\n          </div>\n          <span className=\"text-[16px] text-[#979EAA]\">{ordersCount}</span>\n        </div>\n        <div className=\"grid grid-cols-2 gap-2 w-full h-fill\">\n          <div onClick={toggleToPendingOrders} style={filteredOrdersStatus === 'pending' ? {border: \"2px solid white\"} : {}} className=\"flex flex-col justify-center items-center bg-[#1E1F23] rounded-[10px] py-2 border  border-[#27282C]\">\n            <div className=\"flex items-center justify-center gap-2\">\n              <img className=\"w-[20px]\" src=\"/Incorrect.gif\" alt=\"incorrect\" />\n              <span className=\"text-white font-bold\">{pendingOrdersCount}</span>\n            </div>\n            <div>\n              <span className=\"text-[#979EAA]\">{t('orders.pending')}</span>\n            </div>\n          </div>\n          <div onClick={toggleToProcessOrders} style={filteredOrdersStatus === 'process' ? {border: \"2px solid white\"} : {}} className=\"flex flex-col justify-center items-center bg-[#1E1F23] rounded-[10px] py-2 border  border-[#27282C]\">\n            <div className=\"flex items-center justify-center gap-2\">\n              <img className=\"w-[20px]\" src=\"/Process.gif\" alt=\"process\" />\n              <span className=\"text-white font-bold\">{processOrdersCount}</span>\n            </div>\n            <div>\n              <span className=\"text-[#979EAA]\">{t('orders.process')}</span>\n            </div>\n          </div>\n          <div onClick={toggleToCanceledOrders} style={filteredOrdersStatus === 'canceled' ? {border: \"2px solid white\"} : {}} className=\"flex flex-col justify-center items-center bg-[#1E1F23] rounded-[10px] py-2 border  border-[#27282C]\">\n            <div className=\"flex items-center justify-center gap-2\">\n              <img className=\"w-[20px]\" src=\"/Canceled.gif\" alt=\"canceled\" />\n              <span className=\"text-white font-bold\">{canceledOrdersCount}</span>\n            </div>\n            <div>\n              <span className=\"text-[#979EAA]\">{t('orders.canceled')}</span>\n            </div>\n          </div>\n          <div onClick={toggleToCompletedOrders} style={filteredOrdersStatus === 'completed' ? {border: \"2px solid white\"} : {}} className=\"flex flex-col justify-center items-center bg-[#1E1F23] rounded-[10px] py-2 border  border-[#27282C]\">\n            <div className=\"flex items-center justify-center gap-2\">\n              <img className=\"w-[20px]\" src=\"/Completed.gif\" alt=\"completed\" />\n              <span className=\"text-white font-bold\">{completedOrdersCount}</span>\n            </div>\n            <div>\n              <span className=\"text-[#979EAA]\">{t('orders.completed')}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div className=\"flex flex-col gap-2 w-full h-fill mt-2 overflow-auto\">\n        {filteredOrders.map(order => (\n          <div key={order._id} className=\"flex flex-col items-start bg-[#1E1F23] rounded-[10px] px-2 py-2 border  border-[#27282C]\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <img className=\"w-[18px]\" src=\"/Number.gif\" alt=\"order number\" />\n                <span className=\"text-[#979EAA] text-[16px]\">{t('orders.number')}:</span>\n              </div>\n              <span className=\"text-white text-[18px]\">{order._id}</span> \n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <img className=\"w-[18px]\" src=\"/Date.gif\" alt=\"order date\" />\n                <span className=\"text-[#979EAA] text-[16px]\">{t('orders.date')}:</span>\n              </div>\n              <span className=\"text-white text-[18px]\">{order.createdAt}</span> \n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <img className=\"w-[18px]\" src=\"/Game.gif\" alt=\"game\" />\n                <span className=\"text-[#979EAA] text-[16px]\">{t('orders.game')}:</span>\n              </div>\n              <span className=\"text-white text-[18px]\">{order.gameTitle}</span> \n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <img className=\"w-[18px]\" src=\"/Status.gif\" alt=\"order status\" />\n                <span className=\"text-[#979EAA] text-[16px]\">{t('orders.status')}:</span>\n              </div>\n              <span className=\"text-white text-[18px]\">{order.status === 'completed' ? t('orders.completedOrder') : order.status === 'pending' ? t('orders.pendingOrder') : order.status === 'process' ? t('orders.processOrder') : t('orders.canceledOrder')}</span>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  )\n}\n\nexport default Orders;\n","size_bytes":7845},"server/src/models/Review.ts":{"content":"// MONGO BACKUP: import { getMaxReviewId } from '../helpers/index';\n// MONGO BACKUP: import mongoose, { Schema, Document } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IReview extends Document {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   orderId: number;\n// MONGO BACKUP:   username: string;\n// MONGO BACKUP:   rating: number;\n// MONGO BACKUP:   comment: string;\n// MONGO BACKUP:   createdAt: Date;\n// MONGO BACKUP:   updatedAt: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const ReviewSchema: Schema = new Schema<IReview>({\n// MONGO BACKUP:   _id: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: false,\n// MONGO BACKUP:   },\n// MONGO BACKUP:   userId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     ref: 'User'\n// MONGO BACKUP:   },\n// MONGO BACKUP:   orderId: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     ref: 'Order',\n// MONGO BACKUP:     index: true,\n// MONGO BACKUP:     unique: true\n// MONGO BACKUP:   },\n// MONGO BACKUP:   username: {\n// MONGO BACKUP:     type: String,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     ref: 'User',\n// MONGO BACKUP:   },\n// MONGO BACKUP:   rating: {\n// MONGO BACKUP:     type: Number,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     min: 1,\n// MONGO BACKUP:     max: 5\n// MONGO BACKUP:   },\n// MONGO BACKUP:   comment: {\n// MONGO BACKUP:     type: String,\n// MONGO BACKUP:     required: true,\n// MONGO BACKUP:     trim: true,\n// MONGO BACKUP:     maxlength: 1000\n// MONGO BACKUP:   },\n// MONGO BACKUP: }, {\n// MONGO BACKUP:   timestamps: true // Automatically manage created_at and updated_at fields\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Pre-save hook to set _id automatically\n// MONGO BACKUP: ReviewSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxReviewId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IReview>('Review', ReviewSchema); \n","size_bytes":2250},"client/src/store/features/transactionsSlice.ts":{"content":"import { createSlice, createAsyncThunk } from \"@reduxjs/toolkit\";\nimport axiosInstance from '../../api/axiosInstance.ts';\n\nexport const fetchTransactionsByReferId = createAsyncThunk('transactions/fetchTransactionsByReferId', async (_, { rejectWithValue }) => {\n  try {\n    const response = await axiosInstance.get(`/transactions/refer`);\n    return response.data;\n  } catch (error: any) {\n    if (error.response && error.response.data) {\n      return rejectWithValue(error.response.data);\n    }\n    return rejectWithValue(error.message);\n  }\n});\n\nexport interface ITransaction {\n  _id: number;\n  userId: number;\n  username: string;\n  referId?: number;\n  amount: number;\n  currency: 'RUB' | 'USDT';\n  earned?: number;\n  type: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface ITransactionsState {\n  transactions: ITransaction[];\n  loading: boolean;\n  error: string | null;\n}\n\nconst initialState: ITransactionsState = {\n  transactions: [],\n  loading: false,\n  error: null,\n};\n\nconst transactionsSlice = createSlice({\n  name: 'transactions',\n  initialState,\n  reducers: {\n    // Define your synchronous actions here if needed\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(fetchTransactionsByReferId.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n      })\n      .addCase(fetchTransactionsByReferId.fulfilled, (state, action) => {\n        state.loading = false;\n        state.transactions = action.payload;\n      })\n      .addCase(fetchTransactionsByReferId.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload as string;\n      });\n  }\n});\n\nexport default transactionsSlice.reducer;","size_bytes":1683},"client/src/components/Footer.tsx":{"content":"import { CircleFadingArrowUp, Menu, MessageCircleMore, SquareArrowOutUpRight } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\nimport MenuComp from './Menu';\nimport { useState, useRef, useEffect } from 'react';\nimport LinksWidget from \"./LinksWidget.tsx\";\nimport { useLocation } from 'react-router-dom';\n\n\nconst Footer = () => {\n  const navigate = useNavigate();\n  const [menuVisible, setMenuVisible] = useState(false);\n  const [linksVisible, setLinksVisible] = useState(false);\n  const menuRef = useRef<HTMLDivElement | null>(null);\n  const linksRef = useRef<HTMLDivElement | null>(null);\n  const location = useLocation();\n\n  const handleMenuToggle = () => setMenuVisible(!menuVisible);\n  const handleLinksToggle = () => setLinksVisible(!linksVisible);\n\n  const handleScrollAllToTop = () => {\n    const scrollableElements = document.querySelectorAll<HTMLElement>('*');\n    scrollableElements.forEach((el) => {\n      const overflowY = getComputedStyle(el).overflowY;\n      const isScrollable = (overflowY === 'auto' || overflowY === 'scroll') && el.scrollHeight > el.clientHeight;\n      if (isScrollable) {\n        el.scrollTo({ top: 0, behavior: 'smooth' });\n      }\n    });\n  };\n\n  useEffect(() => {\n    setMenuVisible(false);\n    setLinksVisible(false);\n  }, [location]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setMenuVisible(false);\n      }\n\n      if (linksRef.current && !linksRef.current.contains(event.target as Node)) {\n        setLinksVisible(false);\n      }\n    };\n\n    if (menuVisible) {\n      document.addEventListener('mousedown', handleClickOutside);\n    }\n\n    if (linksVisible) {\n      document.addEventListener('mousedown', handleClickOutside);\n    }\n\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [menuVisible, linksVisible]);\n\n  return (\n      <footer className='flex justify-center bg-[#1A1B1E] text-white items-center py-[10px] border-t border-[#00CCCC33]'>\n        <div className='relative flex gap-2 max-[350px]:gap-1 max-w-[28rem] w-full items-center gap-1.5 px-2'>\n          <MenuComp ref={menuRef} visible={menuVisible} handleMenuToggle={handleMenuToggle} />\n          <button onClick={handleMenuToggle} className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'>\n            <Menu className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20}/>\n          </button>\n          <button onClick={() => navigate(\"/chat\")} className='cursor-pointer flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]'>\n            <MessageCircleMore className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          <div onClick={() => navigate(\"/\")} className=\"h-[40px] max-[350px]:h-[35px] px-2 rounded-3xl flex flex-1 content-center justify-center items-center gap-2 border-l-2 border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]\">\n            {/*<Gem className=\"text-[#b9f2ff]\" size={18} />*/}\n            <h1 className='max-[350px]:text-[16px] font-bold text-lg text-[#8F96A3] cursor-pointer'>üíé TipTop üíé</h1>\n            {/*<Gem className=\"text-[#b9f2ff]\" size={18} />*/}\n          </div>\n          <button onClick={handleScrollAllToTop} className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'>\n            <CircleFadingArrowUp className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          <button onClick={handleLinksToggle} className='flex items-center w-[40px] h-[40px] max-[350px]:w-[35px] max-[350px]:h-[35px] rounded-lg justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer'>\n            <SquareArrowOutUpRight className=\"text-[#8F96A3] max-[350px]:w-[18px] max-[350px]:h-[18px]\" size={20} />\n          </button>\n          {linksVisible && <LinksWidget ref={linksRef} />}\n        </div>\n      </footer>\n  );\n};\n\nexport default Footer;\n","size_bytes":4414},"server/src/models/Withdrawal.ts":{"content":"// MONGO BACKUP: import { getMaxWithdrawalId } from '../helpers/index';\n// MONGO BACKUP: import mongoose, { Schema, Document } from 'mongoose';\n// MONGO BACKUP: \n// MONGO BACKUP: export interface IWithdrawal extends Document {\n// MONGO BACKUP:   _id: number;\n// MONGO BACKUP:   userId: number;\n// MONGO BACKUP:   amount: number;\n// MONGO BACKUP:   status: 'pending' | 'completed' | 'rejected';\n// MONGO BACKUP:   currency: 'RUB' | 'USDT';\n// MONGO BACKUP:   createdAt: Date;\n// MONGO BACKUP:   updatedAt: Date;\n// MONGO BACKUP: }\n// MONGO BACKUP: \n// MONGO BACKUP: const WithdrawalSchema: Schema = new Schema<IWithdrawal>({\n// MONGO BACKUP:   _id: { type: Number, required: false },\n// MONGO BACKUP:   userId: { type: Number, required: true },\n// MONGO BACKUP:   amount: { type: Number, required: true },\n// MONGO BACKUP:   status: { type: String, enum: ['pending', 'completed', 'rejected'], required: false, default: \"pending\" },\n// MONGO BACKUP:   currency: { type: String, enum: ['RUB', 'USDT'], required: true },\n// MONGO BACKUP:   createdAt: { type: Date, required: true, default: Date.now },\n// MONGO BACKUP:   updatedAt: { type: Date, required: true, default: Date.now },\n// MONGO BACKUP: }, {\n// MONGO BACKUP:   timestamps: true\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Pre-save hook to set _id automatically\n// MONGO BACKUP: WithdrawalSchema.pre('save', async function (next) {\n// MONGO BACKUP:   if (this.isNew) { // Only execute for new documents\n// MONGO BACKUP:     this._id = (await getMaxWithdrawalId()) + 1; // Automatically set _id\n// MONGO BACKUP:   }\n// MONGO BACKUP:   next();\n// MONGO BACKUP: });\n// MONGO BACKUP: \n// MONGO BACKUP: // Index for efficient querying\n// MONGO BACKUP: WithdrawalSchema.index({ userId: 1, status: 1 });\n// MONGO BACKUP: WithdrawalSchema.index({ status: 1, createdAt: -1 });\n// MONGO BACKUP: \n// MONGO BACKUP: export default mongoose.model<IWithdrawal>('Withdrawal', WithdrawalSchema); \n","size_bytes":1953},"server/src/routes/userRoutes.ts":{"content":"import express from 'express';\nimport { authenticateUser } from '../middleware/auth';\nimport {\n  createUser, createUserBot,\n  getUserById, getUserByIdBot, updateLanguage, updateLanguageBot, updateSubscriptionBot,\n} from '../controllers/userController';\n\nconst router = express.Router();\n\n// Bot routes\nrouter.post('/bot', createUserBot);\nrouter.get('/bot/:userId', getUserByIdBot);\n// update user language\nrouter.put('/bot/:userId/language', updateLanguageBot);\nrouter.put('/bot/:userId/isSubscribed', updateSubscriptionBot);\n\n// Client routes\nrouter.post('/', authenticateUser, createUser);\nrouter.get('/me', authenticateUser, getUserById);\nrouter.put('/language', authenticateUser, updateLanguage);\n\nexport default router;","size_bytes":724},"bot/src/utils/messageUpdateManager.ts":{"content":"/**\n * –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n * –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã Telegram –±–æ—Ç–∞\n */\n\ninterface PendingUpdate {\n  timeout: NodeJS.Timeout;\n  timestamp: number;\n}\n\nclass MessageUpdateManager {\n  private pendingUpdates: Map<string, PendingUpdate> = new Map();\n  private readonly DEBOUNCE_DELAY = 100; // –º—Å\n  private readonly MAX_PENDING_TIME = 5000; // –º—Å\n\n  /**\n   * –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º\n   * @param key –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ userId_chatId)\n   * @param updateFunction –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   */\n  scheduleUpdate(key: string, updateFunction: () => Promise<void>): void {\n    // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å\n    this.cancelPendingUpdate(key);\n\n    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n    const timeout = setTimeout(async () => {\n      try {\n        await updateFunction();\n      } catch (error) {\n        console.error(`Error in scheduled update for ${key}:`, error);\n      } finally {\n        this.pendingUpdates.delete(key);\n      }\n    }, this.DEBOUNCE_DELAY);\n\n    this.pendingUpdates.set(key, {\n      timeout,\n      timestamp: Date.now()\n    });\n  }\n\n  /**\n   * –û—Ç–º–µ–Ω—è–µ—Ç –æ–∂–∏–¥–∞—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n   * @param key –ö–ª—é—á –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   */\n  cancelPendingUpdate(key: string): void {\n    const pending = this.pendingUpdates.get(key);\n    if (pending) {\n      clearTimeout(pending.timeout);\n      this.pendingUpdates.delete(key);\n    }\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –æ–∂–∏–¥–∞—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n   * @param key –ö–ª—é—á –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   */\n  hasPendingUpdate(key: string): boolean {\n    return this.pendingUpdates.has(key);\n  }\n\n  /**\n   * –û—á–∏—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   */\n  cleanupStaleUpdates(): void {\n    const now = Date.now();\n    for (const [key, pending] of this.pendingUpdates.entries()) {\n      if (now - pending.timestamp > this.MAX_PENDING_TIME) {\n        clearTimeout(pending.timeout);\n        this.pendingUpdates.delete(key);\n        console.warn(`Cleaned up stale update for ${key}`);\n      }\n    }\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\n   */\n  getPendingCount(): number {\n    return this.pendingUpdates.size;\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–Ω–≥–ª—Ç–æ–Ω\nexport const messageUpdateManager = new MessageUpdateManager();\n\n// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\nsetInterval(() => {\n  messageUpdateManager.cleanupStaleUpdates();\n}, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥","size_bytes":2858},"client/eslint.config.js":{"content":"import js from '@eslint/js'\nimport globals from 'globals'\nimport reactHooks from 'eslint-plugin-react-hooks'\nimport reactRefresh from 'eslint-plugin-react-refresh'\nimport tseslint from 'typescript-eslint'\n\nexport default tseslint.config(\n  { ignores: ['dist'] },\n  {\n    extends: [js.configs.recommended, ...tseslint.configs.recommended],\n    files: ['**/*.{ts,tsx}'],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n    },\n    plugins: {\n      'react-hooks': reactHooks,\n      'react-refresh': reactRefresh,\n    },\n    rules: {\n      ...reactHooks.configs.recommended.rules,\n        \"@typescript-eslint/no-explicit-any\": \"off\",\n      'react-refresh/only-export-components': [\n        'warn',\n        { allowConstantExport: true },\n      ],\n    },\n  },\n)\n","size_bytes":787},"bot/src/middleware/logger.ts":{"content":"import { Context, MiddlewareFn } from 'telegraf';\nimport { configService } from '../config/config.service';\nimport { errorHandler } from '../utils/errorHandler';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\n/**\n * üìä Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏\n */\nexport class LoggerMiddleware {\n  private static instance: LoggerMiddleware;\n  private logToFile: boolean;\n  private logFilePath: string;\n  private logLevel: string;\n\n  private constructor() {\n    this.logToFile = configService.get<boolean>('logging.toFile');\n    this.logFilePath = configService.get<string>('logging.filePath');\n    this.logLevel = configService.get<string>('logging.level');\n\n    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n    if (this.logToFile) {\n      this.ensureLogDirectory();\n    }\n\n    errorHandler.logInfo('üìä Logger Middleware –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', {\n      logToFile: this.logToFile,\n      logFilePath: this.logFilePath,\n      logLevel: this.logLevel,\n    });\n  }\n\n  public static getInstance(): LoggerMiddleware {\n    if (!LoggerMiddleware.instance) {\n      LoggerMiddleware.instance = new LoggerMiddleware();\n    }\n    return LoggerMiddleware.instance;\n  }\n\n  /**\n   * Middleware –¥–ª—è Telegraf\n   */\n  public middleware(): MiddlewareFn<Context> {\n    return async (ctx: Context, next: () => Promise<void>) => {\n      const startTime = Date.now();\n      const requestId = this.generateRequestId();\n\n      // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å\n      await this.logIncomingRequest(ctx, requestId);\n\n      try {\n        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π middleware\n        await next();\n        \n        // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n        const duration = Date.now() - startTime;\n        await this.logRequestCompletion(ctx, requestId, duration, 'success');\n      } catch (error) {\n        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É\n        const duration = Date.now() - startTime;\n        await this.logRequestCompletion(ctx, requestId, duration, 'error', error);\n        throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ\n      }\n    };\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å\n   */\n  private async logIncomingRequest(ctx: Context, requestId: string): Promise<void> {\n    const logData = {\n      requestId,\n      timestamp: new Date().toISOString(),\n      type: 'incoming_request',\n      user: {\n        id: ctx.from?.id,\n        username: ctx.from?.username,\n        firstName: ctx.from?.first_name,\n        lastName: ctx.from?.last_name,\n        languageCode: ctx.from?.language_code,\n        isBot: ctx.from?.is_bot,\n      },\n      chat: {\n        id: ctx.chat?.id,\n        type: ctx.chat?.type,\n      },\n      message: this.extractMessageInfo(ctx),\n      session: this.extractSessionInfo(ctx),\n    };\n\n    await this.writeLog('info', 'Incoming request', logData);\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞\n   */\n  private async logRequestCompletion(\n    ctx: Context,\n    requestId: string,\n    duration: number,\n    status: 'success' | 'error',\n    error?: any\n  ): Promise<void> {\n    const logData = {\n      requestId,\n      timestamp: new Date().toISOString(),\n      type: 'request_completion',\n      status,\n      duration,\n      userId: ctx.from?.id,\n      chatId: ctx.chat?.id,\n      error: error ? {\n        message: error.message,\n        stack: error.stack,\n        name: error.name,\n      } : undefined,\n    };\n\n    const level = status === 'error' ? 'error' : 'info';\n    const message = status === 'error' \n      ? `Request failed (${duration}ms)` \n      : `Request completed (${duration}ms)`;\n\n    await this.writeLog(level, message, logData);\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  public async logUserAction(\n    ctx: Context,\n    action: string,\n    details?: any\n  ): Promise<void>;\n  public async logUserAction(\n    userId: number,\n    action: string,\n    details?: any\n  ): Promise<void>;\n  public async logUserAction(\n    ctxOrUserId: Context | number,\n    action: string,\n    details?: any\n  ): Promise<void> {\n    let logData: any;\n    \n    if (typeof ctxOrUserId === 'number') {\n      // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω userId\n      logData = {\n        timestamp: new Date().toISOString(),\n        type: 'user_action',\n        action,\n        user: {\n          id: ctxOrUserId,\n        },\n        details,\n      };\n    } else {\n      // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω Context\n      logData = {\n        timestamp: new Date().toISOString(),\n        type: 'user_action',\n        action,\n        user: {\n          id: ctxOrUserId.from?.id,\n          username: ctxOrUserId.from?.username,\n        },\n        chat: {\n          id: ctxOrUserId.chat?.id,\n          type: ctxOrUserId.chat?.type,\n        },\n        details,\n      };\n    }\n\n    await this.writeLog('info', `User action: ${action}`, logData);\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ\n   */\n  public async logSystemEvent(\n    event: string,\n    details?: any,\n    level: 'debug' | 'info' | 'warn' | 'error' = 'info'\n  ): Promise<void> {\n    const logData = {\n      timestamp: new Date().toISOString(),\n      type: 'system_event',\n      event,\n      details,\n    };\n\n    await this.writeLog(level, `System event: ${event}`, logData);\n  }\n\n  /**\n   * –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n   */\n  public async logPerformance(\n    operation: string,\n    duration: number,\n    details?: any\n  ): Promise<void> {\n    const logData = {\n      timestamp: new Date().toISOString(),\n      type: 'performance',\n      operation,\n      duration,\n      details,\n    };\n\n    const level = duration > 5000 ? 'warn' : 'debug';\n    await this.writeLog(level, `Performance: ${operation} (${duration}ms)`, logData);\n  }\n\n  /**\n   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏\n   */\n  private extractMessageInfo(ctx: Context): any {\n    if (!ctx.message && !ctx.callbackQuery) {\n      return null;\n    }\n\n    if (ctx.callbackQuery) {\n      return {\n        type: 'callback_query',\n        data: (ctx.callbackQuery as any).data,\n        messageId: (ctx.callbackQuery as any).message?.message_id,\n      };\n    }\n\n    const message = ctx.message as any;\n    return {\n      type: 'message',\n      messageId: message?.message_id,\n      text: message?.text,\n      command: this.extractCommand(message?.text),\n      hasPhoto: !!message?.photo,\n      hasDocument: !!message?.document,\n      hasVideo: !!message?.video,\n      hasAudio: !!message?.audio,\n      hasSticker: !!message?.sticker,\n      hasAnimation: !!message?.animation,\n    };\n  }\n\n  /**\n   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n   */\n  private extractCommand(text?: string): string | null {\n    if (!text || !text.startsWith('/')) {\n      return null;\n    }\n    return text.split(' ')[0];\n  }\n\n  /**\n   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏\n   */\n  private extractSessionInfo(ctx: Context): any {\n    const session = (ctx as any).session;\n    if (!session) {\n      return null;\n    }\n\n    return {\n      language: session.language,\n      isSubscribed: session.isSubscribed,\n      currentSlide: session.currentSlide,\n      slideshowActive: session.slideshowActive,\n      // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n    };\n  }\n\n  /**\n   * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥\n   */\n  private async writeLog(\n    level: 'debug' | 'info' | 'warn' | 'error',\n    message: string,\n    data?: any\n  ): Promise<void> {\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\n    if (!this.shouldLog(level)) {\n      return;\n    }\n\n    const logEntry = {\n      timestamp: new Date().toISOString(),\n      level: level.toUpperCase(),\n      message,\n      data,\n    };\n\n    // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å\n    if (!this.logToFile) {\n      this.logToConsole(level, logEntry);\n    }\n\n    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n    if (this.logToFile) {\n      await this.logToFileSystem(logEntry);\n    }\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è\n   */\n  private shouldLog(level: 'debug' | 'info' | 'warn' | 'error'): boolean {\n    const levels = ['debug', 'info', 'warn', 'error'];\n    const currentLevelIndex = levels.indexOf(this.logLevel);\n    const messageLevelIndex = levels.indexOf(level);\n    \n    return messageLevelIndex >= currentLevelIndex;\n  }\n\n  /**\n   * –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å\n   */\n  private logToConsole(level: string, logEntry: any): void {\n    const emoji = {\n      DEBUG: 'üêõ',\n      INFO: '‚ÑπÔ∏è',\n      WARN: '‚ö†Ô∏è',\n      ERROR: '‚ùå',\n    };\n\n    const logMessage = `${emoji[level as keyof typeof emoji]} [${logEntry.timestamp}] ${logEntry.message}`;\n    \n    switch (level) {\n      case 'debug':\n        console.debug(logMessage, logEntry.data);\n        break;\n      case 'info':\n        console.log(logMessage, logEntry.data);\n        break;\n      case 'warn':\n        console.warn(logMessage, logEntry.data);\n        break;\n      case 'error':\n        console.error(logMessage, logEntry.data);\n        break;\n    }\n  }\n\n  /**\n   * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥ –≤ —Ñ–∞–π–ª\n   */\n  private async logToFileSystem(logEntry: any): Promise<void> {\n    try {\n      const logLine = JSON.stringify(logEntry) + '\\n';\n      await fs.promises.appendFile(this.logFilePath, logLine, 'utf8');\n    } catch (error) {\n      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –ª–æ–≥ –≤ —Ñ–∞–π–ª:', error);\n    }\n  }\n\n  /**\n   * –°–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤\n   */\n  private ensureLogDirectory(): void {\n    try {\n      const logDir = path.dirname(this.logFilePath);\n      if (!fs.existsSync(logDir)) {\n        fs.mkdirSync(logDir, { recursive: true });\n        console.log(`üìÅ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤: ${logDir}`);\n      }\n    } catch (error) {\n      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤:', error);\n    }\n  }\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞\n   */\n  private generateRequestId(): string {\n    return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\n   */\n  public async getLogStats(): Promise<{\n    logFileExists: boolean;\n    logFileSize: number;\n    logLevel: string;\n    logToFile: boolean;\n  }> {\n    let logFileExists = false;\n    let logFileSize = 0;\n\n    if (this.logToFile) {\n      try {\n        const stats = await fs.promises.stat(this.logFilePath);\n        logFileExists = true;\n        logFileSize = stats.size;\n      } catch (error) {\n        // –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n      }\n    }\n\n    return {\n      logFileExists,\n      logFileSize,\n      logLevel: this.logLevel,\n      logToFile: this.logToFile,\n    };\n  }\n\n  /**\n   * –û—á–∏—â–∞–µ—Ç –ª–æ–≥-—Ñ–∞–π–ª\n   */\n  public async clearLogFile(): Promise<void> {\n    if (this.logToFile) {\n      try {\n        await fs.promises.writeFile(this.logFilePath, '', 'utf8');\n        console.log('üßπ –õ–æ–≥-—Ñ–∞–π–ª –æ—á–∏—â–µ–Ω');\n      } catch (error) {\n        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥-—Ñ–∞–π–ª:', error);\n      }\n    }\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–Ω–≥–ª—Ç–æ–Ω –∏ middleware\nexport const loggerMiddleware = LoggerMiddleware.getInstance();\nexport const loggingMiddleware = loggerMiddleware.middleware();","size_bytes":11726},"client/src/pages/Profile.tsx":{"content":"import { ChevronRight, Copy, Gem } from \"lucide-react\";\nimport type { AppDispatch, RootState } from \"../store/store\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useNavigate } from \"react-router-dom\";\nimport { useEffect, useState } from \"react\";\nimport { fetchReferralsCountByReferId } from \"../store/features/referralsSlice.ts\";\nimport { fetchTransactionsByReferId } from \"../store/features/transactionsSlice.ts\";\nimport {useTranslation} from \"react-i18next\";\n\nconst Profile = () => {\n  const navigate = useNavigate();\n  const dispatch = useDispatch<AppDispatch>();\n\n  const {t} = useTranslation();\n\n  const [showCopyTooltip, setShowCopyTooltip] = useState(false);\n\n  const user = useSelector((state: RootState) => state.user.user);\n   const transactionsCount = useSelector((state: RootState) => state.transactions.transactions.length);\n  const referralsCount = useSelector((state: RootState) => state.referrals.referralsCount);\n\n  useEffect(() => {\n    if (!user?._id) return;\n\n    dispatch(fetchTransactionsByReferId());\n    dispatch(fetchReferralsCountByReferId());\n  }, [dispatch, user?._id]);\n\n  const referralLink = `https://t.me/TipTop999_bot?start=${user?._id || \"\"}`;\n\n  const copyToClipboard = async (text: string) => {\n    await navigator.clipboard.writeText(text);\n    setShowCopyTooltip(true);\n    setTimeout(() => setShowCopyTooltip(false), 2000);\n  };\n\n  if (!user) return null;\n\n  return (\n    <div className=\"flex flex-col max-w-[28rem] w-full h-full overflow-y-auto py-3 px-2\">\n      {/* User Info Section */}\n      <div className=\"flex gap-4 justify-between items-end w-full text-[14px] box-border rounded-lg bg-[#1a1b1e] border  border-[#27282C]\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"flex items-center w-[75px] h-[75px]\">\n            <img className=\"h-full w-full rounded-lg\" src={user.avatarUrl || \"\"} alt=\"profile photo\" />\n          </div>\n          <div className=\"flex flex-col items-start gap-0\">\n            <span className=\"text-white\">{user.username}</span>\n            <span className=\"text-[#979EAA]\">ID: {user._id}</span>\n            <span className=\"flex items-center gap-1\">\n              <span className=\"text-[#b9f2ff]\">{user.referralPercent}% - </span>\n              {Array.from({ length: user.referralPercent || 0 }, (_, i) => (\n                <Gem key={i} className=\"text-[#b9f2ff]\" size={18} />\n              ))}\n            </span>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <button onClick={() => navigate(\"/referral-info\")} className=\"flex items-center gap-2 bg-[#252629] rounded-lg px-2 py-1 mb-1.5 mr-1.5 border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\">\n            <span className=\"text-[#8F96A3]\">{t('profile.detailsBtn')}</span>\n            <ChevronRight className=\"w-[18px] h-[18px] text-[#8F96A3]\" />\n          </button>\n        </div>\n      </div>\n\n      {/*shadow-[0_0_10px_rgba(0,163,255,0.3)]*/}\n\n      {/* Text */}\n      <div className=\"space-y-6 mb-2 bg-[#1a1b1e] border border-[#27282C] rounded-lg p-2 mt-2\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-8 h-8 flex items-center justify-center\">\n            <img\n              src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–†–∞–∫–µ—Ç–∞-4uqIvLXI9GOpvgCowfLDs6BxX71mJK.gif\"\n              alt=\"Rocket\"\n              className=\"w-7 h-7\"\n            />\n          </div>\n          <p className=\"text-[#8F96A3] text-[15px] text-base max-[350px]:text-sm flex-1\">\n            {t('profile.desc')}\n          </p>\n        </div>\n      </div>\n\n      {/* Link */}\n      <div className=\"mb-2 p-2 rounded-lg bg-[#1a1b1e] border border-[#27282C]\">\n        <div className=\"flex items-center gap-2 mb-2\">\n          <img\n            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–°–∫—Ä–µ–ø–∫–∞-rQgbCH2HgqS5Yg1bMkjeqq89xyyPTz.gif\"\n            alt=\"Link\"\n            className=\"w-5 h-5\"\n          />\n          <h2 className=\"text-[#8F96A3] text-sm\">{t('profile.linkText')}</h2>\n        </div>\n        <div className=\"flex flex-nowrap items-center gap-2 relative\">\n          <div className=\"bg-[#252629] flex-1 p-2 rounded-lg\">\n            <div className=\"text-[#8F96A3] text-[12px] truncate whitespace-break-spaces\">\n              {referralLink}\n            </div>\n          </div>\n          <button\n            onClick={() => copyToClipboard(referralLink)}\n            className=\"h-8 w-8 bg-[#252629] rounded-lg flex items-center justify-center relative border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          >\n            <Copy className=\"h-4 w-4 text-[#8F96A3]\" />\n            {showCopyTooltip && (\n              <div className=\"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-[#252629] rounded text-xs whitespace-nowrap\">\n                –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!\n              </div>\n            )}\n          </button>\n        </div>\n      </div>\n\n      {/* Balance */}\n      <div className=\"flex items-center justify-between mb-2 p-2 rounded-lg bg-[#1a1b1e] border border-[#27282C]\">\n        <div className=\"flex items-center gap-3\">\n          <img\n            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–ë–∞–ª–∞–Ω—Å-qapBAab88WemJOjXjXkYQE04Qi7oan.gif\"\n            alt=\"Balance\"\n            className=\"w-7 h-7\"\n          />\n          <div>\n            <div className=\"text-[#8F96A3] text-sm\">{t('profile.balance')}</div>\n            <div className=\"text-xl font-bold text-white\">{user?.balanceUSDT + \"$\"}</div>\n          </div>\n        </div>\n        <button\n          className=\"bg-[#252629] text-[#8F96A3] max-[350px]:text-sm rounded-lg px-4 py-2 border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => navigate('/withdrawals')}\n        >\n          {t('profile.withdrawalBtn')}\n        </button>\n      </div>\n\n      {/* Statistics Section */}\n      <div className=\"space-y-2 rounded-lg p-2 bg-[#1a1b1e] border border-[#27282C]\">\n        <button\n          className=\"w-full bg-[#252629] text-[#fff] mb-4 text-lg max-[350px]:text-base rounded-lg px-4 py-2 flex items-center justify-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)] cursor-pointer\"\n          onClick={() => navigate('/statistics')}\n        >\n          <img\n            src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞-YhivudarfVdH5nrWjCGb22Dzi0bV69.gif\"\n            alt=\"Statistics\"\n            className=\"w-7 h-7 mr-2\"\n          />\n          <span className=\"text-shadow-[0_0_5px_rgba(0,163,255,0.5)] transition-all duration-300 hover:text-shadow-[0_0_10px_rgba(0,163,255,0.7)] text-white\">\n            {t('profile.statisticsBtn')}\n          </span>\n        </button>\n        <div className=\"grid grid-cols-3 gap-2\">\n          <div className=\"bg-[#252629] p-3 rounded-lg text-center flex flex-col items-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]\">\n            <div className=\"text-lg font-bold flex items-center justify-center gap-3 text-white mb-1\">\n              <img\n                src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–õ—é–¥–∏-r51OhufSUCgXxG5rZX5E7K5d5TpfAB.gif\"\n                alt=\"Referrals\"\n                className=\"w-7 h-7\"\n              />\n              <span>{referralsCount}</span>\n            </div>\n            <div className=\"text-[13px] text-[#8F96A3]\">{t('profile.referrals')}</div>\n          </div>\n          <div className=\"bg-[#252629] p-3 rounded-lg text-center flex flex-col items-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]\">\n            <div className=\"text-lg font-bold flex items-center justify-center gap-3 text-white mb-1\">\n              <img\n                src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–ü–æ–∫—É–ø–æ–∫-WRzItxdECelB09wDBDbapS7JN4nqAR.gif\"\n                alt=\"Purchases\"\n                className=\"w-7 h-7\"\n              />\n              <span>{transactionsCount}</span>\n            </div>\n            <div className=\"text-[13px] text-[#8F96A3]\">{t('profile.purchases')}</div>\n          </div>\n          <div className=\"bg-[#252629] p-3 rounded-lg text-center flex flex-col items-center border border-[#00CCCC33] shadow-[0_0_10px_rgba(0,204,204,0.2)]\">\n            <div className=\"text-lg font-bold flex items-center justify-center gap-3 text-white mb-1\">\n              <img\n                src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/–î–æ—Ö–æ–¥-Wj6IqY7LjQWdgWAiYijUlRNkY32Sxp.gif\"\n                alt=\"Income\"\n                className=\"w-7 h-7\"\n              />\n              <span>{(user?.balanceUSDT ?? 0) > 0 ? (user?.balanceUSDT ?? 0).toFixed(1) : '0'}</span>\n            </div>\n            <div className=\"text-[13px] text-[#8F96A3]\">{t('profile.income')}</div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Profile;\n","size_bytes":8942},"README.md":{"content":"","size_bytes":0},"bot/src/middleware/rateLimiter.ts":{"content":"import { Context, MiddlewareFn } from 'telegraf';\nimport { configService } from '../config/config.service';\nimport { errorHandler } from '../utils/errorHandler';\nimport { localization } from '../config/localization';\n\n/**\n * üõ°Ô∏è Rate Limiter –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞\n * –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n */\nexport class RateLimiter {\n  private static instance: RateLimiter;\n  private userRequests: Map<number, { count: number; resetTime: number }> = new Map();\n  private readonly maxRequests: number;\n  private readonly windowMs: number;\n  private cleanupInterval: NodeJS.Timeout;\n\n  private constructor() {\n    this.maxRequests = configService.get<number>('security.rateLimitMaxRequests');\n    this.windowMs = configService.get<number>('security.rateLimitWindowMs');\n    \n    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π\n    this.cleanupInterval = setInterval(() => {\n      this.cleanup();\n    }, this.windowMs);\n\n    errorHandler.logInfo('üõ°Ô∏è Rate Limiter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', {\n      maxRequests: this.maxRequests,\n      windowMs: this.windowMs,\n    });\n  }\n\n  public static getInstance(): RateLimiter {\n    if (!RateLimiter.instance) {\n      RateLimiter.instance = new RateLimiter();\n    }\n    return RateLimiter.instance;\n  }\n\n  /**\n   * Middleware –¥–ª—è Telegraf\n   */\n  public middleware(): MiddlewareFn<Context> {\n    return async (ctx: Context, next: () => Promise<void>) => {\n      const userId = ctx.from?.id;\n      \n      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ\n      if (!userId) {\n        return next();\n      }\n\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç\n      if (await this.isRateLimited(userId, ctx)) {\n        return; // –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n      }\n\n      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n      return next();\n    };\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  private async isRateLimited(userId: number, ctx: Context): Promise<boolean> {\n    const now = Date.now();\n    const userRecord = this.userRequests.get(userId);\n\n    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç –∏–ª–∏ –æ–∫–Ω–æ —Å–±—Ä–æ—à–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é\n    if (!userRecord || now > userRecord.resetTime) {\n      this.userRequests.set(userId, {\n        count: 1,\n        resetTime: now + this.windowMs,\n      });\n      return false;\n    }\n\n    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫\n    userRecord.count++;\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç\n    if (userRecord.count > this.maxRequests) {\n      await this.handleRateLimitExceeded(userId, ctx, userRecord.count);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤\n   */\n  private async handleRateLimitExceeded(\n    userId: number,\n    ctx: Context,\n    requestCount: number\n  ): Promise<void> {\n    const userLang = (ctx as any).session?.language || 'ru';\n    const timeLeft = Math.ceil((this.userRequests.get(userId)?.resetTime || 0 - Date.now()) / 1000);\n\n    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞\n    errorHandler.logWarning('üõ°Ô∏è Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω', {\n      userId,\n      username: ctx.from?.username,\n      requestCount,\n      maxRequests: this.maxRequests,\n      timeLeft,\n    });\n\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n    try {\n      const rateLimitMessage = this.getRateLimitMessage(userLang, timeLeft);\n      await ctx.reply(rateLimitMessage);\n    } catch (error) {\n      errorHandler.logWarning('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ rate limit', error);\n    }\n\n    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç, —É–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n    if (requestCount > this.maxRequests * 3) {\n      try {\n        const adminMessage = \n          `üö® –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨\\n\\n` +\n          `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId} (@${ctx.from?.username})\\n` +\n          `üìä –ó–∞–ø—Ä–æ—Å–æ–≤: ${requestCount}/${this.maxRequests}\\n` +\n          `üïê –ó–∞ –ø–µ—Ä–∏–æ–¥: ${this.windowMs / 1000}—Å\\n` +\n          `‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–π —Å–ø–∞–º –∏–ª–∏ –∞—Ç–∞–∫–∞`;\n\n        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É\n        errorHandler.logWarning('üö® –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞', {\n          userId,\n          username: ctx.from?.username,\n          requestCount,\n          maxRequests: this.maxRequests,\n        });\n      } catch (error) {\n        errorHandler.logWarning('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', error);\n      }\n    }\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ\n   */\n  private getRateLimitMessage(language: string, timeLeft: number): string {\n    const messages = {\n      ru: `üõ°Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤!\\n\\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ ${timeLeft} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º.\\n\\nüí° –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.`,\n      en: `üõ°Ô∏è Too many requests!\\n\\nPlease wait ${timeLeft} seconds before the next action.\\n\\nüí° This is spam protection for stable bot operation.`,\n    };\n\n    return messages[language as keyof typeof messages] || messages.ru;\n  }\n\n  /**\n   * –û—á–∏—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏\n   */\n  private cleanup(): void {\n    const now = Date.now();\n    let cleanedCount = 0;\n\n    for (const [userId, record] of this.userRequests.entries()) {\n      if (now > record.resetTime) {\n        this.userRequests.delete(userId);\n        cleanedCount++;\n      }\n    }\n\n    if (cleanedCount > 0) {\n      errorHandler.logDebug('üßπ Rate limiter cleanup', {\n        cleanedRecords: cleanedCount,\n        remainingRecords: this.userRequests.size,\n      });\n    }\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É rate limiter\n   */\n  public getStats(): {\n    activeUsers: number;\n    maxRequests: number;\n    windowMs: number;\n    topUsers: Array<{ userId: number; requests: number }>;\n  } {\n    const topUsers = Array.from(this.userRequests.entries())\n      .map(([userId, record]) => ({ userId, requests: record.count }))\n      .sort((a, b) => b.requests - a.requests)\n      .slice(0, 10);\n\n    return {\n      activeUsers: this.userRequests.size,\n      maxRequests: this.maxRequests,\n      windowMs: this.windowMs,\n      topUsers,\n    };\n  }\n\n  /**\n   * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n   */\n  public resetUserLimit(userId: number): boolean {\n    const deleted = this.userRequests.delete(userId);\n    if (deleted) {\n      errorHandler.logInfo('üîÑ Rate limit —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', { userId });\n    }\n    return deleted;\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n   */\n  public isUserBlocked(userId: number): boolean {\n    const userRecord = this.userRequests.get(userId);\n    if (!userRecord) return false;\n\n    const now = Date.now();\n    return userRecord.count > this.maxRequests && now <= userRecord.resetTime;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n   */\n  public getUserLimitInfo(userId: number): {\n    requests: number;\n    maxRequests: number;\n    resetTime: number;\n    timeLeft: number;\n    isBlocked: boolean;\n  } | null {\n    const userRecord = this.userRequests.get(userId);\n    if (!userRecord) {\n      return {\n        requests: 0,\n        maxRequests: this.maxRequests,\n        resetTime: 0,\n        timeLeft: 0,\n        isBlocked: false,\n      };\n    }\n\n    const now = Date.now();\n    const timeLeft = Math.max(0, userRecord.resetTime - now);\n    const isBlocked = userRecord.count > this.maxRequests && timeLeft > 0;\n\n    return {\n      requests: userRecord.count,\n      maxRequests: this.maxRequests,\n      resetTime: userRecord.resetTime,\n      timeLeft: Math.ceil(timeLeft / 1000),\n      isBlocked,\n    };\n  }\n\n  /**\n   * –£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç rate limiter –∏ –æ—á–∏—â–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã\n   */\n  public destroy(): void {\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval);\n    }\n    this.userRequests.clear();\n    errorHandler.logInfo('üõ°Ô∏è Rate Limiter —É–Ω–∏—á—Ç–æ–∂–µ–Ω');\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–Ω–≥–ª—Ç–æ–Ω –∏ middleware\nexport const rateLimiter = RateLimiter.getInstance();\nexport const rateLimitMiddleware = rateLimiter.middleware();","size_bytes":8888},"server/src/controllers/gameController.ts":{"content":"import { Request, Response } from 'express';\n// MONGO BACKUP: import Game from '../models/Game';\nimport { logger } from '../config/logger';\nimport { prisma } from '../db/client';\nimport { gameRepository } from '../db';\n\n// -> User\n\n// Get all games\nexport const getGames = async (req: Request, res: Response) => {\n  try {\n    logger.info('Fetching all games');\n    // MONGO BACKUP: const games = await Game.find();\n    const games = await gameRepository.findAll();\n    logger.info('Games fetched successfully', { context: { count: games.length } });\n    res.json(games);\n  } catch (error) {\n    logger.error('Error fetching games', { context: { error } });\n    res.status(500).json({ error: 'Error fetching games' });\n  }\n};\n\n// Get active games\nexport const getActiveGames = async (req: Request, res: Response) => {\n  try {\n    logger.info('Fetching active games');\n    // MONGO BACKUP: const games = await Game.find({ isActive: true });\n    const games = await prisma.game.findMany({\n      where: { isEnabled: true, isActual: true },\n      include: { offers: true },\n      orderBy: { createdAt: 'desc' }\n    });\n    logger.info('Active games fetched', { context: { count: games.length } });\n    res.json(games);\n  } catch (error) {\n    logger.error('Error fetching active games', { context: { error } });\n    res.status(500).json({ error: 'Error fetching active games' });\n  }\n};\n\n// Get games with discounts\nexport const getDiscountedGames = async (req: Request, res: Response) => {\n  try {\n    logger.info('Fetching discounted games');\n    // MONGO BACKUP: const games = await Game.find({ hasDiscount: true });\n    const games = await gameRepository.findWithDiscount();\n    logger.info('Discounted games fetched', { context: { count: games.length } });\n    res.json(games);\n  } catch (error) {\n    logger.error('Error fetching discounted games', { context: { error } });\n    res.status(500).json({ error: 'Error fetching discounted games' });\n  }\n};\n\n// Search games\nexport const searchGames = async (req: Request, res: Response) => {\n  try {\n    const { query } = req.query;\n    logger.info('Searching games', { context: { query } });\n    // MONGO BACKUP: const games = await Game.find({\n    // MONGO BACKUP:   $or: [{ title: { $regex: query, $options: 'i' } }],\n    // MONGO BACKUP: });\n    const games = await prisma.game.findMany({\n      where: {\n        title: {\n          contains: query as string,\n          mode: 'insensitive'\n        }\n      },\n      include: { offers: true }\n    });\n    logger.info('Games search completed', { context: { query, count: games.length } });\n    res.json(games);\n  } catch (error) {\n    logger.error('Error searching games', { context: { error } });\n    res.status(500).json({ error: 'Error searching games' });\n  }\n};\n\n// Get game by ID\nexport const getGameById = async (req: Request, res: Response) => {\n  try {\n    const { id } = req.params;\n    logger.info('Fetching game by ID', { context: { gameId: id } });\n    // MONGO BACKUP: const game = await Game.findById(id);\n    const game = await gameRepository.findById(parseInt(id));\n    if (!game) {\n      logger.warn('Game not found', { context: { gameId: id } });\n      return res.status(404).json({ error: 'Game not found' });\n    }\n    logger.info('Game fetched successfully', { context: { gameId: game.id } });\n    res.json(game);\n  } catch (error) {\n    logger.error('Error fetching game by ID', { context: { error } });\n    res.status(500).json({ error: 'Error fetching game' });\n  }\n};\n\n// -> Admin\n\n// Create a new game\nexport const createGame = async (req: Request, res: Response) => {\n  try {\n    logger.info('Creating a new game', { context: { body: req.body } });\n\n    // Validate request body\n    if (!req.body.title || !req.body.imageUrl || !req.body.gifUrl || !req.body.appleStoreUrl || !req.body.googlePlayUrl || !req.body.trailerUrl) {\n      logger.warn('Invalid request body', { context: { body: req.body } });\n      return res.status(400).json({ error: 'Invalid request body' });\n    }\n\n    // Get the allowed fields from the Game schema\n    const allowedFields = Object.keys({\"title\": null, \"imageUrl\": null, \"gifUrl\": null, \"appleStoreUrl\": null, \"googlePlayUrl\": null, \"trailerUrl\": null, \"hasDiscount\": null, \"isActual\": null, \"isEnabled\": null});\n\n    // Get the fields from the request body\n    const requestFields = Object.keys(req.body);\n\n    // Find fields in req.body that are not in the Game schema\n    const invalidFields = requestFields.filter((field) => !allowedFields.includes(field));\n    if (invalidFields.length > 0) {\n      logger.warn('Invalid fields in request body', { context: { invalidFields } });\n      return res.status(400).json({ error: `Invalid fields: ${invalidFields.join(', ')}` });\n    }\n\n    // MONGO BACKUP: const existingGame = await Game.findOne({ title: req.body.title });\n    const existingGame = await prisma.game.findFirst({\n      where: { title: req.body.title }\n    });\n    if (existingGame) {\n      logger.warn('Game already exists', { context: { title: req.body.title } });\n      return res.status(400).json({ error: 'Game already exists' });\n    }\n\n    // MONGO BACKUP: const game = new Game(req.body);\n    // MONGO BACKUP: await game.save();\n    const game = await gameRepository.create(req.body);\n    logger.info('Game created successfully', { context: { gameId: game.id } });\n    res.status(201).json(game);\n  } catch (error) {\n    logger.error('Error creating game', { context: { error } });\n    res.status(400).json({ error: 'Error creating game' });\n  }\n};\n\n// Update game\nexport const updateGame = async (req: Request, res: Response) => {\n  try {\n    const { id } = req.params;\n    logger.info('Updating game', { context: { gameId: id, body: req.body } });\n    // MONGO BACKUP: const game = await Game.findByIdAndUpdate(id, req.body, { new: true });\n    const game = await gameRepository.update(parseInt(id), req.body);\n    if (!game) {\n      logger.warn('Game not found for update', { context: { gameId: id } });\n      return res.status(404).json({ error: 'Game not found' });\n    }\n    logger.info('Game updated successfully', { context: { gameId: game.id } });\n    res.json(game);\n  } catch (error) {\n    logger.error('Error updating game', { context: { error } });\n    res.status(400).json({ error: 'Error updating game' });\n  }\n};\n\n// Delete game\nexport const deleteGame = async (req: Request, res: Response) => {\n  try {\n    const { id } = req.params;\n    logger.info('Deleting game', { context: { gameId: id } });\n    // MONGO BACKUP: const game = await Game.findByIdAndDelete(id);\n    const game = await gameRepository.delete(parseInt(id));\n    if (!game) {\n      logger.warn('Game not found for deletion', { context: { gameId: id } });\n      return res.status(404).json({ error: 'Game not found' });\n    }\n    logger.info('Game deleted successfully', { context: { gameId: game.id } });\n    res.json({ message: 'Game deleted successfully' });\n  } catch (error) {\n    logger.error('Error deleting game', { context: { error } });\n    res.status(500).json({ error: 'Error deleting game' });\n  }\n};\n","size_bytes":7072},"admin/src/store/features/authSlice.ts":{"content":"import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';\nimport axiosInstance from '../../api/axiosInstance.ts';\nimport type {RootState} from \"../store.ts\";\n\ninterface AuthState {\n    token: string | null;\n    loading: boolean;\n    error: string | null;\n}\n\nconst initialState: AuthState = {\n    token: localStorage.getItem('adminToken'),\n    loading: false,\n    error: null,\n};\n\nexport const loginAdmin = createAsyncThunk(\n    'auth/loginAdmin',\n    async (credentials: { username: string; password: string }, { rejectWithValue }) => {\n        try {\n            const response = await axiosInstance.post('/admin/login', credentials);\n            localStorage.setItem('adminToken', response.data.token);\n            return response.data.token;\n        } catch {\n            return rejectWithValue('Invalid credentials');\n        }\n    }\n);\n\nexport const checkToken = createAsyncThunk(\n    'auth/checkToken',\n    async (_, { getState, rejectWithValue }) => {\n        const state = getState() as RootState;\n        const token = state.auth.token;\n        if (!token) return rejectWithValue('No token');\n\n        try {\n            await axiosInstance.get('/admin/protected', {\n                headers: { Authorization: `Bearer ${token}` },\n            });\n            return token;\n        } catch {\n            return rejectWithValue('Invalid token');\n        }\n    }\n);\n\nconst authSlice = createSlice({\n    name: 'auth',\n    initialState,\n    reducers: {\n        logout(state) {\n            state.token = null;\n            localStorage.removeItem('adminToken');\n        },\n    },\n    extraReducers: (builder) => {\n        builder\n            .addCase(loginAdmin.pending, (state) => {\n                state.loading = true;\n                state.error = null;\n            })\n            .addCase(loginAdmin.fulfilled, (state, action) => {\n                state.token = action.payload;\n                state.loading = false;\n            })\n            .addCase(loginAdmin.rejected, (state, action) => {\n                state.loading = false;\n                state.error = action.payload as string;\n            })\n            .addCase(checkToken.rejected, (state) => {\n                state.token = null;\n                localStorage.removeItem('adminToken');\n            });\n    },\n});\n\nexport const { logout } = authSlice.actions;\nexport default authSlice.reducer;\n","size_bytes":2370},"server/prisma/migrations/migration_lock.toml":{"content":"# Please do not edit this file manually\n# It should be added in your version-control system (e.g., Git)\nprovider = \"postgresql\"\n","size_bytes":128},"server/src/db/repositories/offer.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Prisma } from '../../../generated/prisma';\n\nexport class OfferRepository {\n  async findById(id: number) {\n    try {\n      const offer = await prisma.offer.findUnique({\n        where: { id },\n        include: { game: true },\n      });\n      if (!offer) {\n        throw new NotFoundError('Offer', id);\n      }\n      return offer;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find offer by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.offer.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: { game: true },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all offers', error);\n    }\n  }\n\n  async create(data: Prisma.OfferCreateInput) {\n    try {\n      return await prisma.offer.create({ data });\n    } catch (error) {\n      throw new DatabaseError('Failed to create offer', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.OfferUpdateInput) {\n    try {\n      return await prisma.offer.update({\n        where: { id },\n        data,\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update offer', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.offer.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete offer', error);\n    }\n  }\n\n  async findByGameId(gameId: number) {\n    try {\n      return await prisma.offer.findMany({\n        where: { gameId },\n        include: { game: true },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find offers by game id', error);\n    }\n  }\n\n  async findEnabled() {\n    try {\n      return await prisma.offer.findMany({\n        where: { isEnabled: true },\n        include: { game: true },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find enabled offers', error);\n    }\n  }\n\n  async findEnabledByGameId(gameId: number) {\n    try {\n      return await prisma.offer.findMany({\n        where: {\n          gameId,\n          isEnabled: true,\n        },\n        include: { game: true },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find enabled offers by game id', error);\n    }\n  }\n\n  async toggleEnabled(id: number) {\n    try {\n      const offer = await this.findById(id);\n      return await prisma.offer.update({\n        where: { id },\n        data: { isEnabled: !offer.isEnabled },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to toggle offer enabled status', error);\n    }\n  }\n\n  async updatePrices(id: number, priceRUB: number, priceUSDT: number) {\n    try {\n      return await prisma.offer.update({\n        where: { id },\n        data: {\n          priceRUB,\n          priceUSDT,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update offer prices', error);\n    }\n  }\n}\n\nexport const offerRepository = new OfferRepository();\n","size_bytes":3258},"server/src/db/repositories/payment.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { PaymentStatus, Prisma } from '../../../generated/prisma';\n\nexport class PaymentRepository {\n  async findById(id: number) {\n    try {\n      const payment = await prisma.payment.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n      if (!payment) {\n        throw new NotFoundError('Payment', id);\n      }\n      return payment;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find payment by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.payment.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all payments', error);\n    }\n  }\n\n  async create(data: Prisma.PaymentCreateInput) {\n    try {\n      return await prisma.payment.create({\n        data,\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create payment', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.PaymentUpdateInput) {\n    try {\n      return await prisma.payment.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update payment', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.payment.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete payment', error);\n    }\n  }\n\n  async findByExternalId(externalId: string) {\n    try {\n      return await prisma.payment.findUnique({\n        where: { externalId },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find payment by external id', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.payment.findMany({\n        where: { userId },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find payments by user id', error);\n    }\n  }\n\n  async findByStatus(status: PaymentStatus) {\n    try {\n      return await prisma.payment.findMany({\n        where: { status },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find payments by status', error);\n    }\n  }\n\n  async updateStatus(id: number, status: PaymentStatus) {\n    try {\n      return await prisma.payment.update({\n        where: { id },\n        data: { status },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update payment status', error);\n    }\n  }\n\n  async updateStatusByExternalId(externalId: string, status: PaymentStatus) {\n    try {\n      return await prisma.payment.update({\n        where: { externalId },\n        data: { status },\n        include: {\n          user: true,\n          order: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update payment status by external id', error);\n    }\n  }\n\n  async findPendingPayments() {\n    try {\n      return await prisma.payment.findMany({\n        where: { status: 'pending' },\n        orderBy: { createdAt: 'asc' },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find pending payments', error);\n    }\n  }\n\n  async countByStatus(status: PaymentStatus) {\n    try {\n      return await prisma.payment.count({\n        where: { status },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to count payments by status', error);\n    }\n  }\n}\n\nexport const paymentRepository = new PaymentRepository();\n","size_bytes":4714},"server/src/db/repositories/review.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Prisma } from '../../../generated/prisma';\n\nexport class ReviewRepository {\n  async findById(id: number) {\n    try {\n      const review = await prisma.review.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n      if (!review) {\n        throw new NotFoundError('Review', id);\n      }\n      return review;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find review by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.review.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all reviews', error);\n    }\n  }\n\n  async create(data: Prisma.ReviewCreateInput) {\n    try {\n      return await prisma.review.create({\n        data,\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create review', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.ReviewUpdateInput) {\n    try {\n      return await prisma.review.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update review', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.review.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete review', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.review.findMany({\n        where: { userId },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find reviews by user id', error);\n    }\n  }\n\n  async findByOrderId(orderId: number) {\n    try {\n      return await prisma.review.findUnique({\n        where: { orderId },\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find review by order id', error);\n    }\n  }\n\n  async findByRating(rating: number) {\n    try {\n      return await prisma.review.findMany({\n        where: { rating },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find reviews by rating', error);\n    }\n  }\n\n  async getAverageRating() {\n    try {\n      const result = await prisma.review.aggregate({\n        _avg: { rating: true },\n      });\n      return result._avg.rating || 0;\n    } catch (error) {\n      throw new DatabaseError('Failed to get average rating', error);\n    }\n  }\n\n  async countByRating(rating: number) {\n    try {\n      return await prisma.review.count({\n        where: { rating },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to count reviews by rating', error);\n    }\n  }\n\n  async getLatestReviews(limit: number = 10) {\n    try {\n      return await prisma.review.findMany({\n        take: limit,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          order: { include: { offer: { include: { game: true } } } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to get latest reviews', error);\n    }\n  }\n}\n\nexport const reviewRepository = new ReviewRepository();\n","size_bytes":4133},"server/src/db/repositories/referral.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Prisma } from '../../../generated/prisma';\n\nexport class ReferralRepository {\n  async findById(id: number) {\n    try {\n      const referral = await prisma.referral.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n      if (!referral) {\n        throw new NotFoundError('Referral', id);\n      }\n      return referral;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find referral by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.referral.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all referrals', error);\n    }\n  }\n\n  async create(data: Prisma.ReferralCreateInput) {\n    try {\n      return await prisma.referral.create({\n        data,\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create referral', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.ReferralUpdateInput) {\n    try {\n      return await prisma.referral.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update referral', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.referral.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete referral', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.referral.findUnique({\n        where: { userId },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find referral by user id', error);\n    }\n  }\n\n  async findByReferrerId(referId: number) {\n    try {\n      return await prisma.referral.findMany({\n        where: { referId },\n        include: {\n          user: true,\n          referrer: true,\n        },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find referrals by referrer id', error);\n    }\n  }\n\n  async countByReferrerId(referId: number) {\n    try {\n      return await prisma.referral.count({\n        where: { referId },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to count referrals by referrer id', error);\n    }\n  }\n\n  async getReferrerByUserId(userId: number) {\n    try {\n      const referral = await prisma.referral.findUnique({\n        where: { userId },\n        include: {\n          referrer: true,\n        },\n      });\n      return referral?.referrer || null;\n    } catch (error) {\n      throw new DatabaseError('Failed to get referrer by user id', error);\n    }\n  }\n\n  async createReferral(userId: number, referId: number) {\n    try {\n      return await prisma.referral.create({\n        data: {\n          user: { connect: { id: userId } },\n          referrer: { connect: { id: referId } },\n        },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create referral relationship', error);\n    }\n  }\n}\n\nexport const referralRepository = new ReferralRepository();\n","size_bytes":3678},"server/src/db/repositories/withdrawal.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { WithdrawalStatus, Currency, Prisma } from '../../../generated/prisma';\n\nexport class WithdrawalRepository {\n  async findById(id: number) {\n    try {\n      const withdrawal = await prisma.withdrawal.findUnique({\n        where: { id },\n        include: {\n          user: true,\n        },\n      });\n      if (!withdrawal) {\n        throw new NotFoundError('Withdrawal', id);\n      }\n      return withdrawal;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find withdrawal by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.withdrawal.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all withdrawals', error);\n    }\n  }\n\n  async create(data: Prisma.WithdrawalCreateInput) {\n    try {\n      return await prisma.withdrawal.create({\n        data,\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create withdrawal', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.WithdrawalUpdateInput) {\n    try {\n      return await prisma.withdrawal.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update withdrawal', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.withdrawal.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete withdrawal', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.withdrawal.findMany({\n        where: { userId },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find withdrawals by user id', error);\n    }\n  }\n\n  async findByStatus(status: WithdrawalStatus) {\n    try {\n      return await prisma.withdrawal.findMany({\n        where: { status },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find withdrawals by status', error);\n    }\n  }\n\n  async updateStatus(id: number, status: WithdrawalStatus) {\n    try {\n      return await prisma.withdrawal.update({\n        where: { id },\n        data: { status },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update withdrawal status', error);\n    }\n  }\n\n  async findPendingWithdrawals() {\n    try {\n      return await prisma.withdrawal.findMany({\n        where: { status: 'pending' },\n        orderBy: { createdAt: 'asc' },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find pending withdrawals', error);\n    }\n  }\n\n  async getTotalByUserId(userId: number, status?: WithdrawalStatus, currency?: Currency) {\n    try {\n      const where: any = { userId };\n      if (status) {\n        where.status = status;\n      }\n      if (currency) {\n        where.currency = currency;\n      }\n\n      const result = await prisma.withdrawal.aggregate({\n        where,\n        _sum: {\n          amount: true,\n        },\n      });\n\n      return result._sum.amount || 0;\n    } catch (error) {\n      throw new DatabaseError('Failed to get total withdrawals by user id', error);\n    }\n  }\n\n  async countByStatus(status: WithdrawalStatus) {\n    try {\n      return await prisma.withdrawal.count({\n        where: { status },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to count withdrawals by status', error);\n    }\n  }\n\n  async createWithdrawal(userId: number, amount: number, currency: Currency) {\n    try {\n      return await prisma.withdrawal.create({\n        data: {\n          user: { connect: { id: userId } },\n          amount,\n          currency,\n          status: 'pending',\n        },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create withdrawal request', error);\n    }\n  }\n\n  async approveWithdrawal(id: number) {\n    try {\n      return await this.updateStatus(id, 'completed');\n    } catch (error) {\n      throw new DatabaseError('Failed to approve withdrawal', error);\n    }\n  }\n\n  async rejectWithdrawal(id: number) {\n    try {\n      return await this.updateStatus(id, 'rejected');\n    } catch (error) {\n      throw new DatabaseError('Failed to reject withdrawal', error);\n    }\n  }\n}\n\nexport const withdrawalRepository = new WithdrawalRepository();\n","size_bytes":4883},"server/prisma/seed.ts":{"content":"import { PrismaClient } from '../generated/prisma';\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  console.log('üå± Seeding database...');\n\n  // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ! —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ)\n  console.log('üóëÔ∏è  Clearing existing data...');\n  await prisma.orderDetails.deleteMany();\n  await prisma.review.deleteMany();\n  await prisma.transaction.deleteMany();\n  await prisma.withdrawal.deleteMany();\n  await prisma.referral.deleteMany();\n  await prisma.payment.deleteMany();\n  await prisma.order.deleteMany();\n  await prisma.chat.deleteMany();\n  await prisma.offer.deleteMany();\n  await prisma.game.deleteMany();\n  await prisma.user.deleteMany();\n\n  // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n  console.log('üë§ Creating users...');\n  const users = await Promise.all([\n    prisma.user.create({\n      data: {\n        telegramId: BigInt(111111111), // Test Telegram ID 1\n        username: 'test_user_1',\n        language: 'ru',\n        balanceRUB: 1000,\n        balanceUSDT: 50,\n        isSubscribed: true,\n        acceptedPrivacyConsent: true,\n      },\n    }),\n    prisma.user.create({\n      data: {\n        telegramId: BigInt(222222222), // Test Telegram ID 2\n        username: 'test_user_2',\n        language: 'en',\n        balanceRUB: 500,\n        balanceUSDT: 25,\n        isSubscribed: false,\n        acceptedPrivacyConsent: true,\n      },\n    }),\n    prisma.user.create({\n      data: {\n        telegramId: BigInt(333333333), // Test Admin Telegram ID\n        username: 'admin_user',\n        language: 'ru',\n        balanceRUB: 10000,\n        balanceUSDT: 500,\n        isSubscribed: true,\n        acceptedPrivacyConsent: true,\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${users.length} users`);\n\n  // –°–æ–∑–¥–∞—ë–º –∏–≥—Ä—ã\n  console.log('üéÆ Creating games...');\n  const games = await Promise.all([\n    prisma.game.create({\n      data: {\n        title: 'Mobile Legends',\n        imageUrl: 'https://via.placeholder.com/800x400?text=Mobile+Legends',\n        gifUrl: 'https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif',\n        hasDiscount: true,\n        isActual: true,\n        isEnabled: true,\n        appleStoreUrl: 'https://apps.apple.com/app/mobile-legends',\n        googlePlayUrl: 'https://play.google.com/store/apps/details?id=com.mobile.legends',\n        trailerUrl: 'https://youtube.com/watch?v=example',\n      },\n    }),\n    prisma.game.create({\n      data: {\n        title: 'PUBG Mobile',\n        imageUrl: 'https://via.placeholder.com/800x400?text=PUBG+Mobile',\n        gifUrl: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif',\n        hasDiscount: false,\n        isActual: true,\n        isEnabled: true,\n        appleStoreUrl: 'https://apps.apple.com/app/pubg-mobile',\n        googlePlayUrl: 'https://play.google.com/store/apps/details?id=com.pubg.krmobile',\n        trailerUrl: 'https://youtube.com/watch?v=example2',\n      },\n    }),\n    prisma.game.create({\n      data: {\n        title: 'Genshin Impact',\n        imageUrl: 'https://via.placeholder.com/800x400?text=Genshin+Impact',\n        gifUrl: 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif',\n        hasDiscount: true,\n        isActual: true,\n        isEnabled: true,\n        appleStoreUrl: 'https://apps.apple.com/app/genshin-impact',\n        googlePlayUrl: 'https://play.google.com/store/apps/details?id=com.miHoYo.GenshinImpact',\n        trailerUrl: 'https://youtube.com/watch?v=example3',\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${games.length} games`);\n\n  // –°–æ–∑–¥–∞—ë–º –æ—Ñ—Ñ–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã\n  console.log('üíé Creating offers...');\n  const offers = [];\n  for (const game of games) {\n    const gameOffers = await Promise.all([\n      prisma.offer.create({\n        data: {\n          gameId: game.id,\n          title: `${game.title} - Starter Pack`,\n          imageUrl: `https://via.placeholder.com/400x200?text=${encodeURIComponent(game.title)}+Starter`,\n          priceRUB: 299,\n          priceUSDT: 3.5,\n          isEnabled: true,\n        },\n      }),\n      prisma.offer.create({\n        data: {\n          gameId: game.id,\n          title: `${game.title} - Premium Pack`,\n          imageUrl: `https://via.placeholder.com/400x200?text=${encodeURIComponent(game.title)}+Premium`,\n          priceRUB: 999,\n          priceUSDT: 11.5,\n          isEnabled: true,\n        },\n      }),\n      prisma.offer.create({\n        data: {\n          gameId: game.id,\n          title: `${game.title} - Ultimate Pack`,\n          imageUrl: `https://via.placeholder.com/400x200?text=${encodeURIComponent(game.title)}+Ultimate`,\n          priceRUB: 2999,\n          priceUSDT: 35,\n          isEnabled: true,\n        },\n      }),\n    ]);\n    offers.push(...gameOffers);\n  }\n\n  console.log(`‚úÖ Created ${offers.length} offers`);\n\n  // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã\n  console.log('üì¶ Creating orders...');\n  const orders = await Promise.all([\n    prisma.order.create({\n      data: {\n        userId: users[0].id,\n        offerId: offers[0].id,\n        paymentId: 1, // will update after payment creation\n        currency: 'USDT',\n        status: 'completed',\n      },\n    }),\n    prisma.order.create({\n      data: {\n        userId: users[0].id,\n        offerId: offers[1].id,\n        paymentId: 2, // will update after payment creation\n        currency: 'USDT',\n        status: 'pending',\n      },\n    }),\n    prisma.order.create({\n      data: {\n        userId: users[1].id,\n        offerId: offers[2].id,\n        paymentId: 3, // will update after payment creation\n        currency: 'RUB',\n        status: 'process',\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${orders.length} orders`);\n\n  // –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç–µ–∂–∏\n  console.log('üí≥ Creating payments...');\n  const payments = await Promise.all([\n    prisma.payment.create({\n      data: {\n        userId: users[0].id,\n        offerId: offers[0].id,\n        orderId: orders[0].id,\n        amountToPay: 3.5,\n        currency: 'USDT',\n        externalId: 'test_payment_1',\n        status: 'completed',\n      },\n    }),\n    prisma.payment.create({\n      data: {\n        userId: users[0].id,\n        offerId: offers[1].id,\n        orderId: orders[1].id,\n        amountToPay: 11.5,\n        currency: 'USDT',\n        externalId: 'test_payment_2',\n        status: 'pending',\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${payments.length} payments`);\n\n  // –°–æ–∑–¥–∞—ë–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤\n  console.log('ü§ù Creating referrals...');\n  const referrals = await Promise.all([\n    prisma.referral.create({\n      data: {\n        userId: users[1].id,\n        referId: users[0].id,\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${referrals.length} referrals`);\n\n  // –°–æ–∑–¥–∞—ë–º –æ—Ç–∑—ã–≤—ã\n  console.log('‚≠ê Creating reviews...');\n  const reviews = await Promise.all([\n    prisma.review.create({\n      data: {\n        userId: users[0].id,\n        orderId: orders[0].id,\n        username: users[0].username,\n        rating: 5,\n        comment: '–û—Ç–ª–∏—á–Ω–∞—è –∏–≥—Ä–∞! –†–µ–∫–æ–º–µ–Ω–¥—É—é!',\n      },\n    }),\n    prisma.review.create({\n      data: {\n        userId: users[1].id,\n        orderId: orders[2].id,\n        username: users[1].username,\n        rating: 4,\n        comment: 'Good game, but needs optimization',\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${reviews.length} reviews`);\n\n  // –°–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n  console.log('üí∞ Creating transactions...');\n  const transactions = await Promise.all([\n    prisma.transaction.create({\n      data: {\n        userId: users[0].id,\n        type: 'order',\n        amount: -3.5,\n        currency: 'USDT',\n      },\n    }),\n    prisma.transaction.create({\n      data: {\n        userId: users[0].id,\n        referId: users[1].id,\n        type: 'refund',\n        amount: 5,\n        currency: 'USDT',\n        earned: 5,\n      },\n    }),\n  ]);\n\n  console.log(`‚úÖ Created ${transactions.length} transactions`);\n\n  console.log('\\nüéâ Seeding completed successfully!');\n  console.log('\\nüìä Summary:');\n  console.log(`   - Users: ${users.length}`);\n  console.log(`   - Games: ${games.length}`);\n  console.log(`   - Offers: ${offers.length}`);\n  console.log(`   - Orders: ${orders.length}`);\n  console.log(`   - Payments: ${payments.length}`);\n  console.log(`   - Referrals: ${referrals.length}`);\n  console.log(`   - Reviews: ${reviews.length}`);\n  console.log(`   - Transactions: ${transactions.length}`);\n}\n\nmain()\n  .catch((e) => {\n    console.error('‚ùå Error seeding database:', e);\n    process.exit(1);\n  })\n  .finally(async () => {\n    await prisma.$disconnect();\n  });\n","size_bytes":8658},"server/src/db/repositories/order.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { OrderStatus, Prisma } from '../../../generated/prisma';\n\nexport class OrderRepository {\n  async findById(id: number) {\n    try {\n      const order = await prisma.order.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n          review: true,\n        },\n      });\n      if (!order) {\n        throw new NotFoundError('Order', id);\n      }\n      return order;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find order by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.order.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all orders', error);\n    }\n  }\n\n  async create(data: Prisma.OrderCreateInput) {\n    try {\n      return await prisma.order.create({\n        data,\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create order', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.OrderUpdateInput) {\n    try {\n      return await prisma.order.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update order', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.order.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete order', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.order.findMany({\n        where: { userId },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n          review: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find orders by user id', error);\n    }\n  }\n\n  async findByStatus(status: OrderStatus) {\n    try {\n      return await prisma.order.findMany({\n        where: { status },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find orders by status', error);\n    }\n  }\n\n  async updateStatus(id: number, status: OrderStatus) {\n    try {\n      return await prisma.order.update({\n        where: { id },\n        data: { status },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update order status', error);\n    }\n  }\n\n  async createWithDetails(\n    orderData: Prisma.OrderCreateInput,\n    detailsData: Omit<Prisma.OrderDetailsCreateInput, 'order'>\n  ) {\n    try {\n      return await prisma.order.create({\n        data: {\n          ...orderData,\n          orderDetails: {\n            create: detailsData,\n          },\n        },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n          orderDetails: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create order with details', error);\n    }\n  }\n\n  async updateDetails(orderId: number, detailsData: Prisma.OrderDetailsUpdateInput) {\n    try {\n      return await prisma.orderDetails.update({\n        where: { orderId },\n        data: detailsData,\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update order details', error);\n    }\n  }\n\n  async getDetails(orderId: number) {\n    try {\n      return await prisma.orderDetails.findUnique({\n        where: { orderId },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to get order details', error);\n    }\n  }\n\n  async findPendingOrders() {\n    try {\n      return await prisma.order.findMany({\n        where: { status: 'pending' },\n        orderBy: { createdAt: 'asc' },\n        include: {\n          user: true,\n          offer: { include: { game: true } },\n          payment: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find pending orders', error);\n    }\n  }\n\n  async countByStatus(status: OrderStatus) {\n    try {\n      return await prisma.order.count({\n        where: { status },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to count orders by status', error);\n    }\n  }\n}\n\nexport const orderRepository = new OrderRepository();\n","size_bytes":5255},"server/src/db/client.ts":{"content":"import { PrismaClient } from '../../generated/prisma';\nimport process from 'node:process';\n\nconst globalForPrisma = globalThis as unknown as { prisma: PrismaClient };\n\nexport const prisma = globalForPrisma.prisma || new PrismaClient({\n  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n});\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n","size_bytes":404},"server/src/db/index.ts":{"content":"import process from 'node:process';\n\nexport { prisma } from './client';\n\nexport {\n  DatabaseError,\n  NotFoundError,\n  ValidationError,\n} from './error';\n\nexport { userRepository, UserRepository } from './repositories/user';\nexport { gameRepository, GameRepository } from './repositories/game';\nexport { offerRepository, OfferRepository } from './repositories/offer';\nexport { orderRepository, OrderRepository } from './repositories/order';\nexport { paymentRepository, PaymentRepository } from './repositories/payment';\nexport { chatRepository, ChatRepository } from './repositories/chat';\nexport { reviewRepository, ReviewRepository } from './repositories/review';\nexport { referralRepository, ReferralRepository } from './repositories/referral';\nexport { transactionRepository, TransactionRepository } from './repositories/transaction';\nexport { withdrawalRepository, WithdrawalRepository } from './repositories/withdrawal';\n\nexport * from '../../generated/prisma';\n\n// Database selection switch - read from environment\nexport const USE_POSTGRES = process.env.USE_POSTGRES === 'true';\n\n// Connection helper\nexport async function connectDatabase() {\n  if (USE_POSTGRES) {\n    // Test Prisma connection\n    try {\n      await prisma.$connect();\n      console.log('‚úÖ PostgreSQL connected successfully via Prisma');\n      return true;\n    } catch (error) {\n      console.error('‚ùå Failed to connect to PostgreSQL:', error);\n      throw error;\n    }\n  } else {\n    console.warn('‚ö†Ô∏è  MongoDB is disabled. Set USE_POSTGRES=true to use PostgreSQL.');\n    return false;\n  }\n}\n\n// Disconnect helper\nexport async function disconnectDatabase() {\n  if (USE_POSTGRES) {\n    await prisma.$disconnect();\n  }\n}\n","size_bytes":1701},"server/src/db/repositories/chat.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Prisma } from '../../../generated/prisma';\n\nexport class ChatRepository {\n  async findById(id: number) {\n    try {\n      const chat = await prisma.chat.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          messages: {\n            orderBy: { timestamp: 'asc' },\n          },\n        },\n      });\n      if (!chat) {\n        throw new NotFoundError('Chat', id);\n      }\n      return chat;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find chat by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.chat.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { updatedAt: 'desc' },\n        include: {\n          user: true,\n          messages: {\n            orderBy: { timestamp: 'desc' },\n            take: 1,\n          },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all chats', error);\n    }\n  }\n\n  async create(data: Prisma.ChatCreateInput) {\n    try {\n      return await prisma.chat.create({\n        data,\n        include: {\n          user: true,\n          messages: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create chat', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.ChatUpdateInput) {\n    try {\n      return await prisma.chat.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          messages: {\n            orderBy: { timestamp: 'asc' },\n          },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update chat', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.chat.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete chat', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.chat.findUnique({\n        where: { userId },\n        include: {\n          user: true,\n          messages: {\n            orderBy: { timestamp: 'asc' },\n          },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find chat by user id', error);\n    }\n  }\n\n  async addMessage(chatId: number, messageData: Omit<Prisma.ChatMessageCreateInput, 'chat'>) {\n    try {\n      return await prisma.chatMessage.create({\n        data: {\n          ...messageData,\n          chat: { connect: { id: chatId } },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to add message to chat', error);\n    }\n  }\n\n  async getMessages(chatId: number, limit?: number, offset?: number) {\n    try {\n      return await prisma.chatMessage.findMany({\n        where: { chatId },\n        take: limit,\n        skip: offset,\n        orderBy: { timestamp: 'asc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to get chat messages', error);\n    }\n  }\n\n  async markAsReadByUser(chatId: number) {\n    try {\n      return await prisma.chat.update({\n        where: { id: chatId },\n        data: {\n          lastReadByUser: new Date(),\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to mark chat as read by user', error);\n    }\n  }\n\n  async markAsReadByAdmin(chatId: number) {\n    try {\n      return await prisma.chat.update({\n        where: { id: chatId },\n        data: {\n          lastReadByAdmin: new Date(),\n          unreadAdminCount: 0,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to mark chat as read by admin', error);\n    }\n  }\n\n  async incrementUnreadAdminCount(chatId: number) {\n    try {\n      return await prisma.chat.update({\n        where: { id: chatId },\n        data: {\n          unreadAdminCount: { increment: 1 },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to increment unread admin count', error);\n    }\n  }\n\n  async getUnreadChatsCount() {\n    try {\n      return await prisma.chat.count({\n        where: {\n          unreadAdminCount: { gt: 0 },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to get unread chats count', error);\n    }\n  }\n\n  async findOrCreate(userId: number) {\n    try {\n      let chat = await prisma.chat.findUnique({\n        where: { userId },\n        include: {\n          user: true,\n          messages: {\n            orderBy: { timestamp: 'asc' },\n          },\n        },\n      });\n\n      if (!chat) {\n        chat = await prisma.chat.create({\n          data: {\n            user: { connect: { id: userId } },\n          },\n          include: {\n            user: true,\n            messages: true,\n          },\n        });\n      }\n\n      return chat;\n    } catch (error) {\n      throw new DatabaseError('Failed to find or create chat', error);\n    }\n  }\n}\n\nexport const chatRepository = new ChatRepository();\n","size_bytes":5007},"server/src/db/repositories/transaction.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Currency, TransactionType, Prisma } from '../../../generated/prisma';\n\nexport class TransactionRepository {\n  async findById(id: number) {\n    try {\n      const transaction = await prisma.transaction.findUnique({\n        where: { id },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n      if (!transaction) {\n        throw new NotFoundError('Transaction', id);\n      }\n      return transaction;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find transaction by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.transaction.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all transactions', error);\n    }\n  }\n\n  async create(data: Prisma.TransactionCreateInput) {\n    try {\n      return await prisma.transaction.create({\n        data,\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create transaction', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.TransactionUpdateInput) {\n    try {\n      return await prisma.transaction.update({\n        where: { id },\n        data,\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update transaction', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.transaction.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete transaction', error);\n    }\n  }\n\n  async findByUserId(userId: number) {\n    try {\n      return await prisma.transaction.findMany({\n        where: { userId },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find transactions by user id', error);\n    }\n  }\n\n  async findByReferrerId(referId: number) {\n    try {\n      return await prisma.transaction.findMany({\n        where: { referId },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find transactions by referrer id', error);\n    }\n  }\n\n  async findByType(type: TransactionType) {\n    try {\n      return await prisma.transaction.findMany({\n        where: { type },\n        orderBy: { createdAt: 'desc' },\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find transactions by type', error);\n    }\n  }\n\n  async getTotalByUserId(userId: number, currency?: Currency) {\n    try {\n      const where: any = { userId };\n      if (currency) {\n        where.currency = currency;\n      }\n\n      const result = await prisma.transaction.aggregate({\n        where,\n        _sum: {\n          amount: true,\n          earned: true,\n        },\n      });\n\n      return {\n        totalAmount: result._sum.amount || 0,\n        totalEarned: result._sum.earned || 0,\n      };\n    } catch (error) {\n      throw new DatabaseError('Failed to get total transactions by user id', error);\n    }\n  }\n\n  async getTotalByReferrerId(referId: number, currency?: Currency) {\n    try {\n      const where: any = { referId };\n      if (currency) {\n        where.currency = currency;\n      }\n\n      const result = await prisma.transaction.aggregate({\n        where,\n        _sum: {\n          earned: true,\n        },\n      });\n\n      return result._sum.earned || 0;\n    } catch (error) {\n      throw new DatabaseError('Failed to get total earned by referrer id', error);\n    }\n  }\n\n  async createOrderTransaction(\n    userId: number,\n    referId: number | null,\n    amount: number,\n    currency: Currency,\n    earned?: number\n  ) {\n    try {\n      const data: Prisma.TransactionCreateInput = {\n        user: { connect: { id: userId } },\n        amount,\n        currency,\n        type: 'order',\n        earned: earned || null,\n      };\n\n      if (referId) {\n        data.referrer = { connect: { id: referId } };\n      }\n\n      return await prisma.transaction.create({\n        data,\n        include: {\n          user: true,\n          referrer: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create order transaction', error);\n    }\n  }\n\n  async createRefundTransaction(userId: number, amount: number, currency: Currency) {\n    try {\n      return await prisma.transaction.create({\n        data: {\n          user: { connect: { id: userId } },\n          amount,\n          currency,\n          type: 'refund',\n        },\n        include: {\n          user: true,\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to create refund transaction', error);\n    }\n  }\n}\n\nexport const transactionRepository = new TransactionRepository();\n","size_bytes":5278},"server/src/db/repositories/game.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Prisma } from '../../../generated/prisma';\n\nexport class GameRepository {\n  async findById(id: number) {\n    try {\n      const game = await prisma.game.findUnique({\n        where: { id },\n        include: { offers: true },\n      });\n      if (!game) {\n        throw new NotFoundError('Game', id);\n      }\n      return game;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find game by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.game.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n        include: { offers: true },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all games', error);\n    }\n  }\n\n  async create(data: Prisma.GameCreateInput) {\n    try {\n      return await prisma.game.create({ data });\n    } catch (error) {\n      throw new DatabaseError('Failed to create game', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.GameUpdateInput) {\n    try {\n      return await prisma.game.update({\n        where: { id },\n        data,\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update game', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.game.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete game', error);\n    }\n  }\n\n  async findEnabled() {\n    try {\n      return await prisma.game.findMany({\n        where: { isEnabled: true },\n        include: { offers: { where: { isEnabled: true } } },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find enabled games', error);\n    }\n  }\n\n  async findActual() {\n    try {\n      return await prisma.game.findMany({\n        where: {\n          isEnabled: true,\n          isActual: true,\n        },\n        include: { offers: { where: { isEnabled: true } } },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find actual games', error);\n    }\n  }\n\n  async findWithDiscount() {\n    try {\n      return await prisma.game.findMany({\n        where: {\n          isEnabled: true,\n          hasDiscount: true,\n        },\n        include: { offers: { where: { isEnabled: true } } },\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find games with discount', error);\n    }\n  }\n\n  async toggleEnabled(id: number) {\n    try {\n      const game = await this.findById(id);\n      return await prisma.game.update({\n        where: { id },\n        data: { isEnabled: !game.isEnabled },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to toggle game enabled status', error);\n    }\n  }\n\n  async toggleActual(id: number) {\n    try {\n      const game = await this.findById(id);\n      return await prisma.game.update({\n        where: { id },\n        data: { isActual: !game.isActual },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to toggle game actual status', error);\n    }\n  }\n\n  async toggleDiscount(id: number) {\n    try {\n      const game = await this.findById(id);\n      return await prisma.game.update({\n        where: { id },\n        data: { hasDiscount: !game.hasDiscount },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to toggle game discount status', error);\n    }\n  }\n}\n\nexport const gameRepository = new GameRepository();\n","size_bytes":3654},"server/src/db/error.ts":{"content":"export class DatabaseError extends Error {\n  constructor(message: string, public originalError?: any) {\n    super(message);\n    this.name = 'DatabaseError';\n  }\n}\n\nexport class NotFoundError extends DatabaseError {\n  constructor(resource: string, id: number | string) {\n    super(`${resource} with id ${id} not found`);\n    this.name = 'NotFoundError';\n  }\n}\n\nexport class ValidationError extends DatabaseError {\n  constructor(message: string, public validationErrors?: any) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n","size_bytes":538},"install-all.sh":{"content":"#!/bin/bash\n\necho \"üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...\"\necho \"\"\n\n# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞\necho \"üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–µ—Ä–≤–µ—Ä–∞...\"\ncd server && npm install && cd ..\n\n# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–æ—Ç–∞\necho \"üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–æ—Ç–∞...\"\ncd bot && npm install && cd ..\n\n# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞\necho \"üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞...\"\ncd client && npm install && cd ..\n\n# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∫–∏\necho \"üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∞–¥–º–∏–Ω–∫–∏...\"\ncd admin && npm install && cd ..\n\necho \"\"\necho \"‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!\"\n","size_bytes":896},"server/src/db/repositories/user.ts":{"content":"import { prisma } from '../client';\nimport { DatabaseError, NotFoundError } from '../error';\nimport { Currency, Prisma } from '../../../generated/prisma';\n\nexport class UserRepository {\n  async findById(id: number) {\n    try {\n      const user = await prisma.user.findUnique({\n        where: { id },\n        include: {\n          chat: true,\n          referrals: true,\n          referredBy: true,\n        },\n      });\n      if (!user) {\n        throw new NotFoundError('User', id);\n      }\n      return user;\n    } catch (error) {\n      if (error instanceof NotFoundError) throw error;\n      throw new DatabaseError('Failed to find user by id', error);\n    }\n  }\n\n  async findAll(limit?: number, offset?: number) {\n    try {\n      return await prisma.user.findMany({\n        take: limit,\n        skip: offset,\n        orderBy: { createdAt: 'desc' },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find all users', error);\n    }\n  }\n\n  async create(data: Prisma.UserCreateInput) {\n    try {\n      return await prisma.user.create({ data });\n    } catch (error) {\n      throw new DatabaseError('Failed to create user', error);\n    }\n  }\n\n  async update(id: number, data: Prisma.UserUpdateInput) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data,\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update user', error);\n    }\n  }\n\n  async delete(id: number) {\n    try {\n      return await prisma.user.delete({ where: { id } });\n    } catch (error) {\n      throw new DatabaseError('Failed to delete user', error);\n    }\n  }\n\n  async findByUsername(username: string) {\n    try {\n      return await prisma.user.findFirst({\n        where: { username },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to find user by username', error);\n    }\n  }\n\n  async findByTelegramId(telegramId: bigint | number) {\n    try {\n      const user = await prisma.user.findUnique({\n        where: { telegramId: BigInt(telegramId) },\n        include: {\n          chat: true,\n          referrals: true,\n          referredBy: true,\n        },\n      });\n      return user;\n    } catch (error) {\n      throw new DatabaseError('Failed to find user by telegram ID', error);\n    }\n  }\n\n  async updateBalance(id: number, currency: Currency, amount: number) {\n    try {\n      const field = currency === 'RUB' ? 'balanceRUB' : 'balanceUSDT';\n      return await prisma.user.update({\n        where: { id },\n        data: {\n          [field]: {\n            increment: amount,\n          },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update user balance', error);\n    }\n  }\n\n  async incrementOrdersCount(id: number) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data: {\n          ordersCount: { increment: 1 },\n        },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to increment orders count', error);\n    }\n  }\n\n  async updateSubscriptionStatus(id: number, isSubscribed: boolean) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data: { isSubscribed },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update subscription status', error);\n    }\n  }\n\n  async setBanStatus(id: number, isBanned: boolean) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data: { isBanned },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to set ban status', error);\n    }\n  }\n\n  async acceptPrivacyConsent(id: number) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data: { acceptedPrivacyConsent: true },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to accept privacy consent', error);\n    }\n  }\n\n  async updateReferralPercent(id: number, percent: number) {\n    try {\n      return await prisma.user.update({\n        where: { id },\n        data: { referralPercent: percent },\n      });\n    } catch (error) {\n      throw new DatabaseError('Failed to update referral percent', error);\n    }\n  }\n}\n\nexport const userRepository = new UserRepository();\n","size_bytes":4172},"server/prisma.config.ts":{"content":"import { defineConfig, env } from \"prisma/config\";\n\nexport default defineConfig({\n  schema: \"prisma/schema.prisma\",\n  migrations: {\n    path: \"prisma/migrations\",\n  },\n  engine: \"classic\",\n  datasource: {\n    url: env(\"DATABASE_URL\"),\n  },\n});\n","size_bytes":244}},"version":2}