services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: zapusk
      POSTGRES_USER: legendy
      POSTGRES_PASSWORD: 777legendy
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  server:
    build: ./server
    environment:
      DATABASE_URL: postgresql://legendy:777legendy@db:5432/zapusk
      BOT_TOKEN: ${BOT_TOKEN}
      # Internal bot-to-server auth token used to validate requests from the Telegram bot
      # Use the same value as BOT_TOKEN by default to avoid mismatches when AUTH_BOT_TOKEN is not provided
      AUTH_BOT_TOKEN: ${BOT_TOKEN}
      # Разрешённый origin клиента (используется CORS/Socket.IO)
      CLIENT_URL: ${WEB_APP_URL}
    depends_on:
      - db
    ports:
      - "3001:3001"

  bot:
    build: ./bot
    environment:
      BOT_TOKEN: ${BOT_TOKEN}
      BOT_USERNAME: ${BOT_USERNAME}
      ADMIN_ID: ${ADMIN_ID}
      API_URL: http://server:3001/api
      # URL открываемого WebApp. ДОЛЖЕН быть публичным HTTPS URL, доступным из Telegram
      WEB_APP_URL: ${WEB_APP_URL}
      # Keep AUTH_BOT_TOKEN in sync with backend; default to BOT_TOKEN if not explicitly provided
      AUTH_BOT_TOKEN: ${BOT_TOKEN}
    depends_on:
      - server


  nginx:
    image: nginx:alpine
    depends_on:
      - server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./server/ssl:/etc/nginx/ssl:ro
      - ./client/dist:/usr/share/nginx/html:ro
      - ./admin/dist:/usr/share/nginx/html-admin:ro

  cloudflared:
    image: cloudflare/cloudflared:latest
    depends_on:
      - nginx
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared
    restart: unless-stopped

volumes:
  postgres_data:

